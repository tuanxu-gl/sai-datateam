query,total_gigabytes_billed
"WITH gb4230 as (select 4230),
tbl_story_mode_finished as (
 select user_id,FED_ID,PLATFORM,game_id,EVENT_ID,min(client_time),min(client_time),version,country,SESSION_ID
,min(TOKEN),AVATAR_GENDER,END_CAUSE,TOY_NAME,STORY_STEP,avg(TIME_TO_FINISH)
,ACTIVITY_01,ACTIVITY_01_VALUE,ACTIVITY_02,ACTIVITY_02_VALUE,ACTIVITY_03,ACTIVITY_03_VALUE,ACTIVITY_04
,ACTIVITY_04_VALUE,ACTIVITY_05,ACTIVITY_05_VALUE,AVATAR_ONESIE,click_from,ENVIRONMENT_ID,min(EVENT_client_time_LOCAL)
,avg(REALTIME_SPENT),min(load_time),ACTIVITY_06,ACTIVITY_06_VALUE,ACTIVITY_07,ACTIVITY_07_VALUE
,ACTIVITY_08,ACTIVITY_08_VALUE,ACTIVITY_09,ACTIVITY_09_VALUE,ACTIVITY_10,ACTIVITY_10_VALUE,TOY_UNLOCKED_METHOD,from_scene
 from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 where (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0' 
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 group by all
)
,real_story_mode_finished as (
SELECT user_id,game_id,event_id,version,country,session_id,avatar_gender,end_cause,toy_name,story_step,realtime_spent,environment_id,client_time,toy_unlocked_method,count(*) as dup
FROM 
 (
 -- exclude Dino Exp
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished
 WHERE 
 environment_id like 'Natoons v4%' or
 -- DUPLICATIONS in those Experience
 (environment_id like '%Travel%' and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id NOT IN ('Savannah','Space','Ocean','Jungle','Magic Land','Experience - Dino Museum') AND (environment_id not LIKE '%Travel%') ) or 
 (environment_id='Kinderini' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_kinderini_start_date') ) or 
 (environment_id='Eduland Lets Story' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_v5_lets_story_start_date'))
 -- Dino 
 union all
 -- version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') (normal)
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 WHERE (version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19'))
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 union all
 -- (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0'
 select * from tbl_story_mode_finished
 )
group by all
)
,dedicated as (
SELECT user_id,realtime_spent
from real_story_mode_finished
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
SELECT user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.ILLUSTRATION_BOOK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,minigame_done as (
select user_id AS user_id,
game_id AS game_id,
client_time AS client_time,server_time AS server_time,
version AS version,
country AS country,
scene_name AS scene_name,
click_from AS click_from,
case when REALTIME_SPENT is null then time_to_finish else REALTIME_SPENT end AS realtime_spent,
load_time AS load_time,
case when from_scene is null then 'Not yet available' else from_scene end as from_scene,
FROM gcp-bi-elephant-db-gold.applaydu.minigame_finished
)
,minigame as (
SELECT user_id,realtime_spent
FROM minigame_done
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name not in ('Main Menu','NBA_1','NBA_2','Happos Runner','Natoon RunnerV2','Inkmagination_Xmas')
 and from_scene<>'Eduland AvatarHouse' -- EXCLUDE Minigame Drawing in AvatarHouse from Minigame
 and scene_name not like '%Playability%' 
 and( (scene_name<>'Move Ahead'and realtime_spent>=0) or ( scene_name='Move Ahead' and realtime_spent>12) )-- to exclude users quitting during loading screen + cover 99% users
)
,toy_fs as (
--tracking TOY_FRIENDSHIP_FINISHED before v4.6.1
select user_id,time_spent,CAST(client_time AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.TOY_FRIENDSHIP_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'4.6.1' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name like 'Eduland%'
 and time_spent>=0 and time_spent<7200
--change tracking ACTIVITY_FINISHED since v4.6.1
union all
select user_id,time_spent,CAST(client_time AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='4.6.1' AND DATE(client_time) >= '2024-03-11') and version<'5.2.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Current Heart Point' -- first row data only for Natoons and Fantasy event returns 2 rows
 and time_spent>=0 and time_spent<7200
union all 
--change tracking ACTIVITY_FINISHED since v5.2.0
select user_id,sum(time_spent) as total_time,CAST(client_time AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') and version<'5.4.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
group by all
union all 
--change tracking ACTIVITY_FINISHED since v5.4.0
select user_id,sum(time_spent) as total_time,CAST(activity_10_value AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='5.4.0' AND DATE(client_time) >= '2024-12-04') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
group by 1,3
)
,ar_mode as (
select user_id,realtime_spent
FROM gcp-bi-elephant-db-gold.applaydu.AR_MODE_FINISHED
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.FACE_MASK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,avatar_house as (
-- OLD TRACKING: before 4.5.0 use visit_screen
select user_id
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 
 and screen_to like 'Eduland%Avatar%'
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all
select user_id
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0 and from_scene<>'Inkmagination' -- when users from AH Drawing to AH,we do not count as a new session
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,avatarhouse_time as (-- include Minigame Drawing from AH 
-- OLD TRACKING: before 4.5.0 use visit_screen
select time_spent
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 and time_spent>=0 and time_spent<36000
 and (screen_from like '%Avatar%' or (screen_from like '%Ink%' and screen_to like '%Avatar%')) -- INCLUDE TIME SPENT IN MINIGAME DRAWING IN AH
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
-- NEW TRACKING: after 4.5.0 use AH + MINIGAME DRAWING AH
union all
select time_spent
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all -- INCLUDE TIME_SPENT MINIGAME DRAWING in AH
select REALTIME_SPENT
from gcp-bi-elephant-db-gold.applaydu.minigame_finished
where scene_name='Inkmagination'
 and from_scene='Eduland AvatarHouse'
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,parental_section as (
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.PARENTAL_SECTION
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,result as
(
select 'Dedicated Experience' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from dedicated 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

union all
select 'AR' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from ar_mode 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Minigame' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from minigame 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Toy Friendship' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(time_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(time_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from toy_fs 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
group by 1
union all
select 'Avatar House' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,(select sum(time_spent) from avatarhouse_time) / (case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,(select sum(time_spent) from avatarhouse_time) /count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from avatar_house 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Parental Section' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from parental_section 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

)
select *
,concat(floor(`Time spent per user min`),' min ',round((`Time spent per user min` - floor(`Time spent per user min`)) * 60),' sec') as `Time spent per user min - sec`
,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration min`
 from result
order by session desc",171.859375
"WITH gb4230 as (select 4230),
tbl_story_mode_finished as (
 select user_id,FED_ID,PLATFORM,game_id,EVENT_ID,min(client_time),min(client_time),version,country,SESSION_ID
,min(TOKEN),AVATAR_GENDER,END_CAUSE,TOY_NAME,STORY_STEP,avg(TIME_TO_FINISH)
,ACTIVITY_01,ACTIVITY_01_VALUE,ACTIVITY_02,ACTIVITY_02_VALUE,ACTIVITY_03,ACTIVITY_03_VALUE,ACTIVITY_04
,ACTIVITY_04_VALUE,ACTIVITY_05,ACTIVITY_05_VALUE,AVATAR_ONESIE,click_from,ENVIRONMENT_ID,min(EVENT_client_time_LOCAL)
,avg(REALTIME_SPENT),min(load_time),ACTIVITY_06,ACTIVITY_06_VALUE,ACTIVITY_07,ACTIVITY_07_VALUE
,ACTIVITY_08,ACTIVITY_08_VALUE,ACTIVITY_09,ACTIVITY_09_VALUE,ACTIVITY_10,ACTIVITY_10_VALUE,TOY_UNLOCKED_METHOD,from_scene
 from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 where (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0' 
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 group by all
)
,real_story_mode_finished as (
SELECT user_id,game_id,event_id,version,country,session_id,avatar_gender,end_cause,toy_name,story_step,realtime_spent,environment_id,client_time,toy_unlocked_method,count(*) as dup
FROM 
 (
 -- exclude Dino Exp
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished
 WHERE 
 environment_id like 'Natoons v4%' or
 -- DUPLICATIONS in those Experience
 (environment_id like '%Travel%' and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id NOT IN ('Savannah','Space','Ocean','Jungle','Magic Land','Experience - Dino Museum') AND (environment_id not LIKE '%Travel%') ) or 
 (environment_id='Kinderini' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_kinderini_start_date') ) or 
 (environment_id='Eduland Lets Story' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_v5_lets_story_start_date'))
 -- Dino 
 union all
 -- version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') (normal)
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 WHERE (version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19'))
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 union all
 -- (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0'
 select * from tbl_story_mode_finished
 )
group by all
)
,dedicated as (
SELECT user_id,realtime_spent
from real_story_mode_finished
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
SELECT user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.ILLUSTRATION_BOOK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,minigame_done as (
select user_id AS user_id,
game_id AS game_id,
client_time AS client_time,server_time AS server_time,
version AS version,
country AS country,
scene_name AS scene_name,
click_from AS click_from,
case when REALTIME_SPENT is null then time_to_finish else REALTIME_SPENT end AS realtime_spent,
load_time AS load_time,
case when from_scene is null then 'Not yet available' else from_scene end as from_scene,
FROM gcp-bi-elephant-db-gold.applaydu.minigame_finished
)
,minigame as (
SELECT user_id,realtime_spent
FROM minigame_done
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name not in ('Main Menu','NBA_1','NBA_2','Happos Runner','Natoon RunnerV2','Inkmagination_Xmas')
 and from_scene<>'Eduland AvatarHouse' -- EXCLUDE Minigame Drawing in AvatarHouse from Minigame
 and scene_name not like '%Playability%' 
 and( (scene_name<>'Move Ahead'and realtime_spent>=0) or ( scene_name='Move Ahead' and realtime_spent>12) )-- to exclude users quitting during loading screen + cover 99% users
)
,toy_fs as (
--tracking TOY_FRIENDSHIP_FINISHED before v4.6.1
select user_id,time_spent,CAST(client_time AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.TOY_FRIENDSHIP_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'4.6.1' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name like 'Eduland%'
 and time_spent>=0 and time_spent<7200
--change tracking ACTIVITY_FINISHED since v4.6.1
union all
select user_id,time_spent,CAST(client_time AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='4.6.1' AND DATE(client_time) >= '2024-03-11') and version<'5.2.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Current Heart Point' -- first row data only for Natoons and Fantasy event returns 2 rows
 and time_spent>=0 and time_spent<7200
union all 
--change tracking ACTIVITY_FINISHED since v5.2.0
select user_id,sum(time_spent) as total_time,CAST(client_time AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') and version<'5.4.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
group by all
union all 
--change tracking ACTIVITY_FINISHED since v5.4.0
select user_id,sum(time_spent) as total_time,CAST(activity_10_value AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='5.4.0' AND DATE(client_time) >= '2024-12-04') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
group by 1,3
)
,ar_mode as (
select user_id,realtime_spent
FROM gcp-bi-elephant-db-gold.applaydu.AR_MODE_FINISHED
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.FACE_MASK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,avatar_house as (
-- OLD TRACKING: before 4.5.0 use visit_screen
select user_id
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 
 and screen_to like 'Eduland%Avatar%'
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all
select user_id
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0 and from_scene<>'Inkmagination' -- when users from AH Drawing to AH,we do not count as a new session
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,avatarhouse_time as (-- include Minigame Drawing from AH 
-- OLD TRACKING: before 4.5.0 use visit_screen
select time_spent
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 and time_spent>=0 and time_spent<36000
 and (screen_from like '%Avatar%' or (screen_from like '%Ink%' and screen_to like '%Avatar%')) -- INCLUDE TIME SPENT IN MINIGAME DRAWING IN AH
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
-- NEW TRACKING: after 4.5.0 use AH + MINIGAME DRAWING AH
union all
select time_spent
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all -- INCLUDE TIME_SPENT MINIGAME DRAWING in AH
select REALTIME_SPENT
from gcp-bi-elephant-db-gold.applaydu.minigame_finished
where scene_name='Inkmagination'
 and from_scene='Eduland AvatarHouse'
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,parental_section as (
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.PARENTAL_SECTION
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,result as
(
select 'Dedicated Experience' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from dedicated 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

union all
select 'AR' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from ar_mode 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Minigame' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from minigame 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Toy Friendship' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(time_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(time_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from toy_fs 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
group by 1
union all
select 'Avatar House' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,(select sum(time_spent) from avatarhouse_time) / (case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,(select sum(time_spent) from avatarhouse_time) /count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from avatar_house 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Parental Section' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from parental_section 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

)
select *
,concat(floor(`Time spent per user min`),' min ',round((`Time spent per user min` - floor(`Time spent per user min`)) * 60),' sec') as `Time spent per user min - sec`
,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration min`
 from result
order by session desc",171.8564453125
"WITH gb4235 as (select 4235),
tbl_story_mode_finished as (
 select user_id,FED_ID,PLATFORM,game_id,EVENT_ID,min(client_time),min(client_time),version,country,SESSION_ID
,min(TOKEN),AVATAR_GENDER,END_CAUSE,TOY_NAME,STORY_STEP,avg(TIME_TO_FINISH)
,ACTIVITY_01,ACTIVITY_01_VALUE,ACTIVITY_02,ACTIVITY_02_VALUE,ACTIVITY_03,ACTIVITY_03_VALUE,ACTIVITY_04
,ACTIVITY_04_VALUE,ACTIVITY_05,ACTIVITY_05_VALUE,AVATAR_ONESIE,click_from,ENVIRONMENT_ID,min(EVENT_client_time_LOCAL)
,avg(REALTIME_SPENT),min(load_time),ACTIVITY_06,ACTIVITY_06_VALUE,ACTIVITY_07,ACTIVITY_07_VALUE
,ACTIVITY_08,ACTIVITY_08_VALUE,ACTIVITY_09,ACTIVITY_09_VALUE,ACTIVITY_10,ACTIVITY_10_VALUE,TOY_UNLOCKED_METHOD,from_scene
 from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 where (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0' 
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 group by all
)
,real_story_mode_finished as (
SELECT user_id,game_id,event_id,version,country,session_id,avatar_gender,end_cause,toy_name,story_step,realtime_spent,environment_id,client_time,toy_unlocked_method,count(*) as dup
FROM 
 (
 -- exclude Dino Exp
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished
 WHERE 
 environment_id like 'Natoons v4%' or
 -- DUPLICATIONS in those Experience
 (environment_id like '%Travel%' and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id NOT IN ('Savannah','Space','Ocean','Jungle','Magic Land','Experience - Dino Museum') AND (environment_id not LIKE '%Travel%') ) or 
 (environment_id='Kinderini' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_kinderini_start_date') ) or 
 (environment_id='Eduland Lets Story' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_v5_lets_story_start_date'))
 -- Dino 
 union all
 -- version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') (normal)
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 WHERE (version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19'))
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 union all
 -- (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0'
 select * from tbl_story_mode_finished
 )
group by all
)
,dedicated as (
SELECT user_id,realtime_spent
from real_story_mode_finished
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
SELECT user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.ILLUSTRATION_BOOK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,minigame_done as (
select user_id AS user_id,
game_id AS game_id,
client_time AS client_time,server_time AS server_time,
version AS version,
country AS country,
scene_name AS scene_name,
click_from AS click_from,
case when REALTIME_SPENT is null then time_to_finish else REALTIME_SPENT end AS realtime_spent,
load_time AS load_time,
case when from_scene is null then 'Not yet available' else from_scene end as from_scene,
FROM gcp-bi-elephant-db-gold.applaydu.minigame_finished
)
,minigame as (
SELECT user_id,realtime_spent
FROM minigame_done
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name not in ('Main Menu','NBA_1','NBA_2','Happos Runner','Natoon RunnerV2','Inkmagination_Xmas')
 and from_scene<>'Eduland AvatarHouse' -- EXCLUDE Minigame Drawing in AvatarHouse from Minigame
 and scene_name not like '%Playability%' 
 and( (scene_name<>'Move Ahead'and realtime_spent>=0) or ( scene_name='Move Ahead' and realtime_spent>12) )-- to exclude users quitting during loading screen + cover 99% users
)
,toy_fs as (
--tracking TOY_FRIENDSHIP_FINISHED before v4.6.1
select user_id,sum(time_spent) as total_time,count (*) as session
from gcp-bi-elephant-db-gold.applaydu.TOY_FRIENDSHIP_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'4.6.1' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name like 'Eduland%'
 and time_spent>=0 and time_spent<7200
group by 1
--change tracking ACTIVITY_FINISHED since v4.6.1
union all
select user_id,sum(time_spent) as total_time,count (*) as session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='4.6.1' AND DATE(client_time) >= '2024-03-11') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Current Heart Point' -- first row data only for Natoons and Fantasy event returns 2 rows
 and time_spent>=0 and time_spent<7200
group by 1
union all
--change tracking ACTIVITY_FINISHED since v5.2.0
select user_id,total_time,session 
from (
(
select user_id,sum(time_spent) as total_time
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') and version<'5.4.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
group by 1
) a join (
select user_id,count(token) as session
from gcp-bi-elephant-db-gold.applaydu.TOY_FRIENDSHIP_STARTED
where 1=1
 and (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') and version<'5.4.0'
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) 
 and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (SELECT version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 )
 and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  ) 
 and date(client_time)>='2020-08-10' and date(client_time)<CURRENT_DATE()
group by 1
) b using (user_id))
union all
--change tracking ACTIVITY_FINISHED since v5.4.0
select user_id,sum(session_timespent) as total_time,count(session_id) as session
from(
 select user_id,ACTIVITY_10_VALUE as session_id,sum(time_spent) as session_timespent
 from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
 where 1=1
 and (version >='5.4.0' AND DATE(client_time) >= '2024-12-04') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
 group by 1,2
)
group by 1
)
,ar_mode as (
select user_id,realtime_spent
FROM gcp-bi-elephant-db-gold.applaydu.AR_MODE_FINISHED
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.FACE_MASK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,avatar_house as (
-- OLD TRACKING: before 4.5.0 use visit_screen
select user_id
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 
 and screen_to like 'Eduland%Avatar%'
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all
select user_id
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0 and from_scene<>'Inkmagination' -- when users from AH Drawing to AH,we do not count as a new session
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,avatarhouse_time as (-- include Minigame Drawing from AH 
-- OLD TRACKING: before 4.5.0 use visit_screen
select time_spent
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 and time_spent>=0 and time_spent<36000
 and (screen_from like '%Avatar%' or (screen_from like '%Ink%' and screen_to like '%Avatar%')) -- INCLUDE TIME SPENT IN MINIGAME DRAWING IN AH
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
-- NEW TRACKING: after 4.5.0 use AH + MINIGAME DRAWING AH
union all
select time_spent
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all -- INCLUDE TIME_SPENT MINIGAME DRAWING in AH
select REALTIME_SPENT
from gcp-bi-elephant-db-gold.applaydu.minigame_finished
where scene_name='Inkmagination'
 and from_scene='Eduland AvatarHouse'
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,parental_section as (
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.PARENTAL_SECTION
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,result as
(
select 'Dedicated Experience' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from dedicated 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

union all
select 'AR' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from ar_mode 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Minigame' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from minigame 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Toy Friendship' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(total_time)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(total_time)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from toy_fs 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
group by 1
union all
select 'Avatar House' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,(select sum(time_spent) from avatarhouse_time) / (case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,(select sum(time_spent) from avatarhouse_time) /count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from avatar_house 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Parental Section' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from parental_section 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

)
select *
,concat(floor(`Time spent per user min`),' min ',round((`Time spent per user min` - floor(`Time spent per user min`)) * 60),' sec') as `Time spent per user min - sec`
,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration min`
 from result
order by `Time spent per user min` desc",167.34375
"WITH gb4235 as (select 4235),
tbl_story_mode_finished as (
 select user_id,FED_ID,PLATFORM,game_id,EVENT_ID,min(client_time),min(client_time),version,country,SESSION_ID
,min(TOKEN),AVATAR_GENDER,END_CAUSE,TOY_NAME,STORY_STEP,avg(TIME_TO_FINISH)
,ACTIVITY_01,ACTIVITY_01_VALUE,ACTIVITY_02,ACTIVITY_02_VALUE,ACTIVITY_03,ACTIVITY_03_VALUE,ACTIVITY_04
,ACTIVITY_04_VALUE,ACTIVITY_05,ACTIVITY_05_VALUE,AVATAR_ONESIE,click_from,ENVIRONMENT_ID,min(EVENT_client_time_LOCAL)
,avg(REALTIME_SPENT),min(load_time),ACTIVITY_06,ACTIVITY_06_VALUE,ACTIVITY_07,ACTIVITY_07_VALUE
,ACTIVITY_08,ACTIVITY_08_VALUE,ACTIVITY_09,ACTIVITY_09_VALUE,ACTIVITY_10,ACTIVITY_10_VALUE,TOY_UNLOCKED_METHOD,from_scene
 from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 where (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0' 
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 group by all
)
,real_story_mode_finished as (
SELECT user_id,game_id,event_id,version,country,session_id,avatar_gender,end_cause,toy_name,story_step,realtime_spent,environment_id,client_time,toy_unlocked_method,count(*) as dup
FROM 
 (
 -- exclude Dino Exp
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished
 WHERE 
 environment_id like 'Natoons v4%' or
 -- DUPLICATIONS in those Experience
 (environment_id like '%Travel%' and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id NOT IN ('Savannah','Space','Ocean','Jungle','Magic Land','Experience - Dino Museum') AND (environment_id not LIKE '%Travel%') ) or 
 (environment_id='Kinderini' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_kinderini_start_date') ) or 
 (environment_id='Eduland Lets Story' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_v5_lets_story_start_date'))
 -- Dino 
 union all
 -- version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') (normal)
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 WHERE (version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19'))
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 union all
 -- (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0'
 select * from tbl_story_mode_finished
 )
group by all
)
,dedicated as (
SELECT user_id,realtime_spent
from real_story_mode_finished
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
SELECT user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.ILLUSTRATION_BOOK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,minigame_done as (
select user_id AS user_id,
game_id AS game_id,
client_time AS client_time,server_time AS server_time,
version AS version,
country AS country,
scene_name AS scene_name,
click_from AS click_from,
case when REALTIME_SPENT is null then time_to_finish else REALTIME_SPENT end AS realtime_spent,
load_time AS load_time,
case when from_scene is null then 'Not yet available' else from_scene end as from_scene,
FROM gcp-bi-elephant-db-gold.applaydu.minigame_finished
)
,minigame as (
SELECT user_id,realtime_spent
FROM minigame_done
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name not in ('Main Menu','NBA_1','NBA_2','Happos Runner','Natoon RunnerV2','Inkmagination_Xmas')
 and from_scene<>'Eduland AvatarHouse' -- EXCLUDE Minigame Drawing in AvatarHouse from Minigame
 and scene_name not like '%Playability%' 
 and( (scene_name<>'Move Ahead'and realtime_spent>=0) or ( scene_name='Move Ahead' and realtime_spent>12) )-- to exclude users quitting during loading screen + cover 99% users
)
,toy_fs as (
--tracking TOY_FRIENDSHIP_FINISHED before v4.6.1
select user_id,sum(time_spent) as total_time,count (*) as session
from gcp-bi-elephant-db-gold.applaydu.TOY_FRIENDSHIP_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'4.6.1' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name like 'Eduland%'
 and time_spent>=0 and time_spent<7200
group by 1
--change tracking ACTIVITY_FINISHED since v4.6.1
union all
select user_id,sum(time_spent) as total_time,count (*) as session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='4.6.1' AND DATE(client_time) >= '2024-03-11') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Current Heart Point' -- first row data only for Natoons and Fantasy event returns 2 rows
 and time_spent>=0 and time_spent<7200
group by 1
union all
--change tracking ACTIVITY_FINISHED since v5.2.0
select user_id,total_time,session 
from (
(
select user_id,sum(time_spent) as total_time
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') and version<'5.4.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
group by 1
) a join (
select user_id,count(token) as session
from gcp-bi-elephant-db-gold.applaydu.TOY_FRIENDSHIP_STARTED
where 1=1
 and (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') and version<'5.4.0'
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) 
 and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (SELECT version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 )
 and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  ) 
 and date(client_time)>='2020-08-10' and date(client_time)<CURRENT_DATE()
group by 1
) b using (user_id))
union all
--change tracking ACTIVITY_FINISHED since v5.4.0
select user_id,sum(session_timespent) as total_time,count(session_id) as session
from(
 select user_id,ACTIVITY_10_VALUE as session_id,sum(time_spent) as session_timespent
 from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
 where 1=1
 and (version >='5.4.0' AND DATE(client_time) >= '2024-12-04') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
 group by 1,2
)
group by 1
)
,ar_mode as (
select user_id,realtime_spent
FROM gcp-bi-elephant-db-gold.applaydu.AR_MODE_FINISHED
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.FACE_MASK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,avatar_house as (
-- OLD TRACKING: before 4.5.0 use visit_screen
select user_id
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 
 and screen_to like 'Eduland%Avatar%'
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all
select user_id
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0 and from_scene<>'Inkmagination' -- when users from AH Drawing to AH,we do not count as a new session
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,avatarhouse_time as (-- include Minigame Drawing from AH 
-- OLD TRACKING: before 4.5.0 use visit_screen
select time_spent
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 and time_spent>=0 and time_spent<36000
 and (screen_from like '%Avatar%' or (screen_from like '%Ink%' and screen_to like '%Avatar%')) -- INCLUDE TIME SPENT IN MINIGAME DRAWING IN AH
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
-- NEW TRACKING: after 4.5.0 use AH + MINIGAME DRAWING AH
union all
select time_spent
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all -- INCLUDE TIME_SPENT MINIGAME DRAWING in AH
select REALTIME_SPENT
from gcp-bi-elephant-db-gold.applaydu.minigame_finished
where scene_name='Inkmagination'
 and from_scene='Eduland AvatarHouse'
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,parental_section as (
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.PARENTAL_SECTION
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,result as
(
select 'Dedicated Experience' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from dedicated 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

union all
select 'AR' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from ar_mode 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Minigame' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from minigame 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Toy Friendship' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(total_time)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(total_time)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from toy_fs 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
group by 1
union all
select 'Avatar House' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,(select sum(time_spent) from avatarhouse_time) / (case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,(select sum(time_spent) from avatarhouse_time) /count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from avatar_house 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Parental Section' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from parental_section 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

)
select *
,concat(floor(`Time spent per user min`),' min ',round((`Time spent per user min` - floor(`Time spent per user min`)) * 60),' sec') as `Time spent per user min - sec`
,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration min`
 from result
order by `Time spent per user min` desc",167.3408203125
"with gb4250 as (select 0)
,tbl_install as (
    SELECT user_id, DATE(MIN(install_date)) as install_date
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity`
    WHERE 1=1 
        AND install_country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND install_source IN (SELECT install_source FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` WHERE 1=1 )
        AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1 )
    GROUP BY 1 
),
t_users as (
    SELECT user_id,
           SUM(sessions_count) as sessions_count,
           SUM(total_time_spent) as total_time_spent,
           SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) as scans
    FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
            AND DATE(ACTIVE_DATE) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(ACTIVE_DATE) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
    WHERE DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version >= (SELECT MIN(version) FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND version <= (SELECT MAX(version) FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1 )
    GROUP BY user_id
),
tbl_launch_resume_src as (
    SELECT 'All' as period,
           SUM(time_spent) as `Total time spent`,
           COUNT(DISTINCT user_id) AS `Total Users`,
           SUM(time_spent) / COUNT(DISTINCT user_id) as time_result,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result)) AS `Average Time per Users`,
           SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) AS `Total Sessions`,
           SUM(time_spent) / SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) as time_result_sessions,
           --FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(time_result_sessions)) AS `Average Time per Session`,
           SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) /  COUNT(DISTINCT user_id) as `Average Session per User`,
           SUM(CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) as `Total Time Spent New users`,
           COUNT(DISTINCT CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) AS `Total New Users`,
           SUM(CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) / COUNT(DISTINCT CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as time_result_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_new_users)) AS `Average Time Spent Per New Users`,
           SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                          AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)) 
                    THEN 1 ELSE 0 END) AS `Total Sessions New Users`,
           SUM(CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) / SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                          AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)) 
                    THEN 1 ELSE 0 END) as time_result_sessions_new_users,
           --FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(time_result_sessions_new_users)) AS `Average Time per Session New Users`,
           SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                          AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)) 
                    THEN 1 ELSE 0 END) / COUNT(DISTINCT CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as `Average Session per New User`,
           SUM(CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) as `Total Time Spent Old users`,
           COUNT(DISTINCT CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) AS `Total Old Users`,
           SUM(CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) / COUNT(DISTINCT CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as time_result_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_old_users)) AS `Average Time Per Old Users`,
           SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)) 
                    THEN 1 ELSE 0 END) AS `Total Sessions Old Users`,
           SUM(CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) / SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)) 
                    THEN 1 ELSE 0 END) as time_result_sessions_old_users,
           --FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(time_result_sessions_old_users)) AS `Average Time per Session Old Users`,
           SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)) 
                    THEN 1 ELSE 0 END) / COUNT(DISTINCT CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as `Average Session per Old User`
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    LEFT JOIN tbl_install USING (user_id)
    WHERE CAST(time_spent AS INT) >= 0
        AND CAST(time_spent AS INT) < 86400
        AND version >= (SELECT MIN(version) FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND version <= (SELECT MAX(version) FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND `gcp-bi-elephant-db-gold.applaydu.launch_resume`.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1 )
        AND (DATE(client_time) >= '2020-08-10' AND DATE(client_time) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY))
),
tbl_users_src as (
    SELECT 'All' as period,
           COUNT(DISTINCT CASE WHEN scans > 0 THEN user_id ELSE 0 END) as scan_users,
           SUM(CASE WHEN scans > 0 THEN total_time_spent ELSE 0 END) as sum_total_time_spent_scan_users,
           SUM(CASE WHEN scans > 0 THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans > 0 THEN user_id ELSE 0 END) as time_result_scan_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_scan_users)) AS `Time Spent Per Scan User`,
           SUM(CASE WHEN scans > 0 THEN sessions_count ELSE 0 END) as scan_sessions_count,
           SUM(CASE WHEN scans > 0 THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans > 0 THEN sessions_count ELSE 0 END) as time_result_session_scan_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_scan_users)) AS `Time Spent Per Session of Scan Users`,
           COUNT(DISTINCT CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as scan_new_users,
           SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) as sum_total_time_spent_scan_new_users,
            SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as time_result_scan_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_scan_new_users)) AS `Time Spent Per Scan New User`,
           SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) as scan_sessions_new_users_count,
           SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) as time_result_session_scan_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_scan_new_users)) AS `Time Spent Per Session of Scan New Users`,
           COUNT(DISTINCT CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as scan_old_users,
           SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) as sum_total_time_spent_scan_old_users,
           SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as time_result_scan_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_scan_old_users)) AS `Time Spent Per Scan Old User`,
           SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) as scan_sessions_old_users_count,
           CASE WHEN SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) = 0 THEN 0 ELSE SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) END as time_result_session_scan_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_scan_old_users)) AS `Time Spent Per Session of Scan Old Users`,
           COUNT(DISTINCT CASE WHEN scans = 0 THEN user_id ELSE 0 END) as free_users,
           SUM(CASE WHEN scans = 0 THEN total_time_spent ELSE 0 END) as sum_total_time_spent_free_users,
           SUM(CASE WHEN scans = 0 THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans = 0 THEN user_id ELSE 0 END) as time_result_free_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_free_users)) AS `Time Spent Per Free User`,
           SUM(CASE WHEN scans = 0 THEN sessions_count ELSE 0 END) as scan_sessions_free_users_count,
           CASE WHEN SUM(CASE WHEN scans = 0 THEN sessions_count ELSE 0 END) = 0 THEN 0 ELSE SUM(CASE WHEN scans = 0 THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans = 0 THEN sessions_count ELSE 0 END) END as time_result_session_free_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_free_users)) AS `Time Spent Per Session of Free Users`,
           COUNT(DISTINCT CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as free_new_users,
           SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) as sum_total_time_spent_free_new_users,
           SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as time_result_free_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_free_new_users)) AS `Time Spent Per Free New User`,
           SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) as scan_sessions_new_free_users_count,
           CASE WHEN SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) = 0 THEN 0 ELSE SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) END as time_result_session_free_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_free_new_users)) AS `Time Spent Per Session of Free New Users`,
           COUNT(DISTINCT CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as free_old_users,
           SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) as sum_total_time_spent_free_old_users,
           SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as time_result_free_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_free_old_users)) AS `Time Spent Per Free Old User`,
           SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) as scan_sessions_free_old_users_count,
           CASE WHEN SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) = 0 THEN 0 ELSE SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) END as time_result_session_free_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_free_old_users)) AS `Time Spent Per Session of Free Old Users`
    FROM t_users
    LEFT JOIN tbl_install USING (user_id)
)
select '01.Average Time per Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result AS INT64))) as value from tbl_launch_resume_src
union all select '02.Average Time Spent Per New Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_new_users AS INT64))) as value from tbl_launch_resume_src

union all select '03.Average Time Per Old Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_old_users AS INT64))) as value from tbl_launch_resume_src
union all select '04.Time Spent Per Scan User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_scan_users AS INT64))) as value from tbl_users_src
union all select '05.Time Spent Per Scan New User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_scan_new_users AS INT64))) as value from tbl_users_src
union all select '06.Time Spent Per Scan Old User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_scan_old_users AS INT64))) as value from tbl_users_src
union all select '07.Time Spent Per Free User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_free_users AS INT64))) as value from tbl_users_src
union all select '08.Time Spent Per Free New User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_free_new_users AS INT64))) as value from tbl_users_src
union all select '09.Time Spent Per Free Old User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_free_old_users AS INT64))) as value from tbl_users_src
union all select '10.Average Time per Session' as kpi, FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_sessions AS INT64))) as value from tbl_launch_resume_src
union all select '11.Average Time per Session New Users' as kpi, FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_sessions_new_users AS INT64))) as value from tbl_launch_resume_src
union all select '12.Average Time per Session Old Users' as kpi, FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_sessions_old_users AS INT64))) as value from tbl_launch_resume_src
union all select '13.Time Spent Per Session of Scan Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_scan_users AS INT64))) as value from tbl_users_src
union all select '14.Time Spent Per Session of Scan New Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_scan_new_users AS INT64))) as value from tbl_users_src
union all select '15.Time Spent Per Session of Scan Old Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_scan_old_users AS INT64))) as value from tbl_users_src
union all select '16.Time Spent Per Session of Free Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_free_users AS INT64))) as value from tbl_users_src
union all select '17.Time Spent Per Session of Free New Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_free_new_users AS INT64))) as value from tbl_users_src
union all select '18.Time Spent Per Session of Free Old Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_free_old_users AS INT64))) as value from tbl_users_src
union all select '19.Average Session per User' as kpi, CAST(`Average Session per User` as STRING) as value from tbl_launch_resume_src
union all select '20.Average Session per New User' as kpi, CAST(`Average Session per New User` as STRING) as value from tbl_launch_resume_src
union all select '21.Average Session per Old User' as kpi, CAST(`Average Session per Old User` as STRING) as value from tbl_launch_resume_src
order by kpi asc",103.9560546875
"with gb4250 as (select 0)
,tbl_install as (
    SELECT user_id, DATE(MIN(install_date)) as install_date
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity`
    WHERE 1=1 
        AND install_country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND install_source IN (SELECT install_source FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` WHERE 1=1 )
        AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1 )
    GROUP BY 1 
),
t_users as (
    SELECT user_id,
           SUM(sessions_count) as sessions_count,
           SUM(total_time_spent) as total_time_spent,
           SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) as scans
    FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
            AND DATE(ACTIVE_DATE) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(ACTIVE_DATE) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
    WHERE DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version >= (SELECT MIN(version) FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND version <= (SELECT MAX(version) FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1 )
    GROUP BY user_id
),
tbl_launch_resume_src as (
    SELECT 'All' as period,
           SUM(time_spent) as `Total time spent`,
           COUNT(DISTINCT user_id) AS `Total Users`,
           SUM(time_spent) / COUNT(DISTINCT user_id) as time_result,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result)) AS `Average Time per Users`,
           SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) AS `Total Sessions`,
           SUM(time_spent) / SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) as time_result_sessions,
           --FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(time_result_sessions)) AS `Average Time per Session`,
           SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) /  COUNT(DISTINCT user_id) as `Average Session per User`,
           SUM(CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) as `Total Time Spent New users`,
           COUNT(DISTINCT CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) AS `Total New Users`,
           SUM(CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) / COUNT(DISTINCT CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as time_result_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_new_users)) AS `Average Time Spent Per New Users`,
           SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                          AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)) 
                    THEN 1 ELSE 0 END) AS `Total Sessions New Users`,
           SUM(CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) / SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                          AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)) 
                    THEN 1 ELSE 0 END) as time_result_sessions_new_users,
           --FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(time_result_sessions_new_users)) AS `Average Time per Session New Users`,
           SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                          AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)) 
                    THEN 1 ELSE 0 END) / COUNT(DISTINCT CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as `Average Session per New User`,
           SUM(CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) as `Total Time Spent Old users`,
           COUNT(DISTINCT CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) AS `Total Old Users`,
           SUM(CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) / COUNT(DISTINCT CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as time_result_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_old_users)) AS `Average Time Per Old Users`,
           SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)) 
                    THEN 1 ELSE 0 END) AS `Total Sessions Old Users`,
           SUM(CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) / SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)) 
                    THEN 1 ELSE 0 END) as time_result_sessions_old_users,
           --FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(time_result_sessions_old_users)) AS `Average Time per Session Old Users`,
           SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)) 
                    THEN 1 ELSE 0 END) / COUNT(DISTINCT CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as `Average Session per Old User`
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    LEFT JOIN tbl_install USING (user_id)
    WHERE CAST(time_spent AS INT) >= 0
        AND CAST(time_spent AS INT) < 86400
        AND version >= (SELECT MIN(version) FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND version <= (SELECT MAX(version) FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND `gcp-bi-elephant-db-gold.applaydu.launch_resume`.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1 )
        AND (DATE(client_time) >= '2020-08-10' AND DATE(client_time) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY))
),
tbl_users_src as (
    SELECT 'All' as period,
           COUNT(DISTINCT CASE WHEN scans > 0 THEN user_id ELSE 0 END) as scan_users,
           SUM(CASE WHEN scans > 0 THEN total_time_spent ELSE 0 END) as sum_total_time_spent_scan_users,
           SUM(CASE WHEN scans > 0 THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans > 0 THEN user_id ELSE 0 END) as time_result_scan_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_scan_users)) AS `Time Spent Per Scan User`,
           SUM(CASE WHEN scans > 0 THEN sessions_count ELSE 0 END) as scan_sessions_count,
           SUM(CASE WHEN scans > 0 THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans > 0 THEN sessions_count ELSE 0 END) as time_result_session_scan_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_scan_users)) AS `Time Spent Per Session of Scan Users`,
           COUNT(DISTINCT CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as scan_new_users,
           SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) as sum_total_time_spent_scan_new_users,
            SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as time_result_scan_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_scan_new_users)) AS `Time Spent Per Scan New User`,
           SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) as scan_sessions_new_users_count,
           SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) as time_result_session_scan_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_scan_new_users)) AS `Time Spent Per Session of Scan New Users`,
           COUNT(DISTINCT CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as scan_old_users,
           SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) as sum_total_time_spent_scan_old_users,
           SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as time_result_scan_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_scan_old_users)) AS `Time Spent Per Scan Old User`,
           SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) as scan_sessions_old_users_count,
           CASE WHEN SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) = 0 THEN 0 ELSE SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) END as time_result_session_scan_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_scan_old_users)) AS `Time Spent Per Session of Scan Old Users`,
           COUNT(DISTINCT CASE WHEN scans = 0 THEN user_id ELSE 0 END) as free_users,
           SUM(CASE WHEN scans = 0 THEN total_time_spent ELSE 0 END) as sum_total_time_spent_free_users,
           SUM(CASE WHEN scans = 0 THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans = 0 THEN user_id ELSE 0 END) as time_result_free_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_free_users)) AS `Time Spent Per Free User`,
           SUM(CASE WHEN scans = 0 THEN sessions_count ELSE 0 END) as scan_sessions_free_users_count,
           CASE WHEN SUM(CASE WHEN scans = 0 THEN sessions_count ELSE 0 END) = 0 THEN 0 ELSE SUM(CASE WHEN scans = 0 THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans = 0 THEN sessions_count ELSE 0 END) END as time_result_session_free_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_free_users)) AS `Time Spent Per Session of Free Users`,
           COUNT(DISTINCT CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as free_new_users,
           SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) as sum_total_time_spent_free_new_users,
           SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as time_result_free_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_free_new_users)) AS `Time Spent Per Free New User`,
           SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) as scan_sessions_new_free_users_count,
           CASE WHEN SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) = 0 THEN 0 ELSE SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) END as time_result_session_free_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_free_new_users)) AS `Time Spent Per Session of Free New Users`,
           COUNT(DISTINCT CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as free_old_users,
           SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) as sum_total_time_spent_free_old_users,
           SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as time_result_free_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_free_old_users)) AS `Time Spent Per Free Old User`,
           SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) as scan_sessions_free_old_users_count,
           CASE WHEN SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) = 0 THEN 0 ELSE SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) END as time_result_session_free_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_free_old_users)) AS `Time Spent Per Session of Free Old Users`
    FROM t_users
    LEFT JOIN tbl_install USING (user_id)
)
select '01.Average Time per Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result AS INT64))) as value from tbl_launch_resume_src
union all select '02.Average Time Spent Per New Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_new_users AS INT64))) as value from tbl_launch_resume_src

union all select '03.Average Time Per Old Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_old_users AS INT64))) as value from tbl_launch_resume_src
union all select '04.Time Spent Per Scan User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_scan_users AS INT64))) as value from tbl_users_src
union all select '05.Time Spent Per Scan New User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_scan_new_users AS INT64))) as value from tbl_users_src
union all select '06.Time Spent Per Scan Old User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_scan_old_users AS INT64))) as value from tbl_users_src
union all select '07.Time Spent Per Free User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_free_users AS INT64))) as value from tbl_users_src
union all select '08.Time Spent Per Free New User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_free_new_users AS INT64))) as value from tbl_users_src
union all select '09.Time Spent Per Free Old User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_free_old_users AS INT64))) as value from tbl_users_src
union all select '10.Average Time per Session' as kpi, FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_sessions AS INT64))) as value from tbl_launch_resume_src
union all select '11.Average Time per Session New Users' as kpi, FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_sessions_new_users AS INT64))) as value from tbl_launch_resume_src
union all select '12.Average Time per Session Old Users' as kpi, FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_sessions_old_users AS INT64))) as value from tbl_launch_resume_src
union all select '13.Time Spent Per Session of Scan Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_scan_users AS INT64))) as value from tbl_users_src
union all select '14.Time Spent Per Session of Scan New Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_scan_new_users AS INT64))) as value from tbl_users_src
union all select '15.Time Spent Per Session of Scan Old Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_scan_old_users AS INT64))) as value from tbl_users_src
union all select '16.Time Spent Per Session of Free Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_free_users AS INT64))) as value from tbl_users_src
union all select '17.Time Spent Per Session of Free New Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_free_new_users AS INT64))) as value from tbl_users_src
union all select '18.Time Spent Per Session of Free Old Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_free_old_users AS INT64))) as value from tbl_users_src
union all select '19.Average Session per User' as kpi, CAST(`Average Session per User` as STRING) as value from tbl_launch_resume_src
union all select '20.Average Session per New User' as kpi, CAST(`Average Session per New User` as STRING) as value from tbl_launch_resume_src
union all select '21.Average Session per Old User' as kpi, CAST(`Average Session per Old User` as STRING) as value from tbl_launch_resume_src
order by kpi asc",103.9560546875
"WITH gb4228 as (select 0)
,user_type AS (
    SELECT 
        user_id, 
        COUNT(*) AS number_of_sessions, 
        'One and Done Users' AS UserType
    FROM 
        `gcp-bi-elephant-db-gold.applaydu.launch_resume` t 
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 1=1 
        
    GROUP BY 
        1
    HAVING 
        number_of_sessions = 1
),
main AS (
    SELECT 
        lr.*, 
        ut.UserType
    FROM 
        `gcp-bi-elephant-db-gold.applaydu.launch_resume` lr
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        ) USING (user_id)
    LEFT JOIN 
        user_type ut USING (user_id)
    WHERE 1=1 
        
    ORDER BY 
        lr.user_id
)
SELECT 
    SUM(CASE WHEN UserType = 'One and Done Users' THEN 1 ELSE 0 END) / COUNT(DISTINCT user_id) AS `One and Done`
FROM 
    main t
WHERE 
    CAST(time_spent AS FLOAT64) >= 0
    AND CAST(time_spent AS FLOAT64) < 86400
    AND (session_id = 1 OR CAST(time_between_sessions AS INT64) >= 30)
    AND DATE(client_time) >= '2020-08-10' 
    AND DATE(client_time) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )  
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )  
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )",70.8251953125
"with gb4237 as (select 0)
SELECT 
    SUM(CAST(time_spent AS INT64)) AS `Total time spent`,
    SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT64) >= 30) THEN 1 ELSE 0 END) AS `Total Session`,
    SUM(CAST(time_spent AS INT64)) / SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT64) >= 30) THEN 1 ELSE 0 END) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(CAST(time_spent AS INT64)) / SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT64) >= 30) THEN 1 ELSE 0 END) AS INT64))) AS `Average Time per Users`
FROM 
    `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    CAST(time_spent AS INT64) >= 0
    AND CAST(time_spent AS INT64) < 86400
    AND version >= (SELECT MIN(version) FROM `applaydu.tbl_version_filter` WHERE 1=1  ) 
    AND version <= (SELECT MAX(version) FROM `applaydu.tbl_version_filter` WHERE 1=1  )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ) 
    AND DATE(server_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
    AND (DATE(server_time) >= '2020-08-10' AND DATE(server_time) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY))",70.794921875
"with gb4259 as (select 0)
SELECT 
    SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) AS `Number of Sessions`,
    COUNT(DISTINCT user_id) AS Total_Users,
    SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) / COUNT(DISTINCT user_id) AS `Average Session per User`
FROM 
    `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    CAST(time_spent AS FLOAT64) >= 0
    AND CAST(time_spent AS FLOAT64) < 86400
    AND (DATE(server_time) >= '2020-08-10' AND DATE(server_time) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY))
    AND version >= (SELECT MIN(version) FROM `applaydu.tbl_version_filter` WHERE 1=1  ) 
    AND version <= (SELECT MAX(version) FROM `applaydu.tbl_version_filter` WHERE 1=1  )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ) 
    AND DATE(server_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )",70.794921875
"with gb4248 as (select 0)
SELECT 
    SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) AS `Number of Sessions`,
    COUNT(DISTINCT user_id) AS Total_Users,
    SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) / COUNT(DISTINCT user_id) AS `Average Session per User`
FROM 
    `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    CAST(time_spent AS FLOAT64) >= 0
    AND CAST(time_spent AS FLOAT64) < 86400
    AND (DATE(server_time) >= '2020-08-10' AND DATE(server_time) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY))
    AND version >= (SELECT MIN(version) FROM `applaydu.tbl_version_filter` WHERE 1=1  ) 
    AND version <= (SELECT MAX(version) FROM `applaydu.tbl_version_filter` WHERE 1=1  )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ) 
    AND DATE(server_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )",70.794921875
"with gb4259 as (select 0)
SELECT 
    SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) AS `Number of Sessions`,
    COUNT(DISTINCT user_id) AS Total_Users,
    SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) / COUNT(DISTINCT user_id) AS `Average Session per User`
FROM 
    `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    CAST(time_spent AS FLOAT64) >= 0
    AND CAST(time_spent AS FLOAT64) < 86400
    AND (DATE(server_time) >= '2020-08-10' AND DATE(server_time) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY))
    AND version >= (SELECT MIN(version) FROM `applaydu.tbl_version_filter` WHERE 1=1  ) 
    AND version <= (SELECT MAX(version) FROM `applaydu.tbl_version_filter` WHERE 1=1  )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ) 
    AND DATE(server_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )",70.7529296875
"WITH gb4242 as (SELECT 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (
        `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`.unlock_cause IN ('QR Code', 'Toy Scan', 'Deep_Link')
        AND `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`.isnewtoy = 1
    )
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date')
    GROUP BY user_id
    HAVING `Number of Toys Unlocked` > 0
)

,
launch_raw AS (
    SELECT user_id, DATE(client_time)AS login_Day, 
           MIN(DATE(client_time)) OVER (PARTITION BY user_id) AS `First Day`, 
           version
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
        AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    ) USING (user_id)
    JOIN unlock USING (user_id)
    WHERE `gcp-bi-elephant-db-gold.applaydu.launch_resume`.country IN ('IN', 'BR', 'RU', 'US', 'IT', 'MX')
    AND game_id IN (81337, 81335)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    GROUP BY user_id, login_Day, version,client_time
),
launch_with_version AS (
    SELECT user_id, login_Day, `First Day`, 
           DATE_DIFF(login_Day, `First Day`, DAY) AS Day_number
    FROM launch_raw
    WHERE `First Day` >= '2022-06-01' 
    AND `First Day` < DATE_SUB(CURRENT_DATE(), INTERVAL 10 DAY)
    AND `First Day` >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND `First Day` < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND `First Day` >= DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 30 MONTH)
    ORDER BY user_id, Day_number
)
,
retention AS (
    SELECT DATE_TRUNC(`First Day`, MONTH) AS Month,
           FORMAT_DATE('%A', `First Day`) AS `Weekday`, `First Day`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS `No of New user Acquired`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS Day_0,
           SUM(CASE WHEN Day_number = 1 THEN 1 ELSE 0 END) AS Day_1,
           SUM(CASE WHEN Day_number = 2 THEN 1 ELSE 0 END) AS Day_3,
           SUM(CASE WHEN Day_number = 3 THEN 1 ELSE 0 END) AS Day_7,
           SUM(CASE WHEN Day_number = 4 THEN 1 ELSE 0 END) AS Day_14,
           SUM(CASE WHEN Day_number = 5 THEN 1 ELSE 0 END) AS Day_28,
           SUM(CASE WHEN Day_number = 6 THEN 1 ELSE 0 END) AS Day_30
    FROM launch_with_version
    GROUP BY `First Day`
    HAVING `Weekday` IN ('Friday', 'Saturday')
    ORDER BY `First Day`
)

SELECT 'All' AS Platform, Month,
       CONCAT(ROUND(SUM(Day_1)/SUM(Day_0)*100, 2), '%') AS `Retention D1`,
       CONCAT(ROUND(SUM(Day_3)/SUM(Day_0)*100, 2), '%') AS `Retention D3`,
       CONCAT(ROUND(SUM(Day_7)/SUM(Day_0)*100, 2), '%') AS `Retention D7`,
       CONCAT(ROUND(SUM(Day_14)/SUM(Day_0)*100, 2), '%') AS `Retention D14`,
       CONCAT(ROUND(SUM(Day_28)/SUM(Day_0)*100, 2), '%') AS `Retention D28`,
       CONCAT(ROUND(SUM(Day_30)/SUM(Day_0)*100, 2), '%') AS `Retention D30`,
       CONCAT(ROUND(SUM(Day_7)/SUM(Day_1)*100, 2), '%') AS `D7 per D1`
FROM retention
GROUP BY Month
ORDER BY Month ASC",62.16796875
"WITH tbl_illustration_book_finished AS (
    SELECT COUNT(*) AS Events,
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.illustration_book_finished`
    WHERE story_title LIKE 'Experience - Lets Story%'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_pp_access AS (
    SELECT SUM(ACTIVITY_01_VALUE) AS Events
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
    WHERE activity_01 = 'Experience - Lets Story - Parent Prompt Clicked'
        AND scene_name = 'Eduland Lets Story'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    SAFE_DIVIDE((SELECT Events FROM tbl_pp_access), (SELECT Events FROM tbl_illustration_book_finished)) AS `PP access per book`,
    SAFE_DIVIDE((SELECT Events FROM tbl_pp_access), (SELECT users FROM tbl_illustration_book_finished)) AS `PP access per user`;",59.748046875
"WITH tbl_illustration_book_finished AS (
    SELECT COUNT(*) AS Events,
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.illustration_book_finished`
    WHERE story_title LIKE 'Experience - Lets Story%'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_pp_access AS (
    SELECT SUM(ACTIVITY_01_VALUE) AS Events
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
    WHERE activity_01 = 'Experience - Lets Story - Parent Prompt Clicked'
        AND scene_name = 'Eduland Lets Story'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    SAFE_DIVIDE((SELECT Events FROM tbl_pp_access), (SELECT Events FROM tbl_illustration_book_finished)) AS `PP access per book`,
    SAFE_DIVIDE((SELECT Events FROM tbl_pp_access), (SELECT users FROM tbl_illustration_book_finished)) AS `PP access per user`;",59.748046875
"WITH tbl_illustration_book_finished AS (
    SELECT COUNT(*) AS Events,
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.illustration_book_finished`
    WHERE story_title LIKE 'Experience - Lets Story%'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_pp_access AS (
    SELECT SUM(ACTIVITY_01_VALUE) AS Events
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
    WHERE activity_01 = 'Experience - Lets Story - Parent Prompt Clicked'
        AND scene_name = 'Eduland Lets Story'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    SAFE_DIVIDE((SELECT Events FROM tbl_pp_access), (SELECT Events FROM tbl_illustration_book_finished)) AS `PP access per book`,
    SAFE_DIVIDE((SELECT Events FROM tbl_pp_access), (SELECT users FROM tbl_illustration_book_finished)) AS `PP access per user`;",59.748046875
"with gb4249 as (select 0)
SELECT 
    EXTRACT(MONTH FROM client_time) AS `Month`,
    EXTRACT(YEAR FROM client_time) AS `Year`,
    CONCAT(EXTRACT(YEAR FROM client_time), ' ', FORMAT_TIMESTAMP('%B', client_time)) AS `Time`,
    COUNT(DISTINCT user_id) AS `Monthly Active Users`
FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
JOIN (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
    WHERE 1=1 
    AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
) USING (user_id)
JOIN `applaydu.tbl_shop_filter` using (game_id ,country) 
WHERE 1=1
    AND NOT (t.game_id = 82471 AND client_time < '2020-12-14')
    AND (client_time >= '2020-08-10' AND client_time < TIMESTAMP(DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)))
    AND CAST(time_spent AS FLOAT64) >= 0
    AND CAST(time_spent AS FLOAT64) < 86400
    AND client_time >= TIMESTAMP((SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ))
    AND client_time < TIMESTAMP(DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY))
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )
    
GROUP BY all
ORDER BY `Year` ASC, `Month` ASC",58.5546875
"WITH gb4245 as (select 0)
,kdr_scan_users AS (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.scan_mode_finished`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_kinderini_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND scan_result IN ('New_Toy', 'Old_Toy')
        AND (
            (scan_type = 'Deep Link' AND UPPER(reference) LIKE '%KINDERINI%')
            OR scan_type IN ('Scan_Toy_Biscuit', 'Scan_QR_Biscuit')
        )
),
filter_sst AS (
    SELECT * 
    FROM `gcp-bi-elephant-db-gold.applaydu.story_step_finished`
    JOIN kdr_scan_users USING (user_id)
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_kinderini_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND environment_id = 'Kinderini'
),
tap_emotion_user AS (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.story_mode_triggered`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_kinderini_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND environment_id = 'Kinderini'
        AND click_from IN (
            'Eduland Kinderini Menu - Cluster - Wonder',
            'Eduland Kinderini Menu - Cluster - Happiness',
            'Eduland Kinderini Menu - Cluster - Kindness',
            'Eduland Kinderini Menu - Cluster - Fearfulness'
        )
        AND user_id IN (SELECT DISTINCT user_id FROM kdr_scan_users)
),
result AS (
    SELECT 
        'Kinderini Scan Users' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM kdr_scan_users
    UNION ALL 
    SELECT 
        'Tap Emotion Cluster' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM tap_emotion_user
    UNION ALL
    SELECT 
        'Drawing Start' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Drawing MIG' AND user_selection = 'Started'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Drawing Stop' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Drawing MIG' AND user_selection = 'Finished'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Finding Start' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Finding MIG' AND user_selection = 'Started'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Finding Stop' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Finding MIG' AND user_selection = 'Finished'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Catching Start' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Catching MIG' AND user_selection = 'Started'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Catching Stop' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Catching MIG' AND user_selection = 'Finished'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Diary Start' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Dairy Screen' AND user_selection = 'Started'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Diary Stop' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Dairy Screen' AND user_selection = 'Finished'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
)
SELECT * FROM result",57.712890625
"WITH gb4242 as (SELECT 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (
        `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`.unlock_cause IN ('QR Code', 'Toy Scan', 'Deep_Link')
        AND `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`.isnewtoy = 1
    )
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date')
    GROUP BY user_id
    HAVING `Number of Toys Unlocked` > 0
)

,
launch_raw AS (
    SELECT user_id, DATE(client_time)AS login_Day, 
           MIN(DATE(client_time)) OVER (PARTITION BY user_id) AS `First Day`, 
           version
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
        AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
    JOIN unlock USING (user_id)
    WHERE `gcp-bi-elephant-db-gold.applaydu.launch_resume`.country IN ('IN', 'BR', 'RU', 'US', 'IT', 'MX')
    AND game_id IN (81337, 81335)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    GROUP BY user_id, login_Day, version,client_time
),
launch_with_version AS (
    SELECT user_id, login_Day, `First Day`, 
           DATE_DIFF(login_Day, `First Day`, DAY) AS Day_number
    FROM launch_raw
    WHERE `First Day` >= '2022-06-01' 
    AND `First Day` < DATE_SUB(CURRENT_DATE(), INTERVAL 10 DAY)
    AND `First Day` >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND `First Day` < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND `First Day` >= DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 30 MONTH)
    ORDER BY user_id, Day_number
)
,
retention AS (
    SELECT DATE_TRUNC(`First Day`, MONTH) AS Month,
           FORMAT_DATE('%A', `First Day`) AS `Weekday`, `First Day`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS `No of New user Acquired`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS Day_0,
           SUM(CASE WHEN Day_number = 1 THEN 1 ELSE 0 END) AS Day_1,
           SUM(CASE WHEN Day_number = 2 THEN 1 ELSE 0 END) AS Day_3,
           SUM(CASE WHEN Day_number = 3 THEN 1 ELSE 0 END) AS Day_7,
           SUM(CASE WHEN Day_number = 4 THEN 1 ELSE 0 END) AS Day_14,
           SUM(CASE WHEN Day_number = 5 THEN 1 ELSE 0 END) AS Day_28,
           SUM(CASE WHEN Day_number = 6 THEN 1 ELSE 0 END) AS Day_30
    FROM launch_with_version
    GROUP BY `First Day`
    HAVING `Weekday` IN ('Friday', 'Saturday')
    ORDER BY `First Day`
)

SELECT 'All' AS Platform, Month,
       CONCAT(ROUND(SUM(Day_1)/SUM(Day_0)*100, 2), '%') AS `Retention D1`,
       CONCAT(ROUND(SUM(Day_3)/SUM(Day_0)*100, 2), '%') AS `Retention D3`,
       CONCAT(ROUND(SUM(Day_7)/SUM(Day_0)*100, 2), '%') AS `Retention D7`,
       CONCAT(ROUND(SUM(Day_14)/SUM(Day_0)*100, 2), '%') AS `Retention D14`,
       CONCAT(ROUND(SUM(Day_28)/SUM(Day_0)*100, 2), '%') AS `Retention D28`,
       CONCAT(ROUND(SUM(Day_30)/SUM(Day_0)*100, 2), '%') AS `Retention D30`,
       CONCAT(ROUND(SUM(Day_7)/SUM(Day_1)*100, 2), '%') AS `D7 per D1`
FROM retention
GROUP BY Month
ORDER BY Month ASC",55.783203125
"WITH gb4242 as (SELECT 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (
        `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`.unlock_cause IN ('QR Code', 'Toy Scan', 'Deep_Link')
        AND `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`.isnewtoy = 1
    )
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date')
    GROUP BY user_id
    HAVING `Number of Toys Unlocked` > 0
)

,
launch_raw AS (
    SELECT user_id, DATE(client_time)AS login_Day, 
           MIN(DATE(client_time)) OVER (PARTITION BY user_id) AS `First Day`, 
           version
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
        AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
    JOIN unlock USING (user_id)
    WHERE `gcp-bi-elephant-db-gold.applaydu.launch_resume`.country IN ('IN', 'BR', 'RU', 'US', 'IT', 'MX')
    AND game_id IN (81337, 81335)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    GROUP BY user_id, login_Day, version,client_time
),
launch_with_version AS (
    SELECT user_id, login_Day, `First Day`, 
           DATE_DIFF(login_Day, `First Day`, DAY) AS Day_number
    FROM launch_raw
    WHERE `First Day` >= '2022-06-01' 
    AND `First Day` < DATE_SUB(CURRENT_DATE(), INTERVAL 10 DAY)
    AND `First Day` >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND `First Day` < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND `First Day` >= DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 30 MONTH)
    ORDER BY user_id, Day_number
)
,
retention AS (
    SELECT DATE_TRUNC(`First Day`, MONTH) AS Month,
           FORMAT_DATE('%A', `First Day`) AS `Weekday`, `First Day`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS `No of New user Acquired`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS Day_0,
           SUM(CASE WHEN Day_number = 1 THEN 1 ELSE 0 END) AS Day_1,
           SUM(CASE WHEN Day_number = 2 THEN 1 ELSE 0 END) AS Day_3,
           SUM(CASE WHEN Day_number = 3 THEN 1 ELSE 0 END) AS Day_7,
           SUM(CASE WHEN Day_number = 4 THEN 1 ELSE 0 END) AS Day_14,
           SUM(CASE WHEN Day_number = 5 THEN 1 ELSE 0 END) AS Day_28,
           SUM(CASE WHEN Day_number = 6 THEN 1 ELSE 0 END) AS Day_30
    FROM launch_with_version
    GROUP BY `First Day`
    HAVING `Weekday` IN ('Friday', 'Saturday')
    ORDER BY `First Day`
)

SELECT 'All' AS Platform, Month,
       CONCAT(ROUND(SUM(Day_1)/SUM(Day_0)*100, 2), '%') AS `Retention D1`,
       CONCAT(ROUND(SUM(Day_3)/SUM(Day_0)*100, 2), '%') AS `Retention D3`,
       CONCAT(ROUND(SUM(Day_7)/SUM(Day_0)*100, 2), '%') AS `Retention D7`,
       CONCAT(ROUND(SUM(Day_14)/SUM(Day_0)*100, 2), '%') AS `Retention D14`,
       CONCAT(ROUND(SUM(Day_28)/SUM(Day_0)*100, 2), '%') AS `Retention D28`,
       CONCAT(ROUND(SUM(Day_30)/SUM(Day_0)*100, 2), '%') AS `Retention D30`,
       CONCAT(ROUND(SUM(Day_7)/SUM(Day_1)*100, 2), '%') AS `D7 per D1`
FROM retention
GROUP BY Month
ORDER BY Month ASC",55.783203125
"WITH gb4242 as (SELECT 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (
        `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`.unlock_cause IN ('QR Code', 'Toy Scan', 'Deep_Link')
        AND `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`.isnewtoy = 1
    )
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date')
    GROUP BY user_id
    HAVING `Number of Toys Unlocked` > 0
)

,
launch_raw AS (
    SELECT user_id, DATE(client_time)AS login_Day, 
           MIN(DATE(client_time)) OVER (PARTITION BY user_id) AS `First Day`, 
           version
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
        AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
    JOIN unlock USING (user_id)
    WHERE `gcp-bi-elephant-db-gold.applaydu.launch_resume`.country IN ('IN', 'BR', 'RU', 'US', 'IT', 'MX')
    AND game_id IN (81337, 81335)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    GROUP BY user_id, login_Day, version,client_time
),
launch_with_version AS (
    SELECT user_id, login_Day, `First Day`, 
           DATE_DIFF(login_Day, `First Day`, DAY) AS Day_number
    FROM launch_raw
    WHERE `First Day` >= '2022-06-01' 
    AND `First Day` < DATE_SUB(CURRENT_DATE(), INTERVAL 10 DAY)
    AND `First Day` >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND `First Day` < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND `First Day` >= DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 30 MONTH)
    ORDER BY user_id, Day_number
)
,
retention AS (
    SELECT DATE_TRUNC(`First Day`, MONTH) AS Month,
           FORMAT_DATE('%A', `First Day`) AS `Weekday`, `First Day`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS `No of New user Acquired`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS Day_0,
           SUM(CASE WHEN Day_number = 1 THEN 1 ELSE 0 END) AS Day_1,
           SUM(CASE WHEN Day_number = 2 THEN 1 ELSE 0 END) AS Day_3,
           SUM(CASE WHEN Day_number = 3 THEN 1 ELSE 0 END) AS Day_7,
           SUM(CASE WHEN Day_number = 4 THEN 1 ELSE 0 END) AS Day_14,
           SUM(CASE WHEN Day_number = 5 THEN 1 ELSE 0 END) AS Day_28,
           SUM(CASE WHEN Day_number = 6 THEN 1 ELSE 0 END) AS Day_30
    FROM launch_with_version
    GROUP BY `First Day`
    HAVING `Weekday` IN ('Friday', 'Saturday')
    ORDER BY `First Day`
)

SELECT 'All' AS Platform, Month,
       CONCAT(ROUND(SUM(Day_1)/SUM(Day_0)*100, 2), '%') AS `Retention D1`,
       CONCAT(ROUND(SUM(Day_3)/SUM(Day_0)*100, 2), '%') AS `Retention D3`,
       CONCAT(ROUND(SUM(Day_7)/SUM(Day_0)*100, 2), '%') AS `Retention D7`,
       CONCAT(ROUND(SUM(Day_14)/SUM(Day_0)*100, 2), '%') AS `Retention D14`,
       CONCAT(ROUND(SUM(Day_28)/SUM(Day_0)*100, 2), '%') AS `Retention D28`,
       CONCAT(ROUND(SUM(Day_30)/SUM(Day_0)*100, 2), '%') AS `Retention D30`,
       CONCAT(ROUND(SUM(Day_7)/SUM(Day_1)*100, 2), '%') AS `D7 per D1`
FROM retention
GROUP BY Month
ORDER BY Month ASC",55.7548828125
"WITH gb4276 as (SELECT 0),
scan_profile AS (
    SELECT DISTINCT user_id 
    FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
    WHERE (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
),
t1 AS (
    SELECT
        user_id, 
        DATE_TRUNC(DATE(client_time), DAY) AS login_day,
        MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id) AS first_day,
        MIN(version) OVER (PARTITION BY user_id) AS first_version,
        MIN(session_id) OVER (PARTITION BY user_id) AS first_session,
        FORMAT_DATE('%A', MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id)) AS first_weekday,
        DATE_DIFF(DATE(client_time), MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id), DAY) AS subsequent_day
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
    JOIN scan_profile USING (user_id)
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
    ) USING (user_id)
    JOIN `applaydu.tbl_shop_filter` ON `applaydu.tbl_shop_filter`.game_id = t.game_id AND `applaydu.tbl_shop_filter`.country = t.country 
    WHERE 1=1
        AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
        
),
t2 AS (
    SELECT 
        DATE_TRUNC(first_day, MONTH) AS first_month,
        subsequent_day,
        COUNT(DISTINCT user_id) AS users
    FROM t1
    WHERE 1=1
        AND first_day >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND first_day < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND first_version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 AND (`applaydu.tbl_version_filter`.`version` = ?))
        AND first_day >= '2023-12-01' 
        AND first_day < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND first_weekday IN ('Friday', 'Saturday')
    GROUP BY first_month, subsequent_day
)
SELECT 
    first_month AS month,
    SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D0,
    SUM(CASE WHEN subsequent_day = 1 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D1,
    SUM(CASE WHEN subsequent_day = 3 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D3,
    SUM(CASE WHEN subsequent_day = 7 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D7,
    SUM(CASE WHEN subsequent_day = 28 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D28
FROM t2
GROUP BY first_month
ORDER BY first_month",54.33984375
"WITH gb4276 as (SELECT 0),
scan_profile AS (
    SELECT DISTINCT user_id 
    FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
    WHERE (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
),
t1 AS (
    SELECT
        user_id, 
        DATE_TRUNC(DATE(client_time), DAY) AS login_day,
        MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id) AS first_day,
        MIN(version) OVER (PARTITION BY user_id) AS first_version,
        MIN(session_id) OVER (PARTITION BY user_id) AS first_session,
        FORMAT_DATE('%A', MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id)) AS first_weekday,
        DATE_DIFF(DATE(client_time), MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id), DAY) AS subsequent_day
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
    JOIN scan_profile USING (user_id)
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
    ) USING (user_id)
    JOIN `applaydu.tbl_shop_filter` ON `applaydu.tbl_shop_filter`.game_id = t.game_id AND `applaydu.tbl_shop_filter`.country = t.country 
    WHERE 1=1
        AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        
),
t2 AS (
    SELECT 
        DATE_TRUNC(first_day, MONTH) AS first_month,
        subsequent_day,
        COUNT(DISTINCT user_id) AS users
    FROM t1
    WHERE 1=1
        AND first_day >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND first_day < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND first_version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND first_day >= '2023-12-01' 
        AND first_day < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND first_weekday IN ('Friday', 'Saturday')
    GROUP BY first_month, subsequent_day
)
SELECT 
    first_month AS month,
    SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D0,
    SUM(CASE WHEN subsequent_day = 1 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D1,
    SUM(CASE WHEN subsequent_day = 3 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D3,
    SUM(CASE WHEN subsequent_day = 7 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D7,
    SUM(CASE WHEN subsequent_day = 28 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D28
FROM t2
GROUP BY first_month
ORDER BY first_month",54.3349609375
"WITH gb4276 as (SELECT 0),
scan_profile AS (
    SELECT DISTINCT user_id 
    FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
    WHERE (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
),
t1 AS (
    SELECT
        user_id, 
        DATE_TRUNC(DATE(client_time), DAY) AS login_day,
        MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id) AS first_day,
        MIN(version) OVER (PARTITION BY user_id) AS first_version,
        MIN(session_id) OVER (PARTITION BY user_id) AS first_session,
        FORMAT_DATE('%A', MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id)) AS first_weekday,
        DATE_DIFF(DATE(client_time), MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id), DAY) AS subsequent_day
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
    JOIN scan_profile USING (user_id)
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
    ) USING (user_id)
    JOIN `applaydu.tbl_shop_filter` ON `applaydu.tbl_shop_filter`.game_id = t.game_id AND `applaydu.tbl_shop_filter`.country = t.country 
    WHERE 1=1
        AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        
),
t2 AS (
    SELECT 
        DATE_TRUNC(first_day, MONTH) AS first_month,
        subsequent_day,
        COUNT(DISTINCT user_id) AS users
    FROM t1
    WHERE 1=1
        AND first_day >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND first_day < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND first_version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND first_day >= '2023-12-01' 
        AND first_day < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND first_weekday IN ('Friday', 'Saturday')
    GROUP BY first_month, subsequent_day
)
SELECT 
    first_month AS month,
    SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D0,
    SUM(CASE WHEN subsequent_day = 1 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D1,
    SUM(CASE WHEN subsequent_day = 3 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D3,
    SUM(CASE WHEN subsequent_day = 7 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D7,
    SUM(CASE WHEN subsequent_day = 28 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D28
FROM t2
GROUP BY first_month
ORDER BY first_month",54.3349609375
"WITH gb4276 as (SELECT 0),
scan_profile AS (
    SELECT DISTINCT user_id 
    FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
    WHERE (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
),
t1 AS (
    SELECT
        user_id, 
        DATE_TRUNC(DATE(client_time), DAY) AS login_day,
        MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id) AS first_day,
        MIN(version) OVER (PARTITION BY user_id) AS first_version,
        MIN(session_id) OVER (PARTITION BY user_id) AS first_session,
        FORMAT_DATE('%A', MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id)) AS first_weekday,
        DATE_DIFF(DATE(client_time), MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id), DAY) AS subsequent_day
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
    JOIN scan_profile USING (user_id)
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
    ) USING (user_id)
    JOIN `applaydu.tbl_shop_filter` ON `applaydu.tbl_shop_filter`.game_id = t.game_id AND `applaydu.tbl_shop_filter`.country = t.country 
    WHERE 1=1
        AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        
),
t2 AS (
    SELECT 
        DATE_TRUNC(first_day, MONTH) AS first_month,
        subsequent_day,
        COUNT(DISTINCT user_id) AS users
    FROM t1
    WHERE 1=1
        AND first_day >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND first_day < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND first_version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND first_day >= '2023-12-01' 
        AND first_day < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND first_weekday IN ('Friday', 'Saturday')
    GROUP BY first_month, subsequent_day
)
SELECT 
    first_month AS month,
    SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D0,
    SUM(CASE WHEN subsequent_day = 1 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D1,
    SUM(CASE WHEN subsequent_day = 3 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D3,
    SUM(CASE WHEN subsequent_day = 7 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D7,
    SUM(CASE WHEN subsequent_day = 28 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D28
FROM t2
GROUP BY first_month
ORDER BY first_month",54.3349609375
"WITH gb4276 as (SELECT 0),
scan_profile AS (
    SELECT DISTINCT user_id 
    FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
    WHERE (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
),
t1 AS (
    SELECT
        user_id, 
        DATE_TRUNC(DATE(client_time), DAY) AS login_day,
        MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id) AS first_day,
        MIN(version) OVER (PARTITION BY user_id) AS first_version,
        MIN(session_id) OVER (PARTITION BY user_id) AS first_session,
        FORMAT_DATE('%A', MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id)) AS first_weekday,
        DATE_DIFF(DATE(client_time), MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id), DAY) AS subsequent_day
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
    JOIN scan_profile USING (user_id)
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
    ) USING (user_id)
    JOIN `applaydu.tbl_shop_filter` ON `applaydu.tbl_shop_filter`.game_id = t.game_id AND `applaydu.tbl_shop_filter`.country = t.country 
    WHERE 1=1
        AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
        
),
t2 AS (
    SELECT 
        DATE_TRUNC(first_day, MONTH) AS first_month,
        subsequent_day,
        COUNT(DISTINCT user_id) AS users
    FROM t1
    WHERE 1=1
        AND first_day >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND first_day < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND first_version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 AND (`applaydu.tbl_version_filter`.`version` = ?))
        AND first_day >= '2023-12-01' 
        AND first_day < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND first_weekday IN ('Friday', 'Saturday')
    GROUP BY first_month, subsequent_day
)
SELECT 
    first_month AS month,
    SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D0,
    SUM(CASE WHEN subsequent_day = 1 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D1,
    SUM(CASE WHEN subsequent_day = 3 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D3,
    SUM(CASE WHEN subsequent_day = 7 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D7,
    SUM(CASE WHEN subsequent_day = 28 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D28
FROM t2
GROUP BY first_month
ORDER BY first_month",54.333984375
"WITH gb4276 as (SELECT 0),
scan_profile AS (
    SELECT DISTINCT user_id 
    FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
    WHERE (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
),
t1 AS (
    SELECT
        user_id, 
        DATE_TRUNC(DATE(client_time), DAY) AS login_day,
        MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id) AS first_day,
        MIN(version) OVER (PARTITION BY user_id) AS first_version,
        MIN(session_id) OVER (PARTITION BY user_id) AS first_session,
        FORMAT_DATE('%A', MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id)) AS first_weekday,
        DATE_DIFF(DATE(client_time), MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id), DAY) AS subsequent_day
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
    JOIN scan_profile USING (user_id)
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
    ) USING (user_id)
    JOIN `applaydu.tbl_shop_filter` ON `applaydu.tbl_shop_filter`.game_id = t.game_id AND `applaydu.tbl_shop_filter`.country = t.country 
    WHERE 1=1
        AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        
),
t2 AS (
    SELECT 
        DATE_TRUNC(first_day, MONTH) AS first_month,
        subsequent_day,
        COUNT(DISTINCT user_id) AS users
    FROM t1
    WHERE 1=1
        AND first_day >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND first_day < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND first_version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND first_day >= '2023-12-01' 
        AND first_day < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND first_weekday IN ('Friday', 'Saturday')
    GROUP BY first_month, subsequent_day
)
SELECT 
    first_month AS month,
    SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D0,
    SUM(CASE WHEN subsequent_day = 1 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D1,
    SUM(CASE WHEN subsequent_day = 3 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D3,
    SUM(CASE WHEN subsequent_day = 7 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D7,
    SUM(CASE WHEN subsequent_day = 28 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D28
FROM t2
GROUP BY first_month
ORDER BY first_month",54.333984375
"with user_behavior_AB_test_playhub as (select 20250206),
-- ===== User's 1st version (only users active in test period)
tbl_users_type AS (
 SELECT 
  user_id,
  CASE 
    WHEN current_ver = '5.5.5' AND first_ver = '5.5.5' THEN 'Playhub - New'
    WHEN current_ver = '5.5.5' AND first_ver < '5.5.5' THEN 'Playhub - Upgrade'
    WHEN current_ver = '5.5.0' AND first_ver = '5.5.0' THEN 'Classic - New'
    WHEN current_ver = '5.5.0' AND first_ver < '5.5.0' THEN 'Classic - Upgrade'
    WHEN current_ver < '5.5.0' THEN 'Classic - Old ver'
  END AS label,
  CASE 
    WHEN current_ver = '5.5.5' THEN 'Playhub'
    WHEN current_ver = '5.5.0' THEN 'Classic'
    WHEN current_ver < '5.5.0' THEN 'Classic - Old ver'
  END AS label2
  from (select user_id,MIN(first_install_version) AS first_ver,MAX(version) AS current_ver
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity`
        WHERE active_date >= '2025-01-24' AND active_date < DATE_ADD('2025-02-05', INTERVAL 1 DAY)
        GROUP BY user_id
        )
)
-- Total user
,tbl_ls AS (
SELECT *
FROM `gcp-bi-elephant-db-gold.applaydu.LAUNCH_RESUME` t
WHERE 
  CAST(time_spent AS FLOAT64) >= 0 AND CAST(time_spent AS FLOAT64) < 86400
  AND game_id = 81337
  AND server_time >= '2025-01-24' AND Date(server_time) < DATE_ADD('2025-02-05', INTERVAL 1 DAY)
  AND client_time >= '2025-01-24' AND Date(client_time) < DATE_ADD('2025-02-05', INTERVAL 1 DAY)
  AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter`)
  AND version < '9.0.0'
)
,finish_ftue as (
select distinct 'Playhub' as type,user_id as ftue_user,client_time
from `gcp-bi-elephant-db-gold.applaydu.ftue_event` 
WHERE 
  game_id = 81337
  --AND server_time >= '2025-01-24' AND Date(server_time) < DATE_ADD('2025-02-05', INTERVAL 1 DAY)
  --AND client_time >= '2025-01-24' AND Date(client_time) < DATE_ADD('2025-02-05', INTERVAL 1 DAY)
  AND country IN (SELECT country FROM `applaydu.tbl_country_filter`)
  AND version < '9.0.0'
  and ftue_steps = 'FTUE Play Hub - End of FTUE'
union all
select distinct 'Classic' as type,user_id,client_time
from `gcp-bi-elephant-db-gold.applaydu.ftue_event` 
WHERE 
  game_id = 81337
  --AND server_time >= '2025-01-24' AND Date(server_time) < DATE_ADD('2025-02-05', INTERVAL 1 DAY)
  --AND client_time >= '2025-01-24' AND Date(client_time) < DATE_ADD('2025-02-05', INTERVAL 1 DAY)
  AND country IN (SELECT country FROM `applaydu.tbl_country_filter`)
  AND version < '9.0.0'
  and ftue_steps = 'World Map final'
)
,bounce as (
select type,a.user_id
from tbl_ls a
join finish_ftue b on a.user_id = b.ftue_user and a.client_time >= b.client_time 
)

select
  label,
  1 - (COUNT(DISTINCT user_id) / NULLIF((SELECT COUNT(DISTINCT ftue_user) FROM finish_ftue WHERE type = 'Playhub'), 0)) AS bounce_ph,
  1 - (COUNT(DISTINCT user_id) / NULLIF((SELECT COUNT(DISTINCT ftue_user) FROM finish_ftue WHERE type = 'Classic'), 0)) AS bounce_cl
FROM bounce
JOIN tbl_users_type USING(user_id)
group by label
union all
select
  label2,
  1 - (COUNT(DISTINCT user_id) / NULLIF((SELECT COUNT(DISTINCT ftue_user) FROM finish_ftue WHERE type = 'Playhub'), 0)) AS bounce_ph,
  1 - (COUNT(DISTINCT user_id) / NULLIF((SELECT COUNT(DISTINCT ftue_user) FROM finish_ftue WHERE type = 'Classic'), 0)) AS bounce_cl
FROM bounce
JOIN tbl_users_type USING(user_id)
group by label2",51.65625
"with gb4240 as (select 0)
SELECT 
    SUM(CAST(time_spent AS INT64)) AS `Total time spent`,
    COUNT(DISTINCT user_id) AS `Total Users`,
    SUM(CAST(time_spent AS INT64)) / COUNT(DISTINCT user_id) AS time_result,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(CAST(time_spent AS INT64)) / COUNT(DISTINCT user_id) AS INT64))) AS `Average Time per Users`
FROM 
    `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    CAST(time_spent AS INT64) >= 0
    AND CAST(time_spent AS INT64) < 86400
    AND version >= (SELECT MIN(version) FROM `applaydu.tbl_version_filter` WHERE 1=1  ) 
    AND version <= (SELECT MAX(version) FROM `applaydu.tbl_version_filter` WHERE 1=1  )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ) 
    AND DATE(server_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
     
    AND (DATE(server_time) >= '2020-08-10' AND DATE(server_time) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY))",50.619140625
"SELECT 
    Month,
    SUM(Day_1) / SUM(Day_0) AS `Retention D1`,
    SUM(Day_7) / SUM(Day_0) AS `Retention D7`,
    SUM(Day_28) / SUM(Day_0) AS `Retention D28`
FROM (
    SELECT DATE_TRUNC(with_Day_number.`First Day`, MONTH) AS Month,
           FORMAT_TIMESTAMP('%A', with_Day_number.`First Day`) AS `Weekday`,
           `First Day`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS `No. of New user Acquired`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS Day_0,
           SUM(CASE WHEN Day_number = 1 THEN 1 ELSE 0 END) AS Day_1,
           SUM(CASE WHEN Day_number = 7 THEN 1 ELSE 0 END) AS Day_7,
           SUM(CASE WHEN Day_number = 28 THEN 1 ELSE 0 END) AS Day_28
    FROM (
        SELECT
            a.user_id,
            a.login_Day,
            b.first_day AS `First Day`,
            b.first_version AS first_version,
            b.first_country AS first_country,
            DATE_DIFF(a.login_Day, b.first_day, DAY) AS Day_number
        FROM (
            SELECT
                user_id,
                DATE_TRUNC(DATE(CLIENT_TIME), DAY) AS login_Day
            FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
            JOIN (
                SELECT DISTINCT user_id 
                FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
                WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            ) USING (user_id)
            JOIN `applaydu.tbl_shop_filter` using (game_id,country )
            GROUP BY user_id, DATE_TRUNC(DATE(CLIENT_TIME), DAY)
        ) a,
        (
            SELECT
                user_id,
                MIN(DATE_TRUNC(DATE(CLIENT_TIME), DAY)) AS first_day,
                MIN(version) AS first_version,
                MIN(t.country) AS first_country
            FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
            JOIN (
                SELECT DISTINCT user_id 
                FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
                WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            ) USING (user_id)
            JOIN `applaydu.tbl_shop_filter` using (game_id,country )
            GROUP BY user_id
        ) b
        WHERE a.user_id = b.user_id
    ) AS with_Day_number
    WHERE FORMAT_TIMESTAMP('%A', with_Day_number.`First Day`) IN ('Friday', 'Saturday')
    AND date(with_Day_number.`First Day`) >= (DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 2 YEAR))
    AND date(with_Day_number.`First Day`) < (DATE_TRUNC(CURRENT_DATE(), MONTH))
    AND date(with_Day_number.`First Day`) >= ((SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?))
    AND date(with_Day_number.`First Day`) < (DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY))
    AND first_country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
    AND first_version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  AND (`applaydu.tbl_version_filter`.`version` = ?))
    
    GROUP BY `First Day`
    ORDER BY `First Day`
)
GROUP BY Month
ORDER BY Month",48.55859375
"WITH gb4252 as (SELECT 0),
t1 AS (
    SELECT
        user_id, 
        DATE_TRUNC(DATE(client_time), DAY) AS login_day,
        MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id) AS first_day,
        MIN(version) OVER (PARTITION BY user_id) AS first_version,
        MIN(session_id) OVER (PARTITION BY user_id) AS first_session,
        FORMAT_DATE('%A', MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id)) AS first_weekday,
        DATE_DIFF(DATE(client_time), MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id), DAY) AS subsequent_day
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
    ) USING (user_id)
    JOIN `applaydu.tbl_shop_filter` ON `applaydu.tbl_shop_filter`.game_id = t.game_id AND `applaydu.tbl_shop_filter`.country = t.country 
    WHERE 1=1
        AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
        
),
t2 AS (
    SELECT 
        DATE_TRUNC(first_day, MONTH) AS first_month,
        subsequent_day,
        COUNT(DISTINCT user_id) AS users
    FROM t1
    WHERE 1=1
        AND first_day >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND first_day < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND first_version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 AND (`applaydu.tbl_version_filter`.`version` = ?))
        AND first_day >= '2023-12-01' 
        AND first_day < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND first_weekday IN ('Friday', 'Saturday')
    GROUP BY first_month, subsequent_day
)
SELECT 
    first_month AS month,
    SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D0,
    SUM(CASE WHEN subsequent_day = 1 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D1,
    SUM(CASE WHEN subsequent_day = 3 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D3,
    SUM(CASE WHEN subsequent_day = 7 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D7,
    SUM(CASE WHEN subsequent_day = 28 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D28
FROM t2
GROUP BY first_month
ORDER BY first_month",48.55859375
"WITH gb4252 as (SELECT 0),
t1 AS (
    SELECT
        user_id, 
        DATE_TRUNC(DATE(client_time), DAY) AS login_day,
        MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id) AS first_day,
        MIN(version) OVER (PARTITION BY user_id) AS first_version,
        MIN(session_id) OVER (PARTITION BY user_id) AS first_session,
        FORMAT_DATE('%A', MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id)) AS first_weekday,
        DATE_DIFF(DATE(client_time), MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id), DAY) AS subsequent_day
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
    ) USING (user_id)
    JOIN `applaydu.tbl_shop_filter` ON `applaydu.tbl_shop_filter`.game_id = t.game_id AND `applaydu.tbl_shop_filter`.country = t.country 
    WHERE 1=1
        AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        
),
t2 AS (
    SELECT 
        DATE_TRUNC(first_day, MONTH) AS first_month,
        subsequent_day,
        COUNT(DISTINCT user_id) AS users
    FROM t1
    WHERE 1=1
        AND first_day >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND first_day < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND first_version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND first_day >= '2023-12-01' 
        AND first_day < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND first_weekday IN ('Friday', 'Saturday')
    GROUP BY first_month, subsequent_day
)
SELECT 
    first_month AS month,
    SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D0,
    SUM(CASE WHEN subsequent_day = 1 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D1,
    SUM(CASE WHEN subsequent_day = 3 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D3,
    SUM(CASE WHEN subsequent_day = 7 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D7,
    SUM(CASE WHEN subsequent_day = 28 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D28
FROM t2
GROUP BY first_month
ORDER BY first_month",48.5537109375
"SELECT 
    Month,
    SUM(Day_1) / SUM(Day_0) AS `Retention D1`,
    SUM(Day_7) / SUM(Day_0) AS `Retention D7`,
    SUM(Day_28) / SUM(Day_0) AS `Retention D28`
FROM (
    SELECT DATE_TRUNC(with_Day_number.`First Day`, MONTH) AS Month,
           FORMAT_TIMESTAMP('%A', with_Day_number.`First Day`) AS `Weekday`,
           `First Day`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS `No. of New user Acquired`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS Day_0,
           SUM(CASE WHEN Day_number = 1 THEN 1 ELSE 0 END) AS Day_1,
           SUM(CASE WHEN Day_number = 7 THEN 1 ELSE 0 END) AS Day_7,
           SUM(CASE WHEN Day_number = 28 THEN 1 ELSE 0 END) AS Day_28
    FROM (
        SELECT
            a.user_id,
            a.login_Day,
            b.first_day AS `First Day`,
            b.first_version AS first_version,
            b.first_country AS first_country,
            DATE_DIFF(a.login_Day, b.first_day, DAY) AS Day_number
        FROM (
            SELECT
                user_id,
                DATE_TRUNC(DATE(CLIENT_TIME), DAY) AS login_Day
            FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
            JOIN (
                SELECT DISTINCT user_id 
                FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
                WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            ) USING (user_id)
            JOIN `applaydu.tbl_shop_filter` using (game_id,country )
            GROUP BY user_id, DATE_TRUNC(DATE(CLIENT_TIME), DAY)
        ) a,
        (
            SELECT
                user_id,
                MIN(DATE_TRUNC(DATE(CLIENT_TIME), DAY)) AS first_day,
                MIN(version) AS first_version,
                MIN(t.country) AS first_country
            FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
            JOIN (
                SELECT DISTINCT user_id 
                FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
                WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            ) USING (user_id)
            JOIN `applaydu.tbl_shop_filter` using (game_id,country )
            GROUP BY user_id
        ) b
        WHERE a.user_id = b.user_id
    ) AS with_Day_number
    WHERE FORMAT_TIMESTAMP('%A', with_Day_number.`First Day`) IN ('Friday', 'Saturday')
    AND date(with_Day_number.`First Day`) >= (DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 2 YEAR))
    AND date(with_Day_number.`First Day`) < (DATE_TRUNC(CURRENT_DATE(), MONTH))
    AND date(with_Day_number.`First Day`) >= ((SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?))
    AND date(with_Day_number.`First Day`) < (DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY))
    AND first_country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
    AND first_version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )
    
    GROUP BY `First Day`
    ORDER BY `First Day`
)
GROUP BY Month
ORDER BY Month",48.5537109375
"WITH gb4252 as (SELECT 0),
t1 AS (
    SELECT
        user_id, 
        DATE_TRUNC(DATE(client_time), DAY) AS login_day,
        MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id) AS first_day,
        MIN(version) OVER (PARTITION BY user_id) AS first_version,
        MIN(session_id) OVER (PARTITION BY user_id) AS first_session,
        FORMAT_DATE('%A', MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id)) AS first_weekday,
        DATE_DIFF(DATE(client_time), MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id), DAY) AS subsequent_day
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
    ) USING (user_id)
    JOIN `applaydu.tbl_shop_filter` ON `applaydu.tbl_shop_filter`.game_id = t.game_id AND `applaydu.tbl_shop_filter`.country = t.country 
    WHERE 1=1
        AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        
),
t2 AS (
    SELECT 
        DATE_TRUNC(first_day, MONTH) AS first_month,
        subsequent_day,
        COUNT(DISTINCT user_id) AS users
    FROM t1
    WHERE 1=1
        AND first_day >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND first_day < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND first_version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND first_day >= '2023-12-01' 
        AND first_day < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND first_weekday IN ('Friday', 'Saturday')
    GROUP BY first_month, subsequent_day
)
SELECT 
    first_month AS month,
    SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D0,
    SUM(CASE WHEN subsequent_day = 1 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D1,
    SUM(CASE WHEN subsequent_day = 3 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D3,
    SUM(CASE WHEN subsequent_day = 7 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D7,
    SUM(CASE WHEN subsequent_day = 28 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D28
FROM t2
GROUP BY first_month
ORDER BY first_month",48.5537109375
"SELECT 
    Month,
    SUM(Day_1) / SUM(Day_0) AS `Retention D1`,
    SUM(Day_7) / SUM(Day_0) AS `Retention D7`,
    SUM(Day_28) / SUM(Day_0) AS `Retention D28`
FROM (
    SELECT DATE_TRUNC(with_Day_number.`First Day`, MONTH) AS Month,
           FORMAT_TIMESTAMP('%A', with_Day_number.`First Day`) AS `Weekday`,
           `First Day`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS `No. of New user Acquired`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS Day_0,
           SUM(CASE WHEN Day_number = 1 THEN 1 ELSE 0 END) AS Day_1,
           SUM(CASE WHEN Day_number = 7 THEN 1 ELSE 0 END) AS Day_7,
           SUM(CASE WHEN Day_number = 28 THEN 1 ELSE 0 END) AS Day_28
    FROM (
        SELECT
            a.user_id,
            a.login_Day,
            b.first_day AS `First Day`,
            b.first_version AS first_version,
            b.first_country AS first_country,
            DATE_DIFF(a.login_Day, b.first_day, DAY) AS Day_number
        FROM (
            SELECT
                user_id,
                DATE_TRUNC(DATE(CLIENT_TIME), DAY) AS login_Day
            FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
            JOIN (
                SELECT DISTINCT user_id 
                FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
                WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            ) USING (user_id)
            JOIN `applaydu.tbl_shop_filter` using (game_id,country )
            GROUP BY user_id, DATE_TRUNC(DATE(CLIENT_TIME), DAY)
        ) a,
        (
            SELECT
                user_id,
                MIN(DATE_TRUNC(DATE(CLIENT_TIME), DAY)) AS first_day,
                MIN(version) AS first_version,
                MIN(t.country) AS first_country
            FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
            JOIN (
                SELECT DISTINCT user_id 
                FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
                WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            ) USING (user_id)
            JOIN `applaydu.tbl_shop_filter` using (game_id,country )
            GROUP BY user_id
        ) b
        WHERE a.user_id = b.user_id
    ) AS with_Day_number
    WHERE FORMAT_TIMESTAMP('%A', with_Day_number.`First Day`) IN ('Friday', 'Saturday')
    AND date(with_Day_number.`First Day`) >= (DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 2 YEAR))
    AND date(with_Day_number.`First Day`) < (DATE_TRUNC(CURRENT_DATE(), MONTH))
    AND date(with_Day_number.`First Day`) >= ((SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ))
    AND date(with_Day_number.`First Day`) < (DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY))
    AND first_country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
    AND first_version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )
    
    GROUP BY `First Day`
    ORDER BY `First Day`
)
GROUP BY Month
ORDER BY Month",48.5537109375
"SELECT 
    Month,
    SUM(Day_1) / SUM(Day_0) AS `Retention D1`,
    SUM(Day_7) / SUM(Day_0) AS `Retention D7`,
    SUM(Day_28) / SUM(Day_0) AS `Retention D28`
FROM (
    SELECT DATE_TRUNC(with_Day_number.`First Day`, MONTH) AS Month,
           FORMAT_TIMESTAMP('%A', with_Day_number.`First Day`) AS `Weekday`,
           `First Day`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS `No. of New user Acquired`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS Day_0,
           SUM(CASE WHEN Day_number = 1 THEN 1 ELSE 0 END) AS Day_1,
           SUM(CASE WHEN Day_number = 7 THEN 1 ELSE 0 END) AS Day_7,
           SUM(CASE WHEN Day_number = 28 THEN 1 ELSE 0 END) AS Day_28
    FROM (
        SELECT
            a.user_id,
            a.login_Day,
            b.first_day AS `First Day`,
            b.first_version AS first_version,
            b.first_country AS first_country,
            DATE_DIFF(a.login_Day, b.first_day, DAY) AS Day_number
        FROM (
            SELECT
                user_id,
                DATE_TRUNC(DATE(CLIENT_TIME), DAY) AS login_Day
            FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
            JOIN (
                SELECT DISTINCT user_id 
                FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
                WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            ) USING (user_id)
            JOIN `applaydu.tbl_shop_filter` using (game_id,country )
            GROUP BY user_id, DATE_TRUNC(DATE(CLIENT_TIME), DAY)
        ) a,
        (
            SELECT
                user_id,
                MIN(DATE_TRUNC(DATE(CLIENT_TIME), DAY)) AS first_day,
                MIN(version) AS first_version,
                MIN(t.country) AS first_country
            FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
            JOIN (
                SELECT DISTINCT user_id 
                FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
                WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            ) USING (user_id)
            JOIN `applaydu.tbl_shop_filter` using (game_id,country )
            GROUP BY user_id
        ) b
        WHERE a.user_id = b.user_id
    ) AS with_Day_number
    WHERE FORMAT_TIMESTAMP('%A', with_Day_number.`First Day`) IN ('Friday', 'Saturday')
    AND date(with_Day_number.`First Day`) >= (DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 2 YEAR))
    AND date(with_Day_number.`First Day`) < (DATE_TRUNC(CURRENT_DATE(), MONTH))
    AND date(with_Day_number.`First Day`) >= ((SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?))
    AND date(with_Day_number.`First Day`) < (DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY))
    AND first_country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
    AND first_version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  AND (`applaydu.tbl_version_filter`.`version` = ?))
    
    GROUP BY `First Day`
    ORDER BY `First Day`
)
GROUP BY Month
ORDER BY Month",48.5537109375
"WITH gb4252 as (SELECT 0),
t1 AS (
    SELECT
        user_id, 
        DATE_TRUNC(DATE(client_time), DAY) AS login_day,
        MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id) AS first_day,
        MIN(version) OVER (PARTITION BY user_id) AS first_version,
        MIN(session_id) OVER (PARTITION BY user_id) AS first_session,
        FORMAT_DATE('%A', MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id)) AS first_weekday,
        DATE_DIFF(DATE(client_time), MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id), DAY) AS subsequent_day
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
    ) USING (user_id)
    JOIN `applaydu.tbl_shop_filter` ON `applaydu.tbl_shop_filter`.game_id = t.game_id AND `applaydu.tbl_shop_filter`.country = t.country 
    WHERE 1=1
        AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
        
),
t2 AS (
    SELECT 
        DATE_TRUNC(first_day, MONTH) AS first_month,
        subsequent_day,
        COUNT(DISTINCT user_id) AS users
    FROM t1
    WHERE 1=1
        AND first_day >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND first_day < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND first_version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 AND (`applaydu.tbl_version_filter`.`version` = ?))
        AND first_day >= '2023-12-01' 
        AND first_day < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND first_weekday IN ('Friday', 'Saturday')
    GROUP BY first_month, subsequent_day
)
SELECT 
    first_month AS month,
    SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D0,
    SUM(CASE WHEN subsequent_day = 1 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D1,
    SUM(CASE WHEN subsequent_day = 3 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D3,
    SUM(CASE WHEN subsequent_day = 7 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D7,
    SUM(CASE WHEN subsequent_day = 28 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D28
FROM t2
GROUP BY first_month
ORDER BY first_month",48.5537109375
"SELECT 
    Month,
    SUM(Day_1) / SUM(Day_0) AS `Retention D1`,
    SUM(Day_7) / SUM(Day_0) AS `Retention D7`,
    SUM(Day_28) / SUM(Day_0) AS `Retention D28`
FROM (
    SELECT DATE_TRUNC(with_Day_number.`First Day`, MONTH) AS Month,
           FORMAT_TIMESTAMP('%A', with_Day_number.`First Day`) AS `Weekday`,
           `First Day`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS `No. of New user Acquired`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS Day_0,
           SUM(CASE WHEN Day_number = 1 THEN 1 ELSE 0 END) AS Day_1,
           SUM(CASE WHEN Day_number = 7 THEN 1 ELSE 0 END) AS Day_7,
           SUM(CASE WHEN Day_number = 28 THEN 1 ELSE 0 END) AS Day_28
    FROM (
        SELECT
            a.user_id,
            a.login_Day,
            b.first_day AS `First Day`,
            b.first_version AS first_version,
            b.first_country AS first_country,
            DATE_DIFF(a.login_Day, b.first_day, DAY) AS Day_number
        FROM (
            SELECT
                user_id,
                DATE_TRUNC(DATE(CLIENT_TIME), DAY) AS login_Day
            FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
            JOIN (
                SELECT DISTINCT user_id 
                FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
                WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            ) USING (user_id)
            JOIN `applaydu.tbl_shop_filter` using (game_id,country )
            GROUP BY user_id, DATE_TRUNC(DATE(CLIENT_TIME), DAY)
        ) a,
        (
            SELECT
                user_id,
                MIN(DATE_TRUNC(DATE(CLIENT_TIME), DAY)) AS first_day,
                MIN(version) AS first_version,
                MIN(t.country) AS first_country
            FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
            JOIN (
                SELECT DISTINCT user_id 
                FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
                WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            ) USING (user_id)
            JOIN `applaydu.tbl_shop_filter` using (game_id,country )
            GROUP BY user_id
        ) b
        WHERE a.user_id = b.user_id
    ) AS with_Day_number
    WHERE FORMAT_TIMESTAMP('%A', with_Day_number.`First Day`) IN ('Friday', 'Saturday')
    AND date(with_Day_number.`First Day`) >= (DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 2 YEAR))
    AND date(with_Day_number.`First Day`) < (DATE_TRUNC(CURRENT_DATE(), MONTH))
    AND date(with_Day_number.`First Day`) >= ((SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?))
    AND date(with_Day_number.`First Day`) < (DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY))
    AND first_country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
    AND first_version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )
    
    GROUP BY `First Day`
    ORDER BY `First Day`
)
GROUP BY Month
ORDER BY Month",48.5537109375
"SELECT 
    Month,
    SUM(Day_1) / SUM(Day_0) AS `Retention D1`,
    SUM(Day_7) / SUM(Day_0) AS `Retention D7`,
    SUM(Day_28) / SUM(Day_0) AS `Retention D28`
FROM (
    SELECT DATE_TRUNC(with_Day_number.`First Day`, MONTH) AS Month,
           FORMAT_TIMESTAMP('%A', with_Day_number.`First Day`) AS `Weekday`,
           `First Day`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS `No. of New user Acquired`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS Day_0,
           SUM(CASE WHEN Day_number = 1 THEN 1 ELSE 0 END) AS Day_1,
           SUM(CASE WHEN Day_number = 7 THEN 1 ELSE 0 END) AS Day_7,
           SUM(CASE WHEN Day_number = 28 THEN 1 ELSE 0 END) AS Day_28
    FROM (
        SELECT
            a.user_id,
            a.login_Day,
            b.first_day AS `First Day`,
            b.first_version AS first_version,
            b.first_country AS first_country,
            DATE_DIFF(a.login_Day, b.first_day, DAY) AS Day_number
        FROM (
            SELECT
                user_id,
                DATE_TRUNC(DATE(CLIENT_TIME), DAY) AS login_Day
            FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
            JOIN (
                SELECT DISTINCT user_id 
                FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
                WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            ) USING (user_id)
            JOIN `applaydu.tbl_shop_filter` using (game_id,country )
            GROUP BY user_id, DATE_TRUNC(DATE(CLIENT_TIME), DAY)
        ) a,
        (
            SELECT
                user_id,
                MIN(DATE_TRUNC(DATE(CLIENT_TIME), DAY)) AS first_day,
                MIN(version) AS first_version,
                MIN(t.country) AS first_country
            FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
            JOIN (
                SELECT DISTINCT user_id 
                FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
                WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            ) USING (user_id)
            JOIN `applaydu.tbl_shop_filter` using (game_id,country )
            GROUP BY user_id
        ) b
        WHERE a.user_id = b.user_id
    ) AS with_Day_number
    WHERE FORMAT_TIMESTAMP('%A', with_Day_number.`First Day`) IN ('Friday', 'Saturday')
    AND date(with_Day_number.`First Day`) >= (DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 2 YEAR))
    AND date(with_Day_number.`First Day`) < (DATE_TRUNC(CURRENT_DATE(), MONTH))
    AND date(with_Day_number.`First Day`) >= ((SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?))
    AND date(with_Day_number.`First Day`) < (DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY))
    AND first_country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
    AND first_version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )
    
    GROUP BY `First Day`
    ORDER BY `First Day`
)
GROUP BY Month
ORDER BY Month",48.5537109375
"WITH gb4252 as (SELECT 0),
t1 AS (
    SELECT
        user_id, 
        DATE_TRUNC(DATE(client_time), DAY) AS login_day,
        MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id) AS first_day,
        MIN(version) OVER (PARTITION BY user_id) AS first_version,
        MIN(session_id) OVER (PARTITION BY user_id) AS first_session,
        FORMAT_DATE('%A', MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id)) AS first_weekday,
        DATE_DIFF(DATE(client_time), MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id), DAY) AS subsequent_day
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
    ) USING (user_id)
    JOIN `applaydu.tbl_shop_filter` ON `applaydu.tbl_shop_filter`.game_id = t.game_id AND `applaydu.tbl_shop_filter`.country = t.country 
    WHERE 1=1
        AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        
),
t2 AS (
    SELECT 
        DATE_TRUNC(first_day, MONTH) AS first_month,
        subsequent_day,
        COUNT(DISTINCT user_id) AS users
    FROM t1
    WHERE 1=1
        AND first_day >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND first_day < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND first_version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND first_day >= '2023-12-01' 
        AND first_day < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND first_weekday IN ('Friday', 'Saturday')
    GROUP BY first_month, subsequent_day
)
SELECT 
    first_month AS month,
    SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D0,
    SUM(CASE WHEN subsequent_day = 1 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D1,
    SUM(CASE WHEN subsequent_day = 3 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D3,
    SUM(CASE WHEN subsequent_day = 7 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D7,
    SUM(CASE WHEN subsequent_day = 28 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D28
FROM t2
GROUP BY first_month
ORDER BY first_month",48.5537109375
"WITH gb4252 as (SELECT 0),
t1 AS (
    SELECT
        user_id, 
        DATE_TRUNC(DATE(client_time), DAY) AS login_day,
        MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id) AS first_day,
        MIN(version) OVER (PARTITION BY user_id) AS first_version,
        MIN(session_id) OVER (PARTITION BY user_id) AS first_session,
        FORMAT_DATE('%A', MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id)) AS first_weekday,
        DATE_DIFF(DATE(client_time), MIN(DATE_TRUNC(DATE(client_time), DAY)) OVER (PARTITION BY user_id), DAY) AS subsequent_day
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
    ) USING (user_id)
    JOIN `applaydu.tbl_shop_filter` ON `applaydu.tbl_shop_filter`.game_id = t.game_id AND `applaydu.tbl_shop_filter`.country = t.country 
    WHERE 1=1
        AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        
),
t2 AS (
    SELECT 
        DATE_TRUNC(first_day, MONTH) AS first_month,
        subsequent_day,
        COUNT(DISTINCT user_id) AS users
    FROM t1
    WHERE 1=1
        AND first_day >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND first_day < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND first_version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND first_day >= '2023-12-01' 
        AND first_day < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND first_weekday IN ('Friday', 'Saturday')
    GROUP BY first_month, subsequent_day
)
SELECT 
    first_month AS month,
    SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D0,
    SUM(CASE WHEN subsequent_day = 1 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D1,
    SUM(CASE WHEN subsequent_day = 3 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D3,
    SUM(CASE WHEN subsequent_day = 7 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D7,
    SUM(CASE WHEN subsequent_day = 28 THEN users ELSE 0 END) / SUM(CASE WHEN subsequent_day = 0 THEN users ELSE 0 END) AS D28
FROM t2
GROUP BY first_month
ORDER BY first_month",48.5537109375
"WITH gb4254 as (SELECT 0)
,launch_raw AS (
    SELECT user_id, 
           DATE(client_time) AS login_Day, 
           MIN(DATE(client_time)) OVER (PARTITION BY user_id) AS `First Day`, 
           version
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
    ) USING (user_id)
    WHERE country IN ('IN', 'BR', 'RU', 'US', 'IT', 'MX')
    AND game_id IN (81337, 81335)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
    GROUP BY user_id, login_Day, version,client_time
),
launch_with_version AS (
    SELECT user_id, login_Day, `First Day`, DATE_DIFF(login_Day, `First Day`, DAY) AS Day_number
    FROM launch_raw
    WHERE `First Day` >= '2022-06-01' 
    AND `First Day` < DATE_SUB(CURRENT_DATE(), INTERVAL 10 DAY) -- full D30 (-10 days)
    AND `First Day` >= DATE((SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?))
    AND `First Day` < DATE(DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY))
    AND `First Day` >= DATE(DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 30 MONTH))
    ORDER BY user_id, `First Day`
)

,
retention AS (
    SELECT DATE_TRUNC(`First Day`, MONTH) AS Month,
           FORMAT_TIMESTAMP('%A', `First Day`) AS `Weekday`,
           `First Day`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS `No. of New user Acquired`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS Day_0,
           SUM(CASE WHEN Day_number = 1 THEN 1 ELSE 0 END) AS Day_1,
           SUM(CASE WHEN Day_number = 3 THEN 1 ELSE 0 END) AS Day_3,
           SUM(CASE WHEN Day_number = 7 THEN 1 ELSE 0 END) AS Day_7,
           SUM(CASE WHEN Day_number = 14 THEN 1 ELSE 0 END) AS Day_14,
           SUM(CASE WHEN Day_number = 28 THEN 1 ELSE 0 END) AS Day_28,
           SUM(CASE WHEN Day_number = 30 THEN 1 ELSE 0 END) AS Day_30
    FROM launch_with_version
    GROUP BY `First Day`
    HAVING `Weekday` IN ('Friday', 'Saturday')
    ORDER BY `First Day`
)
SELECT 'All' AS Platform,
       Month,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_1) / SUM(Day_0) * 100, 2), '%') end AS `Retention D1`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_3) / SUM(Day_0) * 100, 2), '%') end AS `Retention D3`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_7) / SUM(Day_0) * 100, 2), '%') end AS `Retention D7`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_14) / SUM(Day_0) * 100, 2), '%') end AS `Retention D14`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_28) / SUM(Day_0) * 100, 2), '%') end AS `Retention D28`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_30) / SUM(Day_0) * 100, 2), '%') end AS `Retention D30`,
       case when SUM(Day_1) = 0 then '0' else CONCAT(ROUND(SUM(Day_7) / SUM(Day_1) * 100, 2), '%') end AS `D7 per D1`
FROM retention
GROUP BY Month
ORDER BY Month ASC",48.5478515625
"WITH gb4254 as (SELECT 0)
,launch_raw AS (
    SELECT user_id, 
           DATE(client_time) AS login_Day, 
           MIN(DATE(client_time)) OVER (PARTITION BY user_id) AS `First Day`, 
           version
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
    ) USING (user_id)
    WHERE country IN ('IN', 'BR', 'RU', 'US', 'IT', 'MX')
    AND game_id IN (81337, 81335)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
    GROUP BY user_id, login_Day, version,client_time
),
launch_with_version AS (
    SELECT user_id, login_Day, `First Day`, DATE_DIFF(login_Day, `First Day`, DAY) AS Day_number
    FROM launch_raw
    WHERE `First Day` >= '2022-06-01' 
    AND `First Day` < DATE_SUB(CURRENT_DATE(), INTERVAL 10 DAY) -- full D30 (-10 days)
    AND `First Day` >= DATE((SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?))
    AND `First Day` < DATE(DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY))
    AND `First Day` >= DATE(DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 30 MONTH))
    ORDER BY user_id, `First Day`
)

,
retention AS (
    SELECT DATE_TRUNC(`First Day`, MONTH) AS Month,
           FORMAT_TIMESTAMP('%A', `First Day`) AS `Weekday`,
           `First Day`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS `No. of New user Acquired`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS Day_0,
           SUM(CASE WHEN Day_number = 1 THEN 1 ELSE 0 END) AS Day_1,
           SUM(CASE WHEN Day_number = 3 THEN 1 ELSE 0 END) AS Day_3,
           SUM(CASE WHEN Day_number = 7 THEN 1 ELSE 0 END) AS Day_7,
           SUM(CASE WHEN Day_number = 14 THEN 1 ELSE 0 END) AS Day_14,
           SUM(CASE WHEN Day_number = 28 THEN 1 ELSE 0 END) AS Day_28,
           SUM(CASE WHEN Day_number = 30 THEN 1 ELSE 0 END) AS Day_30
    FROM launch_with_version
    GROUP BY `First Day`
    HAVING `Weekday` IN ('Friday', 'Saturday')
    ORDER BY `First Day`
)
SELECT 'All' AS Platform,
       Month,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_1) / SUM(Day_0) * 100, 2), '%') end AS `Retention D1`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_3) / SUM(Day_0) * 100, 2), '%') end AS `Retention D3`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_7) / SUM(Day_0) * 100, 2), '%') end AS `Retention D7`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_14) / SUM(Day_0) * 100, 2), '%') end AS `Retention D14`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_28) / SUM(Day_0) * 100, 2), '%') end AS `Retention D28`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_30) / SUM(Day_0) * 100, 2), '%') end AS `Retention D30`,
       case when SUM(Day_1) = 0 then '0' else CONCAT(ROUND(SUM(Day_7) / SUM(Day_1) * 100, 2), '%') end AS `D7 per D1`
FROM retention
GROUP BY Month
ORDER BY Month ASC",48.5478515625
"WITH gb4254 as (SELECT 0)
,launch_raw AS (
    SELECT user_id, 
           DATE(client_time) AS login_Day, 
           MIN(DATE(client_time)) OVER (PARTITION BY user_id) AS `First Day`, 
           version
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
    ) USING (user_id)
    WHERE country IN ('IN', 'BR', 'RU', 'US', 'IT', 'MX')
    AND game_id IN (81337, 81335)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
    GROUP BY user_id, login_Day, version,client_time
),
launch_with_version AS (
    SELECT user_id, login_Day, `First Day`, DATE_DIFF(login_Day, `First Day`, DAY) AS Day_number
    FROM launch_raw
    WHERE `First Day` >= '2022-06-01' 
    AND `First Day` < DATE_SUB(CURRENT_DATE(), INTERVAL 10 DAY) -- full D30 (-10 days)
    AND `First Day` >= DATE((SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ))
    AND `First Day` < DATE(DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY))
    AND `First Day` >= DATE(DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 30 MONTH))
    ORDER BY user_id, `First Day`
)

,
retention AS (
    SELECT DATE_TRUNC(`First Day`, MONTH) AS Month,
           FORMAT_TIMESTAMP('%A', `First Day`) AS `Weekday`,
           `First Day`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS `No. of New user Acquired`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS Day_0,
           SUM(CASE WHEN Day_number = 1 THEN 1 ELSE 0 END) AS Day_1,
           SUM(CASE WHEN Day_number = 3 THEN 1 ELSE 0 END) AS Day_3,
           SUM(CASE WHEN Day_number = 7 THEN 1 ELSE 0 END) AS Day_7,
           SUM(CASE WHEN Day_number = 14 THEN 1 ELSE 0 END) AS Day_14,
           SUM(CASE WHEN Day_number = 28 THEN 1 ELSE 0 END) AS Day_28,
           SUM(CASE WHEN Day_number = 30 THEN 1 ELSE 0 END) AS Day_30
    FROM launch_with_version
    GROUP BY `First Day`
    HAVING `Weekday` IN ('Friday', 'Saturday')
    ORDER BY `First Day`
)
SELECT 'All' AS Platform,
       Month,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_1) / SUM(Day_0) * 100, 2), '%') end AS `Retention D1`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_3) / SUM(Day_0) * 100, 2), '%') end AS `Retention D3`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_7) / SUM(Day_0) * 100, 2), '%') end AS `Retention D7`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_14) / SUM(Day_0) * 100, 2), '%') end AS `Retention D14`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_28) / SUM(Day_0) * 100, 2), '%') end AS `Retention D28`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_30) / SUM(Day_0) * 100, 2), '%') end AS `Retention D30`,
       case when SUM(Day_1) = 0 then '0' else CONCAT(ROUND(SUM(Day_7) / SUM(Day_1) * 100, 2), '%') end AS `D7 per D1`
FROM retention
GROUP BY Month
ORDER BY Month ASC",48.5478515625
"WITH gb4254 as (SELECT 0)
,launch_raw AS (
    SELECT user_id, 
           DATE(client_time) AS login_Day, 
           MIN(DATE(client_time)) OVER (PARTITION BY user_id) AS `First Day`, 
           version
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
    ) USING (user_id)
    WHERE country IN ('IN', 'BR', 'RU', 'US', 'IT', 'MX')
    AND game_id IN (81337, 81335)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
    GROUP BY user_id, login_Day, version,client_time
),
launch_with_version AS (
    SELECT user_id, login_Day, `First Day`, DATE_DIFF(login_Day, `First Day`, DAY) AS Day_number
    FROM launch_raw
    WHERE `First Day` >= '2022-06-01' 
    AND `First Day` < DATE_SUB(CURRENT_DATE(), INTERVAL 10 DAY) -- full D30 (-10 days)
    AND `First Day` >= DATE((SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?))
    AND `First Day` < DATE(DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY))
    AND `First Day` >= DATE(DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 30 MONTH))
    ORDER BY user_id, `First Day`
)

,
retention AS (
    SELECT DATE_TRUNC(`First Day`, MONTH) AS Month,
           FORMAT_TIMESTAMP('%A', `First Day`) AS `Weekday`,
           `First Day`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS `No. of New user Acquired`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS Day_0,
           SUM(CASE WHEN Day_number = 1 THEN 1 ELSE 0 END) AS Day_1,
           SUM(CASE WHEN Day_number = 3 THEN 1 ELSE 0 END) AS Day_3,
           SUM(CASE WHEN Day_number = 7 THEN 1 ELSE 0 END) AS Day_7,
           SUM(CASE WHEN Day_number = 14 THEN 1 ELSE 0 END) AS Day_14,
           SUM(CASE WHEN Day_number = 28 THEN 1 ELSE 0 END) AS Day_28,
           SUM(CASE WHEN Day_number = 30 THEN 1 ELSE 0 END) AS Day_30
    FROM launch_with_version
    GROUP BY `First Day`
    HAVING `Weekday` IN ('Friday', 'Saturday')
    ORDER BY `First Day`
)
SELECT 'All' AS Platform,
       Month,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_1) / SUM(Day_0) * 100, 2), '%') end AS `Retention D1`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_3) / SUM(Day_0) * 100, 2), '%') end AS `Retention D3`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_7) / SUM(Day_0) * 100, 2), '%') end AS `Retention D7`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_14) / SUM(Day_0) * 100, 2), '%') end AS `Retention D14`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_28) / SUM(Day_0) * 100, 2), '%') end AS `Retention D28`,
       case when SUM(Day_0) = 0 then '0' else CONCAT(ROUND(SUM(Day_30) / SUM(Day_0) * 100, 2), '%') end AS `Retention D30`,
       case when SUM(Day_1) = 0 then '0' else CONCAT(ROUND(SUM(Day_7) / SUM(Day_1) * 100, 2), '%') end AS `D7 per D1`
FROM retention
GROUP BY Month
ORDER BY Month ASC",48.5478515625
"SELECT * FROM `gcp-gfb-sai-tracking-gold.applaydu.store_stats_qr_impressions`
where  store_date = '2025-01-26' and d_country != 'CN' and version ='1.0.0-debug'",45.3271484375
"SELECT * FROM `gcp-gfb-sai-tracking-gold.applaydu.store_stats_qr_impressions`
where  store_date = '2025-01-22' and d_country != 'CN' and version ='1.0.0'",45.326171875
"WITH gb4230 as (select 4230),
tbl_story_mode_finished as (
 select user_id,FED_ID,PLATFORM,game_id,EVENT_ID,min(client_time),min(client_time),version,country,SESSION_ID
,min(TOKEN),AVATAR_GENDER,END_CAUSE,TOY_NAME,STORY_STEP,avg(TIME_TO_FINISH)
,ACTIVITY_01,ACTIVITY_01_VALUE,ACTIVITY_02,ACTIVITY_02_VALUE,ACTIVITY_03,ACTIVITY_03_VALUE,ACTIVITY_04
,ACTIVITY_04_VALUE,ACTIVITY_05,ACTIVITY_05_VALUE,AVATAR_ONESIE,click_from,ENVIRONMENT_ID,min(EVENT_client_time_LOCAL)
,avg(REALTIME_SPENT),min(load_time),ACTIVITY_06,ACTIVITY_06_VALUE,ACTIVITY_07,ACTIVITY_07_VALUE
,ACTIVITY_08,ACTIVITY_08_VALUE,ACTIVITY_09,ACTIVITY_09_VALUE,ACTIVITY_10,ACTIVITY_10_VALUE,TOY_UNLOCKED_METHOD,from_scene
 from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 where (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0' 
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 group by all
)
,real_story_mode_finished as (
SELECT user_id,game_id,event_id,version,country,session_id,avatar_gender,end_cause,toy_name,story_step,realtime_spent,environment_id,client_time,toy_unlocked_method,count(*) as dup
FROM 
 (
 -- exclude Dino Exp
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished
 WHERE 
 environment_id like 'Natoons v4%' or
 -- DUPLICATIONS in those Experience
 (environment_id like '%Travel%' and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id NOT IN ('Savannah','Space','Ocean','Jungle','Magic Land','Experience - Dino Museum') AND (environment_id not LIKE '%Travel%') ) or 
 (environment_id='Kinderini' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_kinderini_start_date') ) or 
 (environment_id='Eduland Lets Story' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_v5_lets_story_start_date'))
 -- Dino 
 union all
 -- version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') (normal)
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 WHERE (version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19'))
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 union all
 -- (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0'
 select * from tbl_story_mode_finished
 )
group by all
)
,dedicated as (
SELECT user_id,realtime_spent
from real_story_mode_finished
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
SELECT user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.ILLUSTRATION_BOOK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,minigame_done as (
select user_id AS user_id,
game_id AS game_id,
client_time AS client_time,server_time AS server_time,
version AS version,
country AS country,
scene_name AS scene_name,
click_from AS click_from,
case when REALTIME_SPENT is null then time_to_finish else REALTIME_SPENT end AS realtime_spent,
load_time AS load_time,
case when from_scene is null then 'Not yet available' else from_scene end as from_scene,
FROM gcp-bi-elephant-db-gold.applaydu.minigame_finished
)
,minigame as (
SELECT user_id,realtime_spent
FROM minigame_done
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name not in ('Main Menu','NBA_1','NBA_2','Happos Runner','Natoon RunnerV2','Inkmagination_Xmas')
 and from_scene<>'Eduland AvatarHouse' -- EXCLUDE Minigame Drawing in AvatarHouse from Minigame
 and scene_name not like '%Playability%' 
 and( (scene_name<>'Move Ahead'and realtime_spent>=0) or ( scene_name='Move Ahead' and realtime_spent>12) )-- to exclude users quitting during loading screen + cover 99% users
)
,toy_fs as (
--tracking TOY_FRIENDSHIP_FINISHED before v4.6.1
select user_id,time_spent,CAST(client_time AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.TOY_FRIENDSHIP_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'4.6.1' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name like 'Eduland%'
 and time_spent>=0 and time_spent<7200
--change tracking ACTIVITY_FINISHED since v4.6.1
union all
select user_id,time_spent,CAST(client_time AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='4.6.1' AND DATE(client_time) >= '2024-03-11') and version<'5.2.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Current Heart Point' -- first row data only for Natoons and Fantasy event returns 2 rows
 and time_spent>=0 and time_spent<7200
union all 
--change tracking ACTIVITY_FINISHED since v5.2.0
select user_id,sum(time_spent) as total_time,CAST(client_time AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') and version<'5.4.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
group by all
union all 
--change tracking ACTIVITY_FINISHED since v5.4.0
select user_id,sum(time_spent) as total_time,CAST(activity_10_value AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='5.4.0' AND DATE(client_time) >= '2024-12-04') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
group by 1,3
)
,ar_mode as (
select user_id,realtime_spent
FROM gcp-bi-elephant-db-gold.applaydu.AR_MODE_FINISHED
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.FACE_MASK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,avatar_house as (
-- OLD TRACKING: before 4.5.0 use visit_screen
select user_id
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 
 and screen_to like 'Eduland%Avatar%'
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all
select user_id
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0 and from_scene<>'Inkmagination' -- when users from AH Drawing to AH,we do not count as a new session
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,avatarhouse_time as (-- include Minigame Drawing from AH 
-- OLD TRACKING: before 4.5.0 use visit_screen
select time_spent
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 and time_spent>=0 and time_spent<36000
 and (screen_from like '%Avatar%' or (screen_from like '%Ink%' and screen_to like '%Avatar%')) -- INCLUDE TIME SPENT IN MINIGAME DRAWING IN AH
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
-- NEW TRACKING: after 4.5.0 use AH + MINIGAME DRAWING AH
union all
select time_spent
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all -- INCLUDE TIME_SPENT MINIGAME DRAWING in AH
select REALTIME_SPENT
from gcp-bi-elephant-db-gold.applaydu.minigame_finished
where scene_name='Inkmagination'
 and from_scene='Eduland AvatarHouse'
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,parental_section as (
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.PARENTAL_SECTION
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,result as
(
select 'Dedicated Experience' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from dedicated 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

union all
select 'AR' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from ar_mode 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Minigame' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from minigame 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Toy Friendship' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(time_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(time_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from toy_fs 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
group by 1
union all
select 'Avatar House' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,(select sum(time_spent) from avatarhouse_time) / (case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,(select sum(time_spent) from avatarhouse_time) /count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from avatar_house 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Parental Section' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from parental_section 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

)
select *
,concat(floor(`Time spent per user min`),' min ',round((`Time spent per user min` - floor(`Time spent per user min`)) * 60),' sec') as `Time spent per user min - sec`
,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration min`
 from result
order by session desc",44.5576171875
"WITH gb4230 as (select 4230),
tbl_story_mode_finished as (
 select user_id,FED_ID,PLATFORM,game_id,EVENT_ID,min(client_time),min(client_time),version,country,SESSION_ID
,min(TOKEN),AVATAR_GENDER,END_CAUSE,TOY_NAME,STORY_STEP,avg(TIME_TO_FINISH)
,ACTIVITY_01,ACTIVITY_01_VALUE,ACTIVITY_02,ACTIVITY_02_VALUE,ACTIVITY_03,ACTIVITY_03_VALUE,ACTIVITY_04
,ACTIVITY_04_VALUE,ACTIVITY_05,ACTIVITY_05_VALUE,AVATAR_ONESIE,click_from,ENVIRONMENT_ID,min(EVENT_client_time_LOCAL)
,avg(REALTIME_SPENT),min(load_time),ACTIVITY_06,ACTIVITY_06_VALUE,ACTIVITY_07,ACTIVITY_07_VALUE
,ACTIVITY_08,ACTIVITY_08_VALUE,ACTIVITY_09,ACTIVITY_09_VALUE,ACTIVITY_10,ACTIVITY_10_VALUE,TOY_UNLOCKED_METHOD,from_scene
 from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 where (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0' 
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 group by all
)
,real_story_mode_finished as (
SELECT user_id,game_id,event_id,version,country,session_id,avatar_gender,end_cause,toy_name,story_step,realtime_spent,environment_id,client_time,toy_unlocked_method,count(*) as dup
FROM 
 (
 -- exclude Dino Exp
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished
 WHERE 
 environment_id like 'Natoons v4%' or
 -- DUPLICATIONS in those Experience
 (environment_id like '%Travel%' and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id NOT IN ('Savannah','Space','Ocean','Jungle','Magic Land','Experience - Dino Museum') AND (environment_id not LIKE '%Travel%') ) or 
 (environment_id='Kinderini' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_kinderini_start_date') ) or 
 (environment_id='Eduland Lets Story' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_v5_lets_story_start_date'))
 -- Dino 
 union all
 -- version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') (normal)
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 WHERE (version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19'))
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 union all
 -- (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0'
 select * from tbl_story_mode_finished
 )
group by all
)
,dedicated as (
SELECT user_id,realtime_spent
from real_story_mode_finished
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
SELECT user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.ILLUSTRATION_BOOK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,minigame_done as (
select user_id AS user_id,
game_id AS game_id,
client_time AS client_time,server_time AS server_time,
version AS version,
country AS country,
scene_name AS scene_name,
click_from AS click_from,
case when REALTIME_SPENT is null then time_to_finish else REALTIME_SPENT end AS realtime_spent,
load_time AS load_time,
case when from_scene is null then 'Not yet available' else from_scene end as from_scene,
FROM gcp-bi-elephant-db-gold.applaydu.minigame_finished
)
,minigame as (
SELECT user_id,realtime_spent
FROM minigame_done
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name not in ('Main Menu','NBA_1','NBA_2','Happos Runner','Natoon RunnerV2','Inkmagination_Xmas')
 and from_scene<>'Eduland AvatarHouse' -- EXCLUDE Minigame Drawing in AvatarHouse from Minigame
 and scene_name not like '%Playability%' 
 and( (scene_name<>'Move Ahead'and realtime_spent>=0) or ( scene_name='Move Ahead' and realtime_spent>12) )-- to exclude users quitting during loading screen + cover 99% users
)
,toy_fs as (
--tracking TOY_FRIENDSHIP_FINISHED before v4.6.1
select user_id,time_spent,CAST(client_time AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.TOY_FRIENDSHIP_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'4.6.1' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name like 'Eduland%'
 and time_spent>=0 and time_spent<7200
--change tracking ACTIVITY_FINISHED since v4.6.1
union all
select user_id,time_spent,CAST(client_time AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='4.6.1' AND DATE(client_time) >= '2024-03-11') and version<'5.2.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Current Heart Point' -- first row data only for Natoons and Fantasy event returns 2 rows
 and time_spent>=0 and time_spent<7200
union all 
--change tracking ACTIVITY_FINISHED since v5.2.0
select user_id,sum(time_spent) as total_time,CAST(client_time AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') and version<'5.4.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
group by all
union all 
--change tracking ACTIVITY_FINISHED since v5.4.0
select user_id,sum(time_spent) as total_time,CAST(activity_10_value AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='5.4.0' AND DATE(client_time) >= '2024-12-04') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
group by 1,3
)
,ar_mode as (
select user_id,realtime_spent
FROM gcp-bi-elephant-db-gold.applaydu.AR_MODE_FINISHED
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.FACE_MASK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,avatar_house as (
-- OLD TRACKING: before 4.5.0 use visit_screen
select user_id
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 
 and screen_to like 'Eduland%Avatar%'
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all
select user_id
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0 and from_scene<>'Inkmagination' -- when users from AH Drawing to AH,we do not count as a new session
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,avatarhouse_time as (-- include Minigame Drawing from AH 
-- OLD TRACKING: before 4.5.0 use visit_screen
select time_spent
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 and time_spent>=0 and time_spent<36000
 and (screen_from like '%Avatar%' or (screen_from like '%Ink%' and screen_to like '%Avatar%')) -- INCLUDE TIME SPENT IN MINIGAME DRAWING IN AH
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
-- NEW TRACKING: after 4.5.0 use AH + MINIGAME DRAWING AH
union all
select time_spent
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all -- INCLUDE TIME_SPENT MINIGAME DRAWING in AH
select REALTIME_SPENT
from gcp-bi-elephant-db-gold.applaydu.minigame_finished
where scene_name='Inkmagination'
 and from_scene='Eduland AvatarHouse'
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,parental_section as (
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.PARENTAL_SECTION
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,result as
(
select 'Dedicated Experience' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from dedicated 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

union all
select 'AR' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from ar_mode 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Minigame' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from minigame 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Toy Friendship' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(time_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(time_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from toy_fs 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
group by 1
union all
select 'Avatar House' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,(select sum(time_spent) from avatarhouse_time) / (case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,(select sum(time_spent) from avatarhouse_time) /count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from avatar_house 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Parental Section' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from parental_section 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

)
select *
,concat(floor(`Time spent per user min`),' min ',round((`Time spent per user min` - floor(`Time spent per user min`)) * 60),' sec') as `Time spent per user min - sec`
,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration min`
 from result
order by session desc",44.541015625
"WITH gb4235 as (select 4235),
tbl_story_mode_finished as (
 select user_id,FED_ID,PLATFORM,game_id,EVENT_ID,min(client_time),min(client_time),version,country,SESSION_ID
,min(TOKEN),AVATAR_GENDER,END_CAUSE,TOY_NAME,STORY_STEP,avg(TIME_TO_FINISH)
,ACTIVITY_01,ACTIVITY_01_VALUE,ACTIVITY_02,ACTIVITY_02_VALUE,ACTIVITY_03,ACTIVITY_03_VALUE,ACTIVITY_04
,ACTIVITY_04_VALUE,ACTIVITY_05,ACTIVITY_05_VALUE,AVATAR_ONESIE,click_from,ENVIRONMENT_ID,min(EVENT_client_time_LOCAL)
,avg(REALTIME_SPENT),min(load_time),ACTIVITY_06,ACTIVITY_06_VALUE,ACTIVITY_07,ACTIVITY_07_VALUE
,ACTIVITY_08,ACTIVITY_08_VALUE,ACTIVITY_09,ACTIVITY_09_VALUE,ACTIVITY_10,ACTIVITY_10_VALUE,TOY_UNLOCKED_METHOD,from_scene
 from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 where (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0' 
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 group by all
)
,real_story_mode_finished as (
SELECT user_id,game_id,event_id,version,country,session_id,avatar_gender,end_cause,toy_name,story_step,realtime_spent,environment_id,client_time,toy_unlocked_method,count(*) as dup
FROM 
 (
 -- exclude Dino Exp
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished
 WHERE 
 environment_id like 'Natoons v4%' or
 -- DUPLICATIONS in those Experience
 (environment_id like '%Travel%' and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id NOT IN ('Savannah','Space','Ocean','Jungle','Magic Land','Experience - Dino Museum') AND (environment_id not LIKE '%Travel%') ) or 
 (environment_id='Kinderini' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_kinderini_start_date') ) or 
 (environment_id='Eduland Lets Story' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_v5_lets_story_start_date'))
 -- Dino 
 union all
 -- version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') (normal)
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 WHERE (version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19'))
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 union all
 -- (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0'
 select * from tbl_story_mode_finished
 )
group by all
)
,dedicated as (
SELECT user_id,realtime_spent
from real_story_mode_finished
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
SELECT user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.ILLUSTRATION_BOOK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,minigame_done as (
select user_id AS user_id,
game_id AS game_id,
client_time AS client_time,server_time AS server_time,
version AS version,
country AS country,
scene_name AS scene_name,
click_from AS click_from,
case when REALTIME_SPENT is null then time_to_finish else REALTIME_SPENT end AS realtime_spent,
load_time AS load_time,
case when from_scene is null then 'Not yet available' else from_scene end as from_scene,
FROM gcp-bi-elephant-db-gold.applaydu.minigame_finished
)
,minigame as (
SELECT user_id,realtime_spent
FROM minigame_done
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name not in ('Main Menu','NBA_1','NBA_2','Happos Runner','Natoon RunnerV2','Inkmagination_Xmas')
 and from_scene<>'Eduland AvatarHouse' -- EXCLUDE Minigame Drawing in AvatarHouse from Minigame
 and scene_name not like '%Playability%' 
 and( (scene_name<>'Move Ahead'and realtime_spent>=0) or ( scene_name='Move Ahead' and realtime_spent>12) )-- to exclude users quitting during loading screen + cover 99% users
)
,toy_fs as (
--tracking TOY_FRIENDSHIP_FINISHED before v4.6.1
select user_id,sum(time_spent) as total_time,count (*) as session
from gcp-bi-elephant-db-gold.applaydu.TOY_FRIENDSHIP_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'4.6.1' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name like 'Eduland%'
 and time_spent>=0 and time_spent<7200
group by 1
--change tracking ACTIVITY_FINISHED since v4.6.1
union all
select user_id,sum(time_spent) as total_time,count (*) as session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='4.6.1' AND DATE(client_time) >= '2024-03-11') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Current Heart Point' -- first row data only for Natoons and Fantasy event returns 2 rows
 and time_spent>=0 and time_spent<7200
group by 1
union all
--change tracking ACTIVITY_FINISHED since v5.2.0
select user_id,total_time,session 
from (
(
select user_id,sum(time_spent) as total_time
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') and version<'5.4.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
group by 1
) a join (
select user_id,count(token) as session
from gcp-bi-elephant-db-gold.applaydu.TOY_FRIENDSHIP_STARTED
where 1=1
 and (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') and version<'5.4.0'
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) 
 and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (SELECT version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
 and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  ) 
 and date(client_time)>='2020-08-10' and date(client_time)<CURRENT_DATE()
group by 1
) b using (user_id))
union all
--change tracking ACTIVITY_FINISHED since v5.4.0
select user_id,sum(session_timespent) as total_time,count(session_id) as session
from(
 select user_id,ACTIVITY_10_VALUE as session_id,sum(time_spent) as session_timespent
 from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
 where 1=1
 and (version >='5.4.0' AND DATE(client_time) >= '2024-12-04') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
 group by 1,2
)
group by 1
)
,ar_mode as (
select user_id,realtime_spent
FROM gcp-bi-elephant-db-gold.applaydu.AR_MODE_FINISHED
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.FACE_MASK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,avatar_house as (
-- OLD TRACKING: before 4.5.0 use visit_screen
select user_id
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 
 and screen_to like 'Eduland%Avatar%'
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all
select user_id
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0 and from_scene<>'Inkmagination' -- when users from AH Drawing to AH,we do not count as a new session
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,avatarhouse_time as (-- include Minigame Drawing from AH 
-- OLD TRACKING: before 4.5.0 use visit_screen
select time_spent
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 and time_spent>=0 and time_spent<36000
 and (screen_from like '%Avatar%' or (screen_from like '%Ink%' and screen_to like '%Avatar%')) -- INCLUDE TIME SPENT IN MINIGAME DRAWING IN AH
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
-- NEW TRACKING: after 4.5.0 use AH + MINIGAME DRAWING AH
union all
select time_spent
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all -- INCLUDE TIME_SPENT MINIGAME DRAWING in AH
select REALTIME_SPENT
from gcp-bi-elephant-db-gold.applaydu.minigame_finished
where scene_name='Inkmagination'
 and from_scene='Eduland AvatarHouse'
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,parental_section as (
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.PARENTAL_SECTION
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,result as
(
select 'Dedicated Experience' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from dedicated 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

union all
select 'AR' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from ar_mode 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Minigame' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from minigame 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Toy Friendship' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(total_time)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(total_time)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from toy_fs 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
group by 1
union all
select 'Avatar House' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,(select sum(time_spent) from avatarhouse_time) / (case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,(select sum(time_spent) from avatarhouse_time) /count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from avatar_house 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Parental Section' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from parental_section 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

)
select *
,concat(floor(`Time spent per user min`),' min ',round((`Time spent per user min` - floor(`Time spent per user min`)) * 60),' sec') as `Time spent per user min - sec`
,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration min`
 from result
order by `Time spent per user min` desc",44.1875
"WITH gb4235 as (select 4235),
tbl_story_mode_finished as (
 select user_id,FED_ID,PLATFORM,game_id,EVENT_ID,min(client_time),min(client_time),version,country,SESSION_ID
,min(TOKEN),AVATAR_GENDER,END_CAUSE,TOY_NAME,STORY_STEP,avg(TIME_TO_FINISH)
,ACTIVITY_01,ACTIVITY_01_VALUE,ACTIVITY_02,ACTIVITY_02_VALUE,ACTIVITY_03,ACTIVITY_03_VALUE,ACTIVITY_04
,ACTIVITY_04_VALUE,ACTIVITY_05,ACTIVITY_05_VALUE,AVATAR_ONESIE,click_from,ENVIRONMENT_ID,min(EVENT_client_time_LOCAL)
,avg(REALTIME_SPENT),min(load_time),ACTIVITY_06,ACTIVITY_06_VALUE,ACTIVITY_07,ACTIVITY_07_VALUE
,ACTIVITY_08,ACTIVITY_08_VALUE,ACTIVITY_09,ACTIVITY_09_VALUE,ACTIVITY_10,ACTIVITY_10_VALUE,TOY_UNLOCKED_METHOD,from_scene
 from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 where (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0' 
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 group by all
)
,real_story_mode_finished as (
SELECT user_id,game_id,event_id,version,country,session_id,avatar_gender,end_cause,toy_name,story_step,realtime_spent,environment_id,client_time,toy_unlocked_method,count(*) as dup
FROM 
 (
 -- exclude Dino Exp
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished
 WHERE 
 environment_id like 'Natoons v4%' or
 -- DUPLICATIONS in those Experience
 (environment_id like '%Travel%' and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id NOT IN ('Savannah','Space','Ocean','Jungle','Magic Land','Experience - Dino Museum') AND (environment_id not LIKE '%Travel%') ) or 
 (environment_id='Kinderini' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_kinderini_start_date') ) or 
 (environment_id='Eduland Lets Story' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_v5_lets_story_start_date'))
 -- Dino 
 union all
 -- version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') (normal)
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 WHERE (version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19'))
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 union all
 -- (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0'
 select * from tbl_story_mode_finished
 )
group by all
)
,dedicated as (
SELECT user_id,realtime_spent
from real_story_mode_finished
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
SELECT user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.ILLUSTRATION_BOOK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,minigame_done as (
select user_id AS user_id,
game_id AS game_id,
client_time AS client_time,server_time AS server_time,
version AS version,
country AS country,
scene_name AS scene_name,
click_from AS click_from,
case when REALTIME_SPENT is null then time_to_finish else REALTIME_SPENT end AS realtime_spent,
load_time AS load_time,
case when from_scene is null then 'Not yet available' else from_scene end as from_scene,
FROM gcp-bi-elephant-db-gold.applaydu.minigame_finished
)
,minigame as (
SELECT user_id,realtime_spent
FROM minigame_done
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name not in ('Main Menu','NBA_1','NBA_2','Happos Runner','Natoon RunnerV2','Inkmagination_Xmas')
 and from_scene<>'Eduland AvatarHouse' -- EXCLUDE Minigame Drawing in AvatarHouse from Minigame
 and scene_name not like '%Playability%' 
 and( (scene_name<>'Move Ahead'and realtime_spent>=0) or ( scene_name='Move Ahead' and realtime_spent>12) )-- to exclude users quitting during loading screen + cover 99% users
)
,toy_fs as (
--tracking TOY_FRIENDSHIP_FINISHED before v4.6.1
select user_id,sum(time_spent) as total_time,count (*) as session
from gcp-bi-elephant-db-gold.applaydu.TOY_FRIENDSHIP_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'4.6.1' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name like 'Eduland%'
 and time_spent>=0 and time_spent<7200
group by 1
--change tracking ACTIVITY_FINISHED since v4.6.1
union all
select user_id,sum(time_spent) as total_time,count (*) as session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='4.6.1' AND DATE(client_time) >= '2024-03-11') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Current Heart Point' -- first row data only for Natoons and Fantasy event returns 2 rows
 and time_spent>=0 and time_spent<7200
group by 1
union all
--change tracking ACTIVITY_FINISHED since v5.2.0
select user_id,total_time,session 
from (
(
select user_id,sum(time_spent) as total_time
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') and version<'5.4.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
group by 1
) a join (
select user_id,count(token) as session
from gcp-bi-elephant-db-gold.applaydu.TOY_FRIENDSHIP_STARTED
where 1=1
 and (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') and version<'5.4.0'
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) 
 and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (SELECT version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
 and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  ) 
 and date(client_time)>='2020-08-10' and date(client_time)<CURRENT_DATE()
group by 1
) b using (user_id))
union all
--change tracking ACTIVITY_FINISHED since v5.4.0
select user_id,sum(session_timespent) as total_time,count(session_id) as session
from(
 select user_id,ACTIVITY_10_VALUE as session_id,sum(time_spent) as session_timespent
 from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
 where 1=1
 and (version >='5.4.0' AND DATE(client_time) >= '2024-12-04') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
 group by 1,2
)
group by 1
)
,ar_mode as (
select user_id,realtime_spent
FROM gcp-bi-elephant-db-gold.applaydu.AR_MODE_FINISHED
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.FACE_MASK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,avatar_house as (
-- OLD TRACKING: before 4.5.0 use visit_screen
select user_id
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 
 and screen_to like 'Eduland%Avatar%'
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all
select user_id
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0 and from_scene<>'Inkmagination' -- when users from AH Drawing to AH,we do not count as a new session
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,avatarhouse_time as (-- include Minigame Drawing from AH 
-- OLD TRACKING: before 4.5.0 use visit_screen
select time_spent
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 and time_spent>=0 and time_spent<36000
 and (screen_from like '%Avatar%' or (screen_from like '%Ink%' and screen_to like '%Avatar%')) -- INCLUDE TIME SPENT IN MINIGAME DRAWING IN AH
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
-- NEW TRACKING: after 4.5.0 use AH + MINIGAME DRAWING AH
union all
select time_spent
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all -- INCLUDE TIME_SPENT MINIGAME DRAWING in AH
select REALTIME_SPENT
from gcp-bi-elephant-db-gold.applaydu.minigame_finished
where scene_name='Inkmagination'
 and from_scene='Eduland AvatarHouse'
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,parental_section as (
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.PARENTAL_SECTION
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,result as
(
select 'Dedicated Experience' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from dedicated 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

union all
select 'AR' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from ar_mode 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Minigame' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from minigame 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Toy Friendship' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(total_time)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(total_time)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from toy_fs 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
group by 1
union all
select 'Avatar House' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,(select sum(time_spent) from avatarhouse_time) / (case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,(select sum(time_spent) from avatarhouse_time) /count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from avatar_house 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Parental Section' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from parental_section 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

)
select *
,concat(floor(`Time spent per user min`),' min ',round((`Time spent per user min` - floor(`Time spent per user min`)) * 60),' sec') as `Time spent per user min - sec`
,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration min`
 from result
order by `Time spent per user min` desc",44.1748046875
"WITH gb4234 as (SELECT 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (unlock_cause = 'QR Code'
        OR unlock_cause = 'Toy Scan' 
        OR unlock_cause = 'Deep_Link')
        AND isnewtoy = 1
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
    GROUP BY user_id
),
Persona AS (
    SELECT user_id, 
           CASE WHEN `Number of Toys Unlocked` IN (1,2,3) THEN 'Persona #2'
                ELSE 'Persona #3' END AS `Persona Type`
    FROM unlock
),
tbl_launch_resume AS (
    SELECT user_id, COALESCE(c.name, 'Unknown') AS country_name, client_time
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` l
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
        AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    ) USING (user_id)
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.country` c ON l.country = c.code
)
SELECT country_name, 
       COALESCE(`Persona #1`, 0) AS `Persona #1`, 
       COALESCE(`Persona #2`, 0) AS `Persona #2`, 
       COALESCE(`Persona #3`, 0) AS `Persona #3`,
       (`Persona #1` + `Persona #2` + `Persona #3`) AS `Active Users`,
       (`Persona #1` / (`Persona #1` + `Persona #2` + `Persona #3`)) * 100 AS `% Persona 1`,
       (`Persona #2` / (`Persona #1` + `Persona #2` + `Persona #3`)) * 100 AS `% Persona 2`, 
       (`Persona #3` / (`Persona #1` + `Persona #2` + `Persona #3`)) * 100 AS `% Persona 3`
FROM (
    SELECT *
    FROM (
        SELECT country_name, 
               CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END AS `Persona_Type`, 
               COUNT(DISTINCT l.user_id) AS `No. of Users`
        FROM tbl_launch_resume l
        LEFT JOIN Persona p ON l.user_id = p.user_id
        WHERE l.user_id IS NOT NULL
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        --AND `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 [[AND {{ipersona}}]])
        AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )
        GROUP BY country_name, `Persona_Type`
        having `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 )
    )
    PIVOT(SUM(`No. of Users`) FOR `Persona_Type` IN ('Persona #1', 'Persona #2', 'Persona #3')) AS pivottable
)
ORDER BY `Active Users` DESC, `Persona #3` DESC 
LIMIT 20",43.25
"WITH gb4247 as (select 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (unlock_cause = 'QR Code'
        OR unlock_cause = 'Toy Scan' 
        OR unlock_cause = 'Deep_Link')
        AND isnewtoy = 1
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
    GROUP BY user_id
),
Persona AS (
    SELECT user_id, 
           CASE WHEN `Number of Toys Unlocked` IN (1,2,3) THEN 'Persona #2'
                ELSE 'Persona #3' END AS `Persona Type`
    FROM unlock
)
SELECT CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END AS `Persona_Type`,
       COUNT(DISTINCT l.user_id) AS Total
FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` l
LEFT JOIN Persona p ON l.user_id = p.user_id
JOIN (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
    WHERE 1=1 
    AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
    AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
) install ON l.user_id = install.user_id
WHERE l.user_id IS NOT NULL
AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
--AND `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 [[AND {{ipersona}}]])
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
GROUP BY `Persona_Type`
having  `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 )
ORDER BY `Persona_Type`",43.25
"with gb4268  as (select 0)
,tbl_mau as
(
    select EXTRACT(YEAR FROM client_time) as year
        ,EXTRACT(MONTH FROM client_time) as month
        ,concat(EXTRACT(YEAR FROM client_time),' ',FORMAT_TIMESTAMP('%B', client_time)) as year_month
        ,count(distinct user_id) as users
        ,sum(cast(time_spent as int)) as total_time_spent
        ,sum(case when (session_id=1 or cast(time_between_sessions as int)>=30) then 1 else 0 end) as total_sessions
        ,sum(cast(time_spent as int)) / sum(case when (session_id=1 or cast(time_between_sessions as int)>=30) then 1 else 0 end) as time_result
        ,concat(EXTRACT(MINUTE FROM TIMESTAMP_SECONDS(cast(sum(cast(time_spent as int)) / sum(case when (session_id=1 or cast(time_between_sessions as int)>=30) then 1 else 0 end) as int))), ' min ', EXTRACT(SECOND FROM TIMESTAMP_SECONDS(cast(sum(cast(time_spent as int)) / sum(case when (session_id=1 or cast(time_between_sessions as int)>=30) then 1 else 0 end) as int))), ' sec') as `Average Time per Sessions`
    from `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
    join (
        select distinct user_id 
        from `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        where 1=1 
        and install_source in (select ua_filter from `applaydu.tbl_ua_filter` where 1=1   )
        and date(active_date) >= (select min(server_date) from `applaydu.tbl_date_filter` where 1=1  )
        and date(active_date) < date_add((select max(server_date) from `applaydu.tbl_date_filter` where 1=1  ), interval 1 day)
    ) using (user_id)
       
    where 1=1
        and not(t.game_id = 82471 and client_time <'2020-12-14')
        and date(client_time) >= date_sub(date_trunc(current_date(), month), interval 2 year)
        and date(client_time) < date_trunc(current_date(), month)
        and cast(time_spent as FLOAT64) >= 0
        and cast(time_spent as FLOAT64) < 86400
        and date(client_time) >= (select min(server_date) from `applaydu.tbl_date_filter` where 1=1  )
        and date(client_time) < date_add((select max(server_date) from `applaydu.tbl_date_filter` where 1=1  ), interval 1 day)
        and t.country in (select country from `applaydu.tbl_country_filter` where 1=1   )    
        and version in (select version from `applaydu.tbl_version_filter` where 1=1   )
    group by year, month, year_month
)
,t_users as
(
    select user_id
        ,EXTRACT(YEAR FROM server_date) as year
        ,EXTRACT(MONTH FROM server_date) as month
        ,concat(EXTRACT(YEAR FROM server_date),' ',FORMAT_TIMESTAMP('%B', server_date)) as year_month
        ,sum(total_time_spent) as total_time_spent
        ,sum(toy_unlocked_by_scan_count) as toy_unlocked_by_scan_count
        ,sum(scan_mode_finished_count) as scan_mode_finished_count
        
    from `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    join (
        select distinct user_id 
        from `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        where 1=1 
        and install_source in (select ua_filter from `applaydu.tbl_ua_filter` where 1=1   )
        and date(active_date) >= (select min(server_date) from `applaydu.tbl_date_filter` where 1=1  )
        and date(active_date) < date_add((select max(server_date) from `applaydu.tbl_date_filter` where 1=1  ), interval 1 day)
    ) using (user_id)
    where date(server_date) >= date_sub(date_trunc(current_date(), month), interval 2 year)
        and date(server_date) < date_trunc(current_date(), month)
        and date(server_date) >= (select min(server_date) from `applaydu.tbl_date_filter` where 1=1  )
        and date(server_date) < date_add((select max(server_date) from `applaydu.tbl_date_filter` where 1=1  ), interval 1 day)
        and t.country_name in (select country_name from `applaydu.tbl_country_filter` where 1=1   )   
        and version in (select version from `applaydu.tbl_version_filter` where 1=1   )   
    group by user_id, year, month, year_month
)
,t_scan_users as (
    select year
        ,month
        ,year_month
        ,count(distinct user_id) as users
        ,sum(total_time_spent) as sum_total_time_spent
        ,sum(total_time_spent) / count(distinct user_id) as time_result
        ,concat(EXTRACT(HOUR FROM TIMESTAMP_SECONDS(cast(sum(total_time_spent) / count(distinct user_id) as int))), ' hour ', EXTRACT(MINUTE FROM TIMESTAMP_SECONDS(cast(sum(total_time_spent) / count(distinct user_id) as int))), ' min ', EXTRACT(SECOND FROM TIMESTAMP_SECONDS(cast(sum(total_time_spent) / count(distinct user_id) as int))), ' sec') as time_spent
    from t_users
    where toy_unlocked_by_scan_count > 0 or scan_mode_finished_count > 0 
    group by year, month, year_month
)
,t_not_scan_users as (
   select year
        ,month
        ,year_month
        ,count(distinct user_id) as users
        ,sum(total_time_spent) as sum_total_time_spent
        ,sum(total_time_spent) / count(distinct user_id) as time_result
        ,concat(EXTRACT(HOUR FROM TIMESTAMP_SECONDS(cast(sum(total_time_spent) / count(distinct user_id) as int))), ' hour ', EXTRACT(MINUTE FROM TIMESTAMP_SECONDS(cast(sum(total_time_spent) / count(distinct user_id) as int))), ' min ', EXTRACT(SECOND FROM TIMESTAMP_SECONDS(cast(sum(total_time_spent) / count(distinct user_id) as int))), ' sec') as time_spent
    from t_users
    where toy_unlocked_by_scan_count = 0 and  scan_mode_finished_count = 0 
    group by year, month, year_month
)
   
select year, month, year_month as `Time`
    ,tbl_mau.users as `Users`
    ,t_scan_users.users as `Scanned Users`
    ,t_scan_users.users / tbl_mau.users as `Scan users ratio`
    ,tbl_mau.users as `Users`
    ,`Average Time per Sessions`
    ,t_scan_users.time_spent as `Average Time per scanned user`
    ,t_not_scan_users.time_spent as `Average Time per NOT scanned user`
from tbl_mau
    join t_scan_users using (year, month, year_month)
    join t_not_scan_users using (year, month, year_month)
order by year asc, month asc",40.958984375
"WITH gb4244 as (select 0)
,tbl_mau AS (
    SELECT 
        EXTRACT(YEAR FROM client_time) AS year,
        EXTRACT(MONTH FROM client_time) AS month,
        CONCAT(EXTRACT(YEAR FROM client_time), ' ', FORMAT_TIMESTAMP('%B', client_time)) AS year_month,
        COUNT(DISTINCT user_id) AS users,
        SUM(CAST(time_spent AS INT)) AS total_time_spent,
        SUM(CASE WHEN (session_id = 1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) AS total_sessions,
        SUM(CAST(time_spent AS INT)) /  SUM(CASE WHEN (session_id = 1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) AS time_result,
       -- CONCAT(FORMAT_TIMESTAMP('%M', TIMESTAMP_SECONDS(CAST(time_result AS INT))), ' min ', FORMAT_TIMESTAMP('%S', TIMESTAMP_SECONDS(CAST(time_result AS INT))), ' sec') AS `Average Time per Sessions`
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
        AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    ) USING (user_id)
    WHERE 1=1
        AND NOT (t.game_id = 82471 AND client_time < '2020-12-14')
        AND client_time >= TIMESTAMP(DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 2 YEAR))
        AND client_time < TIMESTAMP(DATE_TRUNC(CURRENT_DATE(), MONTH))
        AND CAST(time_spent AS FLOAT64) >= 0
        AND CAST(time_spent AS FLOAT64) < 86400
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY year, month, year_month
),
t_users AS (
    SELECT 
        user_id,
        EXTRACT(YEAR FROM server_date) AS year,
        EXTRACT(MONTH FROM server_date) AS month,
        CONCAT(EXTRACT(YEAR FROM server_date), ' ', FORMAT_TIMESTAMP('%B', server_date)) AS year_month,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
        AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    ) USING (user_id)
    WHERE server_date >= TIMESTAMP(DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 2 YEAR))
        AND server_date < TIMESTAMP(DATE_TRUNC(CURRENT_DATE(), MONTH))
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY user_id, year, month, year_month
),
t_scan_users AS (
    SELECT 
        year,
        month,
        year_month,
        COUNT(DISTINCT user_id) AS users,
        SUM(total_time_spent) AS sum_total_time_spent,
        SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
        --CONCAT(FORMAT_TIMESTAMP('%H', TIMESTAMP_SECONDS(CAST(time_result AS INT))), ' hour ', FORMAT_TIMESTAMP('%M', TIMESTAMP_SECONDS(CAST(time_result AS INT))), ' min ', FORMAT_TIMESTAMP('%S', TIMESTAMP_SECONDS(CAST(time_result AS INT))), ' sec') AS time_spent
    FROM t_users
    WHERE toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0
    GROUP BY year, month, year_month
),
t_not_scan_users AS (
    SELECT 
        year,
        month,
        year_month,
        COUNT(DISTINCT user_id) AS users,
        SUM(total_time_spent) AS sum_total_time_spent,
        SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
        --CONCAT(FORMAT_TIMESTAMP('%H', TIMESTAMP_SECONDS(CAST(time_result AS INT))), ' hour ', FORMAT_TIMESTAMP('%M', TIMESTAMP_SECONDS(CAST(time_result AS INT))), ' min ', FORMAT_TIMESTAMP('%S', TIMESTAMP_SECONDS(CAST(time_result AS INT))), ' sec') AS time_spent
    FROM t_users
    WHERE toy_unlocked_by_scan_count = 0 AND scan_mode_finished_count = 0
    GROUP BY year, month, year_month
)
SELECT 
    year,
    month,
    year_month AS `Time`,
    tbl_mau.users AS `Users`,
    t_scan_users.users AS `Scanned Users`,
    t_scan_users.users / tbl_mau.users AS `Scan users ratio`,
   -- `Average Time per Sessions`,
   CONCAT(FORMAT_TIMESTAMP('%M', TIMESTAMP_SECONDS(CAST(tbl_mau.time_result AS INT))), ' min ', FORMAT_TIMESTAMP('%S', TIMESTAMP_SECONDS(CAST(tbl_mau.time_result AS INT))), ' sec') AS `Average Time per Sessions`,
   -- t_scan_users.time_spent AS `Average Time per scanned user`,
   CONCAT(FORMAT_TIMESTAMP('%H', TIMESTAMP_SECONDS(CAST(t_scan_users.time_result AS INT))), ' hour ', FORMAT_TIMESTAMP('%M', TIMESTAMP_SECONDS(CAST(t_scan_users.time_result AS INT))), ' min ', FORMAT_TIMESTAMP('%S', TIMESTAMP_SECONDS(CAST(t_scan_users.time_result AS INT))), ' sec') AS `Average Time per scanned user`,
   -- t_not_scan_users.time_spent AS `Average Time per NOT scanned user`
   CONCAT(FORMAT_TIMESTAMP('%H', TIMESTAMP_SECONDS(CAST(t_not_scan_users.time_result AS INT))), ' hour ', FORMAT_TIMESTAMP('%M', TIMESTAMP_SECONDS(CAST(t_not_scan_users.time_result AS INT))), ' min ', FORMAT_TIMESTAMP('%S', TIMESTAMP_SECONDS(CAST(t_not_scan_users.time_result AS INT))), ' sec') AS `Average Time per NOT scanned user`
FROM tbl_mau
JOIN t_scan_users USING (year, month, year_month)
JOIN t_not_scan_users USING (year, month, year_month)
ORDER BY year DESC, month DESC",40.958984375
"WITH gb4273 as (SELECT 0)
,tbl_ls_scan_users AS (
    SELECT DISTINCT user_id
    FROM (
        SELECT user_id
        FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
        JOIN (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
        ) USING (user_id)
        WHERE utm_campaign LIKE '%KCLTS%'
            AND version >= '5.0.0'
            AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
            AND DATE(server_time) < CURRENT_DATE()
            AND DATE(server_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
            AND DATE(server_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
            AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
            AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        UNION ALL 
        SELECT user_id
        FROM `gcp-bi-elephant-db-gold.applaydu.scan_mode_finished`
        JOIN (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
        ) USING (user_id)
        WHERE (
            (reference LIKE '%KCLTS%' AND NOT (game_id != 81335 AND scan_type = 'Deep Link')) 
            OR scan_type = 'Scan_QR_LS'
        )
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND scan_result IN ('New_Toy', 'Old_Toy')
    )
),
tbl_ls_user_activity AS (
    SELECT 
        t.*,
        d1.name AS language,
        d2.name AS location,
        d3.name AS hero,
        d4.name AS sidekick,
        d5.name AS plot,
        d6.name AS theme
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished` t
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d1 ON d1.id = activity_01_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d2 ON d2.id = activity_02_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d3 ON d3.id = activity_03_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d4 ON d4.id = activity_04_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d5 ON d5.id = activity_05_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d6 ON d6.id = activity_06_value 
    WHERE activity_01 = 'Experience - Lets Story - New Story Created'
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND user_id IN (SELECT DISTINCT user_id FROM tbl_ls_scan_users)
)
SELECT n2.name AS Language, COUNT(0) AS stories
FROM tbl_ls_user_activity
LEFT JOIN UNNEST([
    STRUCT('en' AS id, 'English' AS name),
    STRUCT('es' AS id, 'Spanish' AS name),
    STRUCT('de' AS id, 'German' AS name),
    STRUCT('it' AS id, 'Italian' AS name),
    STRUCT('pt' AS id, 'Portuguese' AS name),
    STRUCT('fr' AS id, 'French' AS name),
    STRUCT('pl' AS id, 'Polish' AS name),
    STRUCT('ko' AS id, 'Korean' AS name),
    STRUCT('hu' AS id, 'Hungarian' AS name),
    STRUCT('nl' AS id, 'Dutch' AS name),
    STRUCT('zh-Hant' AS id, 'Traditional Chinese' AS name),
    STRUCT('ar' AS id, 'Arabic' AS name),
    STRUCT('zh-Hans' AS id, 'Simplified Chinese' AS name)
]) AS n2 ON n2.id = tbl_ls_user_activity.language
GROUP BY Language
ORDER BY stories DESC",39.7548828125
"WITH gb4245 as (select 0)
,kdr_scan_users AS (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.scan_mode_finished`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_kinderini_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND scan_result IN ('New_Toy', 'Old_Toy')
        AND (
            (scan_type = 'Deep Link' AND UPPER(reference) LIKE '%KINDERINI%')
            OR scan_type IN ('Scan_Toy_Biscuit', 'Scan_QR_Biscuit')
        )
),
filter_sst AS (
    SELECT * 
    FROM `gcp-bi-elephant-db-gold.applaydu.story_step_finished`
    JOIN kdr_scan_users USING (user_id)
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_kinderini_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND environment_id = 'Kinderini'
),
tap_emotion_user AS (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.story_mode_triggered`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_kinderini_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND environment_id = 'Kinderini'
        AND click_from IN (
            'Eduland Kinderini Menu - Cluster - Wonder',
            'Eduland Kinderini Menu - Cluster - Happiness',
            'Eduland Kinderini Menu - Cluster - Kindness',
            'Eduland Kinderini Menu - Cluster - Fearfulness'
        )
        AND user_id IN (SELECT DISTINCT user_id FROM kdr_scan_users)
),
result AS (
    SELECT 
        'Kinderini Scan Users' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM kdr_scan_users
    UNION ALL 
    SELECT 
        'Tap Emotion Cluster' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM tap_emotion_user
    UNION ALL
    SELECT 
        'Drawing Start' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Drawing MIG' AND user_selection = 'Started'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Drawing Stop' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Drawing MIG' AND user_selection = 'Finished'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Finding Start' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Finding MIG' AND user_selection = 'Started'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Finding Stop' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Finding MIG' AND user_selection = 'Finished'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Catching Start' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Catching MIG' AND user_selection = 'Started'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Catching Stop' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Catching MIG' AND user_selection = 'Finished'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Diary Start' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Dairy Screen' AND user_selection = 'Started'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Diary Stop' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Dairy Screen' AND user_selection = 'Finished'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
)
SELECT * FROM result",34.357421875
"WITH gb4245 as (select 0)
,kdr_scan_users AS (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.scan_mode_finished`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_kinderini_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND scan_result IN ('New_Toy', 'Old_Toy')
        AND (
            (scan_type = 'Deep Link' AND UPPER(reference) LIKE '%KINDERINI%')
            OR scan_type IN ('Scan_Toy_Biscuit', 'Scan_QR_Biscuit')
        )
),
filter_sst AS (
    SELECT * 
    FROM `gcp-bi-elephant-db-gold.applaydu.story_step_finished`
    JOIN kdr_scan_users USING (user_id)
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_kinderini_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND environment_id = 'Kinderini'
),
tap_emotion_user AS (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.story_mode_triggered`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_kinderini_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND environment_id = 'Kinderini'
        AND click_from IN (
            'Eduland Kinderini Menu - Cluster - Wonder',
            'Eduland Kinderini Menu - Cluster - Happiness',
            'Eduland Kinderini Menu - Cluster - Kindness',
            'Eduland Kinderini Menu - Cluster - Fearfulness'
        )
        AND user_id IN (SELECT DISTINCT user_id FROM kdr_scan_users)
),
result AS (
    SELECT 
        'Kinderini Scan Users' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM kdr_scan_users
    UNION ALL 
    SELECT 
        'Tap Emotion Cluster' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM tap_emotion_user
    UNION ALL
    SELECT 
        'Drawing Start' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Drawing MIG' AND user_selection = 'Started'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Drawing Stop' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Drawing MIG' AND user_selection = 'Finished'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Finding Start' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Finding MIG' AND user_selection = 'Started'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Finding Stop' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Finding MIG' AND user_selection = 'Finished'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Catching Start' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Catching MIG' AND user_selection = 'Started'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Catching Stop' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Catching MIG' AND user_selection = 'Finished'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Diary Start' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Dairy Screen' AND user_selection = 'Started'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Diary Stop' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Dairy Screen' AND user_selection = 'Finished'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
)
SELECT * FROM result",34.357421875
"WITH tbl_ls_user_activity AS (
    SELECT t.*, 
        d1.name AS language, 
        d2.name AS location, 
        d3.name AS hero, 
        d4.name AS sidekick, 
        d5.name AS plot, 
        d6.name AS theme
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished` t
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d1 ON d1.id = t.activity_01_value
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d2 ON d2.id = t.activity_02_value
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d3 ON d3.id = t.activity_03_value
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d4 ON d4.id = t.activity_04_value
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d5 ON d5.id = t.activity_05_value
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d6 ON d6.id = t.activity_06_value
    WHERE activity_01 = 'Experience - Lets Story - New Story Created'
        AND version >= '5.0.0' 
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    n2.name AS `Language`, 
    COUNT(*) AS stories
FROM tbl_ls_user_activity
LEFT JOIN UNNEST([
    STRUCT('en' AS id, 'English' AS name),
    STRUCT('es', 'Spanish'),
    STRUCT('de', 'German'),
    STRUCT('it', 'Italian'),
    STRUCT('pt', 'Portuguese'),
    STRUCT('fr', 'French'),
    STRUCT('pl', 'Polish'),
    STRUCT('ko', 'Korean'),
    STRUCT('hu', 'Hungarian'),
    STRUCT('nl', 'Dutch'),
    STRUCT('zh-Hant', 'Traditional Chinese'),
    STRUCT('ar', 'Arabic'),
    STRUCT('zh-Hans', 'Simplified Chinese')
]) AS n2 ON n2.id = tbl_ls_user_activity.language
GROUP BY `Language`
ORDER BY stories DESC;",33.533203125
"WITH tbl_ls_user_activity AS (
    SELECT t.*, 
        d1.name AS language, 
        d2.name AS location, 
        d3.name AS hero, 
        d4.name AS sidekick, 
        d5.name AS plot, 
        d6.name AS theme
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished` t
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d1 ON d1.id = t.activity_01_value
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d2 ON d2.id = t.activity_02_value
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d3 ON d3.id = t.activity_03_value
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d4 ON d4.id = t.activity_04_value
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d5 ON d5.id = t.activity_05_value
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d6 ON d6.id = t.activity_06_value
    WHERE activity_01 = 'Experience - Lets Story - New Story Created'
        AND version >= '5.0.0' 
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    n2.name AS `Language`, 
    COUNT(*) AS stories
FROM tbl_ls_user_activity
LEFT JOIN UNNEST([
    STRUCT('en' AS id, 'English' AS name),
    STRUCT('es', 'Spanish'),
    STRUCT('de', 'German'),
    STRUCT('it', 'Italian'),
    STRUCT('pt', 'Portuguese'),
    STRUCT('fr', 'French'),
    STRUCT('pl', 'Polish'),
    STRUCT('ko', 'Korean'),
    STRUCT('hu', 'Hungarian'),
    STRUCT('nl', 'Dutch'),
    STRUCT('zh-Hant', 'Traditional Chinese'),
    STRUCT('ar', 'Arabic'),
    STRUCT('zh-Hans', 'Simplified Chinese')
]) AS n2 ON n2.id = tbl_ls_user_activity.language
GROUP BY `Language`
ORDER BY stories DESC;",33.533203125
"WITH tbl_user_activity AS (
    SELECT *
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
    WHERE activity_01 = 'Experience - Lets Story - Complex Word Clicked'
        AND scene_name = 'Eduland Lets Story'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    SUM(ACTIVITY_01_VALUE) AS Events,
    COUNT(DISTINCT user_id) AS users,
    SAFE_DIVIDE(SUM(ACTIVITY_01_VALUE), COUNT(DISTINCT user_id)) AS avg_event
FROM tbl_user_activity;",32.4765625
"WITH tbl_user_activity AS (
    SELECT *
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
    WHERE activity_01 = 'Experience - Lets Story - Complex Word Clicked'
        AND scene_name = 'Eduland Lets Story'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    SUM(ACTIVITY_01_VALUE) AS Events,
    COUNT(DISTINCT user_id) AS users,
    SAFE_DIVIDE(SUM(ACTIVITY_01_VALUE), COUNT(DISTINCT user_id)) AS avg_event
FROM tbl_user_activity;",32.4765625
"SELECT 
    CASE 
        WHEN activity_01_value = 1 THEN 'Age 3-5'  
        WHEN activity_01_value = 2 THEN 'Age 5-7'  
        ELSE 'Age 7+' 
    END AS `User age`,
    COUNT(DISTINCT user_id)
FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
WHERE scene_name = 'Eduland Lets Story'
    AND activity_01 = 'Experience - Lets Story - Reading Level' 
    AND activity_01_value > 0
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY `User age`
ORDER BY `User age` ASC;",32.4755859375
"SELECT 
    CASE 
        WHEN activity_01_value = 1 THEN 'Age 3-5'  
        WHEN activity_01_value = 2 THEN 'Age 5-7'  
        ELSE 'Age 7+' 
    END AS `User age`,
    COUNT(DISTINCT user_id)
FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
WHERE scene_name = 'Eduland Lets Story'
    AND activity_01 = 'Experience - Lets Story - Reading Level' 
    AND activity_01_value > 0
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY `User age`
ORDER BY `User age` ASC;",32.3291015625
"SELECT 
    CASE 
        WHEN activity_01_value = 1 THEN 'Age 3-5'  
        WHEN activity_01_value = 2 THEN 'Age 5-7'  
        ELSE 'Age 7+' 
    END AS `User age`,
    COUNT(DISTINCT user_id)
FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
WHERE scene_name = 'Eduland Lets Story'
    AND activity_01 = 'Experience - Lets Story - Reading Level' 
    AND activity_01_value > 0
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY `User age`
ORDER BY `User age` ASC;",32.3291015625
"SELECT 
    CASE 
        WHEN activity_01_value = 1 THEN 'Age 3-5'  
        WHEN activity_01_value = 2 THEN 'Age 5-7'  
        ELSE 'Age 7+' 
    END AS `User age`,
    COUNT(DISTINCT user_id)
FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
WHERE scene_name = 'Eduland Lets Story'
    AND activity_01 = 'Experience - Lets Story - Reading Level' 
    AND activity_01_value > 0
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY `User age`
ORDER BY `User age` ASC;",32.3291015625
"SELECT 
    CASE 
        WHEN activity_01_value = 1 THEN 'Age 3-5'  
        WHEN activity_01_value = 2 THEN 'Age 5-7'  
        ELSE 'Age 7+' 
    END AS `User age`,
    COUNT(DISTINCT user_id)
FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
WHERE scene_name = 'Eduland Lets Story'
    AND activity_01 = 'Experience - Lets Story - Reading Level' 
    AND activity_01_value > 0
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY `User age`
ORDER BY `User age` ASC;",32.3291015625
"SELECT 
    CASE 
        WHEN activity_01_value = 1 THEN 'Age 3-5'  
        WHEN activity_01_value = 2 THEN 'Age 5-7'  
        ELSE 'Age 7+' 
    END AS `User age`,
    COUNT(DISTINCT user_id)
FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
WHERE scene_name = 'Eduland Lets Story'
    AND activity_01 = 'Experience - Lets Story - Reading Level' 
    AND activity_01_value > 0
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY `User age`
ORDER BY `User age` ASC;",32.3291015625
"SELECT 
    CASE 
        WHEN activity_01_value = 1 THEN 'Age 3-5'  
        WHEN activity_01_value = 2 THEN 'Age 5-7'  
        ELSE 'Age 7+' 
    END AS `User age`,
    COUNT(DISTINCT user_id)
FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
WHERE scene_name = 'Eduland Lets Story'
    AND activity_01 = 'Experience - Lets Story - Reading Level' 
    AND activity_01_value > 0
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY `User age`
ORDER BY `User age` ASC;",32.3291015625
"SELECT 
    CASE 
        WHEN activity_01_value = 1 THEN 'Age 3-5'  
        WHEN activity_01_value = 2 THEN 'Age 5-7'  
        ELSE 'Age 7+' 
    END AS `User age`,
    COUNT(DISTINCT user_id)
FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
WHERE scene_name = 'Eduland Lets Story'
    AND activity_01 = 'Experience - Lets Story - Reading Level' 
    AND activity_01_value > 0
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY `User age`
ORDER BY `User age` ASC;",32.3291015625
"SELECT 
    CASE 
        WHEN activity_01_value = 1 THEN 'Age 3-5'  
        WHEN activity_01_value = 2 THEN 'Age 5-7'  
        ELSE 'Age 7+' 
    END AS `User age`,
    COUNT(DISTINCT user_id)
FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
WHERE scene_name = 'Eduland Lets Story'
    AND activity_01 = 'Experience - Lets Story - Reading Level' 
    AND activity_01_value > 0
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY `User age`
ORDER BY `User age` ASC;",32.3291015625
"SELECT 
    CASE 
        WHEN activity_01_value = 1 THEN 'Age 3-5'  
        WHEN activity_01_value = 2 THEN 'Age 5-7'  
        ELSE 'Age 7+' 
    END AS `User age`,
    COUNT(DISTINCT user_id)
FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
WHERE scene_name = 'Eduland Lets Story'
    AND activity_01 = 'Experience - Lets Story - Reading Level' 
    AND activity_01_value > 0
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY `User age`
ORDER BY `User age` ASC;",32.3291015625
"WITH gb4260 as (SELECT 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (unlock_cause = 'QR Code'
        OR unlock_cause = 'Toy Scan' 
        OR unlock_cause = 'Deep_Link')
        AND isnewtoy = 1
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
        AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1  )
    GROUP BY user_id
),
Persona AS (
    SELECT user_id, 
           CASE WHEN `Number of Toys Unlocked` IN (1,2,3) THEN 'Persona #2'
                ELSE 'Persona #3' END AS `Persona Type`
    FROM unlock
)
SELECT EXTRACT(YEAR FROM client_time) AS year,
       EXTRACT(MONTH FROM client_time) AS month,
       CONCAT(EXTRACT(YEAR FROM client_time), ' ', FORMAT_TIMESTAMP('%B', client_time)) AS `Time`,
       CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END AS `Persona_Type`,
       COUNT(DISTINCT l.user_id) AS Total
FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` l
JOIN (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
    WHERE 1=1 
    AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
) USING (user_id)
LEFT JOIN Persona p ON l.user_id = p.user_id
WHERE l.user_id IS NOT NULL
AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
AND client_time >= TIMESTAMP((SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ))
AND client_time < TIMESTAMP(DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY))
AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1  )
AND CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
AND client_time >= TIMESTAMP(DATE_SUB(DATE_TRUNC(CURRENT_DATE(), month), INTERVAL 2 YEAR))
AND client_time < TIMESTAMP(DATE_TRUNC(CURRENT_DATE(), month))
GROUP BY year, month, `Time`, `Persona_Type`
ORDER BY year ASC, month ASC, `Persona_Type` ASC",32.240234375
"WITH story_creation AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to = 'Eduland Lets Story - Story Creation'
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    SAFE_DIVIDE(COUNT(DISTINCT user_id), (SELECT users FROM story_creation)) AS `% Users finish creating story`
FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
WHERE activity_01 = 'Experience - Lets Story - New Story Created'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 );",32.2177734375
"WITH story_creation AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to = 'Eduland Lets Story - Story Creation'
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    SAFE_DIVIDE(COUNT(DISTINCT user_id), (SELECT users FROM story_creation)) AS `% Users finish creating story`
FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
WHERE activity_01 = 'Experience - Lets Story - New Story Created'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 );",32.2177734375
"with gb4227 as (select 0)
,v_scan_mode_finished_vr as
(
    (
    select user_id
        ,game_id
        ,date(server_date)
        ,version
        ,t.country_name
        ,'New_Toy' as scan_result
        ,coalesce(toy_name,'Undefined') as toy_name
        ,coalesce(toy_detected ,'Undefined') as toy_detected
        ,'Scan_Toy' as scan_type
        ,count(0) as event_count
    
    from `gcp-gfb-sai-tracking-gold.applaydu.tbl_scan_mode_finished_24x` t
        join `applaydu.tbl_country_vr`using (country)
    where (DATE(server_date) >= DATE('2021-01-06') and DATE(server_date) < date_sub(current_date(), interval 3 day))
        and date(server_date) >= (select min(server_date) from `applaydu.tbl_date_filter` where 1=1  )
        and date(server_date) < date_add((select max(server_date) from `applaydu.tbl_date_filter` where 1=1  ), interval 1 day)
        and t.country in (select country from `applaydu.tbl_country_filter` where 1=1   )
        and t.country in (select country from `applaydu.tbl_country_filter` where 1=1  ) 
        and version in (select version from `applaydu.tbl_version_filter` where 1=1  )
        and game_id in (select game_id from `applaydu.tbl_shop_filter` where 1=1  )
        and server_date >= `applaydu.tbl_country_vr`.start_date
        and user_id is not null
        and total_scan > 0 and visenze_new_toy_count>0
    group by user_id
        ,game_id
        ,server_date
        ,version
        ,t.country_name
        ,scan_result
        ,toy_name
        ,toy_detected 
        ,scan_type
    
    )
   
    union all
    (
    select user_id
        ,game_id
        ,date(server_date)
        ,version
        ,t.country_name
        ,'Old_Toy' as scan_result
        ,coalesce(toy_name,'Undefined') as toy_name
        ,coalesce(toy_detected ,'Undefined') as toy_detected
        ,'Scan_Toy' as scan_type
        ,sum(case when visenze_new_toy_count>0 then (total_scan-1) else total_scan end) as event_count
    
    from `gcp-gfb-sai-tracking-gold.applaydu.tbl_scan_mode_finished_24x` t
        join `applaydu.tbl_country_vr` on `applaydu.tbl_country_vr`.country = t.country
    where (date(server_date) >= date('2021-01-06') and date(server_date) < date_sub(current_date(), interval 3 day))
        and date(server_date) >= (select min(server_date) from `applaydu.tbl_date_filter` where 1=1  )
        and date(server_date) < date_add((select max(server_date) from `applaydu.tbl_date_filter` where 1=1  ), interval 1 day)
        and t.country in (select country from `applaydu.tbl_country_filter` where 1=1   )
        and t.country in (select country from `applaydu.tbl_country_filter` where 1=1  ) 
        and version in (select version from `applaydu.tbl_version_filter` where 1=1  ) 
        and game_id in (select game_id from `applaydu.tbl_shop_filter` where 1=1  )
        and server_date >= `applaydu.tbl_country_vr`.start_date
        and user_id is not null
        and total_scan > 1 
    group by user_id
        ,game_id
        ,server_date
        ,version
        ,t.country_name
        ,scan_result
        ,toy_name
        ,toy_detected 
        ,scan_type
    )
   
    union all
    (
    select t.user_id
      ,t.game_id
      ,date(t.server_time) as server_date
      ,t.version
      ,`applaydu.tbl_country_vr`.country_name as country_name
      ,t.scan_result
      ,coalesce(t.toy_name,'Undefined') as toy_name
      ,case when t.scan_type = 'Scan_Toy' and version in ('2.0.1','2.0.2','2.0.4','2.0.7','2.0.8','2.0.9','2.2.0','2.2.1','2.2.2','2.2.3','2.3.0','2.3.1','2.4.3','2.5.0','2.6.0','2.6.1','2.6.2','2.6.3','2.7.0','2.7.1','2.7.2','2.7.3','3.0.0','3.0.1','3.0.2','3.0.3','3.0.4','3.0.5','3.0.6','3.0.7')
        then coalesce(upper(t.toy_detected),'Undefined') 
        else 
            (case when t.reference is null or  t.reference = 'N/A' then 'Undefined' else coalesce(upper(regexp_substr(t.reference, '[^/]*$')),'Undefined') end)
        end as toy_detected
      ,case when t.toy_detected like '%_leftover' and t.reference not like 'http%' and t.version in ('3.1.0','3.1.2','3.2.0','3.2.1') then 'Scan_Toy' else scan_type end as scan_type
      ,count(0) as event_count
       
    from `gcp-bi-elephant-db-gold.applaydu.scan_mode_finished` t
        join `applaydu.tbl_country_vr` on `applaydu.tbl_country_vr`.country = t.country
    where  (date(server_time) >= date('2021-01-06') and date(server_time) < date_sub(current_date(), interval 3 day))
        and date(server_time) >= (select min(server_date) from `applaydu.tbl_date_filter` where 1=1  )
        and date(server_time) < date_add((select max(server_date) from `applaydu.tbl_date_filter` where 1=1  ), interval 1 day)
        and t.country in (select country from `applaydu.tbl_country_filter` where 1=1   )
        and t.country in (select country from `applaydu.tbl_country_filter` where 1=1  ) 
        and version in (select version from `applaydu.tbl_version_filter` where 1=1  ) 
        and game_id in (select game_id from `applaydu.tbl_shop_filter` where 1=1  )
        and date(server_time) >= date(`applaydu.tbl_country_vr`.start_date)
        and t.user_id is not null
        and scan_result in ('New_Toy','Old_Toy')
       
    group by t.user_id
      ,t.game_id
      ,server_date
      ,t.version
      ,country_name
      ,t.scan_result
      ,t.reference
      ,t.toy_name
      ,t.toy_detected
      ,t.scan_type
    )
)
select case when scan_type in ('Scan_Toy') then 'Scan Toy' else 'Scan Leaflet' end as `Scan type`,
    sum(event_count) as total_scan
from   v_scan_mode_finished_vr
    join (
        select distinct user_id 
        from `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        where 1=1 
        and install_source in (select ua_filter from `applaydu.tbl_ua_filter` where 1=1  )
        and date(active_date) >= (select min(server_date) from `applaydu.tbl_date_filter` where 1=1  )
        and date(active_date) < date_add((select max(server_date) from `applaydu.tbl_date_filter` where 1=1  ), interval 1 day)
    ) using (user_id)
where scan_type in ('Scan_Toy','Alternative_Vignette','Scan_QR','Scan_Vignette')
group by 1

union all
select 'Deeplink' as `Scan type`
,count(0) as `Total scans`
from `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    join (
        select distinct user_id 
        from `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        where 1=1 
        and install_source in (select ua_filter from `applaydu.tbl_ua_filter` where 1=1  )
        and date(active_date) >= (select min(server_date) from `applaydu.tbl_date_filter` where 1=1  )
        and date(active_date) < date_add((select max(server_date) from `applaydu.tbl_date_filter` where 1=1  ), interval 1 day)
    ) using (user_id)
where unlock_cause in ('Deep_Link')
    and date(server_time) >= date('2020-08-10') and date(server_time) < date_sub(current_date(), interval 3 day)
        and date(server_time) >= (select min(server_date) from `applaydu.tbl_date_filter` where 1=1  )
        and date(server_time) < date_add((select max(server_date) from `applaydu.tbl_date_filter` where 1=1  ), interval 1 day)
        and country in (select country from `applaydu.tbl_country_filter` where 1=1   )
        and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
        and game_id in (select game_id from `applaydu.tbl_shop_filter` where 1=1  )",31.9189453125
"with gb4227 as (select 0)
,v_scan_mode_finished_vr as
(
    (
    select user_id
        ,game_id
        ,date(server_date)
        ,version
        ,t.country_name
        ,'New_Toy' as scan_result
        ,coalesce(toy_name,'Undefined') as toy_name
        ,coalesce(toy_detected ,'Undefined') as toy_detected
        ,'Scan_Toy' as scan_type
        ,count(0) as event_count
    
    from `gcp-gfb-sai-tracking-gold.applaydu.tbl_scan_mode_finished_24x` t
        join `applaydu.tbl_country_vr`using (country)
    where (DATE(server_date) >= DATE('2021-01-06') and DATE(server_date) < date_sub(current_date(), interval 3 day))
        and date(server_date) >= (select min(server_date) from `applaydu.tbl_date_filter` where 1=1  )
        and date(server_date) < date_add((select max(server_date) from `applaydu.tbl_date_filter` where 1=1  ), interval 1 day)
        and t.country in (select country from `applaydu.tbl_country_filter` where 1=1   )
        and t.country in (select country from `applaydu.tbl_country_filter` where 1=1  ) 
        and version in (select version from `applaydu.tbl_version_filter` where 1=1  )
        and game_id in (select game_id from `applaydu.tbl_shop_filter` where 1=1  )
        and server_date >= `applaydu.tbl_country_vr`.start_date
        and user_id is not null
        and total_scan > 0 and visenze_new_toy_count>0
    group by user_id
        ,game_id
        ,server_date
        ,version
        ,t.country_name
        ,scan_result
        ,toy_name
        ,toy_detected 
        ,scan_type
    
    )
   
    union all
    (
    select user_id
        ,game_id
        ,date(server_date)
        ,version
        ,t.country_name
        ,'Old_Toy' as scan_result
        ,coalesce(toy_name,'Undefined') as toy_name
        ,coalesce(toy_detected ,'Undefined') as toy_detected
        ,'Scan_Toy' as scan_type
        ,sum(case when visenze_new_toy_count>0 then (total_scan-1) else total_scan end) as event_count
    
    from `gcp-gfb-sai-tracking-gold.applaydu.tbl_scan_mode_finished_24x` t
        join `applaydu.tbl_country_vr` on `applaydu.tbl_country_vr`.country = t.country
    where (date(server_date) >= date('2021-01-06') and date(server_date) < date_sub(current_date(), interval 3 day))
        and date(server_date) >= (select min(server_date) from `applaydu.tbl_date_filter` where 1=1  )
        and date(server_date) < date_add((select max(server_date) from `applaydu.tbl_date_filter` where 1=1  ), interval 1 day)
        and t.country in (select country from `applaydu.tbl_country_filter` where 1=1   )
        and t.country in (select country from `applaydu.tbl_country_filter` where 1=1  ) 
        and version in (select version from `applaydu.tbl_version_filter` where 1=1  ) 
        and game_id in (select game_id from `applaydu.tbl_shop_filter` where 1=1  )
        and server_date >= `applaydu.tbl_country_vr`.start_date
        and user_id is not null
        and total_scan > 1 
    group by user_id
        ,game_id
        ,server_date
        ,version
        ,t.country_name
        ,scan_result
        ,toy_name
        ,toy_detected 
        ,scan_type
    )
   
    union all
    (
    select t.user_id
      ,t.game_id
      ,date(t.server_time) as server_date
      ,t.version
      ,`applaydu.tbl_country_vr`.country_name as country_name
      ,t.scan_result
      ,coalesce(t.toy_name,'Undefined') as toy_name
      ,case when t.scan_type = 'Scan_Toy' and version in ('2.0.1','2.0.2','2.0.4','2.0.7','2.0.8','2.0.9','2.2.0','2.2.1','2.2.2','2.2.3','2.3.0','2.3.1','2.4.3','2.5.0','2.6.0','2.6.1','2.6.2','2.6.3','2.7.0','2.7.1','2.7.2','2.7.3','3.0.0','3.0.1','3.0.2','3.0.3','3.0.4','3.0.5','3.0.6','3.0.7')
        then coalesce(upper(t.toy_detected),'Undefined') 
        else 
            (case when t.reference is null or  t.reference = 'N/A' then 'Undefined' else coalesce(upper(regexp_substr(t.reference, '[^/]*$')),'Undefined') end)
        end as toy_detected
      ,case when t.toy_detected like '%_leftover' and t.reference not like 'http%' and t.version in ('3.1.0','3.1.2','3.2.0','3.2.1') then 'Scan_Toy' else scan_type end as scan_type
      ,count(0) as event_count
       
    from `gcp-bi-elephant-db-gold.applaydu.scan_mode_finished` t
        join `applaydu.tbl_country_vr` on `applaydu.tbl_country_vr`.country = t.country
    where  (date(server_time) >= date('2021-01-06') and date(server_time) < date_sub(current_date(), interval 3 day))
        and date(server_time) >= (select min(server_date) from `applaydu.tbl_date_filter` where 1=1  )
        and date(server_time) < date_add((select max(server_date) from `applaydu.tbl_date_filter` where 1=1  ), interval 1 day)
        and t.country in (select country from `applaydu.tbl_country_filter` where 1=1   )
        and t.country in (select country from `applaydu.tbl_country_filter` where 1=1  ) 
        and version in (select version from `applaydu.tbl_version_filter` where 1=1  ) 
        and game_id in (select game_id from `applaydu.tbl_shop_filter` where 1=1  )
        and date(server_time) >= date(`applaydu.tbl_country_vr`.start_date)
        and t.user_id is not null
        and scan_result in ('New_Toy','Old_Toy')
       
    group by t.user_id
      ,t.game_id
      ,server_date
      ,t.version
      ,country_name
      ,t.scan_result
      ,t.reference
      ,t.toy_name
      ,t.toy_detected
      ,t.scan_type
    )
)
select case when scan_type in ('Scan_Toy') then 'Scan Toy' else 'Scan Leaflet' end as `Scan type`,
    sum(event_count) as total_scan
from   v_scan_mode_finished_vr
    join (
        select distinct user_id 
        from `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        where 1=1 
        and install_source in (select ua_filter from `applaydu.tbl_ua_filter` where 1=1  )
        and date(active_date) >= (select min(server_date) from `applaydu.tbl_date_filter` where 1=1  )
        and date(active_date) < date_add((select max(server_date) from `applaydu.tbl_date_filter` where 1=1  ), interval 1 day)
    ) using (user_id)
where scan_type in ('Scan_Toy','Alternative_Vignette','Scan_QR','Scan_Vignette')
group by 1

union all
select 'Deeplink' as `Scan type`
,count(0) as `Total scans`
from `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    join (
        select distinct user_id 
        from `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        where 1=1 
        and install_source in (select ua_filter from `applaydu.tbl_ua_filter` where 1=1  )
        and date(active_date) >= (select min(server_date) from `applaydu.tbl_date_filter` where 1=1  )
        and date(active_date) < date_add((select max(server_date) from `applaydu.tbl_date_filter` where 1=1  ), interval 1 day)
    ) using (user_id)
where unlock_cause in ('Deep_Link')
    and date(server_time) >= date('2020-08-10') and date(server_time) < date_sub(current_date(), interval 3 day)
        and date(server_time) >= (select min(server_date) from `applaydu.tbl_date_filter` where 1=1  )
        and date(server_time) < date_add((select max(server_date) from `applaydu.tbl_date_filter` where 1=1  ), interval 1 day)
        and country in (select country from `applaydu.tbl_country_filter` where 1=1   )
        and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
        and game_id in (select game_id from `applaydu.tbl_shop_filter` where 1=1  )",31.9189453125
"WITH gb4263 as (select 0)
,tbl_story_mode_finished as (
 select user_id,FED_ID,PLATFORM,game_id,EVENT_ID,min(client_time),min(client_time),version,country,SESSION_ID
,min(TOKEN),AVATAR_GENDER,END_CAUSE,TOY_NAME,STORY_STEP,avg(TIME_TO_FINISH)
,ACTIVITY_01,ACTIVITY_01_VALUE,ACTIVITY_02,ACTIVITY_02_VALUE,ACTIVITY_03,ACTIVITY_03_VALUE,ACTIVITY_04
,ACTIVITY_04_VALUE,ACTIVITY_05,ACTIVITY_05_VALUE,AVATAR_ONESIE,click_from,ENVIRONMENT_ID,min(EVENT_client_time_LOCAL)
,avg(REALTIME_SPENT),min(load_time),ACTIVITY_06,ACTIVITY_06_VALUE,ACTIVITY_07,ACTIVITY_07_VALUE
,ACTIVITY_08,ACTIVITY_08_VALUE,ACTIVITY_09,ACTIVITY_09_VALUE,ACTIVITY_10,ACTIVITY_10_VALUE,TOY_UNLOCKED_METHOD,from_scene
 from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 where (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0' 
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 group by all
)
,real_story_mode_finished as (
SELECT user_id,game_id,event_id,version,country,session_id,avatar_gender,end_cause,toy_name,story_step,realtime_spent,environment_id,client_time,toy_unlocked_method,count(*) as dup
FROM 
 (
 -- exclude Dino Exp
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished
 WHERE 
 environment_id like 'Natoons v4%' or
 -- DUPLICATIONS in those Experience
 (environment_id like '%Travel%' and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id NOT IN ('Savannah','Space','Ocean','Jungle','Magic Land','Experience - Dino Museum') AND (environment_id not LIKE '%Travel%') ) or 
 (environment_id='Kinderini' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_kinderini_start_date') ) or 
 (environment_id='Eduland Lets Story' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_v5_lets_story_start_date'))
 -- Dino 
 union all
 -- version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') (normal)
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 WHERE (version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19'))
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 union all
 -- (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0'
 select * from tbl_story_mode_finished
 )
group by all
)
,result as (
SELECT case when environment_id like 'Natoons v4%' then 'Natoons Experience'
 when environment_id like '%Travel%' then 'Travel Experience'
 when environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') then 'Fantasy Experience'
 when environment_id like '%Space%' and environment_id<>'Space' then 'Space Experience'
 when environment_id='Experience - Dino Museum' then 'Dino Experience - since v4.7.0'
 when environment_id='Kinderini' then 'Kinderini'
 when environment_id='Eduland Lets Story' then 'Lets Story'
 else null end as environment
,count (0) as `No of Session`,count (distinct user_id) as `No of Users`
,count (0)/count (distinct user_id) as `Sessions per user`,sum(realtime_spent)/count (distinct user_id)/60 as `Time spent per user in min`
,sum(realtime_spent)/count (0)/60 as `Time spent per session in min`
--,concat(floor(`Time spent per user in min`),' min ',round((`Time spent per user in min` - floor(`Time spent per user in min`)) * 60),' sec') as `Time spent per user (min - sec)`
--,concat(floor(`Time spent per session in min`),' min ',round((`Time spent per session in min` - floor(`Time spent per session in min`)) * 60),' sec') as `Time spent per session (min - sec)`
from real_story_mode_finished
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
group by 1
)
select * 
--,concat(floor(`Time spent per user in min`),' min ',round((`Time spent per user in min` - floor(`Time spent per user in min`)) * 60),' sec') as `Time spent per user in min sec`
--,concat(floor(`Time spent per session in min`),' min ',round((`Time spent per session in min` - floor(`Time spent per session in min`)) * 60),' sec') as `Time spent per session in min sec`

from result 
where Environment is not null
order by `Time spent per user in min` desc",31.728515625
"with gb4250 as (select 0)
,tbl_install as (
    SELECT user_id, DATE(MIN(install_date)) as install_date
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity`
    WHERE 1=1 
        AND install_country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
        AND install_source IN (SELECT install_source FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` WHERE 1=1 )
        AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1 )
    GROUP BY 1 
),
t_users as (
    SELECT user_id,
           SUM(sessions_count) as sessions_count,
           SUM(total_time_spent) as total_time_spent,
           SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) as scans
    FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
            AND DATE(ACTIVE_DATE) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(ACTIVE_DATE) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
    WHERE DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1 AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
        AND version >= (SELECT MIN(version) FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND version <= (SELECT MAX(version) FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 AND (`applaydu.tbl_version_filter`.`version` = ?))
        AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1 )
    GROUP BY user_id
),
tbl_launch_resume_src as (
    SELECT 'All' as period,
           SUM(time_spent) as `Total time spent`,
           COUNT(DISTINCT user_id) AS `Total Users`,
           SUM(time_spent) / COUNT(DISTINCT user_id) as time_result,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result)) AS `Average Time per Users`,
           SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) AS `Total Sessions`,
           SUM(time_spent) / SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) as time_result_sessions,
           --FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(time_result_sessions)) AS `Average Time per Session`,
           SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) /  COUNT(DISTINCT user_id) as `Average Session per User`,
           SUM(CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) as `Total Time Spent New users`,
           COUNT(DISTINCT CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) AS `Total New Users`,
           SUM(CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) / COUNT(DISTINCT CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as time_result_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_new_users)) AS `Average Time Spent Per New Users`,
           SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                          AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)) 
                    THEN 1 ELSE 0 END) AS `Total Sessions New Users`,
           SUM(CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) / SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                          AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)) 
                    THEN 1 ELSE 0 END) as time_result_sessions_new_users,
           --FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(time_result_sessions_new_users)) AS `Average Time per Session New Users`,
           SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                          AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)) 
                    THEN 1 ELSE 0 END) / COUNT(DISTINCT CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as `Average Session per New User`,
           SUM(CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) as `Total Time Spent Old users`,
           COUNT(DISTINCT CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) AS `Total Old Users`,
           SUM(CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) / COUNT(DISTINCT CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as time_result_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_old_users)) AS `Average Time Per Old Users`,
           SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)) 
                    THEN 1 ELSE 0 END) AS `Total Sessions Old Users`,
           SUM(CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) / SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)) 
                    THEN 1 ELSE 0 END) as time_result_sessions_old_users,
           --FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(time_result_sessions_old_users)) AS `Average Time per Session Old Users`,
           SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)) 
                    THEN 1 ELSE 0 END) / COUNT(DISTINCT CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as `Average Session per Old User`
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    LEFT JOIN tbl_install USING (user_id)
    WHERE CAST(time_spent AS INT) >= 0
        AND CAST(time_spent AS INT) < 86400
        AND version >= (SELECT MIN(version) FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND version <= (SELECT MAX(version) FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 AND (`applaydu.tbl_version_filter`.`version` = ?))
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND `gcp-bi-elephant-db-gold.applaydu.launch_resume`.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
        AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1 )
        AND (DATE(client_time) >= '2020-08-10' AND DATE(client_time) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY))
),
tbl_users_src as (
    SELECT 'All' as period,
           COUNT(DISTINCT CASE WHEN scans > 0 THEN user_id ELSE 0 END) as scan_users,
           SUM(CASE WHEN scans > 0 THEN total_time_spent ELSE 0 END) as sum_total_time_spent_scan_users,
           SUM(CASE WHEN scans > 0 THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans > 0 THEN user_id ELSE 0 END) as time_result_scan_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_scan_users)) AS `Time Spent Per Scan User`,
           SUM(CASE WHEN scans > 0 THEN sessions_count ELSE 0 END) as scan_sessions_count,
           SUM(CASE WHEN scans > 0 THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans > 0 THEN sessions_count ELSE 0 END) as time_result_session_scan_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_scan_users)) AS `Time Spent Per Session of Scan Users`,
           COUNT(DISTINCT CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as scan_new_users,
           SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) as sum_total_time_spent_scan_new_users,
            SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as time_result_scan_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_scan_new_users)) AS `Time Spent Per Scan New User`,
           SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) as scan_sessions_new_users_count,
           SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) as time_result_session_scan_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_scan_new_users)) AS `Time Spent Per Session of Scan New Users`,
           COUNT(DISTINCT CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as scan_old_users,
           SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) as sum_total_time_spent_scan_old_users,
           SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as time_result_scan_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_scan_old_users)) AS `Time Spent Per Scan Old User`,
           SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) as scan_sessions_old_users_count,
           CASE WHEN SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) = 0 THEN 0 ELSE SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) END as time_result_session_scan_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_scan_old_users)) AS `Time Spent Per Session of Scan Old Users`,
           COUNT(DISTINCT CASE WHEN scans = 0 THEN user_id ELSE 0 END) as free_users,
           SUM(CASE WHEN scans = 0 THEN total_time_spent ELSE 0 END) as sum_total_time_spent_free_users,
           SUM(CASE WHEN scans = 0 THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans = 0 THEN user_id ELSE 0 END) as time_result_free_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_free_users)) AS `Time Spent Per Free User`,
           SUM(CASE WHEN scans = 0 THEN sessions_count ELSE 0 END) as scan_sessions_free_users_count,
           CASE WHEN SUM(CASE WHEN scans = 0 THEN sessions_count ELSE 0 END) = 0 THEN 0 ELSE SUM(CASE WHEN scans = 0 THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans = 0 THEN sessions_count ELSE 0 END) END as time_result_session_free_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_free_users)) AS `Time Spent Per Session of Free Users`,
           COUNT(DISTINCT CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as free_new_users,
           SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) as sum_total_time_spent_free_new_users,
           SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as time_result_free_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_free_new_users)) AS `Time Spent Per Free New User`,
           SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) as scan_sessions_new_free_users_count,
           CASE WHEN SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) = 0 THEN 0 ELSE SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) END as time_result_session_free_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_free_new_users)) AS `Time Spent Per Session of Free New Users`,
           COUNT(DISTINCT CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as free_old_users,
           SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) as sum_total_time_spent_free_old_users,
           SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as time_result_free_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_free_old_users)) AS `Time Spent Per Free Old User`,
           SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) as scan_sessions_free_old_users_count,
           CASE WHEN SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) = 0 THEN 0 ELSE SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) END as time_result_session_free_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_free_old_users)) AS `Time Spent Per Session of Free Old Users`
    FROM t_users
    LEFT JOIN tbl_install USING (user_id)
)
select '01.Average Time per Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result AS INT64))) as value from tbl_launch_resume_src
union all select '02.Average Time Spent Per New Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_new_users AS INT64))) as value from tbl_launch_resume_src

union all select '03.Average Time Per Old Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_old_users AS INT64))) as value from tbl_launch_resume_src
union all select '04.Time Spent Per Scan User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_scan_users AS INT64))) as value from tbl_users_src
union all select '05.Time Spent Per Scan New User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_scan_new_users AS INT64))) as value from tbl_users_src
union all select '06.Time Spent Per Scan Old User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_scan_old_users AS INT64))) as value from tbl_users_src
union all select '07.Time Spent Per Free User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_free_users AS INT64))) as value from tbl_users_src
union all select '08.Time Spent Per Free New User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_free_new_users AS INT64))) as value from tbl_users_src
union all select '09.Time Spent Per Free Old User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_free_old_users AS INT64))) as value from tbl_users_src
union all select '10.Average Time per Session' as kpi, FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_sessions AS INT64))) as value from tbl_launch_resume_src
union all select '11.Average Time per Session New Users' as kpi, FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_sessions_new_users AS INT64))) as value from tbl_launch_resume_src
union all select '12.Average Time per Session Old Users' as kpi, FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_sessions_old_users AS INT64))) as value from tbl_launch_resume_src
union all select '13.Time Spent Per Session of Scan Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_scan_users AS INT64))) as value from tbl_users_src
union all select '14.Time Spent Per Session of Scan New Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_scan_new_users AS INT64))) as value from tbl_users_src
union all select '15.Time Spent Per Session of Scan Old Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_scan_old_users AS INT64))) as value from tbl_users_src
union all select '16.Time Spent Per Session of Free Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_free_users AS INT64))) as value from tbl_users_src
union all select '17.Time Spent Per Session of Free New Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_free_new_users AS INT64))) as value from tbl_users_src
union all select '18.Time Spent Per Session of Free Old Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_free_old_users AS INT64))) as value from tbl_users_src
union all select '19.Average Session per User' as kpi, CAST(`Average Session per User` as STRING) as value from tbl_launch_resume_src
union all select '20.Average Session per New User' as kpi, CAST(`Average Session per New User` as STRING) as value from tbl_launch_resume_src
union all select '21.Average Session per Old User' as kpi, CAST(`Average Session per Old User` as STRING) as value from tbl_launch_resume_src
order by kpi asc",31.6904296875
"with gb4250 as (select 0)
,tbl_install as (
    SELECT user_id, DATE(MIN(install_date)) as install_date
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity`
    WHERE 1=1 
        AND install_country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
        AND install_source IN (SELECT install_source FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` WHERE 1=1 )
        AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1 )
    GROUP BY 1 
),
t_users as (
    SELECT user_id,
           SUM(sessions_count) as sessions_count,
           SUM(total_time_spent) as total_time_spent,
           SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) as scans
    FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
            AND DATE(ACTIVE_DATE) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(ACTIVE_DATE) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
    WHERE DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1 AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
        AND version >= (SELECT MIN(version) FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND version <= (SELECT MAX(version) FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 AND (`applaydu.tbl_version_filter`.`version` = ?))
        AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1 )
    GROUP BY user_id
),
tbl_launch_resume_src as (
    SELECT 'All' as period,
           SUM(time_spent) as `Total time spent`,
           COUNT(DISTINCT user_id) AS `Total Users`,
           SUM(time_spent) / COUNT(DISTINCT user_id) as time_result,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result)) AS `Average Time per Users`,
           SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) AS `Total Sessions`,
           SUM(time_spent) / SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) as time_result_sessions,
           --FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(time_result_sessions)) AS `Average Time per Session`,
           SUM(CASE WHEN (session_id=1 OR CAST(time_between_sessions AS INT) >= 30) THEN 1 ELSE 0 END) /  COUNT(DISTINCT user_id) as `Average Session per User`,
           SUM(CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) as `Total Time Spent New users`,
           COUNT(DISTINCT CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) AS `Total New Users`,
           SUM(CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) / COUNT(DISTINCT CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as time_result_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_new_users)) AS `Average Time Spent Per New Users`,
           SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                          AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)) 
                    THEN 1 ELSE 0 END) AS `Total Sessions New Users`,
           SUM(CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) / SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                          AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)) 
                    THEN 1 ELSE 0 END) as time_result_sessions_new_users,
           --FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(time_result_sessions_new_users)) AS `Average Time per Session New Users`,
           SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                          AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)) 
                    THEN 1 ELSE 0 END) / COUNT(DISTINCT CASE WHEN install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as `Average Session per New User`,
           SUM(CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) as `Total Time Spent Old users`,
           COUNT(DISTINCT CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) AS `Total Old Users`,
           SUM(CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) / COUNT(DISTINCT CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as time_result_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_old_users)) AS `Average Time Per Old Users`,
           SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)) 
                    THEN 1 ELSE 0 END) AS `Total Sessions Old Users`,
           SUM(CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN CAST(time_spent AS INT) ELSE 0 END) / SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)) 
                    THEN 1 ELSE 0 END) as time_result_sessions_old_users,
           --FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(time_result_sessions_old_users)) AS `Average Time per Session Old Users`,
           SUM(CASE WHEN ((session_id=1 OR CAST(time_between_sessions AS INT) >= 30) 
                          AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)) 
                    THEN 1 ELSE 0 END) / COUNT(DISTINCT CASE WHEN install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as `Average Session per Old User`
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    LEFT JOIN tbl_install USING (user_id)
    WHERE CAST(time_spent AS INT) >= 0
        AND CAST(time_spent AS INT) < 86400
        AND version >= (SELECT MIN(version) FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND version <= (SELECT MAX(version) FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 AND (`applaydu.tbl_version_filter`.`version` = ?))
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND `gcp-bi-elephant-db-gold.applaydu.launch_resume`.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
        AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1 )
        AND (DATE(client_time) >= '2020-08-10' AND DATE(client_time) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY))
),
tbl_users_src as (
    SELECT 'All' as period,
           COUNT(DISTINCT CASE WHEN scans > 0 THEN user_id ELSE 0 END) as scan_users,
           SUM(CASE WHEN scans > 0 THEN total_time_spent ELSE 0 END) as sum_total_time_spent_scan_users,
           SUM(CASE WHEN scans > 0 THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans > 0 THEN user_id ELSE 0 END) as time_result_scan_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_scan_users)) AS `Time Spent Per Scan User`,
           SUM(CASE WHEN scans > 0 THEN sessions_count ELSE 0 END) as scan_sessions_count,
           SUM(CASE WHEN scans > 0 THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans > 0 THEN sessions_count ELSE 0 END) as time_result_session_scan_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_scan_users)) AS `Time Spent Per Session of Scan Users`,
           COUNT(DISTINCT CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as scan_new_users,
           SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) as sum_total_time_spent_scan_new_users,
            SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as time_result_scan_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_scan_new_users)) AS `Time Spent Per Scan New User`,
           SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) as scan_sessions_new_users_count,
           SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans > 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) as time_result_session_scan_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_scan_new_users)) AS `Time Spent Per Session of Scan New Users`,
           COUNT(DISTINCT CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as scan_old_users,
           SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) as sum_total_time_spent_scan_old_users,
           SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as time_result_scan_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_scan_old_users)) AS `Time Spent Per Scan Old User`,
           SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) as scan_sessions_old_users_count,
           CASE WHEN SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) = 0 THEN 0 ELSE SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans > 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) END as time_result_session_scan_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_scan_old_users)) AS `Time Spent Per Session of Scan Old Users`,
           COUNT(DISTINCT CASE WHEN scans = 0 THEN user_id ELSE 0 END) as free_users,
           SUM(CASE WHEN scans = 0 THEN total_time_spent ELSE 0 END) as sum_total_time_spent_free_users,
           SUM(CASE WHEN scans = 0 THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans = 0 THEN user_id ELSE 0 END) as time_result_free_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_free_users)) AS `Time Spent Per Free User`,
           SUM(CASE WHEN scans = 0 THEN sessions_count ELSE 0 END) as scan_sessions_free_users_count,
           CASE WHEN SUM(CASE WHEN scans = 0 THEN sessions_count ELSE 0 END) = 0 THEN 0 ELSE SUM(CASE WHEN scans = 0 THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans = 0 THEN sessions_count ELSE 0 END) END as time_result_session_free_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_free_users)) AS `Time Spent Per Session of Free Users`,
           COUNT(DISTINCT CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as free_new_users,
           SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) as sum_total_time_spent_free_new_users,
           SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                               THEN user_id ELSE 0 END) as time_result_free_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_free_new_users)) AS `Time Spent Per Free New User`,
           SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) as scan_sessions_new_free_users_count,
           CASE WHEN SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) = 0 THEN 0 ELSE SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans = 0 AND install_date >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    AND install_date < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY) 
                    THEN sessions_count ELSE 0 END) END as time_result_session_free_new_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_free_new_users)) AS `Time Spent Per Session of Free New Users`,
           COUNT(DISTINCT CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as free_old_users,
           SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) as sum_total_time_spent_free_old_users,
           SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) / COUNT(DISTINCT CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                               THEN user_id ELSE 0 END) as time_result_free_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_free_old_users)) AS `Time Spent Per Free Old User`,
           SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) as scan_sessions_free_old_users_count,
           CASE WHEN SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) = 0 THEN 0 ELSE SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN total_time_spent ELSE 0 END) / SUM(CASE WHEN scans = 0 AND install_date < (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) 
                    THEN sessions_count ELSE 0 END) END as time_result_session_free_old_users,
           --FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(time_result_session_free_old_users)) AS `Time Spent Per Session of Free Old Users`
    FROM t_users
    LEFT JOIN tbl_install USING (user_id)
)
select '01.Average Time per Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result AS INT64))) as value from tbl_launch_resume_src
union all select '02.Average Time Spent Per New Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_new_users AS INT64))) as value from tbl_launch_resume_src

union all select '03.Average Time Per Old Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_old_users AS INT64))) as value from tbl_launch_resume_src
union all select '04.Time Spent Per Scan User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_scan_users AS INT64))) as value from tbl_users_src
union all select '05.Time Spent Per Scan New User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_scan_new_users AS INT64))) as value from tbl_users_src
union all select '06.Time Spent Per Scan Old User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_scan_old_users AS INT64))) as value from tbl_users_src
union all select '07.Time Spent Per Free User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_free_users AS INT64))) as value from tbl_users_src
union all select '08.Time Spent Per Free New User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_free_new_users AS INT64))) as value from tbl_users_src
union all select '09.Time Spent Per Free Old User' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_free_old_users AS INT64))) as value from tbl_users_src
union all select '10.Average Time per Session' as kpi, FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_sessions AS INT64))) as value from tbl_launch_resume_src
union all select '11.Average Time per Session New Users' as kpi, FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_sessions_new_users AS INT64))) as value from tbl_launch_resume_src
union all select '12.Average Time per Session Old Users' as kpi, FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_sessions_old_users AS INT64))) as value from tbl_launch_resume_src
union all select '13.Time Spent Per Session of Scan Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_scan_users AS INT64))) as value from tbl_users_src
union all select '14.Time Spent Per Session of Scan New Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_scan_new_users AS INT64))) as value from tbl_users_src
union all select '15.Time Spent Per Session of Scan Old Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_scan_old_users AS INT64))) as value from tbl_users_src
union all select '16.Time Spent Per Session of Free Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_free_users AS INT64))) as value from tbl_users_src
union all select '17.Time Spent Per Session of Free New Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_free_new_users AS INT64))) as value from tbl_users_src
union all select '18.Time Spent Per Session of Free Old Users' as kpi, FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(time_result_session_free_old_users AS INT64))) as value from tbl_users_src
union all select '19.Average Session per User' as kpi, CAST(`Average Session per User` as STRING) as value from tbl_launch_resume_src
union all select '20.Average Session per New User' as kpi, CAST(`Average Session per New User` as STRING) as value from tbl_launch_resume_src
union all select '21.Average Session per Old User' as kpi, CAST(`Average Session per Old User` as STRING) as value from tbl_launch_resume_src
order by kpi asc",31.673828125
"WITH tbl_user_activity AS (
    SELECT *
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
    WHERE activity_01 = 'Experience - Lets Story - Story Reported'
        AND scene_name = 'Eduland Lets Story'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    CASE 
        WHEN ACTIVITY_01_VALUE = 1 THEN 'Story'
        WHEN ACTIVITY_01_VALUE = 2 THEN 'Image'
        WHEN ACTIVITY_01_VALUE = 3 THEN 'Text'
        ELSE 'Unknown'
    END AS `Reported type`,
    COUNT(*) AS `Report Count`
FROM tbl_user_activity
WHERE ACTIVITY_01_VALUE > 0
GROUP BY `Reported type`
ORDER BY `Report Count` DESC;",29.5234375
"WITH tbl_user_activity AS (
    SELECT *
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
    WHERE activity_01 = 'Experience - Lets Story - Story Reported'
        AND scene_name = 'Eduland Lets Story'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    CASE 
        WHEN ACTIVITY_01_VALUE = 1 THEN 'Story'
        WHEN ACTIVITY_01_VALUE = 2 THEN 'Image'
        WHEN ACTIVITY_01_VALUE = 3 THEN 'Text'
        ELSE 'Unknown'
    END AS `Reported type`,
    COUNT(*) AS `Report Count`
FROM tbl_user_activity
WHERE ACTIVITY_01_VALUE > 0
GROUP BY `Reported type`
ORDER BY `Report Count` DESC;",29.5234375
"WITH gb4235 as (select 4235),
tbl_story_mode_finished as (
 select user_id,FED_ID,PLATFORM,game_id,EVENT_ID,min(client_time),min(client_time),version,country,SESSION_ID
,min(TOKEN),AVATAR_GENDER,END_CAUSE,TOY_NAME,STORY_STEP,avg(TIME_TO_FINISH)
,ACTIVITY_01,ACTIVITY_01_VALUE,ACTIVITY_02,ACTIVITY_02_VALUE,ACTIVITY_03,ACTIVITY_03_VALUE,ACTIVITY_04
,ACTIVITY_04_VALUE,ACTIVITY_05,ACTIVITY_05_VALUE,AVATAR_ONESIE,click_from,ENVIRONMENT_ID,min(EVENT_client_time_LOCAL)
,avg(REALTIME_SPENT),min(load_time),ACTIVITY_06,ACTIVITY_06_VALUE,ACTIVITY_07,ACTIVITY_07_VALUE
,ACTIVITY_08,ACTIVITY_08_VALUE,ACTIVITY_09,ACTIVITY_09_VALUE,ACTIVITY_10,ACTIVITY_10_VALUE,TOY_UNLOCKED_METHOD,from_scene
 from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 where (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0' 
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 group by all
)
,real_story_mode_finished as (
SELECT user_id,game_id,event_id,version,country,session_id,avatar_gender,end_cause,toy_name,story_step,realtime_spent,environment_id,client_time,toy_unlocked_method,count(*) as dup
FROM 
 (
 -- exclude Dino Exp
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished
 WHERE 
 environment_id like 'Natoons v4%' or
 -- DUPLICATIONS in those Experience
 (environment_id like '%Travel%' and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id NOT IN ('Savannah','Space','Ocean','Jungle','Magic Land','Experience - Dino Museum') AND (environment_id not LIKE '%Travel%') ) or 
 (environment_id='Kinderini' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_kinderini_start_date') ) or 
 (environment_id='Eduland Lets Story' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_v5_lets_story_start_date'))
 -- Dino 
 union all
 -- version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') (normal)
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 WHERE (version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19'))
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 union all
 -- (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0'
 select * from tbl_story_mode_finished
 )
group by all
)
,dedicated as (
SELECT user_id,realtime_spent
from real_story_mode_finished
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
SELECT user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.ILLUSTRATION_BOOK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,minigame_done as (
select user_id AS user_id,
game_id AS game_id,
client_time AS client_time,server_time AS server_time,
version AS version,
country AS country,
scene_name AS scene_name,
click_from AS click_from,
case when REALTIME_SPENT is null then time_to_finish else REALTIME_SPENT end AS realtime_spent,
load_time AS load_time,
case when from_scene is null then 'Not yet available' else from_scene end as from_scene,
FROM gcp-bi-elephant-db-gold.applaydu.minigame_finished
)
,minigame as (
SELECT user_id,realtime_spent
FROM minigame_done
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name not in ('Main Menu','NBA_1','NBA_2','Happos Runner','Natoon RunnerV2','Inkmagination_Xmas')
 and from_scene<>'Eduland AvatarHouse' -- EXCLUDE Minigame Drawing in AvatarHouse from Minigame
 and scene_name not like '%Playability%' 
 and( (scene_name<>'Move Ahead'and realtime_spent>=0) or ( scene_name='Move Ahead' and realtime_spent>12) )-- to exclude users quitting during loading screen + cover 99% users
)
,toy_fs as (
--tracking TOY_FRIENDSHIP_FINISHED before v4.6.1
select user_id,sum(time_spent) as total_time,count (*) as session
from gcp-bi-elephant-db-gold.applaydu.TOY_FRIENDSHIP_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'4.6.1' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name like 'Eduland%'
 and time_spent>=0 and time_spent<7200
group by 1
--change tracking ACTIVITY_FINISHED since v4.6.1
union all
select user_id,sum(time_spent) as total_time,count (*) as session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='4.6.1' AND DATE(client_time) >= '2024-03-11') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Current Heart Point' -- first row data only for Natoons and Fantasy event returns 2 rows
 and time_spent>=0 and time_spent<7200
group by 1
union all
--change tracking ACTIVITY_FINISHED since v5.2.0
select user_id,total_time,session 
from (
(
select user_id,sum(time_spent) as total_time
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') and version<'5.4.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
group by 1
) a join (
select user_id,count(token) as session
from gcp-bi-elephant-db-gold.applaydu.TOY_FRIENDSHIP_STARTED
where 1=1
 and (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') and version<'5.4.0'
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) 
 and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (SELECT version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
 and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  ) 
 and date(client_time)>='2020-08-10' and date(client_time)<CURRENT_DATE()
group by 1
) b using (user_id))
union all
--change tracking ACTIVITY_FINISHED since v5.4.0
select user_id,sum(session_timespent) as total_time,count(session_id) as session
from(
 select user_id,ACTIVITY_10_VALUE as session_id,sum(time_spent) as session_timespent
 from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
 where 1=1
 and (version >='5.4.0' AND DATE(client_time) >= '2024-12-04') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
 group by 1,2
)
group by 1
)
,ar_mode as (
select user_id,realtime_spent
FROM gcp-bi-elephant-db-gold.applaydu.AR_MODE_FINISHED
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.FACE_MASK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,avatar_house as (
-- OLD TRACKING: before 4.5.0 use visit_screen
select user_id
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 
 and screen_to like 'Eduland%Avatar%'
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all
select user_id
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0 and from_scene<>'Inkmagination' -- when users from AH Drawing to AH,we do not count as a new session
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,avatarhouse_time as (-- include Minigame Drawing from AH 
-- OLD TRACKING: before 4.5.0 use visit_screen
select time_spent
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 and time_spent>=0 and time_spent<36000
 and (screen_from like '%Avatar%' or (screen_from like '%Ink%' and screen_to like '%Avatar%')) -- INCLUDE TIME SPENT IN MINIGAME DRAWING IN AH
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
-- NEW TRACKING: after 4.5.0 use AH + MINIGAME DRAWING AH
union all
select time_spent
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all -- INCLUDE TIME_SPENT MINIGAME DRAWING in AH
select REALTIME_SPENT
from gcp-bi-elephant-db-gold.applaydu.minigame_finished
where scene_name='Inkmagination'
 and from_scene='Eduland AvatarHouse'
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,parental_section as (
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.PARENTAL_SECTION
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,result as
(
select 'Dedicated Experience' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from dedicated 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

union all
select 'AR' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from ar_mode 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Minigame' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from minigame 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Toy Friendship' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(total_time)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(total_time)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from toy_fs 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
group by 1
union all
select 'Avatar House' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,(select sum(time_spent) from avatarhouse_time) / (case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,(select sum(time_spent) from avatarhouse_time) /count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from avatar_house 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Parental Section' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from parental_section 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

)
select *
,concat(floor(`Time spent per user min`),' min ',round((`Time spent per user min` - floor(`Time spent per user min`)) * 60),' sec') as `Time spent per user min - sec`
,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration min`
 from result
order by `Time spent per user min` desc",29.0439453125
"WITH gb4230 as (select 4230),
tbl_story_mode_finished as (
 select user_id,FED_ID,PLATFORM,game_id,EVENT_ID,min(client_time),min(client_time),version,country,SESSION_ID
,min(TOKEN),AVATAR_GENDER,END_CAUSE,TOY_NAME,STORY_STEP,avg(TIME_TO_FINISH)
,ACTIVITY_01,ACTIVITY_01_VALUE,ACTIVITY_02,ACTIVITY_02_VALUE,ACTIVITY_03,ACTIVITY_03_VALUE,ACTIVITY_04
,ACTIVITY_04_VALUE,ACTIVITY_05,ACTIVITY_05_VALUE,AVATAR_ONESIE,click_from,ENVIRONMENT_ID,min(EVENT_client_time_LOCAL)
,avg(REALTIME_SPENT),min(load_time),ACTIVITY_06,ACTIVITY_06_VALUE,ACTIVITY_07,ACTIVITY_07_VALUE
,ACTIVITY_08,ACTIVITY_08_VALUE,ACTIVITY_09,ACTIVITY_09_VALUE,ACTIVITY_10,ACTIVITY_10_VALUE,TOY_UNLOCKED_METHOD,from_scene
 from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 where (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0' 
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 group by all
)
,real_story_mode_finished as (
SELECT user_id,game_id,event_id,version,country,session_id,avatar_gender,end_cause,toy_name,story_step,realtime_spent,environment_id,client_time,toy_unlocked_method,count(*) as dup
FROM 
 (
 -- exclude Dino Exp
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished
 WHERE 
 environment_id like 'Natoons v4%' or
 -- DUPLICATIONS in those Experience
 (environment_id like '%Travel%' and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id NOT IN ('Savannah','Space','Ocean','Jungle','Magic Land','Experience - Dino Museum') AND (environment_id not LIKE '%Travel%') ) or 
 (environment_id='Kinderini' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_kinderini_start_date') ) or 
 (environment_id='Eduland Lets Story' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_v5_lets_story_start_date'))
 -- Dino 
 union all
 -- version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') (normal)
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 WHERE (version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19'))
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 union all
 -- (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0'
 select * from tbl_story_mode_finished
 )
group by all
)
,dedicated as (
SELECT user_id,realtime_spent
from real_story_mode_finished
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
SELECT user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.ILLUSTRATION_BOOK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,minigame_done as (
select user_id AS user_id,
game_id AS game_id,
client_time AS client_time,server_time AS server_time,
version AS version,
country AS country,
scene_name AS scene_name,
click_from AS click_from,
case when REALTIME_SPENT is null then time_to_finish else REALTIME_SPENT end AS realtime_spent,
load_time AS load_time,
case when from_scene is null then 'Not yet available' else from_scene end as from_scene,
FROM gcp-bi-elephant-db-gold.applaydu.minigame_finished
)
,minigame as (
SELECT user_id,realtime_spent
FROM minigame_done
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name not in ('Main Menu','NBA_1','NBA_2','Happos Runner','Natoon RunnerV2','Inkmagination_Xmas')
 and from_scene<>'Eduland AvatarHouse' -- EXCLUDE Minigame Drawing in AvatarHouse from Minigame
 and scene_name not like '%Playability%' 
 and( (scene_name<>'Move Ahead'and realtime_spent>=0) or ( scene_name='Move Ahead' and realtime_spent>12) )-- to exclude users quitting during loading screen + cover 99% users
)
,toy_fs as (
--tracking TOY_FRIENDSHIP_FINISHED before v4.6.1
select user_id,time_spent,CAST(client_time AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.TOY_FRIENDSHIP_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'4.6.1' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and scene_name like 'Eduland%'
 and time_spent>=0 and time_spent<7200
--change tracking ACTIVITY_FINISHED since v4.6.1
union all
select user_id,time_spent,CAST(client_time AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='4.6.1' AND DATE(client_time) >= '2024-03-11') and version<'5.2.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Current Heart Point' -- first row data only for Natoons and Fantasy event returns 2 rows
 and time_spent>=0 and time_spent<7200
union all 
--change tracking ACTIVITY_FINISHED since v5.2.0
select user_id,sum(time_spent) as total_time,CAST(client_time AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') and version<'5.4.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
group by all
union all 
--change tracking ACTIVITY_FINISHED since v5.4.0
select user_id,sum(time_spent) as total_time,CAST(activity_10_value AS STRING) AS tfs_session
from gcp-bi-elephant-db-gold.applaydu.ACTIVITY_FINISHED
where 1=1
 and (version >='5.4.0' AND DATE(client_time) >= '2024-12-04') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and feature='Toy Friendship'
 and activity_01='TFS Minigame Index Check'
 and time_spent>=0 and time_spent<7200 
group by 1,3
)
,ar_mode as (
select user_id,realtime_spent
FROM gcp-bi-elephant-db-gold.applaydu.AR_MODE_FINISHED
where 1=1 
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
union all
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.FACE_MASK_FINISHED
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,avatar_house as (
-- OLD TRACKING: before 4.5.0 use visit_screen
select user_id
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 
 and screen_to like 'Eduland%Avatar%'
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all
select user_id
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0 and from_scene<>'Inkmagination' -- when users from AH Drawing to AH,we do not count as a new session
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,avatarhouse_time as (-- include Minigame Drawing from AH 
-- OLD TRACKING: before 4.5.0 use visit_screen
select time_spent
from gcp-bi-elephant-db-gold.applaydu.VISIT_SCREEN
where 1=1 and time_spent>=0 and time_spent<36000
 and (screen_from like '%Avatar%' or (screen_from like '%Ink%' and screen_to like '%Avatar%')) -- INCLUDE TIME SPENT IN MINIGAME DRAWING IN AH
 and (version >='4.3.0' AND DATE(client_time) >= '2023-11-24') and version<'4.5.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
-- NEW TRACKING: after 4.5.0 use AH + MINIGAME DRAWING AH
union all
select time_spent
from gcp-bi-elephant-db-gold.applaydu.AVATAR_HOUSE_FINISHED
where 1=1 and time_spent>=0
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
union all -- INCLUDE TIME_SPENT MINIGAME DRAWING in AH
select REALTIME_SPENT
from gcp-bi-elephant-db-gold.applaydu.minigame_finished
where scene_name='Inkmagination'
 and from_scene='Eduland AvatarHouse'
 and (version >='4.5.0' AND DATE(client_time) >= '2024-02-05') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
)
,parental_section as (
select user_id,realtime_spent
from gcp-bi-elephant-db-gold.applaydu.PARENTAL_SECTION
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
)
,result as
(
select 'Dedicated Experience' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from dedicated 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

union all
select 'AR' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from ar_mode 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Minigame' as feature
,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from minigame 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Toy Friendship' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(time_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(time_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from toy_fs 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
group by 1
union all
select 'Avatar House' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,(select sum(time_spent) from avatarhouse_time) / (case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,(select sum(time_spent) from avatarhouse_time) /count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from avatar_house 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
union all
select 'Parental Section' as feature,count (*) as session
,count (*)/ (case when count (distinct user_id)=0 then null else count (distinct user_id) end) as `Sessions per user`
,sum(realtime_spent)/(case when count (distinct user_id)=0 then null else count (distinct user_id) end) /60 as `Time spent per user min`
--,concat(floor(`Time spent per user (min)`),' min ',round((`Time spent per user (min)` - floor(`Time spent per user (min)`)) * 60),' sec') as `Time spent per user (min - sec)`
,sum(realtime_spent)/count (*)/60 as `Session Duration`
--,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration (min)`
from parental_section 
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)

)
select *
,concat(floor(`Time spent per user min`),' min ',round((`Time spent per user min` - floor(`Time spent per user min`)) * 60),' sec') as `Time spent per user min - sec`
,concat(floor(`Session Duration`),' min ',round((`Session Duration` - floor(`Session Duration`)) * 60),' sec') as `Session Duration min`
 from result
order by session desc",29.0439453125
"WITH gb4231 as (SELECT 0)
,scan_user AS (
    SELECT DISTINCT user_id
    FROM (
        SELECT user_id
        FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
        JOIN (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
        ) USING (user_id)
        WHERE utm_campaign LIKE '%KCLTS%'
            AND version >= '5.0.0'
            AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
            AND DATE(client_time) < CURRENT_DATE()
            AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
            AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
            AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
            AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        UNION ALL 
        SELECT user_id
        FROM `gcp-bi-elephant-db-gold.applaydu.scan_mode_finished`
        JOIN (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
        ) USING (user_id)
        WHERE (
            (reference LIKE '%KCLTS%' AND NOT (game_id != 81335 AND scan_type = 'Deep Link')) 
            OR scan_type = 'Scan_QR_LS'
        )
        AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND scan_result IN ('New_Toy', 'Old_Toy')
    )
),
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users,
        COUNT(0) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE (screen_from IN ('World Map', 'Mini Game Screen') OR screen_from LIKE 'Eduland%Minigame Menu') 
        AND screen_to = 'Eduland Lets Story'
        AND version >= '5.0.0'
        AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND user_id IN (SELECT user_id FROM scan_user)
),
story_creation_started AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE screen_to = 'Eduland Lets Story - Story Creation'
        AND version >= '5.0.0'
        AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND user_id IN (SELECT user_id FROM scan_user)
),
story_creation_finished AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE activity_01 = 'Experience - Lets Story - New Story Created'
        AND version >= '5.0.0'
        AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND user_id IN (SELECT user_id FROM scan_user)
),
tbl_illustration_book_started AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users,
        COUNT(0) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE screen_to = 'Eduland Lets Story - Story Reading'
        AND version >= '5.0.0'
        AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND user_id IN (SELECT user_id FROM scan_user)
),
tbl_illustration_book_finished AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.illustration_book_finished`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE story_title LIKE 'Experience - Lets Story%'
        AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND (end_cause = 'Finished' OR max_page_reached = total_page_available)
        AND user_id IN (SELECT user_id FROM scan_user)
)
SELECT 'Access Story Creation' AS `User Type`, (SELECT users FROM story_creation_started) AS users
UNION ALL
SELECT 'Access Story Reading' AS `User Type`, (SELECT users FROM tbl_illustration_book_started) AS users
UNION ALL
SELECT 'Finish reading at least 1 story' AS `User Type`, (SELECT users FROM tbl_illustration_book_finished) AS users
ORDER BY users DESC",28.5712890625
"WITH gb4231 as (SELECT 0)
,scan_user AS (
    SELECT DISTINCT user_id
    FROM (
        SELECT user_id
        FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
        JOIN (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
        ) USING (user_id)
        WHERE utm_campaign LIKE '%KCLTS%'
            AND version >= '5.0.0'
            AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
            AND DATE(client_time) < CURRENT_DATE()
            AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
            AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
            AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
            AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        UNION ALL 
        SELECT user_id
        FROM `gcp-bi-elephant-db-gold.applaydu.scan_mode_finished`
        JOIN (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
        ) USING (user_id)
        WHERE (
            (reference LIKE '%KCLTS%' AND NOT (game_id != 81335 AND scan_type = 'Deep Link')) 
            OR scan_type = 'Scan_QR_LS'
        )
        AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND scan_result IN ('New_Toy', 'Old_Toy')
    )
),
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users,
        COUNT(0) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE (screen_from IN ('World Map', 'Mini Game Screen') OR screen_from LIKE 'Eduland%Minigame Menu') 
        AND screen_to = 'Eduland Lets Story'
        AND version >= '5.0.0'
        AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND user_id IN (SELECT user_id FROM scan_user)
),
story_creation_started AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE screen_to = 'Eduland Lets Story - Story Creation'
        AND version >= '5.0.0'
        AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND user_id IN (SELECT user_id FROM scan_user)
),
story_creation_finished AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE activity_01 = 'Experience - Lets Story - New Story Created'
        AND version >= '5.0.0'
        AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND user_id IN (SELECT user_id FROM scan_user)
),
tbl_illustration_book_started AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users,
        COUNT(0) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE screen_to = 'Eduland Lets Story - Story Reading'
        AND version >= '5.0.0'
        AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND user_id IN (SELECT user_id FROM scan_user)
),
tbl_illustration_book_finished AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.illustration_book_finished`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE story_title LIKE 'Experience - Lets Story%'
        AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND (end_cause = 'Finished' OR max_page_reached = total_page_available)
        AND user_id IN (SELECT user_id FROM scan_user)
)
SELECT 'Access Story Creation' AS `User Type`, (SELECT users FROM story_creation_started) AS users
UNION ALL
SELECT 'Access Story Reading' AS `User Type`, (SELECT users FROM tbl_illustration_book_started) AS users
UNION ALL
SELECT 'Finish reading at least 1 story' AS `User Type`, (SELECT users FROM tbl_illustration_book_finished) AS users
ORDER BY users DESC",28.5703125
"with gb4267 as (select 0)
,minigame_done as (
select user_id AS user_id,
`FED_ID` AS `FED_ID`,
`PLATFORM` AS `PLATFORM`,
game_id AS game_id,
`EVENT_ID` AS `EVENT_ID`,
client_time AS client_time,server_time AS server_time,
version AS version,
country AS country,
`SESSION_ID` AS `SESSION_ID`,
`TOKEN` AS `TOKEN`,
`CURRENT_ELO` AS `CURRENT_ELO`,
`HINT_TRIGGERED` AS `HINT_TRIGGERED`,
`AVATAR_GENDER` AS `AVATAR_GENDER`,
`END_CAUSE` AS `END_CAUSE`,
scene_name AS scene_name,
`TIMES_REPLAYED` AS `TIMES_REPLAYED`,
`GAME_DIFFICULTY` AS `GAME_DIFFICULTY`,
`GAME_MISTAKES` AS `GAME_MISTAKES`,
`ACCESS_POINT` AS `ACCESS_POINT`,
`EVENT_client_time_LOCAL` AS `EVENT_client_time_LOCAL`,
click_from AS click_from,
`IS_MULTI` AS `IS_MULTI`,
`QUIT_PHASE` AS `QUIT_PHASE`,
`TOY_NAME` AS `TOY_NAME`,
case when REALTIME_SPENT is null then time_to_finish else REALTIME_SPENT end AS `REALTIME_SPENT`,
load_time AS load_time,
case when from_scene is null then 'Not yet available' else from_scene end as from_scene,
`AVATAR_DIFFICULTY` AS `AVATAR_DIFFICULTY`,
`TOY_UNLOCKED_METHOD` AS `TOY_UNLOCKED_METHOD`
FROM gcp-bi-elephant-db-gold.applaydu.minigame_finished
)
(SELECT replace(replace(replace(replace(replace(replace(scene_name
,'Vocabulary','Word Explorer')
,'Princess Tower','Tower Block')
,'Code spark','Codeplaydu')
,'Chase Ace','Chase & Ace')
,'Happos Runner','Happos Fun Run')
,'Natoons','Food Quest')
 as `Minigame`
,count(distinct user_id) as `Users count`
,count(0) as `Sessions`
,count(0)/count(distinct user_id) as `Sessions per user`
,sum(realtime_spent) as total_time_spent
,(sum(realtime_spent)/count(distinct user_id)/60) as `Average time spent per game per user minute`
,(sum(realtime_spent)/count(0)/60) as `Average time spent per game per session minute`
--,concat(floor(`Average time spent per game per user (minute)`),' min ',round((`Average time spent per game per user (minute)` - floor(`Average time spent per game per user (minute)`)) * 60),' sec') as `Average time spent per game per user (min - sec)`
--,concat(floor(`Average time spent per game per session (minute)`),' min ',round((`Average time spent per game per session (minute)` - floor(`Average time spent per game per session (minute)`)) * 60),' sec') as `Average time spent per game per session (min - sec)`
FROM minigame_done t
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
 join `applaydu.tbl_shop_filter` on `applaydu.tbl_shop_filter`.game_id=t.game_id and `applaydu.tbl_shop_filter`.country=t.country
WHERE 1=1
 and (date(client_time)>='2020-08-10' and date(client_time)<DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY))
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 ) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
 and t.country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 
 and scene_name not in ('Main Menu','NBA_1','NBA_2','Happos Runner','Natoon RunnerV2','Inkmagination_Xmas','Link The World','Wheel','Wheel Map')
 and scene_name not like '%Playability%' and scene_name not like 'Stylin%'
 and from_scene not in ('Eduland AvatarHouse' ) --remove from dedicated experience 'Story Crafting','Story Natoons Documentary'?
 and ( ( scene_name='Move Ahead' and realtime_spent>12) -- to exclude users quitting during loading screen + cover 99% users
 or (scene_name<>'Move Ahead' and realtime_spent>=0 and realtime_spent<36000) )
 and realtime_spent>=0 and realtime_spent<36000
group by scene_name
)
order by `Average time spent per game per user minute` desc",28.375
"WITH tbl_user_activity AS (
    SELECT *
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
    WHERE activity_04 = 'Experience - Lets Story - Rating'
        AND scene_name = 'Eduland Lets Story'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    CASE 
        WHEN ACTIVITY_04_VALUE = 1 THEN 'Difficult'
        WHEN ACTIVITY_04_VALUE = 2 THEN 'JustRight'
        ELSE 'Easy' 
    END AS Rating,
    COUNT(*) AS Events
FROM tbl_user_activity
GROUP BY Rating
ORDER BY Rating;",25.794921875
"WITH tbl_user_activity AS (
    SELECT *
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
    WHERE activity_04 = 'Experience - Lets Story - Rating'
        AND scene_name = 'Eduland Lets Story'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    CASE 
        WHEN ACTIVITY_04_VALUE = 1 THEN 'Difficult'
        WHEN ACTIVITY_04_VALUE = 2 THEN 'JustRight'
        ELSE 'Easy' 
    END AS Rating,
    COUNT(*) AS Events
FROM tbl_user_activity
GROUP BY Rating
ORDER BY Rating;",25.794921875
"with bq4238 as (select 0)
SELECT 
    COUNT(DISTINCT user_id) AS total_users,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS total_scans,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 and install_source in (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )   
    AND shop_filter IN (SELECT shop_filter FROM `applaydu.tbl_users` WHERE 1=1 )	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)",25.3798828125
"WITH gb4271 as (SELECT 0)
,total_apd AS (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` t
    JOIN `applaydu.tbl_shop_filter` ON `applaydu.tbl_shop_filter`.game_id = t.game_id AND `applaydu.tbl_shop_filter`.country = t.country
    WHERE 1=1
    AND session_id = 1
    AND NOT (t.game_id = 82471 AND client_time < '2020-12-14')
    AND CAST(time_spent AS FLOAT64) >= 0
    AND CAST(time_spent AS FLOAT64) < 86400
    AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND client_time >= '2024-01-01'
    
),
ftue_list AS (
    SELECT DISTINCT user_id
    FROM `gcp-bi-elephant-db-gold.applaydu.ftue_event`
    WHERE 1=1 
    AND user_id IN (SELECT * FROM total_apd)
    AND ftue_stage IN ('Start')
    AND ftue_steps IN ('Email Registration')
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    AND client_time >= '2024-01-01'
    AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1 )
),
regis_regis AS (
    SELECT COUNT(DISTINCT regis.user_id) AS `Successfully Registered Email`
    FROM `gcp-bi-elephant-db-gold.applaydu.account_operation` AS regis
    WHERE 1=1 
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1 )
    AND client_time >= '2024-01-01'
    AND account_operation = 'Email registration' 
    AND result IN ('Good Email: Wrong Age then Correct Age and Success', 'Good Email: Correct Age and Success', 'Success', 'Bad Email then Good Email: Wrong Age then Correct Age and Success', 'Bad Email then Good Email: Correct Age and Success')
),
regis_veri AS (
    SELECT COUNT(DISTINCT user_id) AS `Verified email after registration`
    FROM `gcp-bi-elephant-db-gold.applaydu.account_operation`
    WHERE account_operation = 'Email registration confirmation'
    AND result = 'Success'
    AND 1=1
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v4_start_date')
    AND DATE(client_time) < (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_be_parent_registration_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1 )
    AND client_time >= '2024-01-01'
),
regis_veri_be AS (
    SELECT COUNT(DISTINCT anon_id) AS `Verified email after registration`
    FROM `gcp-gfb-sai-tracking-gold.applaydu.store_stats_subscriptions`
    WHERE DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_be_parent_registration_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1 )
)
SELECT 'New Users Launch' AS Users, COUNT(DISTINCT user_id) AS `Number of Users`
FROM total_apd
UNION ALL
SELECT 'Email Registration Screen' AS Users, COUNT(DISTINCT user_id) AS `Number of Users`
FROM ftue_list
UNION ALL
SELECT 'Finish Email Registration' AS Users, `Successfully Registered Email` AS `Number of Users`
FROM regis_regis
UNION ALL
SELECT 'Email Verification' AS Users, (SELECT `Verified email after registration` FROM regis_veri) + (SELECT `Verified email after registration` FROM regis_veri_be) AS `Number of Users`",25.2744140625
"WITH gb4245 as (select 0)
,kdr_scan_users AS (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.scan_mode_finished`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_kinderini_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND scan_result IN ('New_Toy', 'Old_Toy')
        AND (
            (scan_type = 'Deep Link' AND UPPER(reference) LIKE '%KINDERINI%')
            OR scan_type IN ('Scan_Toy_Biscuit', 'Scan_QR_Biscuit')
        )
),
filter_sst AS (
    SELECT * 
    FROM `gcp-bi-elephant-db-gold.applaydu.story_step_finished`
    JOIN kdr_scan_users USING (user_id)
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_kinderini_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND environment_id = 'Kinderini'
),
tap_emotion_user AS (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.story_mode_triggered`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
    ) USING (user_id)
    WHERE DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_kinderini_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND environment_id = 'Kinderini'
        AND click_from IN (
            'Eduland Kinderini Menu - Cluster - Wonder',
            'Eduland Kinderini Menu - Cluster - Happiness',
            'Eduland Kinderini Menu - Cluster - Kindness',
            'Eduland Kinderini Menu - Cluster - Fearfulness'
        )
        AND user_id IN (SELECT DISTINCT user_id FROM kdr_scan_users)
),
result AS (
    SELECT 
        'Kinderini Scan Users' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM kdr_scan_users
    UNION ALL 
    SELECT 
        'Tap Emotion Cluster' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM tap_emotion_user
    UNION ALL
    SELECT 
        'Drawing Start' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Drawing MIG' AND user_selection = 'Started'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Drawing Stop' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Drawing MIG' AND user_selection = 'Finished'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Finding Start' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Finding MIG' AND user_selection = 'Started'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Finding Stop' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Finding MIG' AND user_selection = 'Finished'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Catching Start' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Catching MIG' AND user_selection = 'Started'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Catching Stop' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Catching MIG' AND user_selection = 'Finished'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Diary Start' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Dairy Screen' AND user_selection = 'Started'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
    UNION ALL
    SELECT 
        'Diary Stop' AS `#`,
        COUNT(DISTINCT user_id) AS `Users`
    FROM filter_sst
    WHERE story_step = 'Kinderini - Dairy Screen' AND user_selection = 'Finished'
        AND user_id IN (SELECT DISTINCT user_id FROM tap_emotion_user)
)
SELECT * FROM result",25.0390625
"with gb4239 as (SELECT 0)
,tbl_ls_scan_users AS (
    SELECT DISTINCT user_id
    FROM (
        SELECT user_id
        FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
        JOIN (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
        ) USING (user_id)
        WHERE utm_campaign LIKE '%KCLTS%'
            AND version >= '5.0.0'
            AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
            AND DATE(client_time) < CURRENT_DATE()
            AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
            AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
            AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
            AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        UNION ALL 
        SELECT user_id
        FROM `gcp-bi-elephant-db-gold.applaydu.scan_mode_finished`
        JOIN (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
        ) USING (user_id)
        WHERE (
            (reference LIKE '%KCLTS%' AND NOT (game_id != 81335 AND scan_type = 'Deep Link')) 
            OR scan_type = 'Scan_QR_LS'
        )
        AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND scan_result IN ('New_Toy', 'Old_Toy')
    )
)
SELECT COUNT(DISTINCT user_id) 
FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
JOIN (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
    WHERE 1=1 
) USING (user_id)
WHERE activity_01 = 'Experience - Lets Story - New Story Created'
    AND version >= '5.0.0'
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND user_id IN (SELECT DISTINCT user_id FROM tbl_ls_scan_users)",23.32421875
"with gb4239 as (SELECT 0)
,tbl_ls_scan_users AS (
    SELECT DISTINCT user_id
    FROM (
        SELECT user_id
        FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
        JOIN (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
        ) USING (user_id)
        WHERE utm_campaign LIKE '%KCLTS%'
            AND version >= '5.0.0'
            AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
            AND DATE(client_time) < CURRENT_DATE()
            AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
            AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
            AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
            AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        UNION ALL 
        SELECT user_id
        FROM `gcp-bi-elephant-db-gold.applaydu.scan_mode_finished`
        JOIN (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
        ) USING (user_id)
        WHERE (
            (reference LIKE '%KCLTS%' AND NOT (game_id != 81335 AND scan_type = 'Deep Link')) 
            OR scan_type = 'Scan_QR_LS'
        )
        AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(client_time) < CURRENT_DATE()
        AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND scan_result IN ('New_Toy', 'Old_Toy')
    )
)
SELECT COUNT(DISTINCT user_id) 
FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
JOIN (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
    WHERE 1=1 
) USING (user_id)
WHERE activity_01 = 'Experience - Lets Story - New Story Created'
    AND version >= '5.0.0'
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND user_id IN (SELECT DISTINCT user_id FROM tbl_ls_scan_users)",23.32421875
"WITH t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",22.5166015625
"WITH gb4256 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",22.5166015625
"WITH gb4255 as (select 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count > 0 
    OR scan_mode_finished_count > 0",22.5166015625
"WITH gb4233 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id  ,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT `Time spent`
FROM (
    SELECT 
        COUNT(DISTINCT user_id) AS users,
        SUM(total_time_spent) AS sum_total_time_spent,
        SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
        FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
    FROM 
        t_users
    WHERE 
        toy_unlocked_by_scan_count > 0 
        OR scan_mode_finished_count > 0 
)",22.5166015625
"WITH gb4255 as (select 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count > 0 
    OR scan_mode_finished_count > 0",22.462890625
"WITH tbl_users_launch_lets_story AS (
    SELECT COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (screen_from IN ('World Map', 'Mini Game Screen') OR screen_from LIKE 'Eduland%Minigame Menu')
        AND screen_to = 'Eduland Lets Story'
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
story_creation_started AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to = 'Eduland Lets Story - Story Creation'
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
story_creation_finished AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
    WHERE activity_01 = 'Experience - Lets Story - New Story Created'
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_illustration_book_started AS (
    SELECT COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to = 'Eduland Lets Story - Story Reading'
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_illustration_book_finished AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.illustration_book_finished`
    WHERE story_title LIKE 'Experience - Lets Story%'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND (end_cause = 'Finished' OR MAX_PAGE_REACHED = total_page_available)
)
SELECT 'Access Story Creation' AS `User Type`, (SELECT users FROM story_creation_started) AS users
UNION ALL
SELECT 'Access Story Reading' AS `User Type`, (SELECT users FROM tbl_illustration_book_started) AS users
UNION ALL
SELECT 'Finish reading at least 1 story' AS `User Type`, (SELECT users FROM tbl_illustration_book_finished) AS users
ORDER BY users DESC;",21.3017578125
"WITH tbl_users_launch_lets_story AS (
    SELECT COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (screen_from IN ('World Map', 'Mini Game Screen') OR screen_from LIKE 'Eduland%Minigame Menu')
        AND screen_to = 'Eduland Lets Story'
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
story_creation_started AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to = 'Eduland Lets Story - Story Creation'
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
story_creation_finished AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
    WHERE activity_01 = 'Experience - Lets Story - New Story Created'
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_illustration_book_started AS (
    SELECT COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to = 'Eduland Lets Story - Story Reading'
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_illustration_book_finished AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.illustration_book_finished`
    WHERE story_title LIKE 'Experience - Lets Story%'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND (end_cause = 'Finished' OR MAX_PAGE_REACHED = total_page_available)
)
SELECT 'Access Story Creation' AS `User Type`, (SELECT users FROM story_creation_started) AS users
UNION ALL
SELECT 'Access Story Reading' AS `User Type`, (SELECT users FROM tbl_illustration_book_started) AS users
UNION ALL
SELECT 'Finish reading at least 1 story' AS `User Type`, (SELECT users FROM tbl_illustration_book_finished) AS users
ORDER BY users DESC;",21.3017578125
"WITH 
tbl_apd_users AS (
    SELECT 
        DATE_TRUNC(client_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS apd_users
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    WHERE 1=1
    AND version >= '5.0.0'
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
),
ls_users AS (
    SELECT 
        DATE_TRUNC(server_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS number_ls_users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
    ORDER BY month
)
SELECT 
    month, 
    `number_ls_users` AS `Users access Lets Story`, 
    `number_ls_users`/ apd_users AS `% APD Users Access Lets Story`
FROM ls_users 
LEFT JOIN tbl_apd_users USING (month)
ORDER BY month;",20.619140625
"WITH 
tbl_apd_users AS (
    SELECT 
        DATE_TRUNC(client_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS apd_users
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    WHERE 1=1
    AND version >= '5.0.0'
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
),
ls_users AS (
    SELECT 
        DATE_TRUNC(server_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS number_ls_users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
    ORDER BY month
)
SELECT 
    month, 
    `number_ls_users` AS `Users access Lets Story`, 
    `number_ls_users`/ apd_users AS `% APD Users Access Lets Story`
FROM ls_users 
LEFT JOIN tbl_apd_users USING (month)
ORDER BY month;",20.5166015625
"WITH 
tbl_apd_users AS (
    SELECT 
        DATE_TRUNC(client_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS apd_users
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    WHERE 1=1
    AND version >= '5.0.0'
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
),
ls_users AS (
    SELECT 
        DATE_TRUNC(server_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS number_ls_users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
    ORDER BY month
)
SELECT 
    month, 
    `number_ls_users` AS `Users access Lets Story`, 
    `number_ls_users`/ apd_users AS `% APD Users Access Lets Story`
FROM ls_users 
LEFT JOIN tbl_apd_users USING (month)
ORDER BY month;",20.5166015625
"WITH 
tbl_apd_users AS (
    SELECT 
        DATE_TRUNC(client_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS apd_users
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    WHERE 1=1
    AND version >= '5.0.0'
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
),
ls_users AS (
    SELECT 
        DATE_TRUNC(server_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS number_ls_users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
    ORDER BY month
)
SELECT 
    month, 
    `number_ls_users` AS `Users access Lets Story`, 
    `number_ls_users`/ apd_users AS `% APD Users Access Lets Story`
FROM ls_users 
LEFT JOIN tbl_apd_users USING (month)
ORDER BY month;",20.5166015625
"WITH 
tbl_apd_users AS (
    SELECT 
        DATE_TRUNC(client_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS apd_users
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    WHERE 1=1
    AND version >= '5.0.0'
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
),
ls_users AS (
    SELECT 
        DATE_TRUNC(server_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS number_ls_users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
    ORDER BY month
)
SELECT 
    month, 
    `number_ls_users` AS `Users access Lets Story`, 
    `number_ls_users`/ apd_users AS `% APD Users Access Lets Story`
FROM ls_users 
LEFT JOIN tbl_apd_users USING (month)
ORDER BY month;",20.5166015625
"WITH 
tbl_apd_users AS (
    SELECT 
        DATE_TRUNC(client_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS apd_users
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    WHERE 1=1
    AND version >= '5.0.0'
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(client_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND (`applaydu.tbl_country_filter`.`country_name` = ?))
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
),
ls_users AS (
    SELECT 
        DATE_TRUNC(server_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS number_ls_users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND (`applaydu.tbl_country_filter`.`country_name` = ?))
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
    ORDER BY month
)
SELECT 
    month, 
    `number_ls_users` AS `Users access Lets Story`, 
    `number_ls_users`/ apd_users AS `% APD Users Access Lets Story`
FROM ls_users 
LEFT JOIN tbl_apd_users USING (month)
ORDER BY month;",20.5166015625
"WITH 
tbl_apd_users AS (
    SELECT 
        DATE_TRUNC(client_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS apd_users
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    WHERE 1=1
    AND version >= '5.0.0'
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
),
ls_users AS (
    SELECT 
        DATE_TRUNC(server_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS number_ls_users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
    ORDER BY month
)
SELECT 
    month, 
    `number_ls_users` AS `Users access Lets Story`, 
    `number_ls_users`/ apd_users AS `% APD Users Access Lets Story`
FROM ls_users 
LEFT JOIN tbl_apd_users USING (month)
ORDER BY month;",20.5166015625
"WITH 
tbl_apd_users AS (
    SELECT 
        DATE_TRUNC(client_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS apd_users
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    WHERE 1=1
    AND version >= '5.0.0'
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
),
ls_users AS (
    SELECT 
        DATE_TRUNC(server_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS number_ls_users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
    ORDER BY month
)
SELECT 
    month, 
    `number_ls_users` AS `Users access Lets Story`, 
    `number_ls_users`/ apd_users AS `% APD Users Access Lets Story`
FROM ls_users 
LEFT JOIN tbl_apd_users USING (month)
ORDER BY month;",20.5166015625
"WITH 
tbl_apd_users AS (
    SELECT 
        DATE_TRUNC(client_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS apd_users
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    WHERE 1=1
    AND version >= '5.0.0'
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
),
ls_users AS (
    SELECT 
        DATE_TRUNC(server_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS number_ls_users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
    ORDER BY month
)
SELECT 
    month, 
    `number_ls_users` AS `Users access Lets Story`, 
    `number_ls_users`/ apd_users AS `% APD Users Access Lets Story`
FROM ls_users 
LEFT JOIN tbl_apd_users USING (month)
ORDER BY month;",20.5166015625
"WITH 
tbl_apd_users AS (
    SELECT 
        DATE_TRUNC(client_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS apd_users
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    WHERE 1=1
    AND version >= '5.0.0'
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
),
ls_users AS (
    SELECT 
        DATE_TRUNC(server_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS number_ls_users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
    ORDER BY month
)
SELECT 
    month, 
    `number_ls_users` AS `Users access Lets Story`, 
    `number_ls_users`/ apd_users AS `% APD Users Access Lets Story`
FROM ls_users 
LEFT JOIN tbl_apd_users USING (month)
ORDER BY month;",20.515625
"WITH 
tbl_apd_users AS (
    SELECT 
        DATE_TRUNC(client_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS apd_users
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    WHERE 1=1
    AND version >= '5.0.0'
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
),
ls_users AS (
    SELECT 
        DATE_TRUNC(server_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS number_ls_users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
    ORDER BY month
)
SELECT 
    month, 
    `number_ls_users` AS `Users access Lets Story`, 
    `number_ls_users`/ apd_users AS `% APD Users Access Lets Story`
FROM ls_users 
LEFT JOIN tbl_apd_users USING (month)
ORDER BY month;",20.515625
"WITH 
tbl_apd_users AS (
    SELECT 
        DATE_TRUNC(client_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS apd_users
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    WHERE 1=1
    AND version >= '5.0.0'
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
),
ls_users AS (
    SELECT 
        DATE_TRUNC(server_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS number_ls_users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
    ORDER BY month
)
SELECT 
    month, 
    `number_ls_users` AS `Users access Lets Story`, 
    `number_ls_users`/ apd_users AS `% APD Users Access Lets Story`
FROM ls_users 
LEFT JOIN tbl_apd_users USING (month)
ORDER BY month;",20.515625
"WITH 
tbl_apd_users AS (
    SELECT 
        DATE_TRUNC(client_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS apd_users
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    WHERE 1=1
    AND version >= '5.0.0'
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
),
ls_users AS (
    SELECT 
        DATE_TRUNC(server_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS number_ls_users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
    ORDER BY month
)
SELECT 
    month, 
    `number_ls_users` AS `Users access Lets Story`, 
    `number_ls_users`/ apd_users AS `% APD Users Access Lets Story`
FROM ls_users 
LEFT JOIN tbl_apd_users USING (month)
ORDER BY month;",20.515625
"WITH 
tbl_apd_users AS (
    SELECT 
        DATE_TRUNC(client_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS apd_users
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    WHERE 1=1
    AND version >= '5.0.0'
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
),
ls_users AS (
    SELECT 
        DATE_TRUNC(server_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS number_ls_users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
    ORDER BY month
)
SELECT 
    month, 
    `number_ls_users` AS `Users access Lets Story`, 
    `number_ls_users`/ apd_users AS `% APD Users Access Lets Story`
FROM ls_users 
LEFT JOIN tbl_apd_users USING (month)
ORDER BY month;",20.515625
"WITH bookshelf AS (
    SELECT
        SAFE_DIVIDE(SUM(time_spent), COUNT(DISTINCT user_id)) AS avg_time_spent,
        FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SAFE_DIVIDE(SUM(time_spent), COUNT(DISTINCT user_id)) AS INT64))) AS `Average time spent per user`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_from = 'Eduland Lets Story - BookShelf'
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND time_spent > 0 AND time_spent < 36000
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    COUNT(*) AS events,
    SAFE_DIVIDE(COUNT(*), COUNT(DISTINCT user_id)) AS `Avg bookshelf access per user`,
    (SELECT `Average time spent per user` FROM bookshelf) AS `Average time spent per user`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_to = 'Eduland Lets Story - BookShelf'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 );",20.064453125
"WITH bookshelf AS (
    SELECT
        SAFE_DIVIDE(SUM(time_spent), COUNT(DISTINCT user_id)) AS avg_time_spent,
        FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SAFE_DIVIDE(SUM(time_spent), COUNT(DISTINCT user_id)) AS INT64))) AS `Average time spent per user`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_from = 'Eduland Lets Story - BookShelf'
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND time_spent > 0 AND time_spent < 36000
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    COUNT(*) AS events,
    SAFE_DIVIDE(COUNT(*), COUNT(DISTINCT user_id)) AS `Avg bookshelf access per user`,
    (SELECT `Average time spent per user` FROM bookshelf) AS `Average time spent per user`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_to = 'Eduland Lets Story - BookShelf'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 );",20.064453125
"WITH story_creation_section_time_spent AS (
    SELECT 
        SAFE_DIVIDE(SUM(time_spent), COUNT(DISTINCT user_id)) AS time_result1,
        AVG(time_spent) AS time_result2,
        FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SAFE_DIVIDE(SUM(time_spent), COUNT(DISTINCT user_id)) AS INT64))) AS `Time spent per user in Story Creation`,
        FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(AVG(time_spent) AS INT64))) AS `Story Creation Session Duration`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_from = 'Eduland Lets Story - Story Creation'
        AND time_spent >= 0 AND time_spent < 36000
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    COUNT(*) AS sessions,
    SAFE_DIVIDE(COUNT(*), COUNT(DISTINCT user_id)) AS avg_sessions,
    (SELECT `Time spent per user in Story Creation` FROM story_creation_section_time_spent) AS `Time spent per user in Story Creation`,
    (SELECT `Story Creation Session Duration` FROM story_creation_section_time_spent) AS `Story Creation Session Duration`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_to = 'Eduland Lets Story - Story Creation'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 );",20.064453125
"WITH story_creation_section_time_spent AS (
    SELECT 
        SAFE_DIVIDE(SUM(time_spent), COUNT(DISTINCT user_id)) AS time_result1,
        AVG(time_spent) AS time_result2,
        FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SAFE_DIVIDE(SUM(time_spent), COUNT(DISTINCT user_id)) AS INT64))) AS `Time spent per user in Story Creation`,
        FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(AVG(time_spent) AS INT64))) AS `Story Creation Session Duration`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_from = 'Eduland Lets Story - Story Creation'
        AND time_spent >= 0 AND time_spent < 36000
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    COUNT(*) AS sessions,
    SAFE_DIVIDE(COUNT(*), COUNT(DISTINCT user_id)) AS avg_sessions,
    (SELECT `Time spent per user in Story Creation` FROM story_creation_section_time_spent) AS `Time spent per user in Story Creation`,
    (SELECT `Story Creation Session Duration` FROM story_creation_section_time_spent) AS `Story Creation Session Duration`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_to = 'Eduland Lets Story - Story Creation'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 );",20.064453125
"WITH story_creation_section_time_spent AS (
    SELECT 
        SAFE_DIVIDE(SUM(time_spent), COUNT(DISTINCT user_id)) AS time_result1,
        AVG(time_spent) AS time_result2,
        FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SAFE_DIVIDE(SUM(time_spent), COUNT(DISTINCT user_id)) AS INT64))) AS `Time spent per user in Story Creation`,
        FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(AVG(time_spent) AS INT64))) AS `Story Creation Session Duration`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_from = 'Eduland Lets Story - Story Creation'
        AND time_spent >= 0 AND time_spent < 36000
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    COUNT(*) AS sessions,
    SAFE_DIVIDE(COUNT(*), COUNT(DISTINCT user_id)) AS avg_sessions,
    (SELECT `Time spent per user in Story Creation` FROM story_creation_section_time_spent) AS `Time spent per user in Story Creation`,
    (SELECT `Story Creation Session Duration` FROM story_creation_section_time_spent) AS `Story Creation Session Duration`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_to = 'Eduland Lets Story - Story Creation'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 );",20.064453125
"WITH story_creation_section_time_spent AS (
    SELECT 
        SAFE_DIVIDE(SUM(time_spent), COUNT(DISTINCT user_id)) AS time_result1,
        AVG(time_spent) AS time_result2,
        FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SAFE_DIVIDE(SUM(time_spent), COUNT(DISTINCT user_id)) AS INT64))) AS `Time spent per user in Story Creation`,
        FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(AVG(time_spent) AS INT64))) AS `Story Creation Session Duration`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_from = 'Eduland Lets Story - Story Creation'
        AND time_spent >= 0 AND time_spent < 36000
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    COUNT(*) AS sessions,
    SAFE_DIVIDE(COUNT(*), COUNT(DISTINCT user_id)) AS avg_sessions,
    (SELECT `Time spent per user in Story Creation` FROM story_creation_section_time_spent) AS `Time spent per user in Story Creation`,
    (SELECT `Story Creation Session Duration` FROM story_creation_section_time_spent) AS `Story Creation Session Duration`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_to = 'Eduland Lets Story - Story Creation'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 );",20.064453125
"WITH 
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_ls_sections AS (
    SELECT 
        REPLACE(screen_to, 'Eduland Lets Story - ', '') AS section, 
        COUNT(DISTINCT user_id) / (SELECT users FROM tbl_users_launch_lets_story) AS `% LS Users access each section`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to LIKE 'Eduland Lets Story%'
    AND screen_to <> 'Eduland Lets Story'
    AND time_spent >= 0 
    AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY section
)
SELECT *
FROM tbl_ls_sections
ORDER BY `% LS Users access each section` DESC;",20.064453125
"WITH 
tbl_apd_users AS (
    SELECT 
        DATE_TRUNC(client_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS apd_users
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    WHERE 1=1
    AND version >= '5.0.0'
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(client_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND (`applaydu.tbl_country_filter`.`country_name` = ?))
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
),
ls_users AS (
    SELECT 
        DATE_TRUNC(server_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS number_ls_users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND (`applaydu.tbl_country_filter`.`country_name` = ?))
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
    ORDER BY month
)
SELECT 
    month, 
    `number_ls_users` AS `Users access Lets Story`, 
    `number_ls_users`/ apd_users AS `% APD Users Access Lets Story`
FROM ls_users 
LEFT JOIN tbl_apd_users USING (month)
ORDER BY month;",20.033203125
"WITH 
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_ls_sections AS (
    SELECT 
        REPLACE(screen_to, 'Eduland Lets Story - ', '') AS section, 
        COUNT(DISTINCT user_id) / (SELECT users FROM tbl_users_launch_lets_story) AS `% LS Users access each section`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to LIKE 'Eduland Lets Story%'
    AND screen_to <> 'Eduland Lets Story'
    AND time_spent >= 0 
    AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY section
)
SELECT *
FROM tbl_ls_sections
ORDER BY `% LS Users access each section` DESC;",19.96484375
"WITH 
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_ls_sections AS (
    SELECT 
        REPLACE(screen_to, 'Eduland Lets Story - ', '') AS section, 
        COUNT(DISTINCT user_id) / (SELECT users FROM tbl_users_launch_lets_story) AS `% LS Users access each section`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to LIKE 'Eduland Lets Story%'
    AND screen_to <> 'Eduland Lets Story'
    AND time_spent >= 0 
    AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY section
)
SELECT *
FROM tbl_ls_sections
ORDER BY `% LS Users access each section` DESC;",19.96484375
"WITH 
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND (`applaydu.tbl_country_filter`.`country_name` = ?))
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_ls_sections AS (
    SELECT 
        REPLACE(screen_to, 'Eduland Lets Story - ', '') AS section, 
        COUNT(DISTINCT user_id) / (SELECT users FROM tbl_users_launch_lets_story) AS `% LS Users access each section`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to LIKE 'Eduland Lets Story%'
    AND screen_to <> 'Eduland Lets Story'
    AND time_spent >= 0 
    AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND (`applaydu.tbl_country_filter`.`country_name` = ?))
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY section
)
SELECT *
FROM tbl_ls_sections
ORDER BY `% LS Users access each section` DESC;",19.96484375
"WITH 
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_ls_sections AS (
    SELECT 
        REPLACE(screen_to, 'Eduland Lets Story - ', '') AS section, 
        COUNT(DISTINCT user_id) / (SELECT users FROM tbl_users_launch_lets_story) AS `% LS Users access each section`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to LIKE 'Eduland Lets Story%'
    AND screen_to <> 'Eduland Lets Story'
    AND time_spent >= 0 
    AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY section
)
SELECT *
FROM tbl_ls_sections
ORDER BY `% LS Users access each section` DESC;",19.96484375
"WITH 
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_ls_sections AS (
    SELECT 
        REPLACE(screen_to, 'Eduland Lets Story - ', '') AS section, 
        COUNT(DISTINCT user_id) / (SELECT users FROM tbl_users_launch_lets_story) AS `% LS Users access each section`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to LIKE 'Eduland Lets Story%'
    AND screen_to <> 'Eduland Lets Story'
    AND time_spent >= 0 
    AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY section
)
SELECT *
FROM tbl_ls_sections
ORDER BY `% LS Users access each section` DESC;",19.96484375
"WITH 
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_ls_sections AS (
    SELECT 
        REPLACE(screen_to, 'Eduland Lets Story - ', '') AS section, 
        COUNT(DISTINCT user_id) / (SELECT users FROM tbl_users_launch_lets_story) AS `% LS Users access each section`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to LIKE 'Eduland Lets Story%'
    AND screen_to <> 'Eduland Lets Story'
    AND time_spent >= 0 
    AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY section
)
SELECT *
FROM tbl_ls_sections
ORDER BY `% LS Users access each section` DESC;",19.96484375
"WITH 
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_ls_sections AS (
    SELECT 
        REPLACE(screen_to, 'Eduland Lets Story - ', '') AS section, 
        COUNT(DISTINCT user_id) / (SELECT users FROM tbl_users_launch_lets_story) AS `% LS Users access each section`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to LIKE 'Eduland Lets Story%'
    AND screen_to <> 'Eduland Lets Story'
    AND time_spent >= 0 
    AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY section
)
SELECT *
FROM tbl_ls_sections
ORDER BY `% LS Users access each section` DESC;",19.96484375
"WITH 
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_ls_sections AS (
    SELECT 
        REPLACE(screen_to, 'Eduland Lets Story - ', '') AS section, 
        COUNT(DISTINCT user_id) / (SELECT users FROM tbl_users_launch_lets_story) AS `% LS Users access each section`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to LIKE 'Eduland Lets Story%'
    AND screen_to <> 'Eduland Lets Story'
    AND time_spent >= 0 
    AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY section
)
SELECT *
FROM tbl_ls_sections
ORDER BY `% LS Users access each section` DESC;",19.96484375
"WITH 
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_ls_sections AS (
    SELECT 
        REPLACE(screen_to, 'Eduland Lets Story - ', '') AS section, 
        COUNT(DISTINCT user_id) / (SELECT users FROM tbl_users_launch_lets_story) AS `% LS Users access each section`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to LIKE 'Eduland Lets Story%'
    AND screen_to <> 'Eduland Lets Story'
    AND time_spent >= 0 
    AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY section
)
SELECT *
FROM tbl_ls_sections
ORDER BY `% LS Users access each section` DESC;",19.96484375
"WITH 
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_ls_sections AS (
    SELECT 
        REPLACE(screen_to, 'Eduland Lets Story - ', '') AS section, 
        COUNT(DISTINCT user_id) / (SELECT users FROM tbl_users_launch_lets_story) AS `% LS Users access each section`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to LIKE 'Eduland Lets Story%'
    AND screen_to <> 'Eduland Lets Story'
    AND time_spent >= 0 
    AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY section
)
SELECT *
FROM tbl_ls_sections
ORDER BY `% LS Users access each section` DESC;",19.96484375
"WITH 
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_ls_sections AS (
    SELECT 
        REPLACE(screen_to, 'Eduland Lets Story - ', '') AS section, 
        COUNT(DISTINCT user_id) / (SELECT users FROM tbl_users_launch_lets_story) AS `% LS Users access each section`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to LIKE 'Eduland Lets Story%'
    AND screen_to <> 'Eduland Lets Story'
    AND time_spent >= 0 
    AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY section
)
SELECT *
FROM tbl_ls_sections
ORDER BY `% LS Users access each section` DESC;",19.96484375
"WITH 
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND (`applaydu.tbl_country_filter`.`country_name` = ?))
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_ls_sections AS (
    SELECT 
        REPLACE(screen_to, 'Eduland Lets Story - ', '') AS section, 
        COUNT(DISTINCT user_id) / (SELECT users FROM tbl_users_launch_lets_story) AS `% LS Users access each section`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to LIKE 'Eduland Lets Story%'
    AND screen_to <> 'Eduland Lets Story'
    AND time_spent >= 0 
    AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND (`applaydu.tbl_country_filter`.`country_name` = ?))
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY section
)
SELECT *
FROM tbl_ls_sections
ORDER BY `% LS Users access each section` DESC;",19.96484375
"WITH 
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_ls_sections AS (
    SELECT 
        REPLACE(screen_to, 'Eduland Lets Story - ', '') AS section, 
        COUNT(DISTINCT user_id) / (SELECT users FROM tbl_users_launch_lets_story) AS `% LS Users access each section`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to LIKE 'Eduland Lets Story%'
    AND screen_to <> 'Eduland Lets Story'
    AND time_spent >= 0 
    AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY section
)
SELECT *
FROM tbl_ls_sections
ORDER BY `% LS Users access each section` DESC;",19.96484375
"WITH 
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_ls_sections AS (
    SELECT 
        REPLACE(screen_to, 'Eduland Lets Story - ', '') AS section, 
        COUNT(DISTINCT user_id) / (SELECT users FROM tbl_users_launch_lets_story) AS `% LS Users access each section`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to LIKE 'Eduland Lets Story%'
    AND screen_to <> 'Eduland Lets Story'
    AND time_spent >= 0 
    AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY section
)
SELECT *
FROM tbl_ls_sections
ORDER BY `% LS Users access each section` DESC;",19.96484375
"WITH 
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_ls_sections AS (
    SELECT 
        REPLACE(screen_to, 'Eduland Lets Story - ', '') AS section, 
        COUNT(DISTINCT user_id) / (SELECT users FROM tbl_users_launch_lets_story) AS `% LS Users access each section`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to LIKE 'Eduland Lets Story%'
    AND screen_to <> 'Eduland Lets Story'
    AND time_spent >= 0 
    AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY section
)
SELECT *
FROM tbl_ls_sections
ORDER BY `% LS Users access each section` DESC;",19.96484375
"SELECT 
    SAFE_DIVIDE(COUNT(*), COUNT(DISTINCT user_id)) AS `AVG Story created per user`
FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
WHERE activity_01 = 'Experience - Lets Story - New Story Created'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 );",19.8662109375
"SELECT 
    SAFE_DIVIDE(COUNT(*), COUNT(DISTINCT user_id)) AS `AVG Story created per user`
FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
WHERE activity_01 = 'Experience - Lets Story - New Story Created'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 );",19.8662109375
"SELECT 
    SAFE_DIVIDE(COUNT(*), COUNT(DISTINCT user_id)) AS `AVG Story created per user`
FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
WHERE activity_01 = 'Experience - Lets Story - New Story Created'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 );",19.8662109375
"WITH gb4260 as (SELECT 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (unlock_cause = 'QR Code'
        OR unlock_cause = 'Toy Scan' 
        OR unlock_cause = 'Deep_Link')
        AND isnewtoy = 1
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
        AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1  )
    GROUP BY user_id
),
Persona AS (
    SELECT user_id, 
           CASE WHEN `Number of Toys Unlocked` IN (1,2,3) THEN 'Persona #2'
                ELSE 'Persona #3' END AS `Persona Type`
    FROM unlock
)
SELECT EXTRACT(YEAR FROM client_time) AS year,
       EXTRACT(MONTH FROM client_time) AS month,
       CONCAT(EXTRACT(YEAR FROM client_time), ' ', FORMAT_TIMESTAMP('%B', client_time)) AS `Time`,
       CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END AS `Persona_Type`,
       COUNT(DISTINCT l.user_id) AS Total
FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` l
JOIN (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
    WHERE 1=1 
    AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
) USING (user_id)
LEFT JOIN Persona p ON l.user_id = p.user_id
WHERE l.user_id IS NOT NULL
AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
AND client_time >= TIMESTAMP((SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?))
AND client_time < TIMESTAMP(DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY))
AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1  )
AND CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
AND client_time >= TIMESTAMP(DATE_SUB(DATE_TRUNC(CURRENT_DATE(), month), INTERVAL 2 YEAR))
AND client_time < TIMESTAMP(DATE_TRUNC(CURRENT_DATE(), month))
GROUP BY year, month, `Time`, `Persona_Type`
ORDER BY year ASC, month ASC, `Persona_Type` ASC",19.1689453125
"WITH gb4260 as (SELECT 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (unlock_cause = 'QR Code'
        OR unlock_cause = 'Toy Scan' 
        OR unlock_cause = 'Deep_Link')
        AND isnewtoy = 1
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
        AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1  )
    GROUP BY user_id
),
Persona AS (
    SELECT user_id, 
           CASE WHEN `Number of Toys Unlocked` IN (1,2,3) THEN 'Persona #2'
                ELSE 'Persona #3' END AS `Persona Type`
    FROM unlock
)
SELECT EXTRACT(YEAR FROM client_time) AS year,
       EXTRACT(MONTH FROM client_time) AS month,
       CONCAT(EXTRACT(YEAR FROM client_time), ' ', FORMAT_TIMESTAMP('%B', client_time)) AS `Time`,
       CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END AS `Persona_Type`,
       COUNT(DISTINCT l.user_id) AS Total
FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` l
JOIN (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
    WHERE 1=1 
    AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
) USING (user_id)
LEFT JOIN Persona p ON l.user_id = p.user_id
WHERE l.user_id IS NOT NULL
AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
AND client_time >= TIMESTAMP((SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?))
AND client_time < TIMESTAMP(DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY))
AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1  )
AND CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
AND client_time >= TIMESTAMP(DATE_SUB(DATE_TRUNC(CURRENT_DATE(), month), INTERVAL 2 YEAR))
AND client_time < TIMESTAMP(DATE_TRUNC(CURRENT_DATE(), month))
GROUP BY year, month, `Time`, `Persona_Type`
ORDER BY year ASC, month ASC, `Persona_Type` ASC",19.1650390625
"-- v4.0.0
WITH gb4258 as (select 0)
,tbl_ua AS (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
    WHERE 1=1 
    AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
    AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
) 
,USER_LAUNCH AS (
    SELECT DISTINCT user_id
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` 
    JOIN tbl_ua USING (user_id)
    WHERE launch_type = 'first_launch'
    AND version >= '5.0.0' AND version < '9.0.0'
    AND DATE(client_time) >=  (SELECT cast(ivalue as DATE) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v4_start_date') 
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND game_id IN (81335, 81337, 85837) 
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
)
,UNIQUE_DA_USER AS (
    SELECT DISTINCT ul.user_id
    FROM `gcp-bi-elephant-db-gold.applaydu.disclaimer_acceptance` AS fe
    RIGHT JOIN user_launch ul ON fe.user_id = ul.user_id
    WHERE version >= '5.0.0' AND version < '9.0.0'
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND game_id IN (81335, 81337, 85837) 
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
)
,choose_scan_free AS (
    SELECT DISTINCT udu.user_id
    FROM `gcp-bi-elephant-db-gold.applaydu.ftue_event` AS fe
    RIGHT JOIN unique_da_user AS udu ON fe.user_id = udu.user_id
    WHERE ftue_stage = 'Start'
    AND ftue_steps = 'Choose Scan Or Unlock'
    AND version >= '5.0.0' AND version < '9.0.0'
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    
)
,deeplink_user AS (
    SELECT user_id
    FROM `gcp-bi-elephant-db-gold.applaydu.dlc_download`
    WHERE 1=1
    AND user_status = 'FTUE'
    AND unlock_cause = 'Deep_Link'
    AND version >= '5.0.0' AND version < '9.0.0'
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    
    EXCEPT DISTINCT
    SELECT DISTINCT user_id
    FROM choose_scan_free
)
,TIME_CONTROL AS (
    SELECT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.time_control_access`
    INNER JOIN unique_da_user USING (user_id)
    WHERE user_status = 'FTUE'
    AND version >= '5.0.0' AND version < '9.0.0'
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
)         
,ALL_DATA AS (
    --FTUE flow start
    (   
    SELECT REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(ftue_steps
        ,'Disclaimer_Acceptance','Parental Agreement ' || ftue_stage)
        ,'Choose Avatar Gender', 'Gender + Difficulty page ' || ftue_stage)
        ,'Avatar_Creation', 'Avatar Creation ' || ftue_stage)
        ,'Enter Avatar Name', 'Avatar Name ' || ftue_stage)
        ,'Avatar_Creation', 'Character Creation ' || ftue_stage)
        ,'Email Registration', 'Email Registration ' || ftue_stage)
        ,'Age Confirmation after Email', 'Age Confirmation after Email ' || ftue_stage)
        ,'Choose Scan Or Unlock', 'Choose No Toy Or Scan ' || ftue_stage)
         AS `Users`
        , COUNT(DISTINCT udu.user_id) AS `Users each step`
    FROM `gcp-bi-elephant-db-gold.applaydu.ftue_event` AS fe
    RIGHT JOIN unique_da_user AS udu ON fe.user_id = udu.user_id
    WHERE ftue_stage = 'Start'
    AND ftue_steps IN ('Choose Avatar Gender', 'Avatar_Creation','Enter Avatar Name','Email Registration')
    AND version >= '5.0.0' AND version < '9.0.0'
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    
    GROUP BY ftue_steps, ftue_stage
    ORDER BY `Users each step` DESC
    )
    UNION ALL
    --Deep link users directly jump to Eduland 
    (   
    SELECT 'Deeplink' AS `Users`
        , COUNT(DISTINCT de.user_id) AS `Users each step`
    FROM deeplink_user de
    RIGHT JOIN unique_da_user AS udu ON de.user_id = udu.user_id
    WHERE 1=1
    GROUP BY `Users`
    ORDER BY `Users each step` DESC
    )
    UNION ALL
    (
    SELECT 'New Users Launch' AS `Users`, COUNT(DISTINCT user_id) AS `Users each step`
    FROM user_launch
    )
)
SELECT *
FROM all_data
WHERE `Users` = 'New Users Launch' OR (`Users` LIKE '%Start' AND `Users` NOT IN ('Camera Permission Start'))
OR `Users` IN ('Deeplink')
UNION all
SELECT 'Time Control' AS `Users`, COUNT(DISTINCT user_id) AS `Users each step`
FROM time_control
UNION all
SELECT 'Parental Agreement Start' AS `Users`, COUNT(DISTINCT user_id) AS `Users each step`
FROM unique_da_user
ORDER BY 
(
CASE 
    WHEN `Users` = 'New Users Launch' THEN 0
    WHEN `Users` = 'Parental Agreement Start' THEN 1
    WHEN `Users` = 'Gender + Difficulty page Start' THEN 2
    WHEN `Users` = 'Gender + Difficulty page Finish' THEN 3
    WHEN `Users` = 'Time Control' THEN 4
    WHEN `Users` = 'Avatar Creation Start' THEN 5
    WHEN `Users` = 'Avatar Creation Finish' THEN 6
    WHEN `Users` = 'Avatar Name Start' THEN 7
    WHEN `Users` = 'Avatar Name Finish' THEN 8
    WHEN `Users` = 'Email Registration Start' THEN 9
    WHEN `Users` = 'Email Registration Finish' THEN 10
    WHEN `Users` = 'Age Confirmation after Email Start' THEN 11
    WHEN `Users` = 'Age Confirmation after Email Finish' THEN 12    
    WHEN `Users` = 'Choose No Toy Or Scan Start' THEN 13
    WHEN `Users` = 'Choose No Toy Or Scan Finish' THEN 14
    WHEN `Users` = 'Choose to Scan' THEN 15
    WHEN `Users` = 'Choose to Unlock Free Toy' THEN 16
    WHEN `Users` = 'Camera Permission Start' THEN 17
    WHEN `Users` = 'Camera Permission Finish' THEN 18
    WHEN `Users` = 'Camera Access explanation screen Start' THEN 19
    WHEN `Users` = 'Camera Access explanation screen Finish' THEN 20
    WHEN `Users` = 'Scan Section Start' THEN 21
    WHEN `Users` = 'Scan Section Finish' THEN 22
    WHEN `Users` = 'Scan toy result Start' THEN 23
    WHEN `Users` = 'Scan toy result Finish' THEN 24
    WHEN `Users` = 'Unlock toy screen Start' THEN 25
    WHEN `Users` = 'Unlock toy screen Finish' THEN 26
    WHEN `Users` = 'Simple Toy AR Start' THEN 27
    WHEN `Users` = 'Simple Toy AR Finish' THEN 28 
    WHEN `Users` = 'World Map final Start' THEN 29
    WHEN `Users` = 'World Map final Finish' THEN 30 
    WHEN `Users` = 'Users Scanned successfully toy 1st time' THEN 31
    WHEN `Users` = 'Users Scanned successfully toy 2nd time' THEN 32 
    WHEN `Users` = 'Users Scanned successfully toy 3rd time' THEN 33 
END
)",19.0888671875
"WITH gb4260 as (SELECT 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (unlock_cause = 'QR Code'
        OR unlock_cause = 'Toy Scan' 
        OR unlock_cause = 'Deep_Link')
        AND isnewtoy = 1
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
        AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1  )
    GROUP BY user_id
),
Persona AS (
    SELECT user_id, 
           CASE WHEN `Number of Toys Unlocked` IN (1,2,3) THEN 'Persona #2'
                ELSE 'Persona #3' END AS `Persona Type`
    FROM unlock
)
SELECT EXTRACT(YEAR FROM client_time) AS year,
       EXTRACT(MONTH FROM client_time) AS month,
       CONCAT(EXTRACT(YEAR FROM client_time), ' ', FORMAT_TIMESTAMP('%B', client_time)) AS `Time`,
       CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END AS `Persona_Type`,
       COUNT(DISTINCT l.user_id) AS Total
FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` l
JOIN (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
    WHERE 1=1 
    AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
) USING (user_id)
LEFT JOIN Persona p ON l.user_id = p.user_id
WHERE l.user_id IS NOT NULL
AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
AND client_time >= TIMESTAMP((SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?))
AND client_time < TIMESTAMP(DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY))
AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1  )
AND CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
AND client_time >= TIMESTAMP(DATE_SUB(DATE_TRUNC(CURRENT_DATE(), month), INTERVAL 2 YEAR))
AND client_time < TIMESTAMP(DATE_TRUNC(CURRENT_DATE(), month))
GROUP BY year, month, `Time`, `Persona_Type`
ORDER BY year ASC, month ASC, `Persona_Type` ASC",19.0322265625
"with bq4238 as (select 0)
SELECT 
    COUNT(DISTINCT user_id) AS total_users,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS total_scans,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 and install_source in (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )   
    AND shop_filter IN (SELECT shop_filter FROM `applaydu.tbl_users` WHERE 1=1 )	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)",18.9951171875
"with bq4238 as (select 0)
SELECT 
    COUNT(DISTINCT user_id) AS total_users,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS total_scans,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 and install_source in (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )   
    AND shop_filter IN (SELECT shop_filter FROM `applaydu.tbl_users` WHERE 1=1 )	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)",18.9951171875
"with bq4238 as (select 0)
SELECT 
    COUNT(DISTINCT user_id) AS total_users,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS total_scans,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 and install_source in (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )   
    AND shop_filter IN (SELECT shop_filter FROM `applaydu.tbl_users` WHERE 1=1 )	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)",18.9677734375
"with bq4238 as (select 0)
SELECT 
    COUNT(DISTINCT user_id) AS total_users,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS total_scans,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 and install_source in (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  AND (`applaydu.tbl_version_filter`.`version` = ?))   
    AND shop_filter IN (SELECT shop_filter FROM `applaydu.tbl_users` WHERE 1=1 )	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)",18.9287109375
"with bq4238 as (select 0)
SELECT 
    COUNT(DISTINCT user_id) AS total_users,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS total_scans,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 and install_source in (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  AND (`applaydu.tbl_version_filter`.`version` = ?))   
    AND shop_filter IN (SELECT shop_filter FROM `applaydu.tbl_users` WHERE 1=1 )	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)",18.9287109375
"WITH 
tbl_users_launch_lets_story AS (
    SELECT 
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_ls_sections AS (
    SELECT 
        REPLACE(screen_to, 'Eduland Lets Story - ', '') AS section, 
        COUNT(DISTINCT user_id) / (SELECT users FROM tbl_users_launch_lets_story) AS `% LS Users access each section`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_to LIKE 'Eduland Lets Story%'
    AND screen_to <> 'Eduland Lets Story'
    AND time_spent >= 0 
    AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY section
)
SELECT *
FROM tbl_ls_sections
ORDER BY `% LS Users access each section` DESC;",18.7421875
"WITH gb4260 as (SELECT 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (unlock_cause = 'QR Code'
        OR unlock_cause = 'Toy Scan' 
        OR unlock_cause = 'Deep_Link')
        AND isnewtoy = 1
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
        AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1  )
    GROUP BY user_id
),
Persona AS (
    SELECT user_id, 
           CASE WHEN `Number of Toys Unlocked` IN (1,2,3) THEN 'Persona #2'
                ELSE 'Persona #3' END AS `Persona Type`
    FROM unlock
)
SELECT EXTRACT(YEAR FROM client_time) AS year,
       EXTRACT(MONTH FROM client_time) AS month,
       CONCAT(EXTRACT(YEAR FROM client_time), ' ', FORMAT_TIMESTAMP('%B', client_time)) AS `Time`,
       CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END AS `Persona_Type`,
       COUNT(DISTINCT l.user_id) AS Total
FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` l
JOIN (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
    WHERE 1=1 
    AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
) USING (user_id)
LEFT JOIN Persona p ON l.user_id = p.user_id
WHERE l.user_id IS NOT NULL
AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
AND client_time >= TIMESTAMP((SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?))
AND client_time < TIMESTAMP(DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY))
AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1  )
AND CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
AND client_time >= TIMESTAMP(DATE_SUB(DATE_TRUNC(CURRENT_DATE(), month), INTERVAL 2 YEAR))
AND client_time < TIMESTAMP(DATE_TRUNC(CURRENT_DATE(), month))
GROUP BY year, month, `Time`, `Persona_Type`
ORDER BY year ASC, month ASC, `Persona_Type` ASC",18.7216796875
"WITH gb4260 as (SELECT 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (unlock_cause = 'QR Code'
        OR unlock_cause = 'Toy Scan' 
        OR unlock_cause = 'Deep_Link')
        AND isnewtoy = 1
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
        AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1  )
    GROUP BY user_id
),
Persona AS (
    SELECT user_id, 
           CASE WHEN `Number of Toys Unlocked` IN (1,2,3) THEN 'Persona #2'
                ELSE 'Persona #3' END AS `Persona Type`
    FROM unlock
)
SELECT EXTRACT(YEAR FROM client_time) AS year,
       EXTRACT(MONTH FROM client_time) AS month,
       CONCAT(EXTRACT(YEAR FROM client_time), ' ', FORMAT_TIMESTAMP('%B', client_time)) AS `Time`,
       CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END AS `Persona_Type`,
       COUNT(DISTINCT l.user_id) AS Total
FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` l
JOIN (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
    WHERE 1=1 
    AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
) USING (user_id)
LEFT JOIN Persona p ON l.user_id = p.user_id
WHERE l.user_id IS NOT NULL
AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
AND client_time >= TIMESTAMP((SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?))
AND client_time < TIMESTAMP(DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY))
AND game_id IN (SELECT game_id FROM `applaydu.tbl_shop_filter` WHERE 1=1  )
AND CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
AND client_time >= TIMESTAMP(DATE_SUB(DATE_TRUNC(CURRENT_DATE(), month), INTERVAL 2 YEAR))
AND client_time < TIMESTAMP(DATE_TRUNC(CURRENT_DATE(), month))
GROUP BY year, month, `Time`, `Persona_Type`
ORDER BY year ASC, month ASC, `Persona_Type` ASC",18.7177734375
"SELECT 
    CONCAT('Season ', LEFT(version, 1)) AS Season,
    COUNT(DISTINCT user_id) AS `Users who have scanned surprises`,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS `Total Scans`,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
    AND version LIKE ANY ('5.%','4.%','3.%')
GROUP BY 
    1
ORDER BY 
    1",18.662109375
"WITH gb4263 as (select 0)
,tbl_story_mode_finished as (
 select user_id,FED_ID,PLATFORM,game_id,EVENT_ID,min(client_time),min(client_time),version,country,SESSION_ID
,min(TOKEN),AVATAR_GENDER,END_CAUSE,TOY_NAME,STORY_STEP,avg(TIME_TO_FINISH)
,ACTIVITY_01,ACTIVITY_01_VALUE,ACTIVITY_02,ACTIVITY_02_VALUE,ACTIVITY_03,ACTIVITY_03_VALUE,ACTIVITY_04
,ACTIVITY_04_VALUE,ACTIVITY_05,ACTIVITY_05_VALUE,AVATAR_ONESIE,click_from,ENVIRONMENT_ID,min(EVENT_client_time_LOCAL)
,avg(REALTIME_SPENT),min(load_time),ACTIVITY_06,ACTIVITY_06_VALUE,ACTIVITY_07,ACTIVITY_07_VALUE
,ACTIVITY_08,ACTIVITY_08_VALUE,ACTIVITY_09,ACTIVITY_09_VALUE,ACTIVITY_10,ACTIVITY_10_VALUE,TOY_UNLOCKED_METHOD,from_scene
 from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 where (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0' 
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 group by all
)
,real_story_mode_finished as (
SELECT user_id,game_id,event_id,version,country,session_id,avatar_gender,end_cause,toy_name,story_step,realtime_spent,environment_id,client_time,toy_unlocked_method,count(*) as dup
FROM 
 (
 -- exclude Dino Exp
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished
 WHERE 
 environment_id like 'Natoons v4%' or
 -- DUPLICATIONS in those Experience
 (environment_id like '%Travel%' and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id NOT IN ('Savannah','Space','Ocean','Jungle','Magic Land','Experience - Dino Museum') AND (environment_id not LIKE '%Travel%') ) or 
 (environment_id='Kinderini' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_kinderini_start_date') ) or 
 (environment_id='Eduland Lets Story' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_v5_lets_story_start_date'))
 -- Dino 
 union all
 -- version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') (normal)
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 WHERE (version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19'))
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 union all
 -- (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0'
 select * from tbl_story_mode_finished
 )
group by all
)
,result as (
SELECT case when environment_id like 'Natoons v4%' then 'Natoons Experience'
 when environment_id like '%Travel%' then 'Travel Experience'
 when environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') then 'Fantasy Experience'
 when environment_id like '%Space%' and environment_id<>'Space' then 'Space Experience'
 when environment_id='Experience - Dino Museum' then 'Dino Experience - since v4.7.0'
 when environment_id='Kinderini' then 'Kinderini'
 when environment_id='Eduland Lets Story' then 'Lets Story'
 else null end as environment
,count (0) as `No of Session`,count (distinct user_id) as `No of Users`
,count (0)/count (distinct user_id) as `Sessions per user`,sum(realtime_spent)/count (distinct user_id)/60 as `Time spent per user in min`
,sum(realtime_spent)/count (0)/60 as `Time spent per session in min`
--,concat(floor(`Time spent per user in min`),' min ',round((`Time spent per user in min` - floor(`Time spent per user in min`)) * 60),' sec') as `Time spent per user (min - sec)`
--,concat(floor(`Time spent per session in min`),' min ',round((`Time spent per session in min` - floor(`Time spent per session in min`)) * 60),' sec') as `Time spent per session (min - sec)`
from real_story_mode_finished
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
group by 1
)
select * 
--,concat(floor(`Time spent per user in min`),' min ',round((`Time spent per user in min` - floor(`Time spent per user in min`)) * 60),' sec') as `Time spent per user in min sec`
--,concat(floor(`Time spent per session in min`),' min ',round((`Time spent per session in min` - floor(`Time spent per session in min`)) * 60),' sec') as `Time spent per session in min sec`

from result 
where Environment is not null
order by `Time spent per user in min` desc",18.03125
"WITH gb4263 as (select 0)
,tbl_story_mode_finished as (
 select user_id,FED_ID,PLATFORM,game_id,EVENT_ID,min(client_time),min(client_time),version,country,SESSION_ID
,min(TOKEN),AVATAR_GENDER,END_CAUSE,TOY_NAME,STORY_STEP,avg(TIME_TO_FINISH)
,ACTIVITY_01,ACTIVITY_01_VALUE,ACTIVITY_02,ACTIVITY_02_VALUE,ACTIVITY_03,ACTIVITY_03_VALUE,ACTIVITY_04
,ACTIVITY_04_VALUE,ACTIVITY_05,ACTIVITY_05_VALUE,AVATAR_ONESIE,click_from,ENVIRONMENT_ID,min(EVENT_client_time_LOCAL)
,avg(REALTIME_SPENT),min(load_time),ACTIVITY_06,ACTIVITY_06_VALUE,ACTIVITY_07,ACTIVITY_07_VALUE
,ACTIVITY_08,ACTIVITY_08_VALUE,ACTIVITY_09,ACTIVITY_09_VALUE,ACTIVITY_10,ACTIVITY_10_VALUE,TOY_UNLOCKED_METHOD,from_scene
 from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 where (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0' 
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 group by all
)
,real_story_mode_finished as (
SELECT user_id,game_id,event_id,version,country,session_id,avatar_gender,end_cause,toy_name,story_step,realtime_spent,environment_id,client_time,toy_unlocked_method,count(*) as dup
FROM 
 (
 -- exclude Dino Exp
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished
 WHERE 
 environment_id like 'Natoons v4%' or
 -- DUPLICATIONS in those Experience
 (environment_id like '%Travel%' and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id NOT IN ('Savannah','Space','Ocean','Jungle','Magic Land','Experience - Dino Museum') AND (environment_id not LIKE '%Travel%') ) or 
 (environment_id='Kinderini' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_kinderini_start_date') ) or 
 (environment_id='Eduland Lets Story' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_v5_lets_story_start_date'))
 -- Dino 
 union all
 -- version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') (normal)
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 WHERE (version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19'))
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 union all
 -- (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0'
 select * from tbl_story_mode_finished
 )
group by all
)
,result as (
SELECT case when environment_id like 'Natoons v4%' then 'Natoons Experience'
 when environment_id like '%Travel%' then 'Travel Experience'
 when environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') then 'Fantasy Experience'
 when environment_id like '%Space%' and environment_id<>'Space' then 'Space Experience'
 when environment_id='Experience - Dino Museum' then 'Dino Experience - since v4.7.0'
 when environment_id='Kinderini' then 'Kinderini'
 when environment_id='Eduland Lets Story' then 'Lets Story'
 else null end as environment
,count (0) as `No of Session`,count (distinct user_id) as `No of Users`
,count (0)/count (distinct user_id) as `Sessions per user`,sum(realtime_spent)/count (distinct user_id)/60 as `Time spent per user in min`
,sum(realtime_spent)/count (0)/60 as `Time spent per session in min`
--,concat(floor(`Time spent per user in min`),' min ',round((`Time spent per user in min` - floor(`Time spent per user in min`)) * 60),' sec') as `Time spent per user (min - sec)`
--,concat(floor(`Time spent per session in min`),' min ',round((`Time spent per session in min` - floor(`Time spent per session in min`)) * 60),' sec') as `Time spent per session (min - sec)`
from real_story_mode_finished
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
group by 1
)
select * 
--,concat(floor(`Time spent per user in min`),' min ',round((`Time spent per user in min` - floor(`Time spent per user in min`)) * 60),' sec') as `Time spent per user in min sec`
--,concat(floor(`Time spent per session in min`),' min ',round((`Time spent per session in min` - floor(`Time spent per session in min`)) * 60),' sec') as `Time spent per session in min sec`

from result 
where Environment is not null
order by `Time spent per user in min` desc",18.01953125
"WITH gb4263 as (select 0)
,tbl_story_mode_finished as (
 select user_id,FED_ID,PLATFORM,game_id,EVENT_ID,min(client_time),min(client_time),version,country,SESSION_ID
,min(TOKEN),AVATAR_GENDER,END_CAUSE,TOY_NAME,STORY_STEP,avg(TIME_TO_FINISH)
,ACTIVITY_01,ACTIVITY_01_VALUE,ACTIVITY_02,ACTIVITY_02_VALUE,ACTIVITY_03,ACTIVITY_03_VALUE,ACTIVITY_04
,ACTIVITY_04_VALUE,ACTIVITY_05,ACTIVITY_05_VALUE,AVATAR_ONESIE,click_from,ENVIRONMENT_ID,min(EVENT_client_time_LOCAL)
,avg(REALTIME_SPENT),min(load_time),ACTIVITY_06,ACTIVITY_06_VALUE,ACTIVITY_07,ACTIVITY_07_VALUE
,ACTIVITY_08,ACTIVITY_08_VALUE,ACTIVITY_09,ACTIVITY_09_VALUE,ACTIVITY_10,ACTIVITY_10_VALUE,TOY_UNLOCKED_METHOD,from_scene
 from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 where (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0' 
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 group by all
)
,real_story_mode_finished as (
SELECT user_id,game_id,event_id,version,country,session_id,avatar_gender,end_cause,toy_name,story_step,realtime_spent,environment_id,client_time,toy_unlocked_method,count(*) as dup
FROM 
 (
 -- exclude Dino Exp
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished
 WHERE 
 environment_id like 'Natoons v4%' or
 -- DUPLICATIONS in those Experience
 (environment_id like '%Travel%' and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id NOT IN ('Savannah','Space','Ocean','Jungle','Magic Land','Experience - Dino Museum') AND (environment_id not LIKE '%Travel%') ) or 
 (environment_id='Kinderini' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_kinderini_start_date') ) or 
 (environment_id='Eduland Lets Story' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_v5_lets_story_start_date'))
 -- Dino 
 union all
 -- version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') (normal)
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 WHERE (version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19'))
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 union all
 -- (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0'
 select * from tbl_story_mode_finished
 )
group by all
)
,result as (
SELECT case when environment_id like 'Natoons v4%' then 'Natoons Experience'
 when environment_id like '%Travel%' then 'Travel Experience'
 when environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') then 'Fantasy Experience'
 when environment_id like '%Space%' and environment_id<>'Space' then 'Space Experience'
 when environment_id='Experience - Dino Museum' then 'Dino Experience - since v4.7.0'
 when environment_id='Kinderini' then 'Kinderini'
 when environment_id='Eduland Lets Story' then 'Lets Story'
 else null end as environment
,count (0) as `No of Session`,count (distinct user_id) as `No of Users`
,count (0)/count (distinct user_id) as `Sessions per user`,sum(realtime_spent)/count (distinct user_id)/60 as `Time spent per user in min`
,sum(realtime_spent)/count (0)/60 as `Time spent per session in min`
--,concat(floor(`Time spent per user in min`),' min ',round((`Time spent per user in min` - floor(`Time spent per user in min`)) * 60),' sec') as `Time spent per user (min - sec)`
--,concat(floor(`Time spent per session in min`),' min ',round((`Time spent per session in min` - floor(`Time spent per session in min`)) * 60),' sec') as `Time spent per session (min - sec)`
from real_story_mode_finished
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
group by 1
)
select * 
--,concat(floor(`Time spent per user in min`),' min ',round((`Time spent per user in min` - floor(`Time spent per user in min`)) * 60),' sec') as `Time spent per user in min sec`
--,concat(floor(`Time spent per session in min`),' min ',round((`Time spent per session in min` - floor(`Time spent per session in min`)) * 60),' sec') as `Time spent per session in min sec`

from result 
where Environment is not null
order by `Time spent per user in min` desc",18.01953125
"WITH 
tbl_users_launch_lets_story AS (
    SELECT
        COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_utm AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
    WHERE utm_campaign LIKE '%CLTS%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 'Kinder Chocolate users' AS `User Source`, (SELECT users FROM tbl_utm) AS users
UNION ALL
SELECT 'Organic users' AS `User Source`, (SELECT users FROM tbl_users_launch_lets_story) - (SELECT users FROM tbl_utm) AS users;",17.921875
"WITH 
tbl_users_launch_lets_story AS (
    SELECT
        COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_utm AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
    WHERE utm_campaign LIKE '%CLTS%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 'Kinder Chocolate users' AS `User Source`, (SELECT users FROM tbl_utm) AS users
UNION ALL
SELECT 'Organic users' AS `User Source`, (SELECT users FROM tbl_users_launch_lets_story) - (SELECT users FROM tbl_utm) AS users;",17.8330078125
"WITH 
tbl_users_launch_lets_story AS (
    SELECT
        COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_utm AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
    WHERE utm_campaign LIKE '%CLTS%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 'Kinder Chocolate users' AS `User Source`, (SELECT users FROM tbl_utm) AS users
UNION ALL
SELECT 'Organic users' AS `User Source`, (SELECT users FROM tbl_users_launch_lets_story) - (SELECT users FROM tbl_utm) AS users;",17.8330078125
"WITH 
tbl_users_launch_lets_story AS (
    SELECT
        COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_utm AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
    WHERE utm_campaign LIKE '%CLTS%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 'Kinder Chocolate users' AS `User Source`, (SELECT users FROM tbl_utm) AS users
UNION ALL
SELECT 'Organic users' AS `User Source`, (SELECT users FROM tbl_users_launch_lets_story) - (SELECT users FROM tbl_utm) AS users;",17.8330078125
"WITH 
tbl_users_launch_lets_story AS (
    SELECT
        COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_utm AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
    WHERE utm_campaign LIKE '%CLTS%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 'Kinder Chocolate users' AS `User Source`, (SELECT users FROM tbl_utm) AS users
UNION ALL
SELECT 'Organic users' AS `User Source`, (SELECT users FROM tbl_users_launch_lets_story) - (SELECT users FROM tbl_utm) AS users;",17.8330078125
"WITH 
tbl_users_launch_lets_story AS (
    SELECT
        COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND (`applaydu.tbl_country_filter`.`country_name` = ?))
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_utm AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
    WHERE utm_campaign LIKE '%CLTS%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND (`applaydu.tbl_country_filter`.`country_name` = ?))
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 'Kinder Chocolate users' AS `User Source`, (SELECT users FROM tbl_utm) AS users
UNION ALL
SELECT 'Organic users' AS `User Source`, (SELECT users FROM tbl_users_launch_lets_story) - (SELECT users FROM tbl_utm) AS users;",17.8330078125
"WITH 
tbl_users_launch_lets_story AS (
    SELECT
        COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_utm AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
    WHERE utm_campaign LIKE '%CLTS%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 'Kinder Chocolate users' AS `User Source`, (SELECT users FROM tbl_utm) AS users
UNION ALL
SELECT 'Organic users' AS `User Source`, (SELECT users FROM tbl_users_launch_lets_story) - (SELECT users FROM tbl_utm) AS users;",17.8330078125
"WITH 
tbl_users_launch_lets_story AS (
    SELECT
        COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_utm AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
    WHERE utm_campaign LIKE '%CLTS%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 'Kinder Chocolate users' AS `User Source`, (SELECT users FROM tbl_utm) AS users
UNION ALL
SELECT 'Organic users' AS `User Source`, (SELECT users FROM tbl_users_launch_lets_story) - (SELECT users FROM tbl_utm) AS users;",17.8330078125
"WITH 
tbl_users_launch_lets_story AS (
    SELECT
        COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_utm AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
    WHERE utm_campaign LIKE '%CLTS%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 'Kinder Chocolate users' AS `User Source`, (SELECT users FROM tbl_utm) AS users
UNION ALL
SELECT 'Organic users' AS `User Source`, (SELECT users FROM tbl_users_launch_lets_story) - (SELECT users FROM tbl_utm) AS users;",17.8330078125
"WITH 
tbl_users_launch_lets_story AS (
    SELECT
        COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_utm AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
    WHERE utm_campaign LIKE '%CLTS%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 'Kinder Chocolate users' AS `User Source`, (SELECT users FROM tbl_utm) AS users
UNION ALL
SELECT 'Organic users' AS `User Source`, (SELECT users FROM tbl_users_launch_lets_story) - (SELECT users FROM tbl_utm) AS users;",17.8330078125
"WITH 
tbl_users_launch_lets_story AS (
    SELECT
        COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_utm AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
    WHERE utm_campaign LIKE '%CLTS%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 'Kinder Chocolate users' AS `User Source`, (SELECT users FROM tbl_utm) AS users
UNION ALL
SELECT 'Organic users' AS `User Source`, (SELECT users FROM tbl_users_launch_lets_story) - (SELECT users FROM tbl_utm) AS users;",17.8330078125
"WITH 
tbl_users_launch_lets_story AS (
    SELECT
        COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_utm AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
    WHERE utm_campaign LIKE '%CLTS%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 'Kinder Chocolate users' AS `User Source`, (SELECT users FROM tbl_utm) AS users
UNION ALL
SELECT 'Organic users' AS `User Source`, (SELECT users FROM tbl_users_launch_lets_story) - (SELECT users FROM tbl_utm) AS users;",17.8330078125
"WITH 
tbl_users_launch_lets_story AS (
    SELECT
        COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_utm AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
    WHERE utm_campaign LIKE '%CLTS%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 'Kinder Chocolate users' AS `User Source`, (SELECT users FROM tbl_utm) AS users
UNION ALL
SELECT 'Organic users' AS `User Source`, (SELECT users FROM tbl_users_launch_lets_story) - (SELECT users FROM tbl_utm) AS users;",17.83203125
"SELECT
    country,
    COUNT(DISTINCT user_id) AS users
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE (
    screen_from IN ('World Map', 'Mini Game Screen')
    OR screen_from LIKE 'Eduland%Minigame Menu'
)
AND screen_to = 'Eduland Lets Story'
AND version >= '5.0.0'
AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
AND DATE(server_time) < CURRENT_DATE()
AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY 1;",17.7666015625
"WITH 
tbl_users_launch_lets_story_by_time AS (
    SELECT 
        user_id,
        COUNT(*) AS enter_times
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY user_id
)
SELECT 
    CASE 
        WHEN enter_times <= 5 THEN CONCAT('Play ', CAST(enter_times AS STRING), ' times') 
        ELSE 'Play 5+ times' 
    END AS status,
    COUNT(DISTINCT user_id) / (SELECT COUNT(DISTINCT user_id) FROM tbl_users_launch_lets_story_by_time) AS `% Users replay`
FROM tbl_users_launch_lets_story_by_time
WHERE enter_times > 1
GROUP BY status
ORDER BY status;",17.7666015625
"WITH 
tbl_users_launch_lets_story_by_time AS (
    SELECT 
        user_id,
        COUNT(*) AS enter_times
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY user_id
)
SELECT 
    CASE 
        WHEN enter_times <= 5 THEN CONCAT('Play ', CAST(enter_times AS STRING), ' times') 
        ELSE 'Play 5+ times' 
    END AS status,
    COUNT(DISTINCT user_id) / (SELECT COUNT(DISTINCT user_id) FROM tbl_users_launch_lets_story_by_time) AS `% Users replay`
FROM tbl_users_launch_lets_story_by_time
WHERE enter_times > 1
GROUP BY status
ORDER BY status;",17.6806640625
"SELECT
    country,
    COUNT(DISTINCT user_id) AS users
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE (
    screen_from IN ('World Map', 'Mini Game Screen')
    OR screen_from LIKE 'Eduland%Minigame Menu'
)
AND screen_to = 'Eduland Lets Story'
AND version >= '5.0.0'
AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
AND DATE(server_time) < CURRENT_DATE()
AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY 1;",17.677734375
"WITH 
tbl_users_launch_lets_story_by_time AS (
    SELECT 
        user_id,
        COUNT(*) AS enter_times
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY user_id
)
SELECT 
    CASE 
        WHEN enter_times <= 5 THEN CONCAT('Play ', CAST(enter_times AS STRING), ' times') 
        ELSE 'Play 5+ times' 
    END AS status,
    COUNT(DISTINCT user_id) / (SELECT COUNT(DISTINCT user_id) FROM tbl_users_launch_lets_story_by_time) AS `% Users replay`
FROM tbl_users_launch_lets_story_by_time
WHERE enter_times > 1
GROUP BY status
ORDER BY status;",17.677734375
"SELECT
    country,
    COUNT(DISTINCT user_id) AS users
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE (
    screen_from IN ('World Map', 'Mini Game Screen')
    OR screen_from LIKE 'Eduland%Minigame Menu'
)
AND screen_to = 'Eduland Lets Story'
AND version >= '5.0.0'
AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
AND DATE(server_time) < CURRENT_DATE()
AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY 1;",17.677734375
"SELECT
    country,
    COUNT(DISTINCT user_id) AS users
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE (
    screen_from IN ('World Map', 'Mini Game Screen')
    OR screen_from LIKE 'Eduland%Minigame Menu'
)
AND screen_to = 'Eduland Lets Story'
AND version >= '5.0.0'
AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
AND DATE(server_time) < CURRENT_DATE()
AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY 1;",17.677734375
"SELECT
    country,
    COUNT(DISTINCT user_id) AS users
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE (
    screen_from IN ('World Map', 'Mini Game Screen')
    OR screen_from LIKE 'Eduland%Minigame Menu'
)
AND screen_to = 'Eduland Lets Story'
AND version >= '5.0.0'
AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
AND DATE(server_time) < CURRENT_DATE()
AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY 1;",17.677734375
"SELECT
    country,
    COUNT(DISTINCT user_id) AS users
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE (
    screen_from IN ('World Map', 'Mini Game Screen')
    OR screen_from LIKE 'Eduland%Minigame Menu'
)
AND screen_to = 'Eduland Lets Story'
AND version >= '5.0.0'
AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
AND DATE(server_time) < CURRENT_DATE()
AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY 1;",17.677734375
"SELECT
    country,
    COUNT(DISTINCT user_id) AS users
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE (
    screen_from IN ('World Map', 'Mini Game Screen')
    OR screen_from LIKE 'Eduland%Minigame Menu'
)
AND screen_to = 'Eduland Lets Story'
AND version >= '5.0.0'
AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
AND DATE(server_time) < CURRENT_DATE()
AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY 1;",17.677734375
"WITH 
tbl_users_launch_lets_story_by_time AS (
    SELECT 
        user_id,
        COUNT(*) AS enter_times
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY user_id
)
SELECT 
    CASE 
        WHEN enter_times <= 5 THEN CONCAT('Play ', CAST(enter_times AS STRING), ' times') 
        ELSE 'Play 5+ times' 
    END AS status,
    COUNT(DISTINCT user_id) / (SELECT COUNT(DISTINCT user_id) FROM tbl_users_launch_lets_story_by_time) AS `% Users replay`
FROM tbl_users_launch_lets_story_by_time
WHERE enter_times > 1
GROUP BY status
ORDER BY status;",17.677734375
"WITH 
tbl_users_launch_lets_story_by_time AS (
    SELECT 
        user_id,
        COUNT(*) AS enter_times
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND (`applaydu.tbl_country_filter`.`country_name` = ?))
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY user_id
)
SELECT 
    CASE 
        WHEN enter_times <= 5 THEN CONCAT('Play ', CAST(enter_times AS STRING), ' times') 
        ELSE 'Play 5+ times' 
    END AS status,
    COUNT(DISTINCT user_id) / (SELECT COUNT(DISTINCT user_id) FROM tbl_users_launch_lets_story_by_time) AS `% Users replay`
FROM tbl_users_launch_lets_story_by_time
WHERE enter_times > 1
GROUP BY status
ORDER BY status;",17.677734375
"WITH 
tbl_users_launch_lets_story_by_time AS (
    SELECT 
        user_id,
        COUNT(*) AS enter_times
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY user_id
)
SELECT 
    CASE 
        WHEN enter_times <= 5 THEN CONCAT('Play ', CAST(enter_times AS STRING), ' times') 
        ELSE 'Play 5+ times' 
    END AS status,
    COUNT(DISTINCT user_id) / (SELECT COUNT(DISTINCT user_id) FROM tbl_users_launch_lets_story_by_time) AS `% Users replay`
FROM tbl_users_launch_lets_story_by_time
WHERE enter_times > 1
GROUP BY status
ORDER BY status;",17.677734375
"WITH 
tbl_users_launch_lets_story_by_time AS (
    SELECT 
        user_id,
        COUNT(*) AS enter_times
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY user_id
)
SELECT 
    CASE 
        WHEN enter_times <= 5 THEN CONCAT('Play ', CAST(enter_times AS STRING), ' times') 
        ELSE 'Play 5+ times' 
    END AS status,
    COUNT(DISTINCT user_id) / (SELECT COUNT(DISTINCT user_id) FROM tbl_users_launch_lets_story_by_time) AS `% Users replay`
FROM tbl_users_launch_lets_story_by_time
WHERE enter_times > 1
GROUP BY status
ORDER BY status;",17.677734375
"SELECT
    country,
    COUNT(DISTINCT user_id) AS users
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE (
    screen_from IN ('World Map', 'Mini Game Screen')
    OR screen_from LIKE 'Eduland%Minigame Menu'
)
AND screen_to = 'Eduland Lets Story'
AND version >= '5.0.0'
AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
AND DATE(server_time) < CURRENT_DATE()
AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY 1;",17.677734375
"WITH 
tbl_users_launch_lets_story_by_time AS (
    SELECT 
        user_id,
        COUNT(*) AS enter_times
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY user_id
)
SELECT 
    CASE 
        WHEN enter_times <= 5 THEN CONCAT('Play ', CAST(enter_times AS STRING), ' times') 
        ELSE 'Play 5+ times' 
    END AS status,
    COUNT(DISTINCT user_id) / (SELECT COUNT(DISTINCT user_id) FROM tbl_users_launch_lets_story_by_time) AS `% Users replay`
FROM tbl_users_launch_lets_story_by_time
WHERE enter_times > 1
GROUP BY status
ORDER BY status;",17.677734375
"SELECT
    country,
    COUNT(DISTINCT user_id) AS users
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE (
    screen_from IN ('World Map', 'Mini Game Screen')
    OR screen_from LIKE 'Eduland%Minigame Menu'
)
AND screen_to = 'Eduland Lets Story'
AND version >= '5.0.0'
AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
AND DATE(server_time) < CURRENT_DATE()
AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY 1;",17.677734375
"WITH 
tbl_users_launch_lets_story_by_time AS (
    SELECT 
        user_id,
        COUNT(*) AS enter_times
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY user_id
)
SELECT 
    CASE 
        WHEN enter_times <= 5 THEN CONCAT('Play ', CAST(enter_times AS STRING), ' times') 
        ELSE 'Play 5+ times' 
    END AS status,
    COUNT(DISTINCT user_id) / (SELECT COUNT(DISTINCT user_id) FROM tbl_users_launch_lets_story_by_time) AS `% Users replay`
FROM tbl_users_launch_lets_story_by_time
WHERE enter_times > 1
GROUP BY status
ORDER BY status;",17.677734375
"WITH 
tbl_users_launch_lets_story_by_time AS (
    SELECT 
        user_id,
        COUNT(*) AS enter_times
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY user_id
)
SELECT 
    CASE 
        WHEN enter_times <= 5 THEN CONCAT('Play ', CAST(enter_times AS STRING), ' times') 
        ELSE 'Play 5+ times' 
    END AS status,
    COUNT(DISTINCT user_id) / (SELECT COUNT(DISTINCT user_id) FROM tbl_users_launch_lets_story_by_time) AS `% Users replay`
FROM tbl_users_launch_lets_story_by_time
WHERE enter_times > 1
GROUP BY status
ORDER BY status;",17.677734375
"WITH 
tbl_users_launch_lets_story_by_time AS (
    SELECT 
        user_id,
        COUNT(*) AS enter_times
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY user_id
)
SELECT 
    CASE 
        WHEN enter_times <= 5 THEN CONCAT('Play ', CAST(enter_times AS STRING), ' times') 
        ELSE 'Play 5+ times' 
    END AS status,
    COUNT(DISTINCT user_id) / (SELECT COUNT(DISTINCT user_id) FROM tbl_users_launch_lets_story_by_time) AS `% Users replay`
FROM tbl_users_launch_lets_story_by_time
WHERE enter_times > 1
GROUP BY status
ORDER BY status;",17.677734375
"SELECT
    country,
    COUNT(DISTINCT user_id) AS users
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE (
    screen_from IN ('World Map', 'Mini Game Screen')
    OR screen_from LIKE 'Eduland%Minigame Menu'
)
AND screen_to = 'Eduland Lets Story'
AND version >= '5.0.0'
AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
AND DATE(server_time) < CURRENT_DATE()
AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY 1;",17.677734375
"WITH 
tbl_users_launch_lets_story_by_time AS (
    SELECT 
        user_id,
        COUNT(*) AS enter_times
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY user_id
)
SELECT 
    CASE 
        WHEN enter_times <= 5 THEN CONCAT('Play ', CAST(enter_times AS STRING), ' times') 
        ELSE 'Play 5+ times' 
    END AS status,
    COUNT(DISTINCT user_id) / (SELECT COUNT(DISTINCT user_id) FROM tbl_users_launch_lets_story_by_time) AS `% Users replay`
FROM tbl_users_launch_lets_story_by_time
WHERE enter_times > 1
GROUP BY status
ORDER BY status;",17.677734375
"WITH 
tbl_users_launch_lets_story_by_time AS (
    SELECT 
        user_id,
        COUNT(*) AS enter_times
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND (`applaydu.tbl_country_filter`.`country_name` = ?))
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY user_id
)
SELECT 
    CASE 
        WHEN enter_times <= 5 THEN CONCAT('Play ', CAST(enter_times AS STRING), ' times') 
        ELSE 'Play 5+ times' 
    END AS status,
    COUNT(DISTINCT user_id) / (SELECT COUNT(DISTINCT user_id) FROM tbl_users_launch_lets_story_by_time) AS `% Users replay`
FROM tbl_users_launch_lets_story_by_time
WHERE enter_times > 1
GROUP BY status
ORDER BY status;",17.677734375
"SELECT
    country,
    COUNT(DISTINCT user_id) AS users
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE (
    screen_from IN ('World Map', 'Mini Game Screen')
    OR screen_from LIKE 'Eduland%Minigame Menu'
)
AND screen_to = 'Eduland Lets Story'
AND version >= '5.0.0'
AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
AND DATE(server_time) < CURRENT_DATE()
AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY 1;",17.677734375
"SELECT
    country,
    COUNT(DISTINCT user_id) AS users
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE (
    screen_from IN ('World Map', 'Mini Game Screen')
    OR screen_from LIKE 'Eduland%Minigame Menu'
)
AND screen_to = 'Eduland Lets Story'
AND version >= '5.0.0'
AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
AND DATE(server_time) < CURRENT_DATE()
AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND (`applaydu.tbl_country_filter`.`country_name` = ?))
AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY 1;",17.677734375
"SELECT
    country,
    COUNT(DISTINCT user_id) AS users
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE (
    screen_from IN ('World Map', 'Mini Game Screen')
    OR screen_from LIKE 'Eduland%Minigame Menu'
)
AND screen_to = 'Eduland Lets Story'
AND version >= '5.0.0'
AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
AND DATE(server_time) < CURRENT_DATE()
AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY 1;",17.677734375
"WITH 
tbl_users_launch_lets_story_by_time AS (
    SELECT 
        user_id,
        COUNT(*) AS enter_times
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY user_id
)
SELECT 
    CASE 
        WHEN enter_times <= 5 THEN CONCAT('Play ', CAST(enter_times AS STRING), ' times') 
        ELSE 'Play 5+ times' 
    END AS status,
    COUNT(DISTINCT user_id) / (SELECT COUNT(DISTINCT user_id) FROM tbl_users_launch_lets_story_by_time) AS `% Users replay`
FROM tbl_users_launch_lets_story_by_time
WHERE enter_times > 1
GROUP BY status
ORDER BY status;",17.677734375
"WITH 
tbl_users_launch_lets_story_by_time AS (
    SELECT 
        user_id,
        COUNT(*) AS enter_times
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY user_id
)
SELECT 
    CASE 
        WHEN enter_times <= 5 THEN CONCAT('Play ', CAST(enter_times AS STRING), ' times') 
        ELSE 'Play 5+ times' 
    END AS status,
    COUNT(DISTINCT user_id) / (SELECT COUNT(DISTINCT user_id) FROM tbl_users_launch_lets_story_by_time) AS `% Users replay`
FROM tbl_users_launch_lets_story_by_time
WHERE enter_times > 1
GROUP BY status
ORDER BY status;",17.677734375
"WITH 
tbl_users_launch_lets_story AS (
    SELECT
        COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND (`applaydu.tbl_country_filter`.`country_name` = ?))
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_utm AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
    WHERE utm_campaign LIKE '%CLTS%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND (`applaydu.tbl_country_filter`.`country_name` = ?))
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 'Kinder Chocolate users' AS `User Source`, (SELECT users FROM tbl_utm) AS users
UNION ALL
SELECT 'Organic users' AS `User Source`, (SELECT users FROM tbl_users_launch_lets_story) - (SELECT users FROM tbl_utm) AS users;",17.607421875
"WITH tbl_ls_user_activity AS (
    SELECT t.*, 
        d1.name AS Character
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished` t
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d1 ON d1.id = t.activity_05_value
    WHERE activity_05 = 'Experience - Lets Story - Initial Character Selection'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    SUBSTR(Character, 14, 100) AS `Initial Character Selection`,
    COUNT(*) AS events
FROM tbl_ls_user_activity
GROUP BY `Initial Character Selection`
ORDER BY events DESC;",17.5712890625
"WITH tbl_ls_user_activity AS (
    SELECT t.*, 
        d1.name AS Character
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished` t
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d1 ON d1.id = t.activity_05_value
    WHERE activity_05 = 'Experience - Lets Story - Initial Character Selection'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    SUBSTR(Character, 14, 100) AS `Initial Character Selection`,
    COUNT(*) AS events
FROM tbl_ls_user_activity
GROUP BY `Initial Character Selection`
ORDER BY events DESC;",17.5712890625
"SELECT 
    CASE 
        WHEN activity_01_value = 1 THEN 'Age 3-5'  
        WHEN activity_01_value = 2 THEN 'Age 5-7'  
        ELSE 'Age 7+' 
    END AS `User age`,
    COUNT(DISTINCT user_id)
FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
WHERE scene_name = 'Eduland Lets Story'
    AND activity_01 = 'Experience - Lets Story - Reading Level' 
    AND activity_01_value > 0
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY `User age`
ORDER BY `User age` ASC;",17.5087890625
"WITH gb4263 as (select 0)
,tbl_story_mode_finished as (
 select user_id,FED_ID,PLATFORM,game_id,EVENT_ID,min(client_time),min(client_time),version,country,SESSION_ID
,min(TOKEN),AVATAR_GENDER,END_CAUSE,TOY_NAME,STORY_STEP,avg(TIME_TO_FINISH)
,ACTIVITY_01,ACTIVITY_01_VALUE,ACTIVITY_02,ACTIVITY_02_VALUE,ACTIVITY_03,ACTIVITY_03_VALUE,ACTIVITY_04
,ACTIVITY_04_VALUE,ACTIVITY_05,ACTIVITY_05_VALUE,AVATAR_ONESIE,click_from,ENVIRONMENT_ID,min(EVENT_client_time_LOCAL)
,avg(REALTIME_SPENT),min(load_time),ACTIVITY_06,ACTIVITY_06_VALUE,ACTIVITY_07,ACTIVITY_07_VALUE
,ACTIVITY_08,ACTIVITY_08_VALUE,ACTIVITY_09,ACTIVITY_09_VALUE,ACTIVITY_10,ACTIVITY_10_VALUE,TOY_UNLOCKED_METHOD,from_scene
 from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 where (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0' 
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 group by all
)
,real_story_mode_finished as (
SELECT user_id,game_id,event_id,version,country,session_id,avatar_gender,end_cause,toy_name,story_step,realtime_spent,environment_id,client_time,toy_unlocked_method,count(*) as dup
FROM 
 (
 -- exclude Dino Exp
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished
 WHERE 
 environment_id like 'Natoons v4%' or
 -- DUPLICATIONS in those Experience
 (environment_id like '%Travel%' and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') and ( end_cause<>'Finished' or (end_cause='Finished' and story_step='Ending') ) ) or
 (environment_id NOT IN ('Savannah','Space','Ocean','Jungle','Magic Land','Experience - Dino Museum') AND (environment_id not LIKE '%Travel%') ) or 
 (environment_id='Kinderini' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_kinderini_start_date') ) or 
 (environment_id='Eduland Lets Story' and date(client_time)>=(select date(ivalue) from gcp-gfb-sai-tracking-gold.applaydu.tbl_variables where ikey='apd_v5_lets_story_start_date'))
 -- Dino 
 union all
 -- version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19') (normal)
 select * from gcp-bi-elephant-db-gold.applaydu.story_mode_finished 
 WHERE (version<'5.0.0' or (version >='5.2.0' AND DATE(client_time) >= '2024-10-19'))
 and (environment_id='Experience - Dino Museum' and version>='4.7.0')
 union all
 -- (version >='5.0.0' AND DATE(client_time) >= '2024-08-28') and version<'5.2.0'
 select * from tbl_story_mode_finished
 )
group by all
)
,result as (
SELECT case when environment_id like 'Natoons v4%' then 'Natoons Experience'
 when environment_id like '%Travel%' then 'Travel Experience'
 when environment_id in ('Savannah','Space','Ocean','Jungle','Magic Land') then 'Fantasy Experience'
 when environment_id like '%Space%' and environment_id<>'Space' then 'Space Experience'
 when environment_id='Experience - Dino Museum' then 'Dino Experience - since v4.7.0'
 when environment_id='Kinderini' then 'Kinderini'
 when environment_id='Eduland Lets Story' then 'Lets Story'
 else null end as environment
,count (0) as `No of Session`,count (distinct user_id) as `No of Users`
,count (0)/count (distinct user_id) as `Sessions per user`,sum(realtime_spent)/count (distinct user_id)/60 as `Time spent per user in min`
,sum(realtime_spent)/count (0)/60 as `Time spent per session in min`
--,concat(floor(`Time spent per user in min`),' min ',round((`Time spent per user in min` - floor(`Time spent per user in min`)) * 60),' sec') as `Time spent per user (min - sec)`
--,concat(floor(`Time spent per session in min`),' min ',round((`Time spent per session in min` - floor(`Time spent per session in min`)) * 60),' sec') as `Time spent per session (min - sec)`
from real_story_mode_finished
 join (select distinct user_id from gcp-bi-elephant-db-gold.applaydu.USER_ACTIVITY where 1=1 ) using (user_id)
where 1=1
 and (version >='4.0.0' AND DATE(client_time) >= '2023-08-22') and version<'9.0.0' and date(client_time)<CURRENT_DATE()
 and version>=(select min(version) from `applaydu.tbl_version_filter` where 1=1 ) and version<=(select max(version) from `applaydu.tbl_version_filter` where 1=1 )
 and version in (select version from `applaydu.tbl_version_filter` where 1=1 )
 and date(client_time)>=(SELECT min(server_date) from `applaydu.tbl_date_filter` where 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?) and date(client_time)<DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
 and country in (select country from `applaydu.tbl_country_filter` where 1=1  )
 and realtime_spent>=0
group by 1
)
select * 
--,concat(floor(`Time spent per user in min`),' min ',round((`Time spent per user in min` - floor(`Time spent per user in min`)) * 60),' sec') as `Time spent per user in min sec`
--,concat(floor(`Time spent per session in min`),' min ',round((`Time spent per session in min` - floor(`Time spent per session in min`)) * 60),' sec') as `Time spent per session in min sec`

from result 
where Environment is not null
order by `Time spent per user in min` desc",17.4765625
"SELECT
    country,
    COUNT(DISTINCT user_id) AS users
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE (
    screen_from IN ('World Map', 'Mini Game Screen')
    OR screen_from LIKE 'Eduland%Minigame Menu'
)
AND screen_to = 'Eduland Lets Story'
AND version >= '5.0.0'
AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
AND DATE(server_time) < CURRENT_DATE()
AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND (`applaydu.tbl_country_filter`.`country_name` = ?))
AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY 1;",17.3076171875
"WITH tbl_illustration_book_finished AS (
    SELECT COUNT(*) AS Events,
        COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.illustration_book_finished`
    WHERE story_title LIKE 'Experience - Lets Story%'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_pp_access AS (
    SELECT SUM(ACTIVITY_01_VALUE) AS Events
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished`
    WHERE activity_01 = 'Experience - Lets Story - Parent Prompt Clicked'
        AND scene_name = 'Eduland Lets Story'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    SAFE_DIVIDE((SELECT Events FROM tbl_pp_access), (SELECT Events FROM tbl_illustration_book_finished)) AS `PP access per book`,
    SAFE_DIVIDE((SELECT Events FROM tbl_pp_access), (SELECT users FROM tbl_illustration_book_finished)) AS `PP access per user`;",16.478515625
"SELECT 'Story Creation' AS section, DATE_TRUNC(DATE(server_time), MONTH) AS month,
    SUM(CAST(time_spent AS INT64))/60/COUNT(DISTINCT user_id) AS `Time spent per user_mins`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from = 'Eduland Lets Story - Story Creation'
    AND time_spent >= 0 AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY month

UNION ALL

SELECT 'Story Reading' AS section, DATE_TRUNC(DATE(server_time), MONTH) AS month, 
    SUM(CAST(realtime_spent AS INT64)) /60/COUNT(DISTINCT user_id) AS `Time spent per user_mins`
FROM `gcp-bi-elephant-db-gold.applaydu.illustration_book_finished`
WHERE story_title = 'Experience - Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY month

UNION ALL

SELECT 'Microgames' AS section, DATE_TRUNC(DATE(server_time), MONTH) AS month, 
    SUM(CAST(time_spent AS INT64)) /60/COUNT(DISTINCT user_id) AS `Time spent per user_mins`
FROM `gcp-bi-elephant-db-gold.applaydu.micro_game_finished`
WHERE SCENE_NAME = 'Eduland Lets Story - Minigame'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY month
ORDER BY month ASC, `Time spent per user_mins` DESC;",16.3681640625
"SELECT 'Story Creation' AS section, DATE_TRUNC(DATE(server_time), MONTH) AS month,
    SUM(CAST(time_spent AS INT64))/60/COUNT(DISTINCT user_id) AS `Time spent per user_mins`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from = 'Eduland Lets Story - Story Creation'
    AND time_spent >= 0 AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY month

UNION ALL

SELECT 'Story Reading' AS section, DATE_TRUNC(DATE(server_time), MONTH) AS month, 
    SUM(CAST(realtime_spent AS INT64)) /60/COUNT(DISTINCT user_id) AS `Time spent per user_mins`
FROM `gcp-bi-elephant-db-gold.applaydu.illustration_book_finished`
WHERE story_title = 'Experience - Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY month

UNION ALL

SELECT 'Microgames' AS section, DATE_TRUNC(DATE(server_time), MONTH) AS month, 
    SUM(CAST(time_spent AS INT64)) /60/COUNT(DISTINCT user_id) AS `Time spent per user_mins`
FROM `gcp-bi-elephant-db-gold.applaydu.micro_game_finished`
WHERE SCENE_NAME = 'Eduland Lets Story - Minigame'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY month
ORDER BY month ASC, `Time spent per user_mins` DESC;",16.3681640625
"SELECT 'Story Creation' AS section, DATE_TRUNC(DATE(server_time), MONTH) AS month,
    SUM(CAST(time_spent AS INT64))/60/COUNT(DISTINCT user_id) AS `Time spent per user_mins`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from = 'Eduland Lets Story - Story Creation'
    AND time_spent >= 0 AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY month

UNION ALL

SELECT 'Story Reading' AS section, DATE_TRUNC(DATE(server_time), MONTH) AS month, 
    SUM(CAST(realtime_spent AS INT64)) /60/COUNT(DISTINCT user_id) AS `Time spent per user_mins`
FROM `gcp-bi-elephant-db-gold.applaydu.illustration_book_finished`
WHERE story_title = 'Experience - Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY month

UNION ALL

SELECT 'Microgames' AS section, DATE_TRUNC(DATE(server_time), MONTH) AS month, 
    SUM(CAST(time_spent AS INT64)) /60/COUNT(DISTINCT user_id) AS `Time spent per user_mins`
FROM `gcp-bi-elephant-db-gold.applaydu.micro_game_finished`
WHERE SCENE_NAME = 'Eduland Lets Story - Minigame'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY month
ORDER BY month ASC, `Time spent per user_mins` DESC;",16.2880859375
"SELECT 'Story Creation' AS section, DATE_TRUNC(DATE(server_time), MONTH) AS month,
    SUM(CAST(time_spent AS INT64))/60/COUNT(DISTINCT user_id) AS `Time spent per user_mins`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from = 'Eduland Lets Story - Story Creation'
    AND time_spent >= 0 AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY month

UNION ALL

SELECT 'Story Reading' AS section, DATE_TRUNC(DATE(server_time), MONTH) AS month, 
    SUM(CAST(realtime_spent AS INT64)) /60/COUNT(DISTINCT user_id) AS `Time spent per user_mins`
FROM `gcp-bi-elephant-db-gold.applaydu.illustration_book_finished`
WHERE story_title = 'Experience - Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY month

UNION ALL

SELECT 'Microgames' AS section, DATE_TRUNC(DATE(server_time), MONTH) AS month, 
    SUM(CAST(time_spent AS INT64)) /60/COUNT(DISTINCT user_id) AS `Time spent per user_mins`
FROM `gcp-bi-elephant-db-gold.applaydu.micro_game_finished`
WHERE SCENE_NAME = 'Eduland Lets Story - Minigame'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY month
ORDER BY month ASC, `Time spent per user_mins` DESC;",16.2880859375
"WITH gb4233 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id  ,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT `Time spent`
FROM (
    SELECT 
        COUNT(DISTINCT user_id) AS users,
        SUM(total_time_spent) AS sum_total_time_spent,
        SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
        FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
    FROM 
        t_users
    WHERE 
        toy_unlocked_by_scan_count > 0 
        OR scan_mode_finished_count > 0 
)",16.1318359375
"WITH gb4233 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id  ,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT `Time spent`
FROM (
    SELECT 
        COUNT(DISTINCT user_id) AS users,
        SUM(total_time_spent) AS sum_total_time_spent,
        SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
        FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
    FROM 
        t_users
    WHERE 
        toy_unlocked_by_scan_count > 0 
        OR scan_mode_finished_count > 0 
)",16.1318359375
"WITH t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.1318359375
"WITH gb4256 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.1318359375
"WITH gb4256 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.1318359375
"WITH gb4255 as (select 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count > 0 
    OR scan_mode_finished_count > 0",16.1318359375
"WITH gb4256 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.1318359375
"WITH gb4256 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.1318359375
"WITH gb4256 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.1318359375
"WITH gb4233 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id  ,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT `Time spent`
FROM (
    SELECT 
        COUNT(DISTINCT user_id) AS users,
        SUM(total_time_spent) AS sum_total_time_spent,
        SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
        FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
    FROM 
        t_users
    WHERE 
        toy_unlocked_by_scan_count > 0 
        OR scan_mode_finished_count > 0 
)",16.1318359375
"WITH gb4256 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.1318359375
"WITH gb4256 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.1318359375
"WITH t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.1318359375
"WITH gb4255 as (select 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count > 0 
    OR scan_mode_finished_count > 0",16.1318359375
"WITH gb4233 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id  ,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT `Time spent`
FROM (
    SELECT 
        COUNT(DISTINCT user_id) AS users,
        SUM(total_time_spent) AS sum_total_time_spent,
        SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
        FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
    FROM 
        t_users
    WHERE 
        toy_unlocked_by_scan_count > 0 
        OR scan_mode_finished_count > 0 
)",16.1318359375
"WITH gb4256 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.1318359375
"WITH t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.1318359375
"WITH gb4256 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.1318359375
"WITH t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.1318359375
"WITH t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.1318359375
"WITH gb4255 as (select 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count > 0 
    OR scan_mode_finished_count > 0",16.1318359375
"WITH gb4256 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.1044921875
"WITH gb4255 as (select 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count > 0 
    OR scan_mode_finished_count > 0",16.1044921875
"WITH gb4233 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id  ,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT `Time spent`
FROM (
    SELECT 
        COUNT(DISTINCT user_id) AS users,
        SUM(total_time_spent) AS sum_total_time_spent,
        SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
        FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
    FROM 
        t_users
    WHERE 
        toy_unlocked_by_scan_count > 0 
        OR scan_mode_finished_count > 0 
)",16.1044921875
"WITH gb4255 as (select 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count > 0 
    OR scan_mode_finished_count > 0",16.1044921875
"WITH t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.1044921875
"WITH gb4256 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.1044921875
"WITH t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.1044921875
"WITH gb4233 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id  ,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
        
    GROUP BY 
        user_id
)
SELECT `Time spent`
FROM (
    SELECT 
        COUNT(DISTINCT user_id) AS users,
        SUM(total_time_spent) AS sum_total_time_spent,
        SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
        FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
    FROM 
        t_users
    WHERE 
        toy_unlocked_by_scan_count > 0 
        OR scan_mode_finished_count > 0 
)",16.1044921875
"WITH gb4233 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id  ,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  AND (`applaydu.tbl_version_filter`.`version` = ?))    	
        
    GROUP BY 
        user_id
)
SELECT `Time spent`
FROM (
    SELECT 
        COUNT(DISTINCT user_id) AS users,
        SUM(total_time_spent) AS sum_total_time_spent,
        SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
        FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
    FROM 
        t_users
    WHERE 
        toy_unlocked_by_scan_count > 0 
        OR scan_mode_finished_count > 0 
)",16.0654296875
"WITH gb4256 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  AND (`applaydu.tbl_version_filter`.`version` = ?))    	
        
    GROUP BY 
        user_id
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.0654296875
"WITH t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  AND (`applaydu.tbl_version_filter`.`version` = ?))    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.0654296875
"WITH gb4256 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  AND (`applaydu.tbl_version_filter`.`version` = ?))    	
        
    GROUP BY 
        user_id
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.0654296875
"WITH gb4233 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id  ,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  AND (`applaydu.tbl_version_filter`.`version` = ?))    	
        
    GROUP BY 
        user_id
)
SELECT `Time spent`
FROM (
    SELECT 
        COUNT(DISTINCT user_id) AS users,
        SUM(total_time_spent) AS sum_total_time_spent,
        SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
        FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
    FROM 
        t_users
    WHERE 
        toy_unlocked_by_scan_count > 0 
        OR scan_mode_finished_count > 0 
)",16.0654296875
"WITH gb4233 as (SELECT 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    JOIN 
        `applaydu.tbl_shop_filter` using (game_id  ,country_name)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  AND (`applaydu.tbl_version_filter`.`version` = ?))    	
        
    GROUP BY 
        user_id
)
SELECT `Time spent`
FROM (
    SELECT 
        COUNT(DISTINCT user_id) AS users,
        SUM(total_time_spent) AS sum_total_time_spent,
        SUM(total_time_spent) / COUNT(DISTINCT user_id) AS time_result,
        FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Time spent`
    FROM 
        t_users
    WHERE 
        toy_unlocked_by_scan_count > 0 
        OR scan_mode_finished_count > 0 
)",16.0654296875
"WITH gb4255 as (select 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  AND (`applaydu.tbl_version_filter`.`version` = ?))    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count > 0 
    OR scan_mode_finished_count > 0",16.0654296875
"WITH t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  AND (`applaydu.tbl_version_filter`.`version` = ?))    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count = 0 
    AND scan_mode_finished_count = 0",16.0654296875
"WITH gb4255 as (select 0)
,t_users AS (
    SELECT 
        user_id,
        SUM(sessions_count) AS sessions_count,
        SUM(total_time_spent) AS total_time_spent,
        SUM(toy_unlocked_by_scan_count) AS toy_unlocked_by_scan_count,
        SUM(scan_mode_finished_count) AS scan_mode_finished_count
    FROM 
        `gcp-gfb-sai-tracking-gold.applaydu.tbl_users` t
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 
        DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
        AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND t.country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )   
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  AND (`applaydu.tbl_version_filter`.`version` = ?))    	
    GROUP BY 
        user_id
)
SELECT 
    SUM(sessions_count) AS sum_sessions_count,
    SUM(total_time_spent) AS sum_total_time_spent,
    SUM(total_time_spent) / SUM(sessions_count) AS time_result,
    FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(total_time_spent) / SUM(sessions_count) AS INT64))) AS `Time spent`
FROM 
    t_users
WHERE 
    toy_unlocked_by_scan_count > 0 
    OR scan_mode_finished_count > 0",16.0654296875
"SELECT 
    DATE_TRUNC(server_time, MONTH) AS month,
    SUM(time_spent) / COUNT(DISTINCT user_id) AS avg_time_spent,
    (SUM(time_spent) / COUNT(DISTINCT user_id)) / 60 AS avg_time_spent_min,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Average time spent per user in Let's Story`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from LIKE 'Eduland Lets Story%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND time_spent > 0 AND time_spent < 36000
GROUP BY month
ORDER BY month;",15.396484375
"SELECT 'Story Creation' AS section, DATE_TRUNC(DATE(server_time), MONTH) AS month,
    SUM(time_spent)/COUNT(DISTINCT user_id) --AS `Time spent per user (mins)`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from = 'Eduland Lets Story - Story Creation'
    AND time_spent >= 0 AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY month",15.3193359375
"SELECT 
    DATE_TRUNC(server_time, MONTH) AS month,
    SUM(time_spent) / COUNT(DISTINCT user_id) AS avg_time_spent,
    (SUM(time_spent) / COUNT(DISTINCT user_id)) / 60 AS avg_time_spent_min,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Average time spent per user in Let's Story`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from LIKE 'Eduland Lets Story%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND time_spent > 0 AND time_spent < 36000
GROUP BY month
ORDER BY month;",15.3193359375
"SELECT 
    DATE_TRUNC(server_time, MONTH) AS month,
    SUM(time_spent) / COUNT(DISTINCT user_id) AS avg_time_spent,
    (SUM(time_spent) / COUNT(DISTINCT user_id)) / 60 AS avg_time_spent_min,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Average time spent per user in Let's Story`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from LIKE 'Eduland Lets Story%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND time_spent > 0 AND time_spent < 36000
GROUP BY month
ORDER BY month;",15.3193359375
"SELECT 
    DATE_TRUNC(server_time, MONTH) AS month,
    SUM(time_spent) / COUNT(DISTINCT user_id) AS avg_time_spent,
    (SUM(time_spent) / COUNT(DISTINCT user_id)) / 60 AS avg_time_spent_min,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Average time spent per user in Let's Story`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from LIKE 'Eduland Lets Story%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND time_spent > 0 AND time_spent < 36000
GROUP BY month
ORDER BY month;",15.3193359375
"SELECT 
    DATE_TRUNC(server_time, MONTH) AS month,
    SUM(time_spent) / COUNT(DISTINCT user_id) AS avg_time_spent,
    (SUM(time_spent) / COUNT(DISTINCT user_id)) / 60 AS avg_time_spent_min,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Average time spent per user in Let's Story`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from LIKE 'Eduland Lets Story%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND time_spent > 0 AND time_spent < 36000
GROUP BY month
ORDER BY month;",15.3193359375
"SELECT 
    DATE_TRUNC(server_time, MONTH) AS month,
    SUM(time_spent) / COUNT(DISTINCT user_id) AS avg_time_spent,
    (SUM(time_spent) / COUNT(DISTINCT user_id)) / 60 AS avg_time_spent_min,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Average time spent per user in Let's Story`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from LIKE 'Eduland Lets Story%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND time_spent > 0 AND time_spent < 36000
GROUP BY month
ORDER BY month;",15.3193359375
"SELECT 
    DATE_TRUNC(server_time, MONTH) AS month,
    SUM(time_spent) / COUNT(DISTINCT user_id) AS avg_time_spent,
    (SUM(time_spent) / COUNT(DISTINCT user_id)) / 60 AS avg_time_spent_min,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Average time spent per user in Let's Story`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from LIKE 'Eduland Lets Story%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND time_spent > 0 AND time_spent < 36000
GROUP BY month
ORDER BY month;",15.3193359375
"SELECT 
    DATE_TRUNC(server_time, MONTH) AS month,
    SUM(time_spent) / COUNT(DISTINCT user_id) AS avg_time_spent,
    (SUM(time_spent) / COUNT(DISTINCT user_id)) / 60 AS avg_time_spent_min,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Average time spent per user in Let's Story`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from LIKE 'Eduland Lets Story%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND time_spent > 0 AND time_spent < 36000
GROUP BY month
ORDER BY month;",15.3193359375
"SELECT 
    DATE_TRUNC(server_time, MONTH) AS month,
    SUM(time_spent) / COUNT(DISTINCT user_id) AS avg_time_spent,
    (SUM(time_spent) / COUNT(DISTINCT user_id)) / 60 AS avg_time_spent_min,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Average time spent per user in Let's Story`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from LIKE 'Eduland Lets Story%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND time_spent > 0 AND time_spent < 36000
GROUP BY month
ORDER BY month;",15.3193359375
"SELECT 
    DATE_TRUNC(server_time, MONTH) AS month,
    SUM(time_spent) / COUNT(DISTINCT user_id) AS avg_time_spent,
    (SUM(time_spent) / COUNT(DISTINCT user_id)) / 60 AS avg_time_spent_min,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Average time spent per user in Let's Story`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from LIKE 'Eduland Lets Story%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND time_spent > 0 AND time_spent < 36000
GROUP BY month
ORDER BY month;",15.3193359375
"SELECT 
    DATE_TRUNC(server_time, MONTH) AS month,
    SUM(time_spent) / COUNT(DISTINCT user_id) AS avg_time_spent,
    (SUM(time_spent) / COUNT(DISTINCT user_id)) / 60 AS avg_time_spent_min,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Average time spent per user in Let's Story`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from LIKE 'Eduland Lets Story%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND time_spent > 0 AND time_spent < 36000
GROUP BY month
ORDER BY month;",15.3193359375
"SELECT 
    DATE_TRUNC(server_time, MONTH) AS month,
    SUM(time_spent) / COUNT(DISTINCT user_id) AS avg_time_spent,
    (SUM(time_spent) / COUNT(DISTINCT user_id)) / 60 AS avg_time_spent_min,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Average time spent per user in Let's Story`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from LIKE 'Eduland Lets Story%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND time_spent > 0 AND time_spent < 36000
GROUP BY month
ORDER BY month;",15.3193359375
"SELECT 
    DATE_TRUNC(server_time, MONTH) AS month,
    SUM(time_spent) / COUNT(DISTINCT user_id) AS avg_time_spent,
    (SUM(time_spent) / COUNT(DISTINCT user_id)) / 60 AS avg_time_spent_min,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Average time spent per user in Let's Story`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from LIKE 'Eduland Lets Story%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND time_spent > 0 AND time_spent < 36000
GROUP BY month
ORDER BY month;",15.3193359375
"SELECT 
    DATE_TRUNC(server_time, MONTH) AS month,
    SUM(time_spent) / COUNT(DISTINCT user_id) AS avg_time_spent,
    (SUM(time_spent) / COUNT(DISTINCT user_id)) / 60 AS avg_time_spent_min,
    FORMAT_TIMESTAMP('%H hour %M min %S sec', TIMESTAMP_SECONDS(CAST(SUM(time_spent) / COUNT(DISTINCT user_id) AS INT64))) AS `Average time spent per user in Let's Story`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from LIKE 'Eduland Lets Story%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    AND time_spent > 0 AND time_spent < 36000
GROUP BY month
ORDER BY month;",15.3193359375
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-02-08'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.5166015625
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-01-26'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0-debug4'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.5078125
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-01-26'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0-debug5'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.5078125
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-01-26'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0-debug2'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.5029296875
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-01-26'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0-debug3'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.5029296875
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-01-26'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0-debug1'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.5029296875
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-01-26'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0-debug'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.5029296875
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-02-06'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.5029296875
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-02-05'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.501953125
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-02-01'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.501953125
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-01-26'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.501953125
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-01-31'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.501953125
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-02-04'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.501953125
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-02-03'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.501953125
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-01-27'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.501953125
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-01-28'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.501953125
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-01-29'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.501953125
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-01-30'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.501953125
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-01-26'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0-dev'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.501953125
"select count(*) as COUNT from applaydu.store_stats_qr_impressions
        Where store_date = '2025-02-02'
        and kpi_name = 'QR Impressions'
        and game_id in (85247, 82471, 82487)
        and version = '1.0.0'
        and D_COUNTRY = 'CN'
        and event_id = 393584",14.501953125
"WITH q4265 as (select 0)
,tbl_ua AS (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity`
    WHERE 1=1 
), 
USER_LAUNCH AS (
    SELECT DISTINCT user_id
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` 
    JOIN tbl_ua USING (user_id)
    WHERE launch_type = 'first_launch'
        AND version >= '5.0.0' AND version < '9.0.0'
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND game_id IN (81335, 81337, 85837)
        
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
)

, 
UNIQUE_DA_USER AS (
    SELECT DISTINCT ul.user_id
    FROM `gcp-bi-elephant-db-gold.applaydu.disclaimer_acceptance` AS fe  
    RIGHT JOIN user_launch ul ON fe.user_id = ul.user_id
    WHERE version >= '5.0.0' AND version < '9.0.0'
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND game_id IN (81335, 81337, 85837)
        
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
), 
SCAN_USER AS (
    SELECT DISTINCT udu.user_id
    FROM `gcp-bi-elephant-db-gold.applaydu.ftue_event` AS fe 
    RIGHT JOIN unique_da_user AS udu ON fe.user_id = udu.user_id
    WHERE ftue_stage = 'Finish'
        AND ftue_steps = 'Choose Scan Or Unlock' AND user_selection = 'No-Deeplink and Scan'
        AND version >= '5.0.0' AND version < '9.0.0'
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
), 
TIME_CONTROL AS (
    SELECT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.time_control_access`
    INNER JOIN unique_da_user USING (user_id)
    WHERE user_status = 'FTUE'
        AND version >= '5.0.0' AND version < '9.0.0'
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
), 
ALL_DATA AS (
    -- FTUE flow start
    (
    SELECT 
        REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(ftue_steps
            ,'Disclaimer_Acceptance','Parental Agreement ' || ftue_stage)
            ,'Choose Avatar Gender', 'Gender + Difficulty page ' || ftue_stage)
            ,'Avatar_Creation', 'Avatar Creation ' || ftue_stage)
            ,'Enter Avatar Name', 'Avatar Name ' || ftue_stage)
            ,'Avatar_Creation', 'Character Creation ' || ftue_stage)
            ,'Email Registration', 'Email Registration ' || ftue_stage)
            ,'Age Confirmation after Email', 'Age Confirmation after Email ' || ftue_stage)
            ,'Choose Scan Or Unlock', 'Choose No Toy Or Scan ' || ftue_stage)
         AS Users,
        COUNT(DISTINCT udu.user_id) AS `Users each step`
    FROM `gcp-bi-elephant-db-gold.applaydu.ftue_event` AS fe 
    RIGHT JOIN unique_da_user AS udu ON fe.user_id = udu.user_id
    WHERE ftue_stage = 'Start'
        AND ftue_steps IN ('Choose Avatar Gender', 'Avatar_Creation','Enter Avatar Name', 'Email Registration', 'Choose Scan Or Unlock')
        AND version >= '5.0.0' AND version < '9.0.0'
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    GROUP BY ftue_steps, ftue_stage
    ORDER BY `Users each step` DESC
    )
    UNION ALL 
    (
    -- AR FTUE start
    SELECT 
        REPLACE(ftue_steps
            ,'Camera_Permission', 'Camera Permission ' || ftue_stage)
         AS Users,
        COUNT(DISTINCT su.user_id) AS `Users each step`
    FROM `gcp-bi-elephant-db-gold.applaydu.ftue_event` AS fe 
    RIGHT JOIN scan_user AS su ON fe.user_id = su.user_id
    WHERE ftue_stage = 'Start'
        AND ftue_steps IN ('Camera_Permission')
        AND version >= '5.0.0' AND version < '9.0.0'
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        
    GROUP BY ftue_steps, ftue_stage
    ORDER BY `Users each step` DESC
    )
    UNION ALL
    -- Scan finish
    (
    SELECT 
        REPLACE(REPLACE(REPLACE(user_selection
            ,'No-Deeplink and Scan', 'Choose to Scan')
            ,'No-Deeplink and Worldmap', 'Choose to Unlock Free Toy')
            ,'Deeplink', 'Deeplink')
         AS Users,
        COUNT(DISTINCT udu.user_id) AS `Users each step`
    FROM `gcp-bi-elephant-db-gold.applaydu.ftue_event` AS fe 
    RIGHT JOIN unique_da_user AS udu ON fe.user_id = udu.user_id
    WHERE ftue_stage = 'Finish'
        AND ftue_steps IN ('Choose Scan Or Unlock')
        AND version >= '5.0.0' AND version < '9.0.0'
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    GROUP BY Users
    ORDER BY `Users each step` DESC
    )
    UNION ALL 
    -- AR FTUE Finish
    (
    SELECT 
        REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(ftue_steps
            ,'Camera_Permission', 'Camera Permission ' || ftue_stage)
            ,'Scan Section', 'Scan Section ' || ftue_stage)
            ,'Scan toy result', 'Cancel Scan toy result')
            ,'Unlock toy screen', 'Unlock toy screen')
            ,'AR_Mode', 'Simple Toy AR ' || ftue_stage)
         AS Users,
        COUNT(DISTINCT su.user_id) AS `Users each step`
    FROM `gcp-bi-elephant-db-gold.applaydu.ftue_event` AS fe  
    RIGHT JOIN scan_user AS su ON fe.user_id = su.user_id
    WHERE ftue_stage = 'Finish'
        AND (ftue_steps IN ('Camera_Permission')
            OR ftue_steps IN ('Scan Section', 'Scan toy result','Unlock toy screen', 'AR_Mode') AND user_selection = 'No-Deeplink and Scan')
        AND version >= '5.0.0' AND version < '9.0.0'
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    GROUP BY ftue_steps, ftue_stage
    ORDER BY `Users each step` DESC
    )
    UNION ALL
    SELECT 'New Users Launch' AS Users, COUNT(DISTINCT user_id) AS `Users each step`
    FROM user_launch
)
SELECT *
FROM all_data
WHERE Users = 'New Users Launch' OR (Users LIKE '%Start' AND Users NOT IN ('Camera Permission Start','Choose No Toy Or Scan Start'))
OR Users IN ('Choose to Unlock Free Toy')
UNION all
(
SELECT 'Time Control' AS Users, COUNT(DISTINCT user_id) AS `Users each step`

FROM time_control
)
ORDER BY 
    CASE 
        WHEN Users = 'New Users Launch' THEN 0
        WHEN Users = 'Parental Agreement Start' THEN 1
        WHEN Users = 'Gender + Difficulty page Start' THEN 2
        WHEN Users = 'Gender + Difficulty page Finish' THEN 3
        WHEN Users = 'Time Control' THEN 4
        WHEN Users = 'Avatar Creation Start' THEN 5
        WHEN Users = 'Avatar Creation Finish' THEN 6
        WHEN Users = 'Avatar Name Start' THEN 7
        WHEN Users = 'Avatar Name Finish' THEN 8
        WHEN Users = 'Email Registration Start' THEN 9
        WHEN Users = 'Email Registration Finish' THEN 10
        WHEN Users = 'Age Confirmation after Email Start' THEN 11
        WHEN Users = 'Age Confirmation after Email Finish' THEN 12    
        WHEN Users = 'Choose No Toy Or Scan Start' THEN 13
        WHEN Users = 'Choose No Toy Or Scan Finish' THEN 14
        WHEN Users = 'Choose to Scan' THEN 15
        WHEN Users = 'Choose to Unlock Free Toy' THEN 16
        WHEN Users = 'Camera Permission Start' THEN 17
        WHEN Users = 'Camera Permission Finish' THEN 18
        WHEN Users = 'Camera Access explanation screen Start' THEN 19
        WHEN Users = 'Camera Access explanation screen Finish' THEN 20
        WHEN Users = 'Scan Section Start' THEN 21
        WHEN Users = 'Scan Section Finish' THEN 22
        WHEN Users = 'Scan toy result Start' THEN 23
        WHEN Users = 'Scan toy result Finish' THEN 24
        WHEN Users = 'Unlock toy screen Start' THEN 25
        WHEN Users = 'Unlock toy screen Finish' THEN 26
        WHEN Users = 'Simple Toy AR Start' THEN 27
        WHEN Users = 'Simple Toy AR Finish' THEN 28 
        WHEN Users = 'World Map final Start' THEN 29
        WHEN Users = 'World Map final Finish' THEN 30 
        WHEN Users = 'Users Scanned successfully toy 1st time' THEN 31
        WHEN Users = 'Users Scanned successfully toy 2nd time' THEN 32 
        WHEN Users = 'Users Scanned successfully toy 3rd time' THEN 33 
    END",13.9951171875
"WITH gb4270 as (select 0)
,tbl_ua AS (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity`
    WHERE 1=1 
), 
USER_LAUNCH AS (
    SELECT DISTINCT user_id
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` 
    JOIN tbl_ua USING (user_id)
    WHERE launch_type = 'first_launch'
        AND version >= '5.0.0' AND version < '9.0.0'
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND game_id IN (81335, 81337, 85837)
        
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
)

, 
UNIQUE_DA_USER AS (
    SELECT DISTINCT ul.user_id
    FROM `gcp-bi-elephant-db-gold.applaydu.disclaimer_acceptance` AS fe  
    RIGHT JOIN user_launch ul ON fe.user_id = ul.user_id
    WHERE version >= '5.0.0' AND version < '9.0.0'
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND game_id IN (81335, 81337, 85837)
        
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
), 
SCAN_USER AS (
    SELECT DISTINCT udu.user_id
    FROM `gcp-bi-elephant-db-gold.applaydu.ftue_event` AS fe 
    RIGHT JOIN unique_da_user AS udu ON fe.user_id = udu.user_id
    WHERE ftue_stage = 'Finish'
        AND ftue_steps = 'Choose Scan Or Unlock' AND user_selection = 'No-Deeplink and Scan'
        AND version >= '5.0.0' AND version < '9.0.0'
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
), 
TIME_CONTROL AS (
    SELECT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.time_control_access`
    INNER JOIN unique_da_user USING (user_id)
    WHERE user_status = 'FTUE'
        AND version >= '5.0.0' AND version < '9.0.0'
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
), 
ALL_DATA AS (
    -- FTUE flow start
    (
    SELECT 
        REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(ftue_steps
            ,'Disclaimer_Acceptance','Parental Agreement ' || ftue_stage)
            ,'Choose Avatar Gender', 'Gender + Difficulty page ' || ftue_stage)
            ,'Avatar_Creation', 'Avatar Creation ' || ftue_stage)
            ,'Enter Avatar Name', 'Avatar Name ' || ftue_stage)
            ,'Avatar_Creation', 'Character Creation ' || ftue_stage)
            ,'Email Registration', 'Email Registration ' || ftue_stage)
            ,'Age Confirmation after Email', 'Age Confirmation after Email ' || ftue_stage)
            ,'Choose Scan Or Unlock', 'Choose No Toy Or Scan ' || ftue_stage)
         AS Users,
        COUNT(DISTINCT udu.user_id) AS `Users each step`
    FROM `gcp-bi-elephant-db-gold.applaydu.ftue_event` AS fe 
    RIGHT JOIN unique_da_user AS udu ON fe.user_id = udu.user_id
    WHERE ftue_stage = 'Start'
        AND ftue_steps IN ('Choose Avatar Gender', 'Avatar_Creation','Enter Avatar Name', 'Email Registration', 'Choose Scan Or Unlock')
        AND version >= '5.0.0' AND version < '9.0.0'
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    GROUP BY ftue_steps, ftue_stage
    ORDER BY `Users each step` DESC
    )
    UNION ALL 
    (
    -- AR FTUE start
    SELECT 
        REPLACE(REPLACE(ftue_steps
            ,'Camera_Permission', 'Camera Permission ' || ftue_stage)
            ,'Scan Section', 'Scan Section '|| ftue_stage)
         AS Users,
        COUNT(DISTINCT su.user_id) AS `Users each step`
    FROM `gcp-bi-elephant-db-gold.applaydu.ftue_event` AS fe 
    RIGHT JOIN scan_user AS su ON fe.user_id = su.user_id
    WHERE ftue_stage = 'Start'
        AND ftue_steps IN ('Camera_Permission', 'Scan Section')
        AND version >= '5.0.0' AND version < '9.0.0'
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        
    GROUP BY ftue_steps, ftue_stage
    ORDER BY `Users each step` DESC
    )
    UNION ALL
    -- Scan finish
    (
    SELECT 
        REPLACE(REPLACE(REPLACE(user_selection
            ,'No-Deeplink and Scan', 'Choose to Scan')
            ,'No-Deeplink and Worldmap', 'Choose to Unlock Free Toy')
            ,'Deeplink', 'Deeplink')
         AS Users,
        COUNT(DISTINCT udu.user_id) AS `Users each step`
    FROM `gcp-bi-elephant-db-gold.applaydu.ftue_event` AS fe 
    RIGHT JOIN unique_da_user AS udu ON fe.user_id = udu.user_id
    WHERE ftue_stage = 'Finish'
        AND ftue_steps IN ('Choose Scan Or Unlock')
        AND version >= '5.0.0' AND version < '9.0.0'
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    GROUP BY Users
    ORDER BY `Users each step` DESC
    )
    UNION ALL 
    -- AR FTUE Finish
    (
    SELECT 
        REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(ftue_steps
            ,'Camera_Permission', 'Camera Permission ' || ftue_stage)
            ,'Scan Section', 'Scan Section '|| ftue_stage)
            ,'Scan toy result', 'Scan toy result '|| ftue_stage)
            ,'Unlock toy screen', 'Unlock toy screen '|| ftue_stage)
            ,'AR_Mode', 'Simple Toy AR '|| ftue_stage)
         AS Users,
        COUNT(DISTINCT su.user_id) AS `Users each step`
    FROM `gcp-bi-elephant-db-gold.applaydu.ftue_event` AS fe  
    RIGHT JOIN scan_user AS su ON fe.user_id = su.user_id
    WHERE ftue_stage = 'Finish'
        AND (ftue_steps IN ('Camera_Permission')
            OR ftue_steps IN ('Scan Section', 'Scan toy result','Unlock toy screen', 'AR_Mode') AND user_selection LIKE 'No-Deeplink and Scan:%')
        AND version >= '5.0.0' AND version < '9.0.0'
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
        
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
    GROUP BY ftue_steps, ftue_stage
    ORDER BY `Users each step` DESC
    )
    UNION ALL
    SELECT 'New Users Launch' AS Users, COUNT(DISTINCT user_id) AS `Users each step`
    FROM user_launch
)
SELECT *
FROM all_data
WHERE Users IN ('New Users Launch','Choose to Scan', 'Unlock toy screen Finish') OR (Users LIKE '%Start' AND Users NOT IN ('Choose No Toy Or Scan Start'))
UNION all
(
SELECT 'Time Control' AS Users, COUNT(DISTINCT user_id) AS `Users each step`

FROM time_control
)
UNION all
(
SELECT 'Parental Agreement Start' AS Users, COUNT(DISTINCT user_id) AS `Users each step`
FROM unique_da_user
)
ORDER BY 
    CASE 
        WHEN Users = 'New Users Launch' THEN 0
        WHEN Users = 'Parental Agreement Start' THEN 1
        WHEN Users = 'Gender + Difficulty page Start' THEN 2
        WHEN Users = 'Gender + Difficulty page Finish' THEN 3
        WHEN Users = 'Time Control' THEN 4
        WHEN Users = 'Avatar Creation Start' THEN 5
        WHEN Users = 'Avatar Creation Finish' THEN 6
        WHEN Users = 'Avatar Name Start' THEN 7
        WHEN Users = 'Avatar Name Finish' THEN 8
        WHEN Users = 'Email Registration Start' THEN 9
        WHEN Users = 'Email Registration Finish' THEN 10
        WHEN Users = 'Age Confirmation after Email Start' THEN 11
        WHEN Users = 'Age Confirmation after Email Finish' THEN 12    
        WHEN Users = 'Choose No Toy Or Scan Start' THEN 13
        WHEN Users = 'Choose No Toy Or Scan Finish' THEN 14
        WHEN Users = 'Choose to Scan' THEN 15
        WHEN Users = 'Choose to Unlock Free Toy' THEN 16
        WHEN Users = 'Camera Permission Start' THEN 17
        WHEN Users = 'Camera Permission Finish' THEN 18
        WHEN Users = 'Camera Access explanation screen Start' THEN 19
        WHEN Users = 'Camera Access explanation screen Finish' THEN 20
        WHEN Users = 'Scan Section Start' THEN 21
        WHEN Users = 'Scan Section Finish' THEN 22
        WHEN Users = 'Scan toy result Start' THEN 23
        WHEN Users = 'Scan toy result Finish' THEN 24
        WHEN Users = 'Unlock toy screen Start' THEN 25
        WHEN Users = 'Unlock toy screen Finish' THEN 26
        WHEN Users = 'Simple Toy AR Start' THEN 27
        WHEN Users = 'Simple Toy AR Finish' THEN 28 
        WHEN Users = 'World Map final Start' THEN 29
        WHEN Users = 'World Map final Finish' THEN 30 
        WHEN Users = 'Users Scanned successfully toy 1st time' THEN 31
        WHEN Users = 'Users Scanned successfully toy 2nd time' THEN 32 
        WHEN Users = 'Users Scanned successfully toy 3rd time' THEN 33 
    END",13.9951171875
"with gb4232 as (SELECT 0)
SELECT 
    REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(cast(game_id as string), 
        '81335', 'App Store')
        ,'81337', 'Google Play')
        , '82471','AppInChina')
        , '84155','Google Play')
        , '84515','Samsung')
        , '84137','AppInChina') AS Shop,
    COUNT(DISTINCT user_id) AS Total_Users
FROM 
    `gcp-bi-elephant-db-gold.applaydu.user_activity`
WHERE 
    1=1 
    AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
    AND NOT (game_id = 82471 AND active_date < '2020-12-14')
    AND (DATE(active_date) >= '2020-08-10' AND DATE(active_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY))
    AND CAST(time_spent AS FLOAT64) >= 0 
    AND CAST(time_spent AS FLOAT64) < 86400
    AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 ), INTERVAL 1 DAY)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )    
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )
    AND version >= (SELECT MIN(version) FROM `applaydu.tbl_version_filter` WHERE 1=1  ) 
    AND version <= (SELECT MAX(version) FROM `applaydu.tbl_version_filter` WHERE 1=1  )
GROUP BY 
    Shop
ORDER BY 
    2 DESC",13.5224609375
"WITH gb4273 as (SELECT 0)
,tbl_ls_scan_users AS (
    SELECT DISTINCT user_id
    FROM (
        SELECT user_id
        FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
        JOIN (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
        ) USING (user_id)
        WHERE utm_campaign LIKE '%KCLTS%'
            AND version >= '5.0.0'
            AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
            AND DATE(server_time) < CURRENT_DATE()
            AND DATE(server_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(server_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
            AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
            AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        UNION ALL 
        SELECT user_id
        FROM `gcp-bi-elephant-db-gold.applaydu.scan_mode_finished`
        JOIN (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
        ) USING (user_id)
        WHERE (
            (reference LIKE '%KCLTS%' AND NOT (game_id != 81335 AND scan_type = 'Deep Link')) 
            OR scan_type = 'Scan_QR_LS'
        )
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND scan_result IN ('New_Toy', 'Old_Toy')
    )
),
tbl_ls_user_activity AS (
    SELECT 
        t.*,
        d1.name AS language,
        d2.name AS location,
        d3.name AS hero,
        d4.name AS sidekick,
        d5.name AS plot,
        d6.name AS theme
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished` t
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d1 ON d1.id = activity_01_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d2 ON d2.id = activity_02_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d3 ON d3.id = activity_03_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d4 ON d4.id = activity_04_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d5 ON d5.id = activity_05_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d6 ON d6.id = activity_06_value 
    WHERE activity_01 = 'Experience - Lets Story - New Story Created'
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND user_id IN (SELECT DISTINCT user_id FROM tbl_ls_scan_users)
)
SELECT n2.name AS Language, COUNT(0) AS stories
FROM tbl_ls_user_activity
LEFT JOIN UNNEST([
    STRUCT('en' AS id, 'English' AS name),
    STRUCT('es' AS id, 'Spanish' AS name),
    STRUCT('de' AS id, 'German' AS name),
    STRUCT('it' AS id, 'Italian' AS name),
    STRUCT('pt' AS id, 'Portuguese' AS name),
    STRUCT('fr' AS id, 'French' AS name),
    STRUCT('pl' AS id, 'Polish' AS name),
    STRUCT('ko' AS id, 'Korean' AS name),
    STRUCT('hu' AS id, 'Hungarian' AS name),
    STRUCT('nl' AS id, 'Dutch' AS name),
    STRUCT('zh-Hant' AS id, 'Traditional Chinese' AS name),
    STRUCT('ar' AS id, 'Arabic' AS name),
    STRUCT('zh-Hans' AS id, 'Simplified Chinese' AS name)
]) AS n2 ON n2.id = tbl_ls_user_activity.language
GROUP BY Language
ORDER BY stories DESC",13.3095703125
"WITH gb4273 as (SELECT 0)
,tbl_ls_scan_users AS (
    SELECT DISTINCT user_id
    FROM (
        SELECT user_id
        FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
        JOIN (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
        ) USING (user_id)
        WHERE utm_campaign LIKE '%KCLTS%'
            AND version >= '5.0.0'
            AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
            AND DATE(server_time) < CURRENT_DATE()
            AND DATE(server_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(server_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
            AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
            AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        UNION ALL 
        SELECT user_id
        FROM `gcp-bi-elephant-db-gold.applaydu.scan_mode_finished`
        JOIN (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
        ) USING (user_id)
        WHERE (
            (reference LIKE '%KCLTS%' AND NOT (game_id != 81335 AND scan_type = 'Deep Link')) 
            OR scan_type = 'Scan_QR_LS'
        )
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND scan_result IN ('New_Toy', 'Old_Toy')
    )
),
tbl_ls_user_activity AS (
    SELECT 
        t.*,
        d1.name AS language,
        d2.name AS location,
        d3.name AS hero,
        d4.name AS sidekick,
        d5.name AS plot,
        d6.name AS theme
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished` t
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d1 ON d1.id = activity_01_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d2 ON d2.id = activity_02_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d3 ON d3.id = activity_03_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d4 ON d4.id = activity_04_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d5 ON d5.id = activity_05_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d6 ON d6.id = activity_06_value 
    WHERE activity_01 = 'Experience - Lets Story - New Story Created'
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND user_id IN (SELECT DISTINCT user_id FROM tbl_ls_scan_users)
)
SELECT n2.name AS Language, COUNT(0) AS stories
FROM tbl_ls_user_activity
LEFT JOIN UNNEST([
    STRUCT('en' AS id, 'English' AS name),
    STRUCT('es' AS id, 'Spanish' AS name),
    STRUCT('de' AS id, 'German' AS name),
    STRUCT('it' AS id, 'Italian' AS name),
    STRUCT('pt' AS id, 'Portuguese' AS name),
    STRUCT('fr' AS id, 'French' AS name),
    STRUCT('pl' AS id, 'Polish' AS name),
    STRUCT('ko' AS id, 'Korean' AS name),
    STRUCT('hu' AS id, 'Hungarian' AS name),
    STRUCT('nl' AS id, 'Dutch' AS name),
    STRUCT('zh-Hant' AS id, 'Traditional Chinese' AS name),
    STRUCT('ar' AS id, 'Arabic' AS name),
    STRUCT('zh-Hans' AS id, 'Simplified Chinese' AS name)
]) AS n2 ON n2.id = tbl_ls_user_activity.language
GROUP BY Language
ORDER BY stories DESC",13.3076171875
"WITH gb4273 as (SELECT 0)
,tbl_ls_scan_users AS (
    SELECT DISTINCT user_id
    FROM (
        SELECT user_id
        FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
        JOIN (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
        ) USING (user_id)
        WHERE utm_campaign LIKE '%KCLTS%'
            AND version >= '5.0.0'
            AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
            AND DATE(server_time) < CURRENT_DATE()
            AND DATE(server_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(server_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
            AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
            AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        UNION ALL 
        SELECT user_id
        FROM `gcp-bi-elephant-db-gold.applaydu.scan_mode_finished`
        JOIN (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
        ) USING (user_id)
        WHERE (
            (reference LIKE '%KCLTS%' AND NOT (game_id != 81335 AND scan_type = 'Deep Link')) 
            OR scan_type = 'Scan_QR_LS'
        )
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND scan_result IN ('New_Toy', 'Old_Toy')
    )
),
tbl_ls_user_activity AS (
    SELECT 
        t.*,
        d1.name AS language,
        d2.name AS location,
        d3.name AS hero,
        d4.name AS sidekick,
        d5.name AS plot,
        d6.name AS theme
    FROM `gcp-bi-elephant-db-gold.applaydu.activity_finished` t
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d1 ON d1.id = activity_01_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d2 ON d2.id = activity_02_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d3 ON d3.id = activity_03_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d4 ON d4.id = activity_04_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d5 ON d5.id = activity_05_value 
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.element` d6 ON d6.id = activity_06_value 
    WHERE activity_01 = 'Experience - Lets Story - New Story Created'
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_time) < DATE_ADD((SELECT MAX(DATE(server_date)) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
        AND user_id IN (SELECT DISTINCT user_id FROM tbl_ls_scan_users)
)
SELECT n2.name AS Language, COUNT(0) AS stories
FROM tbl_ls_user_activity
LEFT JOIN UNNEST([
    STRUCT('en' AS id, 'English' AS name),
    STRUCT('es' AS id, 'Spanish' AS name),
    STRUCT('de' AS id, 'German' AS name),
    STRUCT('it' AS id, 'Italian' AS name),
    STRUCT('pt' AS id, 'Portuguese' AS name),
    STRUCT('fr' AS id, 'French' AS name),
    STRUCT('pl' AS id, 'Polish' AS name),
    STRUCT('ko' AS id, 'Korean' AS name),
    STRUCT('hu' AS id, 'Hungarian' AS name),
    STRUCT('nl' AS id, 'Dutch' AS name),
    STRUCT('zh-Hant' AS id, 'Traditional Chinese' AS name),
    STRUCT('ar' AS id, 'Arabic' AS name),
    STRUCT('zh-Hans' AS id, 'Simplified Chinese' AS name)
]) AS n2 ON n2.id = tbl_ls_user_activity.language
GROUP BY Language
ORDER BY stories DESC",13.3076171875
"SELECT 'Story Creation' AS section, DATE_TRUNC(DATE(server_time), MONTH) AS month
    --SUM(time_spent)/COUNT(DISTINCT user_id) AS `Time spent per user (mins)`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_from = 'Eduland Lets Story - Story Creation'
    AND time_spent >= 0 AND time_spent < 36000
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 )
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY month",13.0498046875
"WITH story_creation_section_time_spent AS (
    SELECT 
        SAFE_DIVIDE(SUM(time_spent), COUNT(DISTINCT user_id)) AS time_result1,
        AVG(time_spent) AS time_result2,
        FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(SAFE_DIVIDE(SUM(time_spent), COUNT(DISTINCT user_id)) AS INT64))) AS `Time spent per user in Story Creation`,
        FORMAT_TIMESTAMP('%M min %S sec', TIMESTAMP_SECONDS(CAST(AVG(time_spent) AS INT64))) AS `Story Creation Session Duration`
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE screen_from = 'Eduland Lets Story - Story Creation'
        AND time_spent >= 0 AND time_spent < 36000
        AND version >= '5.0.0'
        AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
        AND DATE(server_time) < CURRENT_DATE()
        AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
        AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 
    COUNT(DISTINCT user_id) AS users,
    COUNT(*) AS sessions,
    SAFE_DIVIDE(COUNT(*), COUNT(DISTINCT user_id)) AS avg_sessions,
    (SELECT `Time spent per user in Story Creation` FROM story_creation_section_time_spent) AS `Time spent per user in Story Creation`,
    (SELECT `Story Creation Session Duration` FROM story_creation_section_time_spent) AS `Story Creation Session Duration`
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE screen_to = 'Eduland Lets Story - Story Creation'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 );",12.2841796875
"SELECT 
    CONCAT('Season ', LEFT(version, 1)) AS Season,
    COUNT(DISTINCT user_id) AS `Users who have scanned surprises`,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS `Total Scans`,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
    AND version LIKE ANY ('5.%','4.%','3.%')
GROUP BY 
    1
ORDER BY 
    1",12.27734375
"SELECT 
    CONCAT('Season ', LEFT(version, 1)) AS Season,
    COUNT(DISTINCT user_id) AS `Users who have scanned surprises`,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS `Total Scans`,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
    AND version LIKE ANY ('5.%','4.%','3.%')
GROUP BY 
    1
ORDER BY 
    1",12.27734375
"SELECT 
    CONCAT('Season ', LEFT(version, 1)) AS Season,
    COUNT(DISTINCT user_id) AS `Users who have scanned surprises`,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS `Total Scans`,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
    AND version LIKE ANY ('5.%','4.%','3.%')
GROUP BY 
    1
ORDER BY 
    1",12.27734375
"SELECT 
    CONCAT('Season ', LEFT(version, 1)) AS Season,
    COUNT(DISTINCT user_id) AS `Users who have scanned surprises`,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS `Total Scans`,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
    AND version LIKE ANY ('5.%','4.%','3.%')
GROUP BY 
    1
ORDER BY 
    1",12.27734375
"SELECT 
    CONCAT('Season ', LEFT(version, 1)) AS Season,
    COUNT(DISTINCT user_id) AS `Users who have scanned surprises`,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS `Total Scans`,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
    AND version LIKE ANY ('5.%','4.%','3.%')
GROUP BY 
    1
ORDER BY 
    1",12.27734375
"SELECT 
    CONCAT('Season ', LEFT(version, 1)) AS Season,
    COUNT(DISTINCT user_id) AS `Users who have scanned surprises`,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS `Total Scans`,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
    AND version LIKE ANY ('5.%','4.%','3.%')
GROUP BY 
    1
ORDER BY 
    1",12.27734375
"SELECT 
    CONCAT('Season ', LEFT(version, 1)) AS Season,
    COUNT(DISTINCT user_id) AS `Users who have scanned surprises`,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS `Total Scans`,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
    AND version LIKE ANY ('5.%','4.%','3.%')
GROUP BY 
    1
ORDER BY 
    1",12.27734375
"SELECT 
    CONCAT('Season ', LEFT(version, 1)) AS Season,
    COUNT(DISTINCT user_id) AS `Users who have scanned surprises`,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS `Total Scans`,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
    AND version LIKE ANY ('5.%','4.%','3.%')
GROUP BY 
    1
ORDER BY 
    1",12.27734375
"SELECT 
    CONCAT('Season ', LEFT(version, 1)) AS Season,
    COUNT(DISTINCT user_id) AS `Users who have scanned surprises`,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS `Total Scans`,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
    AND version LIKE ANY ('5.%','4.%','3.%')
GROUP BY 
    1
ORDER BY 
    1",12.27734375
"SELECT 
    CONCAT('Season ', LEFT(version, 1)) AS Season,
    COUNT(DISTINCT user_id) AS `Users who have scanned surprises`,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS `Total Scans`,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
    AND version LIKE ANY ('5.%','4.%','3.%')
GROUP BY 
    1
ORDER BY 
    1",12.27734375
"SELECT 
    CONCAT('Season ', LEFT(version, 1)) AS Season,
    COUNT(DISTINCT user_id) AS `Users who have scanned surprises`,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS `Total Scans`,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
    AND version LIKE ANY ('5.%','4.%','3.%')
GROUP BY 
    1
ORDER BY 
    1",12.25
"SELECT 
    CONCAT('Season ', LEFT(version, 1)) AS Season,
    COUNT(DISTINCT user_id) AS `Users who have scanned surprises`,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS `Total Scans`,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )    	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
    AND version LIKE ANY ('5.%','4.%','3.%')
GROUP BY 
    1
ORDER BY 
    1",12.25
"SELECT 
    CONCAT('Season ', LEFT(version, 1)) AS Season,
    COUNT(DISTINCT user_id) AS `Users who have scanned surprises`,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS `Total Scans`,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  AND (`applaydu.tbl_version_filter`.`version` = ?))    	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
    AND version LIKE ANY ('5.%','4.%','3.%')
GROUP BY 
    1
ORDER BY 
    1",12.2109375
"SELECT 
    CONCAT('Season ', LEFT(version, 1)) AS Season,
    COUNT(DISTINCT user_id) AS `Users who have scanned surprises`,
    SUM(toy_unlocked_by_scan_count) AS sum_toy_unlocked_count,
    SUM(scan_mode_finished_count) AS sum_scan_mode_finished_count,
    SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count) AS `Total Scans`,
    (SUM(toy_unlocked_by_scan_count) + SUM(scan_mode_finished_count)) / COUNT(DISTINCT user_id) AS `Average Toys Scanned per User`
FROM 
    `gcp-gfb-sai-tracking-gold.applaydu.tbl_users`
JOIN 
    (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
            AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
            AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
            AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
WHERE 
    DATE(server_date) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(server_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )   
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  AND (`applaydu.tbl_version_filter`.`version` = ?))    	
    AND (toy_unlocked_by_scan_count > 0 OR scan_mode_finished_count > 0)
    AND version LIKE ANY ('5.%','4.%','3.%')
GROUP BY 
    1
ORDER BY 
    1",12.2109375
"WITH gb4247 as (select 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (unlock_cause = 'QR Code'
        OR unlock_cause = 'Toy Scan' 
        OR unlock_cause = 'Deep_Link')
        AND isnewtoy = 1
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
    GROUP BY user_id
),
Persona AS (
    SELECT user_id, 
           CASE WHEN `Number of Toys Unlocked` IN (1,2,3) THEN 'Persona #2'
                ELSE 'Persona #3' END AS `Persona Type`
    FROM unlock
)
SELECT CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END AS `Persona_Type`,
       COUNT(DISTINCT l.user_id) AS Total
FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` l
LEFT JOIN Persona p ON l.user_id = p.user_id
JOIN (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
    WHERE 1=1 
    AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
    AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
) install ON l.user_id = install.user_id
WHERE l.user_id IS NOT NULL
AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
--AND `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 [[AND {{ipersona}}]])
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
GROUP BY `Persona_Type`
having  `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 )
ORDER BY `Persona_Type`",12.0673828125
"WITH gb4234 as (SELECT 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (unlock_cause = 'QR Code'
        OR unlock_cause = 'Toy Scan' 
        OR unlock_cause = 'Deep_Link')
        AND isnewtoy = 1
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
    GROUP BY user_id
),
Persona AS (
    SELECT user_id, 
           CASE WHEN `Number of Toys Unlocked` IN (1,2,3) THEN 'Persona #2'
                ELSE 'Persona #3' END AS `Persona Type`
    FROM unlock
),
tbl_launch_resume AS (
    SELECT user_id, COALESCE(c.name, 'Unknown') AS country_name, client_time
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` l
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
        AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.country` c ON l.country = c.code
)
SELECT country_name, 
       COALESCE(`Persona #1`, 0) AS `Persona #1`, 
       COALESCE(`Persona #2`, 0) AS `Persona #2`, 
       COALESCE(`Persona #3`, 0) AS `Persona #3`,
       (`Persona #1` + `Persona #2` + `Persona #3`) AS `Active Users`,
       (`Persona #1` / (`Persona #1` + `Persona #2` + `Persona #3`)) * 100 AS `% Persona 1`,
       (`Persona #2` / (`Persona #1` + `Persona #2` + `Persona #3`)) * 100 AS `% Persona 2`, 
       (`Persona #3` / (`Persona #1` + `Persona #2` + `Persona #3`)) * 100 AS `% Persona 3`
FROM (
    SELECT *
    FROM (
        SELECT country_name, 
               CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END AS `Persona_Type`, 
               COUNT(DISTINCT l.user_id) AS `No. of Users`
        FROM tbl_launch_resume l
        LEFT JOIN Persona p ON l.user_id = p.user_id
        WHERE l.user_id IS NOT NULL
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        --AND `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 [[AND {{ipersona}}]])
        AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )
        GROUP BY country_name, `Persona_Type`
        having `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 )
    )
    PIVOT(SUM(`No. of Users`) FOR `Persona_Type` IN ('Persona #1', 'Persona #2', 'Persona #3')) AS pivottable
)
ORDER BY `Active Users` DESC, `Persona #3` DESC 
LIMIT 20",12.0673828125
"WITH gb4247 as (select 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (unlock_cause = 'QR Code'
        OR unlock_cause = 'Toy Scan' 
        OR unlock_cause = 'Deep_Link')
        AND isnewtoy = 1
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
    GROUP BY user_id
),
Persona AS (
    SELECT user_id, 
           CASE WHEN `Number of Toys Unlocked` IN (1,2,3) THEN 'Persona #2'
                ELSE 'Persona #3' END AS `Persona Type`
    FROM unlock
)
SELECT CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END AS `Persona_Type`,
       COUNT(DISTINCT l.user_id) AS Total
FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` l
LEFT JOIN Persona p ON l.user_id = p.user_id
JOIN (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
    WHERE 1=1 
    AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
    AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
) install ON l.user_id = install.user_id
WHERE l.user_id IS NOT NULL
AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
--AND `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 [[AND {{ipersona}}]])
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
GROUP BY `Persona_Type`
having  `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 )
ORDER BY `Persona_Type`",12.06640625
"WITH gb4234 as (SELECT 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (unlock_cause = 'QR Code'
        OR unlock_cause = 'Toy Scan' 
        OR unlock_cause = 'Deep_Link')
        AND isnewtoy = 1
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
    GROUP BY user_id
),
Persona AS (
    SELECT user_id, 
           CASE WHEN `Number of Toys Unlocked` IN (1,2,3) THEN 'Persona #2'
                ELSE 'Persona #3' END AS `Persona Type`
    FROM unlock
),
tbl_launch_resume AS (
    SELECT user_id, COALESCE(c.name, 'Unknown') AS country_name, client_time
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` l
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
        AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.country` c ON l.country = c.code
)
SELECT country_name, 
       COALESCE(`Persona #1`, 0) AS `Persona #1`, 
       COALESCE(`Persona #2`, 0) AS `Persona #2`, 
       COALESCE(`Persona #3`, 0) AS `Persona #3`,
       (`Persona #1` + `Persona #2` + `Persona #3`) AS `Active Users`,
       (`Persona #1` / (`Persona #1` + `Persona #2` + `Persona #3`)) * 100 AS `% Persona 1`,
       (`Persona #2` / (`Persona #1` + `Persona #2` + `Persona #3`)) * 100 AS `% Persona 2`, 
       (`Persona #3` / (`Persona #1` + `Persona #2` + `Persona #3`)) * 100 AS `% Persona 3`
FROM (
    SELECT *
    FROM (
        SELECT country_name, 
               CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END AS `Persona_Type`, 
               COUNT(DISTINCT l.user_id) AS `No. of Users`
        FROM tbl_launch_resume l
        LEFT JOIN Persona p ON l.user_id = p.user_id
        WHERE l.user_id IS NOT NULL
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        --AND `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 [[AND {{ipersona}}]])
        AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )
        GROUP BY country_name, `Persona_Type`
        having `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 )
    )
    PIVOT(SUM(`No. of Users`) FOR `Persona_Type` IN ('Persona #1', 'Persona #2', 'Persona #3')) AS pivottable
)
ORDER BY `Active Users` DESC, `Persona #3` DESC 
LIMIT 20",12.06640625
"WITH gb4234 as (SELECT 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (unlock_cause = 'QR Code'
        OR unlock_cause = 'Toy Scan' 
        OR unlock_cause = 'Deep_Link')
        AND isnewtoy = 1
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
    GROUP BY user_id
),
Persona AS (
    SELECT user_id, 
           CASE WHEN `Number of Toys Unlocked` IN (1,2,3) THEN 'Persona #2'
                ELSE 'Persona #3' END AS `Persona Type`
    FROM unlock
),
tbl_launch_resume AS (
    SELECT user_id, COALESCE(c.name, 'Unknown') AS country_name, client_time
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` l
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
        AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.country` c ON l.country = c.code
)
SELECT country_name, 
       COALESCE(`Persona #1`, 0) AS `Persona #1`, 
       COALESCE(`Persona #2`, 0) AS `Persona #2`, 
       COALESCE(`Persona #3`, 0) AS `Persona #3`,
       (`Persona #1` + `Persona #2` + `Persona #3`) AS `Active Users`,
       (`Persona #1` / (`Persona #1` + `Persona #2` + `Persona #3`)) * 100 AS `% Persona 1`,
       (`Persona #2` / (`Persona #1` + `Persona #2` + `Persona #3`)) * 100 AS `% Persona 2`, 
       (`Persona #3` / (`Persona #1` + `Persona #2` + `Persona #3`)) * 100 AS `% Persona 3`
FROM (
    SELECT *
    FROM (
        SELECT country_name, 
               CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END AS `Persona_Type`, 
               COUNT(DISTINCT l.user_id) AS `No. of Users`
        FROM tbl_launch_resume l
        LEFT JOIN Persona p ON l.user_id = p.user_id
        WHERE l.user_id IS NOT NULL
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        --AND `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 [[AND {{ipersona}}]])
        AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1   )
        GROUP BY country_name, `Persona_Type`
        having `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 )
    )
    PIVOT(SUM(`No. of Users`) FOR `Persona_Type` IN ('Persona #1', 'Persona #2', 'Persona #3')) AS pivottable
)
ORDER BY `Active Users` DESC, `Persona #3` DESC 
LIMIT 20",11.9443359375
"WITH gb4247 as (select 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (unlock_cause = 'QR Code'
        OR unlock_cause = 'Toy Scan' 
        OR unlock_cause = 'Deep_Link')
        AND isnewtoy = 1
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
    GROUP BY user_id
),
Persona AS (
    SELECT user_id, 
           CASE WHEN `Number of Toys Unlocked` IN (1,2,3) THEN 'Persona #2'
                ELSE 'Persona #3' END AS `Persona Type`
    FROM unlock
)
SELECT CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END AS `Persona_Type`,
       COUNT(DISTINCT l.user_id) AS Total
FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` l
LEFT JOIN Persona p ON l.user_id = p.user_id
JOIN (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
    WHERE 1=1 
    AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
    AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
) install ON l.user_id = install.user_id
WHERE l.user_id IS NOT NULL
AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
--AND `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 [[AND {{ipersona}}]])
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )
GROUP BY `Persona_Type`
having  `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 )
ORDER BY `Persona_Type`",11.9443359375
"WITH gb4247 as (select 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (unlock_cause = 'QR Code'
        OR unlock_cause = 'Toy Scan' 
        OR unlock_cause = 'Deep_Link')
        AND isnewtoy = 1
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
    GROUP BY user_id
),
Persona AS (
    SELECT user_id, 
           CASE WHEN `Number of Toys Unlocked` IN (1,2,3) THEN 'Persona #2'
                ELSE 'Persona #3' END AS `Persona Type`
    FROM unlock
)
SELECT CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END AS `Persona_Type`,
       COUNT(DISTINCT l.user_id) AS Total
FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` l
LEFT JOIN Persona p ON l.user_id = p.user_id
JOIN (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
    WHERE 1=1 
    AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
    AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
) install ON l.user_id = install.user_id
WHERE l.user_id IS NOT NULL
AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
--AND `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 [[AND {{ipersona}}]])
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
GROUP BY `Persona_Type`
having  `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 )
ORDER BY `Persona_Type`",11.7451171875
"WITH gb4234 as (SELECT 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (unlock_cause = 'QR Code'
        OR unlock_cause = 'Toy Scan' 
        OR unlock_cause = 'Deep_Link')
        AND isnewtoy = 1
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
    GROUP BY user_id
),
Persona AS (
    SELECT user_id, 
           CASE WHEN `Number of Toys Unlocked` IN (1,2,3) THEN 'Persona #2'
                ELSE 'Persona #3' END AS `Persona Type`
    FROM unlock
),
tbl_launch_resume AS (
    SELECT user_id, COALESCE(c.name, 'Unknown') AS country_name, client_time
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` l
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
        AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.country` c ON l.country = c.code
)
SELECT country_name, 
       COALESCE(`Persona #1`, 0) AS `Persona #1`, 
       COALESCE(`Persona #2`, 0) AS `Persona #2`, 
       COALESCE(`Persona #3`, 0) AS `Persona #3`,
       (`Persona #1` + `Persona #2` + `Persona #3`) AS `Active Users`,
       (`Persona #1` / (`Persona #1` + `Persona #2` + `Persona #3`)) * 100 AS `% Persona 1`,
       (`Persona #2` / (`Persona #1` + `Persona #2` + `Persona #3`)) * 100 AS `% Persona 2`, 
       (`Persona #3` / (`Persona #1` + `Persona #2` + `Persona #3`)) * 100 AS `% Persona 3`
FROM (
    SELECT *
    FROM (
        SELECT country_name, 
               CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END AS `Persona_Type`, 
               COUNT(DISTINCT l.user_id) AS `No. of Users`
        FROM tbl_launch_resume l
        LEFT JOIN Persona p ON l.user_id = p.user_id
        WHERE l.user_id IS NOT NULL
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        --AND `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 [[AND {{ipersona}}]])
        AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
        GROUP BY country_name, `Persona_Type`
        having `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 )
    )
    PIVOT(SUM(`No. of Users`) FOR `Persona_Type` IN ('Persona #1', 'Persona #2', 'Persona #3')) AS pivottable
)
ORDER BY `Active Users` DESC, `Persona #3` DESC 
LIMIT 20",11.7451171875
"WITH gb4247 as (select 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (unlock_cause = 'QR Code'
        OR unlock_cause = 'Toy Scan' 
        OR unlock_cause = 'Deep_Link')
        AND isnewtoy = 1
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
    GROUP BY user_id
),
Persona AS (
    SELECT user_id, 
           CASE WHEN `Number of Toys Unlocked` IN (1,2,3) THEN 'Persona #2'
                ELSE 'Persona #3' END AS `Persona Type`
    FROM unlock
)
SELECT CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END AS `Persona_Type`,
       COUNT(DISTINCT l.user_id) AS Total
FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` l
LEFT JOIN Persona p ON l.user_id = p.user_id
JOIN (
    SELECT DISTINCT user_id 
    FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
    WHERE 1=1 
    AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
    AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
) install ON l.user_id = install.user_id
WHERE l.user_id IS NOT NULL
AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
--AND `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 [[AND {{ipersona}}]])
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
GROUP BY `Persona_Type`
having  `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 )
ORDER BY `Persona_Type`",11.744140625
"WITH gb4234 as (SELECT 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (unlock_cause = 'QR Code'
        OR unlock_cause = 'Toy Scan' 
        OR unlock_cause = 'Deep_Link')
        AND isnewtoy = 1
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
    GROUP BY user_id
),
Persona AS (
    SELECT user_id, 
           CASE WHEN `Number of Toys Unlocked` IN (1,2,3) THEN 'Persona #2'
                ELSE 'Persona #3' END AS `Persona Type`
    FROM unlock
),
tbl_launch_resume AS (
    SELECT user_id, COALESCE(c.name, 'Unknown') AS country_name, client_time
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume` l
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
        AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
    LEFT JOIN `gcp-bi-elephant-db-gold.dimensions.country` c ON l.country = c.code
)
SELECT country_name, 
       COALESCE(`Persona #1`, 0) AS `Persona #1`, 
       COALESCE(`Persona #2`, 0) AS `Persona #2`, 
       COALESCE(`Persona #3`, 0) AS `Persona #3`,
       (`Persona #1` + `Persona #2` + `Persona #3`) AS `Active Users`,
       (`Persona #1` / (`Persona #1` + `Persona #2` + `Persona #3`)) * 100 AS `% Persona 1`,
       (`Persona #2` / (`Persona #1` + `Persona #2` + `Persona #3`)) * 100 AS `% Persona 2`, 
       (`Persona #3` / (`Persona #1` + `Persona #2` + `Persona #3`)) * 100 AS `% Persona 3`
FROM (
    SELECT *
    FROM (
        SELECT country_name, 
               CASE WHEN p.`Persona Type` IS NULL THEN 'Persona #1' ELSE p.`Persona Type` END AS `Persona_Type`, 
               COUNT(DISTINCT l.user_id) AS `No. of Users`
        FROM tbl_launch_resume l
        LEFT JOIN Persona p ON l.user_id = p.user_id
        WHERE l.user_id IS NOT NULL
        AND client_time >= CAST((SELECT ivalue FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date') AS TIMESTAMP)
        AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        --AND `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 [[AND {{ipersona}}]])
        AND country_name IN (SELECT country_name FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
        GROUP BY country_name, `Persona_Type`
        having `Persona_Type` IN (SELECT persona FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_persona_filter` WHERE 1=1 )
    )
    PIVOT(SUM(`No. of Users`) FOR `Persona_Type` IN ('Persona #1', 'Persona #2', 'Persona #3')) AS pivottable
)
ORDER BY `Active Users` DESC, `Persona #3` DESC 
LIMIT 20",11.744140625
"WITH 
tbl_apd_users AS (
    SELECT 
        DATE_TRUNC(client_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS apd_users
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    WHERE 1=1
    AND version >= '5.0.0'
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(client_time) < CURRENT_DATE()
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(client_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
),
ls_users AS (
    SELECT 
        DATE_TRUNC(server_time, MONTH) AS month, 
        COUNT(DISTINCT user_id) AS number_ls_users
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
    GROUP BY month
    ORDER BY month
)
SELECT 
    month, 
    `number_ls_users` AS `Users access Lets Story`, 
    `number_ls_users`/ apd_users AS `% APD Users Access Lets Story`
FROM ls_users 
LEFT JOIN tbl_apd_users USING (month)
ORDER BY month;",11.728515625
"WITH gb4242 as (SELECT 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (
        `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`.unlock_cause IN ('QR Code', 'Toy Scan', 'Deep_Link')
        AND `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`.isnewtoy = 1
    )
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date')
    GROUP BY user_id
    HAVING `Number of Toys Unlocked` > 0
)

,
launch_raw AS (
    SELECT user_id, DATE(client_time)AS login_Day, 
           MIN(DATE(client_time)) OVER (PARTITION BY user_id) AS `First Day`, 
           version
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
        AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
    JOIN unlock USING (user_id)
    WHERE `gcp-bi-elephant-db-gold.applaydu.launch_resume`.country IN ('IN', 'BR', 'RU', 'US', 'IT', 'MX')
    AND game_id IN (81337, 81335)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
    GROUP BY user_id, login_Day, version,client_time
),
launch_with_version AS (
    SELECT user_id, login_Day, `First Day`, 
           DATE_DIFF(login_Day, `First Day`, DAY) AS Day_number
    FROM launch_raw
    WHERE `First Day` >= '2022-06-01' 
    AND `First Day` < DATE_SUB(CURRENT_DATE(), INTERVAL 10 DAY)
    AND `First Day` >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND `First Day` < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND `First Day` >= DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 30 MONTH)
    ORDER BY user_id, Day_number
)
,
retention AS (
    SELECT DATE_TRUNC(`First Day`, MONTH) AS Month,
           FORMAT_DATE('%A', `First Day`) AS `Weekday`, `First Day`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS `No of New user Acquired`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS Day_0,
           SUM(CASE WHEN Day_number = 1 THEN 1 ELSE 0 END) AS Day_1,
           SUM(CASE WHEN Day_number = 2 THEN 1 ELSE 0 END) AS Day_3,
           SUM(CASE WHEN Day_number = 3 THEN 1 ELSE 0 END) AS Day_7,
           SUM(CASE WHEN Day_number = 4 THEN 1 ELSE 0 END) AS Day_14,
           SUM(CASE WHEN Day_number = 5 THEN 1 ELSE 0 END) AS Day_28,
           SUM(CASE WHEN Day_number = 6 THEN 1 ELSE 0 END) AS Day_30
    FROM launch_with_version
    GROUP BY `First Day`
    HAVING `Weekday` IN ('Friday', 'Saturday')
    ORDER BY `First Day`
)

SELECT 'All' AS Platform, Month,
       CONCAT(ROUND(SUM(Day_1)/SUM(Day_0)*100, 2), '%') AS `Retention D1`,
       CONCAT(ROUND(SUM(Day_3)/SUM(Day_0)*100, 2), '%') AS `Retention D3`,
       CONCAT(ROUND(SUM(Day_7)/SUM(Day_0)*100, 2), '%') AS `Retention D7`,
       CONCAT(ROUND(SUM(Day_14)/SUM(Day_0)*100, 2), '%') AS `Retention D14`,
       CONCAT(ROUND(SUM(Day_28)/SUM(Day_0)*100, 2), '%') AS `Retention D28`,
       CONCAT(ROUND(SUM(Day_30)/SUM(Day_0)*100, 2), '%') AS `Retention D30`,
       CONCAT(ROUND(SUM(Day_7)/SUM(Day_1)*100, 2), '%') AS `D7 per D1`
FROM retention
GROUP BY Month
ORDER BY Month ASC",11.5791015625
"WITH gb4242 as (SELECT 0)
,unlock AS (
    SELECT DISTINCT user_id, COUNT(*) AS `Number of Toys Unlocked`
    FROM `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`
    WHERE (
        `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`.unlock_cause IN ('QR Code', 'Toy Scan', 'Deep_Link')
        AND `gcp-bi-elephant-db-gold.applaydu.toy_unlocked`.isnewtoy = 1
    )
    AND DATE(client_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey='persona_starting_date')
    GROUP BY user_id
    HAVING `Number of Toys Unlocked` > 0
)

,
launch_raw AS (
    SELECT user_id, DATE(client_time)AS login_Day, 
           MIN(DATE(client_time)) OVER (PARTITION BY user_id) AS `First Day`, 
           version
    FROM `gcp-bi-elephant-db-gold.applaydu.launch_resume`
    JOIN (
        SELECT DISTINCT user_id 
        FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
        WHERE 1=1 
        AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1 )
        AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
        AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    ) USING (user_id)
    JOIN unlock USING (user_id)
    WHERE `gcp-bi-elephant-db-gold.applaydu.launch_resume`.country IN ('IN', 'BR', 'RU', 'US', 'IT', 'MX')
    AND game_id IN (81337, 81335)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )
    GROUP BY user_id, login_Day, version,client_time
),
launch_with_version AS (
    SELECT user_id, login_Day, `First Day`, 
           DATE_DIFF(login_Day, `First Day`, DAY) AS Day_number
    FROM launch_raw
    WHERE `First Day` >= '2022-06-01' 
    AND `First Day` < DATE_SUB(CURRENT_DATE(), INTERVAL 10 DAY)
    AND `First Day` >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND `First Day` < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND `First Day` >= DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 30 MONTH)
    ORDER BY user_id, Day_number
)
,
retention AS (
    SELECT DATE_TRUNC(`First Day`, MONTH) AS Month,
           FORMAT_DATE('%A', `First Day`) AS `Weekday`, `First Day`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS `No of New user Acquired`,
           SUM(CASE WHEN Day_number = 0 THEN 1 ELSE 0 END) AS Day_0,
           SUM(CASE WHEN Day_number = 1 THEN 1 ELSE 0 END) AS Day_1,
           SUM(CASE WHEN Day_number = 2 THEN 1 ELSE 0 END) AS Day_3,
           SUM(CASE WHEN Day_number = 3 THEN 1 ELSE 0 END) AS Day_7,
           SUM(CASE WHEN Day_number = 4 THEN 1 ELSE 0 END) AS Day_14,
           SUM(CASE WHEN Day_number = 5 THEN 1 ELSE 0 END) AS Day_28,
           SUM(CASE WHEN Day_number = 6 THEN 1 ELSE 0 END) AS Day_30
    FROM launch_with_version
    GROUP BY `First Day`
    HAVING `Weekday` IN ('Friday', 'Saturday')
    ORDER BY `First Day`
)

SELECT 'All' AS Platform, Month,
       CONCAT(ROUND(SUM(Day_1)/SUM(Day_0)*100, 2), '%') AS `Retention D1`,
       CONCAT(ROUND(SUM(Day_3)/SUM(Day_0)*100, 2), '%') AS `Retention D3`,
       CONCAT(ROUND(SUM(Day_7)/SUM(Day_0)*100, 2), '%') AS `Retention D7`,
       CONCAT(ROUND(SUM(Day_14)/SUM(Day_0)*100, 2), '%') AS `Retention D14`,
       CONCAT(ROUND(SUM(Day_28)/SUM(Day_0)*100, 2), '%') AS `Retention D28`,
       CONCAT(ROUND(SUM(Day_30)/SUM(Day_0)*100, 2), '%') AS `Retention D30`,
       CONCAT(ROUND(SUM(Day_7)/SUM(Day_1)*100, 2), '%') AS `D7 per D1`
FROM retention
GROUP BY Month
ORDER BY Month ASC",11.578125
"WITH gb4228 as (select 0)
,user_type AS (
    SELECT 
        user_id, 
        COUNT(*) AS number_of_sessions, 
        'One and Done Users' AS UserType
    FROM 
        `gcp-bi-elephant-db-gold.applaydu.launch_resume` t 
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 1=1 
        
    GROUP BY 
        1
    HAVING 
        number_of_sessions = 1
),
main AS (
    SELECT 
        lr.*, 
        ut.UserType
    FROM 
        `gcp-bi-elephant-db-gold.applaydu.launch_resume` lr
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    LEFT JOIN 
        user_type ut USING (user_id)
    WHERE 1=1 
        
    ORDER BY 
        lr.user_id
)
SELECT 
    SUM(CASE WHEN UserType = 'One and Done Users' THEN 1 ELSE 0 END) / COUNT(DISTINCT user_id) AS `One and Done`
FROM 
    main t
WHERE 
    CAST(time_spent AS FLOAT64) >= 0
    AND CAST(time_spent AS FLOAT64) < 86400
    AND (session_id = 1 OR CAST(time_between_sessions AS INT64) >= 30)
    AND DATE(client_time) >= '2020-08-10' 
    AND DATE(client_time) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )  
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )  
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )",11.271484375
"WITH gb4228 as (select 0)
,user_type AS (
    SELECT 
        user_id, 
        COUNT(*) AS number_of_sessions, 
        'One and Done Users' AS UserType
    FROM 
        `gcp-bi-elephant-db-gold.applaydu.launch_resume` t 
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 1=1 
        
    GROUP BY 
        1
    HAVING 
        number_of_sessions = 1
),
main AS (
    SELECT 
        lr.*, 
        ut.UserType
    FROM 
        `gcp-bi-elephant-db-gold.applaydu.launch_resume` lr
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    LEFT JOIN 
        user_type ut USING (user_id)
    WHERE 1=1 
        
    ORDER BY 
        lr.user_id
)
SELECT 
    SUM(CASE WHEN UserType = 'One and Done Users' THEN 1 ELSE 0 END) / COUNT(DISTINCT user_id) AS `One and Done`
FROM 
    main t
WHERE 
    CAST(time_spent AS FLOAT64) >= 0
    AND CAST(time_spent AS FLOAT64) < 86400
    AND (session_id = 1 OR CAST(time_between_sessions AS INT64) >= 30)
    AND DATE(client_time) >= '2020-08-10' 
    AND DATE(client_time) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )  
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )  
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )",11.2705078125
"WITH gb4228 as (select 0)
,user_type AS (
    SELECT 
        user_id, 
        COUNT(*) AS number_of_sessions, 
        'One and Done Users' AS UserType
    FROM 
        `gcp-bi-elephant-db-gold.applaydu.launch_resume` t 
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 1=1 
        
    GROUP BY 
        1
    HAVING 
        number_of_sessions = 1
),
main AS (
    SELECT 
        lr.*, 
        ut.UserType
    FROM 
        `gcp-bi-elephant-db-gold.applaydu.launch_resume` lr
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    LEFT JOIN 
        user_type ut USING (user_id)
    WHERE 1=1 
        
    ORDER BY 
        lr.user_id
)
SELECT 
    SUM(CASE WHEN UserType = 'One and Done Users' THEN 1 ELSE 0 END) / COUNT(DISTINCT user_id) AS `One and Done`
FROM 
    main t
WHERE 
    CAST(time_spent AS FLOAT64) >= 0
    AND CAST(time_spent AS FLOAT64) < 86400
    AND (session_id = 1 OR CAST(time_between_sessions AS INT64) >= 30)
    AND DATE(client_time) >= '2020-08-10' 
    AND DATE(client_time) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )  
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )  
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )",11.2705078125
"WITH gb4228 as (select 0)
,user_type AS (
    SELECT 
        user_id, 
        COUNT(*) AS number_of_sessions, 
        'One and Done Users' AS UserType
    FROM 
        `gcp-bi-elephant-db-gold.applaydu.launch_resume` t 
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 1=1 
        
    GROUP BY 
        1
    HAVING 
        number_of_sessions = 1
),
main AS (
    SELECT 
        lr.*, 
        ut.UserType
    FROM 
        `gcp-bi-elephant-db-gold.applaydu.launch_resume` lr
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    LEFT JOIN 
        user_type ut USING (user_id)
    WHERE 1=1 
        
    ORDER BY 
        lr.user_id
)
SELECT 
    SUM(CASE WHEN UserType = 'One and Done Users' THEN 1 ELSE 0 END) / COUNT(DISTINCT user_id) AS `One and Done`
FROM 
    main t
WHERE 
    CAST(time_spent AS FLOAT64) >= 0
    AND CAST(time_spent AS FLOAT64) < 86400
    AND (session_id = 1 OR CAST(time_between_sessions AS INT64) >= 30)
    AND DATE(client_time) >= '2020-08-10' 
    AND DATE(client_time) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1   )  
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )  
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  )",11.001953125
"WITH gb4228 as (select 0)
,user_type AS (
    SELECT 
        user_id, 
        COUNT(*) AS number_of_sessions, 
        'One and Done Users' AS UserType
    FROM 
        `gcp-bi-elephant-db-gold.applaydu.launch_resume` t 
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 1=1 
        
    GROUP BY 
        1
    HAVING 
        number_of_sessions = 1
),
main AS (
    SELECT 
        lr.*, 
        ut.UserType
    FROM 
        `gcp-bi-elephant-db-gold.applaydu.launch_resume` lr
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    LEFT JOIN 
        user_type ut USING (user_id)
    WHERE 1=1 
        
    ORDER BY 
        lr.user_id
)
SELECT 
    SUM(CASE WHEN UserType = 'One and Done Users' THEN 1 ELSE 0 END) / COUNT(DISTINCT user_id) AS `One and Done`
FROM 
    main t
WHERE 
    CAST(time_spent AS FLOAT64) >= 0
    AND CAST(time_spent AS FLOAT64) < 86400
    AND (session_id = 1 OR CAST(time_between_sessions AS INT64) >= 30)
    AND DATE(client_time) >= '2020-08-10' 
    AND DATE(client_time) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )  
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )  
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  AND (`applaydu.tbl_version_filter`.`version` = ?))",10.4677734375
"WITH gb4228 as (select 0)
,user_type AS (
    SELECT 
        user_id, 
        COUNT(*) AS number_of_sessions, 
        'One and Done Users' AS UserType
    FROM 
        `gcp-bi-elephant-db-gold.applaydu.launch_resume` t 
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    WHERE 1=1 
        
    GROUP BY 
        1
    HAVING 
        number_of_sessions = 1
),
main AS (
    SELECT 
        lr.*, 
        ut.UserType
    FROM 
        `gcp-bi-elephant-db-gold.applaydu.launch_resume` lr
    JOIN 
        (
            SELECT DISTINCT user_id 
            FROM `gcp-bi-elephant-db-gold.applaydu.user_activity` 
            WHERE 1=1 
                AND install_source IN (SELECT ua_filter FROM `applaydu.tbl_ua_filter` WHERE 1=1  )
                AND DATE(active_date) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
                AND DATE(active_date) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
        ) USING (user_id)
    LEFT JOIN 
        user_type ut USING (user_id)
    WHERE 1=1 
        
    ORDER BY 
        lr.user_id
)
SELECT 
    SUM(CASE WHEN UserType = 'One and Done Users' THEN 1 ELSE 0 END) / COUNT(DISTINCT user_id) AS `One and Done`
FROM 
    main t
WHERE 
    CAST(time_spent AS FLOAT64) >= 0
    AND CAST(time_spent AS FLOAT64) < 86400
    AND (session_id = 1 OR CAST(time_between_sessions AS INT64) >= 30)
    AND DATE(client_time) >= '2020-08-10' 
    AND DATE(client_time) < DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND DATE(client_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(client_time) < DATE_ADD((SELECT MAX(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?), INTERVAL 1 DAY)
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  AND ((`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?) OR (`applaydu.tbl_country_filter`.`country_name` = ?)) )  
    AND t.country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1  )  
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1  AND (`applaydu.tbl_version_filter`.`version` = ?))",10.466796875
"WITH 
tbl_users_launch_lets_story AS (
    SELECT
        COUNT(DISTINCT user_id) AS users,
        COUNT(*) AS lets_story_sessions
    FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
    WHERE (
        screen_from IN ('World Map', 'Mini Game Screen')
        OR screen_from LIKE 'Eduland%Minigame Menu'
    )
    AND screen_to = 'Eduland Lets Story'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
),
tbl_utm AS (
    SELECT COUNT(DISTINCT user_id) AS users
    FROM `gcp-bi-elephant-db-gold.applaydu.custom_install_referral`
    WHERE utm_campaign LIKE '%CLTS%'
    AND version >= '5.0.0'
    AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
    AND DATE(server_time) < CURRENT_DATE()
    AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
    AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
    AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
)
SELECT 'Kinder Chocolate users' AS `User Source`, (SELECT users FROM tbl_utm) AS users
UNION ALL
SELECT 'Organic users' AS `User Source`, (SELECT users FROM tbl_users_launch_lets_story) - (SELECT users FROM tbl_utm) AS users;",10.45703125
"SELECT
    country,
    COUNT(DISTINCT user_id) AS users
FROM `gcp-bi-elephant-db-gold.applaydu.visit_screen`
WHERE (
    screen_from IN ('World Map', 'Mini Game Screen')
    OR screen_from LIKE 'Eduland%Minigame Menu'
)
AND screen_to = 'Eduland Lets Story'
AND version >= '5.0.0'
AND DATE(server_time) >= (SELECT DATE(ivalue) FROM `gcp-gfb-sai-tracking-gold.applaydu.tbl_variables` WHERE ikey = 'apd_v5_lets_story_start_date')
AND DATE(server_time) < CURRENT_DATE()
AND DATE(server_time) >= (SELECT MIN(server_date) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
AND DATE(server_time) < (SELECT DATE(MAX(server_date) + 1) FROM `applaydu.tbl_date_filter` WHERE 1=1 AND `applaydu.tbl_date_filter`.`server_date` BETWEEN ? AND ?)
AND country IN (SELECT country FROM `applaydu.tbl_country_filter` WHERE 1=1 )
AND version IN (SELECT version FROM `applaydu.tbl_version_filter` WHERE 1=1 )
GROUP BY 1;",10.2763671875
